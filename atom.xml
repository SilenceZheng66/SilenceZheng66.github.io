<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>SilenceZheng66-BLOG</title>
  
  <subtitle>silencezheng.top</subtitle>
  <link href="http://silencezheng.top/atom.xml" rel="self"/>
  
  <link href="http://silencezheng.top/"/>
  <updated>2024-08-19T15:25:11.209Z</updated>
  <id>http://silencezheng.top/</id>
  
  <author>
    <name>SilenceZheng66</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>xxl-jobæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå®šæ—¶ä»»åŠ¡æ‰§è¡Œé“¾è·¯åˆ†æ</title>
    <link href="http://silencezheng.top/2024/08/19/article135/"/>
    <id>http://silencezheng.top/2024/08/19/article135/</id>
    <published>2024-08-19T15:15:50.000Z</published>
    <updated>2024-08-19T15:25:11.209Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>xxl-jobæºç é˜…è¯»ç¬¬ä¸€ç« ï¼šå®šæ—¶ä»»åŠ¡æ‰§è¡Œé“¾è·¯åˆ†æ</p><p>ä¸€æ—¶å…´èµ·ï¼ŒèŠ±ä¸€ä¸‹åˆçœ‹äº†ä¸€éè¿™éƒ¨åˆ†æºç ï¼Œå†™çš„ä¸é”™ã€‚</p><p>PSï¼šå†™å®Œæ‰å‘ç°æœ‰å®˜æ–¹æ–‡æ¡£è®²è§£â€¦å°´å°¬ğŸ˜…<br><span id="more"></span></p><h1 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h1><h2 id="éƒ¨ç½²xxl-job-admin"><a href="#éƒ¨ç½²xxl-job-admin" class="headerlink" title="éƒ¨ç½²xxl-job-admin"></a>éƒ¨ç½²xxl-job-admin</h2><p>å®˜ç½‘æ–‡æ¡£ç§’äº†ã€‚</p><p>åœ°å€ï¼š<a href="https://www.xuxueli.com/xxl-job/#%E4%BA%8C%E3%80%81%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8">https://www.xuxueli.com/xxl-job/#%E4%BA%8C%E3%80%81%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8</a></p><h2 id="è£…è½½é…ç½®ç±»"><a href="#è£…è½½é…ç½®ç±»" class="headerlink" title="è£…è½½é…ç½®ç±»"></a>è£…è½½é…ç½®ç±»</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobHandlerConfig</span> </span>&#123;</span><br><span class="line">Â  Â  <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses:http://ip:8008/xxl-job-admin-1.8.2&#125;&quot;)</span></span><br><span class="line">Â  Â  <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname:appname&#125;&quot;)</span></span><br><span class="line">Â  Â  <span class="keyword">private</span> String appName;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logpath:./xxlLogs&#125;&quot;)</span></span><br><span class="line">Â  Â  <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Â  Â  <span class="meta">@Bean(initMethod = &quot;start&quot;, destroyMethod = &quot;destroy&quot;)</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> XxlJobExecutor <span class="title">xxlJobExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">Â  Â  Â  Â  XxlJobExecutor xxlJobExecutor = <span class="keyword">new</span> XxlJobExecutor();</span><br><span class="line">Â  Â  Â  Â  xxlJobExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">Â  Â  Â  Â  xxlJobExecutor.setAppName(appName);</span><br><span class="line">Â  Â  Â  Â  xxlJobExecutor.setLogPath(logPath);</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> xxlJobExecutor;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®ç°ä»»åŠ¡æ¥å£"><a href="#å®ç°ä»»åŠ¡æ¥å£" class="headerlink" title="å®ç°ä»»åŠ¡æ¥å£"></a>å®ç°ä»»åŠ¡æ¥å£</h2><p>æ³¨æ„ä¸¤ç‚¹ï¼š</p><ol><li><code>@JobHandler</code>æ³¨è§£ç”¨äºå”¯ä¸€è¯†åˆ«ä»»åŠ¡</li><li>å®ç°äº†<code>IJobHandler</code>æ¥å£æ‰ä¼šè¢«åŠ è½½åˆ°ä»»åŠ¡åˆ—è¡¨ä¸­</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@JobHandler(value = &quot;AutoSendEmailScheduler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoSendEmailScheduler</span> <span class="keyword">extends</span> <span class="title">IJobHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="meta">@Resource</span></span><br><span class="line">Â  Â  <span class="keyword">private</span> UniqueIdenAutoUpdateAndSendEmail uniqueIdenAutoUpdateAndSendEmail;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="meta">@Override</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">execute</span><span class="params">(String startDate)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Â  Â  Â  Â  log.info(<span class="string">&quot;AutoSendEmailScheduler start, startDate:&#123;&#125;&quot;</span>, startDate);</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">Â  Â  Â  Â  ReturnT&lt;String&gt; result = <span class="keyword">new</span> ReturnT&lt;&gt;();</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">try</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  uniqueIdenAutoUpdateAndSendEmail.autoSendEmail(startDate);</span><br><span class="line">Â  Â  Â  Â  &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  log.error(<span class="string">&quot;AutoSendEmailScheduler fail, startDate:&#123;&#125;&quot;</span>, startDate, ex);</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  result.setCode(SUCCESS_CODE);</span><br><span class="line">Â  Â  Â  Â  log.info(<span class="string">&quot;AutoSendEmailScheduler end, cost &#123;&#125;ms&quot;</span>, System.currentTimeMillis() - start);</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> result;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Xxl-job-Serverç«¯æºç åˆ†æ"><a href="#Xxl-job-Serverç«¯æºç åˆ†æ" class="headerlink" title="Xxl-job Serverç«¯æºç åˆ†æ"></a>Xxl-job Serverç«¯æºç åˆ†æ</h1><p>ç‰ˆæœ¬ï¼šxxl-job-core1.9.1</p><h2 id="ç»Ÿä¸€å…¥å£-â€”-æ‰§è¡Œå™¨"><a href="#ç»Ÿä¸€å…¥å£-â€”-æ‰§è¡Œå™¨" class="headerlink" title="ç»Ÿä¸€å…¥å£ â€” æ‰§è¡Œå™¨"></a>ç»Ÿä¸€å…¥å£ â€” æ‰§è¡Œå™¨</h2><p>æ‰§è¡Œå™¨å³<code>XxlJobExecutor</code>ï¼Œè¢«æ³¨å†Œä¸ºä¸Šä¸‹æ–‡ï¼Œä¸»è¦æ˜¯ä¸ºäº†èƒ½ç”¨<code>ApplicationContext</code>è·å–å„ç§ä¿¡æ¯ï¼Œä¾‹å¦‚Beanä¿¡æ¯ç­‰ç­‰ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobExecutor</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span></span>&#123;</span><br><span class="line">Â  Â  ...</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line">Â  Â  <span class="meta">@Override</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> applicationContext;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="åŠ è½½ä»»åŠ¡å¤„ç†å™¨"><a href="#åŠ è½½ä»»åŠ¡å¤„ç†å™¨" class="headerlink" title="åŠ è½½ä»»åŠ¡å¤„ç†å™¨"></a>åŠ è½½ä»»åŠ¡å¤„ç†å™¨</h3><p>æŠŠåˆšæ‰è‡ªå·±å®šä¹‰çš„å®šæ—¶ä»»åŠ¡å¤„ç†å™¨å’Œå…¶ä»–æ‰€æœ‰åŠ å…¥äº†<code>@JobHandler</code>æ³¨è§£çš„ç±»åŠ è½½è¿›æ¥ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, IJobHandler&gt; jobHandlerRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;String, IJobHandler&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IJobHandler <span class="title">registJobHandler</span><span class="params">(String name, IJobHandler jobHandler)</span></span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">return</span> jobHandlerRepository.put(name, jobHandler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initJobHandlerRepository</span><span class="params">(ApplicationContext applicationContext)</span></span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">if</span> (applicationContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span>;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment">// init job handler action</span></span><br><span class="line">Â  Â  Map&lt;String, Object&gt; serviceBeanMap = applicationContext.getBeansWithAnnotation(JobHandler.class);</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">if</span> (serviceBeanMap!=<span class="keyword">null</span> &amp;&amp; serviceBeanMap.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">for</span> (Object serviceBean : serviceBeanMap.values()) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (serviceBean <span class="keyword">instanceof</span> IJobHandler)&#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  String name = serviceBean.getClass().getAnnotation(JobHandler.class).value();</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  IJobHandler handler = (IJobHandler) serviceBean;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (loadJobHandler(name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job jobhandler naming conflicts.&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  registJobHandler(name, handler);</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼ˆè°ƒåº¦ä¸­å¿ƒï¼‰"><a href="#åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼ˆè°ƒåº¦ä¸­å¿ƒï¼‰" class="headerlink" title="åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼ˆè°ƒåº¦ä¸­å¿ƒï¼‰"></a>åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼ˆè°ƒåº¦ä¸­å¿ƒï¼‰</h3><p>xxl-jobæ˜¯C/Sæ¶æ„çš„ï¼Œå®¢æˆ·ç«¯æ˜¯RPCæœåŠ¡çš„è°ƒç”¨è€…ï¼Œå³<code>xxl-job-admin</code>ï¼Œå¸¦æœ‰ä¸€ä¸ªå‰ç«¯ã€‚è¿™é‡Œå¯ä»¥æœ‰å¤šä¸ªè°ƒåº¦ä¸­å¿ƒï¼Œæ˜¯å› ä¸ºæ”¯æŒé›†ç¾¤éƒ¨ç½²ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;AdminBiz&gt; adminBizList;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initAdminBizList</span><span class="params">(String adminAddresses, String accessToken)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">if</span> (adminAddresses!=<span class="keyword">null</span> &amp;&amp; adminAddresses.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">for</span> (String address: adminAddresses.trim().split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (address!=<span class="keyword">null</span> &amp;&amp; address.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// http://ip:port/xxl-job-admin-1.8.2 + /api</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  String addressUrl = address.concat(AdminBiz.MAPPING);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  AdminBiz adminBiz = (AdminBiz) <span class="keyword">new</span> NetComClientProxy(AdminBiz.class, addressUrl, accessToken).getObject();</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (adminBizList == <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminBizList = <span class="keyword">new</span> ArrayList&lt;AdminBiz&gt;();</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  adminBizList.add(adminBiz);</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;AdminBiz&gt; <span class="title">getAdminBizList</span><span class="params">()</span></span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">return</span> adminBizList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="åˆå§‹åŒ–RPCæœåŠ¡å™¨å·¥å‚"><a href="#åˆå§‹åŒ–RPCæœåŠ¡å™¨å·¥å‚" class="headerlink" title="åˆå§‹åŒ–RPCæœåŠ¡å™¨å·¥å‚"></a>åˆå§‹åŒ–RPCæœåŠ¡å™¨å·¥å‚</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> NetComServerFactory serverFactory = <span class="keyword">new</span> NetComServerFactory();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initExecutorServer</span><span class="params">(<span class="keyword">int</span> port, String ip, String appName, String accessToken)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Â  Â  <span class="comment">// valid param</span></span><br><span class="line">Â  Â  port = port&gt;<span class="number">0</span>?port: NetUtil.findAvailablePort(<span class="number">9999</span>);</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment">// start server</span></span><br><span class="line">Â  Â  NetComServerFactory.putService(ExecutorBiz.class, <span class="keyword">new</span> ExecutorBizImpl()); Â  <span class="comment">// rpc-service, base on jetty</span></span><br><span class="line">Â  Â  NetComServerFactory.setAccessToken(accessToken);</span><br><span class="line">Â  Â  serverFactory.start(port, ip, appName); <span class="comment">// jetty + registry</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹æ± "><a href="#ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹æ± " class="headerlink" title="ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹æ± "></a>ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹æ± </h3><p>å¹¶æ²¡æœ‰ç”¨çº¿ç¨‹æ± ï¼Œè€Œæ˜¯ä¸€ä¸ªå¹¶å‘å“ˆå¸Œè¡¨ã€‚è¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼Œå¦‚æœå¹¶å‘çº¿ç¨‹é‡è¿‡å¤§æ˜¯ä¸æ˜¯æœ‰å®‰å…¨é—®é¢˜ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer, JobThread&gt; JobThreadRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, JobThread&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobThread <span class="title">registJobThread</span><span class="params">(<span class="keyword">int</span> jobId, IJobHandler handler, String removeOldReason)</span></span>&#123;</span><br><span class="line">Â  Â  JobThread newJobThread = <span class="keyword">new</span> JobThread(jobId, handler);</span><br><span class="line">Â  Â  newJobThread.start();</span><br><span class="line">Â  Â  logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job regist JobThread success, jobId:&#123;&#125;, handler:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;jobId, handler&#125;);</span><br><span class="line"></span><br><span class="line">Â  Â  JobThread oldJobThread = JobThreadRepository.put(jobId, newJobThread); Â <span class="comment">// putIfAbsent | oh my god, map&#x27;s put method return the old value!!!</span></span><br><span class="line">Â  Â  <span class="keyword">if</span> (oldJobThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  oldJobThread.toStop(removeOldReason);</span><br><span class="line">Â  Â  Â  Â  oldJobThread.interrupt();</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">return</span> newJobThread;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeJobThread</span><span class="params">(<span class="keyword">int</span> jobId, String removeOldReason)</span></span>&#123;</span><br><span class="line">Â  Â  JobThread oldJobThread = JobThreadRepository.remove(jobId);</span><br><span class="line">Â  Â  <span class="keyword">if</span> (oldJobThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  oldJobThread.toStop(removeOldReason);</span><br><span class="line">Â  Â  Â  Â  oldJobThread.interrupt();</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobThread <span class="title">loadJobThread</span><span class="params">(<span class="keyword">int</span> jobId)</span></span>&#123;</span><br><span class="line">Â  Â  JobThread jobThread = JobThreadRepository.get(jobId);</span><br><span class="line">Â  Â  <span class="keyword">return</span> jobThread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="WebæœåŠ¡å™¨"><a href="#WebæœåŠ¡å™¨" class="headerlink" title="WebæœåŠ¡å™¨"></a>WebæœåŠ¡å™¨</h2><p>è¯¥æœåŠ¡å™¨ç”¨äºè·å–è¯·æ±‚ã€æ‰§è¡Œä»»åŠ¡ï¼Œæ˜¯æ ¸å¿ƒçš„æ‰§è¡Œé€»è¾‘ã€‚</p><p>ä¸»ä½“æ˜¯å°è£…äº†ä¸€ä¸ªjettyæœåŠ¡å™¨ï¼ˆservletå®¹å™¨ï¼ŒHTTPåè®®ï¼‰ï¼Œåˆ©ç”¨åå°„å®ç°æœåŠ¡è°ƒç”¨ã€‚</p><p>ç›¸å…³ç±»å¦‚ä¸‹ï¼š</p><ul><li>NetComServerFactoryï¼šRPCæœåŠ¡å™¨å·¥å‚ç±»ï¼ŒåŒæ—¶è´Ÿè´£ç»´æŠ¤RPCæœåŠ¡ã€‚</li><li>JettyServerï¼šæ ¸å¿ƒç±»ï¼ŒçœŸæ­£è¿è¡Œçš„æœåŠ¡å™¨ã€‚</li><li>JettyServerHandlerï¼šjettyçš„handlerï¼Œè´Ÿè´£æ‰§è¡Œä»»åŠ¡ã€‚</li><li>ExecutorBizï¼šåŒ…å«RPCæ–¹æ³•çš„æ¥å£ï¼Œè¢«å·¥å‚ç±»åŠ è½½å¹¶æ‰§è¡Œè¯·æ±‚è°ƒç”¨çš„RPCæ–¹æ³•ã€‚</li><li>ExecutorBizImplï¼šçœŸæ­£æä¾›æœåŠ¡çš„ç±»ï¼Œå®ç°äº†ExecutorBizæ¥å£ã€‚</li><li>JobThreadï¼šçœŸæ­£æ‰§è¡Œä»»åŠ¡ï¼ˆå®ŒæˆJobï¼‰çš„çº¿ç¨‹ï¼Œç»´æŠ¤ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ç”¨äºæ‰§è¡Œä»»åŠ¡ã€‚</li><li>ExecutorRegistryThreadï¼šç”¨äºå°†æœåŠ¡å™¨æ³¨å†Œåˆ°å®¢æˆ·ç«¯ä¸Šï¼Œæˆ–å–æ¶ˆæ³¨å†Œã€‚</li><li>TriggerCallbackThreadï¼šç»´æŠ¤ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œç”¨äºå¯¹ä»»åŠ¡æ‰§è¡Œç»“æœå®æ–½callbackã€‚</li></ul><h3 id="NetComServerFactory"><a href="#NetComServerFactory" class="headerlink" title="NetComServerFactory"></a>NetComServerFactory</h3><p>å…¥å£ä¸­åˆå§‹åŒ–çš„å°±æ˜¯è¿™ä¸ªServerå·¥å‚ï¼Œå·¥å‚é‡Œé¢å†…å®¹å¾ˆç®€å•ï¼Œç®€åŒ–åå¦‚ä¸‹:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡å™¨ï¼Œæ ¸å¿ƒç±»</span></span><br><span class="line">JettyServer server = <span class="keyword">new</span> JettyServer(); <span class="comment">//æœ‰start(), destroy()ä¸¤ä¸ªæ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RPCæœåŠ¡å­˜å‚¨ï¼Œé€šè¿‡åå°„åŠ è½½è¿›æ¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Object&gt; serviceMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"><span class="comment">// è®¤è¯tokenï¼Œæºå¸¦æ­£ç¡®tokençš„è¯·æ±‚æ‰èƒ½è¢«æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String accessToken;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸­æ”¾å…¥ExecutorBizçš„æ–¹æ³•ï¼ŒKeyæ˜¯æ¥å£å</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putService</span><span class="params">(Class&lt;?&gt; iface, Object serviceBean)</span></span>&#123;</span><br><span class="line">Â  Â  serviceMap.put(iface.getName(), serviceBean);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸­è®¾ç½®tokençš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAccessToken</span><span class="params">(String accessToken)</span> </span>&#123;</span><br><span class="line">Â  Â  NetComServerFactory.accessToken = accessToken;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çœŸæ­£å®ç°RPCæœåŠ¡è°ƒç”¨çš„é™æ€æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RpcResponse <span class="title">invokeService</span><span class="params">(RpcRequest request, Object serviceBean)</span> </span>&#123;</span><br><span class="line">Â  Â  ...</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">try</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Class&lt;?&gt; serviceClass = serviceBean.getClass();</span><br><span class="line">Â  Â  Â  Â  String methodName = request.getMethodName();</span><br><span class="line">Â  Â  Â  Â  Class&lt;?&gt;[] parameterTypes = request.getParameterTypes();</span><br><span class="line">Â  Â  Â  Â  Object[] parameters = request.getParameters();</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  FastClass serviceFastClass = FastClass.create(serviceClass);</span><br><span class="line">Â  Â  Â  Â  FastMethod serviceFastMethod = serviceFastClass.getMethod(methodName, parameterTypes);</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Object result = serviceFastMethod.invoke(serviceBean, parameters);</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  response.setResult(result);</span><br><span class="line">Â  Â  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">Â  Â  Â  Â  t.printStackTrace();</span><br><span class="line">Â  Â  Â  Â  response.setError(t.getMessage());</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="JettyServer"><a href="#JettyServer" class="headerlink" title="JettyServer"></a>JettyServer</h3><p><code>JettyServer</code>åŒ…å«æœåŠ¡å™¨ï¼ˆéé˜»å¡çº¿ç¨‹æ± ï¼‰ã€æ³¨å†Œçº¿ç¨‹ã€å›è°ƒçº¿ç¨‹ä¸‰éƒ¨åˆ†ã€‚</p><p>ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JettyServer</span> </span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">private</span> Server server;</span><br><span class="line">Â  Â  <span class="keyword">private</span> Thread thread;</span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> port, <span class="keyword">final</span> String ip, <span class="keyword">final</span> String appName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Â  Â  Â  Â  thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="meta">@Override</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// The Server</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  server = <span class="keyword">new</span> Server(<span class="keyword">new</span> ExecutorThreadPool()); Â <span class="comment">// éé˜»å¡</span></span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// HTTP connector</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  ServerConnector connector = <span class="keyword">new</span> ServerConnector(server);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  connector.setHost(ip);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  connector.setPort(port);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  server.setConnectors(<span class="keyword">new</span> Connector[]&#123;connector&#125;);</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// Set a handler</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  HandlerCollection handlerc =<span class="keyword">new</span> HandlerCollection();</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  handlerc.setHandlers(<span class="keyword">new</span> Handler[]&#123;<span class="keyword">new</span> JettyServerHandler()&#125;);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  server.setHandler(handlerc);</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// Start server</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  server.start();</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// Start Registry-Server</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  ExecutorRegistryThread.getInstance().start(port, ip, appName);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// Start Callback-Server</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  TriggerCallbackThread.getInstance().start();</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  server.join(); Â <span class="comment">// block until thread stopped</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  &#125;);</span><br><span class="line">Â  Â  Â  Â  thread.setDaemon(<span class="keyword">true</span>); <span class="comment">// daemon, service jvm, user thread leave &gt;&gt;&gt; daemon leave &gt;&gt;&gt; jvm leave</span></span><br><span class="line">Â  Â  Â  Â  thread.start();</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// destroy Registry-Server</span></span><br><span class="line">Â  Â  Â  Â  ExecutorRegistryThread.getInstance().toStop();</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// destroy Callback-Server</span></span><br><span class="line">Â  Â  Â  Â  TriggerCallbackThread.getInstance().toStop();</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// å…³é—­æœåŠ¡å™¨</span></span><br><span class="line">Â  Â  Â  Â  server.stop();</span><br><span class="line">Â  Â  Â  Â  server.destroy();</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// å…³é—­æ€»çº¿ç¨‹</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> (thread.isAlive()) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  thread.interrupt();</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œçš„<code>ExecutorThreadPool</code>æ˜¯jettyè‡ªå·±å°è£…çš„<code>ThreadPoolExecutor</code>ï¼Œæœ€å¤§çº¿ç¨‹æ± å¤§å°ä¸º256, çº¿ç¨‹timeoutä¸º1åˆ†é’Ÿï¼Œå¹¶ä½¿ç”¨äº†<code>Unbounded LinkedBlockingQueue</code>ä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutorThreadPool</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Â  Â  <span class="comment">// Using an unbounded queue makes the maxThreads parameter useless</span></span><br><span class="line">Â  Â  <span class="comment">// Refer to ThreadPoolExecutor javadocs for details</span></span><br><span class="line">Â  Â  <span class="keyword">this</span>(<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">256</span>, <span class="number">256</span>, <span class="number">60</span>, TimeUnit.SECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JettyServerHandler"><a href="#JettyServerHandler" class="headerlink" title="JettyServerHandler"></a>JettyServerHandler</h3><p>è¿™ä¸ªç±»å°±æ˜¯ç”¨æ¥è¡”æ¥jettyæ¥åˆ°çš„è¯·æ±‚å’Œå®é™…å¤„ç†æ–¹æ³•<code>NetComServerFactory#invokeService</code>çš„ï¼Œå¯¹å…¥å‚å‡ºå‚å’Œå¼‚å¸¸è¿›è¡Œä¸€äº›å¤„ç†ã€‚</p><p>ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JettyServerHandler</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span> </span>&#123;</span><br><span class="line">Â  Â  <span class="meta">@Override</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// invoke</span></span><br><span class="line">Â  Â  Â  Â  RpcResponse rpcResponse = doInvoke(request);</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// serialize response</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">byte</span>[] responseBytes = HessianSerializer.serialize(rpcResponse);</span><br><span class="line">Â  Â  Â  Â  </span><br><span class="line">Â  Â  Â  Â  response.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  response.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">Â  Â  Â  Â  baseRequest.setHandled(<span class="keyword">true</span>);</span><br><span class="line">Â  Â  Â  Â  </span><br><span class="line">Â  Â  Â  Â  OutputStream out = response.getOutputStream();</span><br><span class="line">Â  Â  Â  Â  out.write(responseBytes);</span><br><span class="line">Â  Â  Â  Â  out.flush();</span><br><span class="line">Â  Â  Â  Â  </span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">private</span> RpcResponse <span class="title">doInvoke</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">try</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="comment">// deserialize request</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">byte</span>[] requestBytes = HttpClientUtil.readBytes(request);</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (requestBytes == <span class="keyword">null</span> || requestBytes.length==<span class="number">0</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  RpcResponse rpcResponse = <span class="keyword">new</span> RpcResponse();</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  rpcResponse.setError(<span class="string">&quot;RpcRequest byte[] is null&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">return</span> rpcResponse;</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  Â  Â  RpcRequest rpcRequest = (RpcRequest) HessianSerializer.deserialize(requestBytes, RpcRequest.class);</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="comment">// invoke</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  RpcResponse rpcResponse = NetComServerFactory.invokeService(rpcRequest, <span class="keyword">null</span>);</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">return</span> rpcResponse;</span><br><span class="line">Â  Â  Â  Â  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  RpcResponse rpcResponse = <span class="keyword">new</span> RpcResponse();</span><br><span class="line">Â  Â  Â  Â  Â  Â  rpcResponse.setError(<span class="string">&quot;Server-error:&quot;</span> + e.getMessage());</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">return</span> rpcResponse;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="ExecutorBizImpl"><a href="#ExecutorBizImpl" class="headerlink" title="ExecutorBizImpl"></a>ExecutorBizImpl</h3><p>çœŸæ­£æ‰§è¡Œä»»åŠ¡çš„ç±»ï¼Œå®ç°äº†<code>ExecutorBiz</code>æ¥å£ã€‚</p><p><code>ExecutorBiz</code>æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecutorBiz</span> </span>&#123;</span><br><span class="line">Â  Â  <span class="comment">// å¿ƒè·³ï¼Œç”¨äºç¡®è®¤æœåŠ¡å™¨çŠ¶æ€</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">beat</span><span class="params">()</span></span>;</span><br><span class="line">Â  Â  <span class="comment">// åˆ¤æ–­ä»»åŠ¡æ˜¯å¦åœ¨æ‰§è¡Œ</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">idleBeat</span><span class="params">(<span class="keyword">int</span> jobId)</span></span>;</span><br><span class="line">Â  Â  <span class="comment">// ç»ˆæ­¢ä»»åŠ¡</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">kill</span><span class="params">(<span class="keyword">int</span> jobId)</span></span>;</span><br><span class="line">Â  Â  <span class="comment">// è¯»æ—¥å¿—ï¼Œè¿”å›æ—¥å¿—å†…å®¹</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> ReturnT&lt;LogResult&gt; <span class="title">log</span><span class="params">(<span class="keyword">long</span> logDateTim, <span class="keyword">int</span> logId, <span class="keyword">int</span> fromLineNum)</span></span>;</span><br><span class="line">Â  Â  <span class="comment">// æ ¹æ®å‚æ•°æ‰§è¡Œä»»åŠ¡ï¼ŒTriggerParamé‡Œæºå¸¦jobId</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">run</span><span class="params">(TriggerParam triggerParam)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>ExecutorBizImpl</code>é€šè¿‡ä¸Šä¸‹æ–‡<code>XxlJobExecutor</code>è·å–èµ„æºï¼ˆä¾‹å¦‚<code>JobThread</code>ï¼‰å®ç°å„ä¸ªåŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³æ³¨<code>run</code>æ–¹æ³•çš„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">run</span><span class="params">(TriggerParam triggerParam)</span> </span>&#123;</span><br><span class="line">Â  Â  <span class="comment">// å°è¯•åŠ è½½å·²æœ‰çº¿ç¨‹ï¼Œæ²¡æœ‰åˆ™éƒ½ç½®ä¸ºç©º</span></span><br><span class="line">Â  Â  <span class="comment">// load oldï¼šjobHandler + jobThread</span></span><br><span class="line">Â  Â  JobThread jobThread = XxlJobExecutor.loadJobThread(triggerParam.getJobId());</span><br><span class="line">Â  Â  IJobHandler jobHandler = jobThread!=<span class="keyword">null</span>?jobThread.getHandler():<span class="keyword">null</span>;</span><br><span class="line">Â  Â  String removeOldReason = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment">// è¿™é‡Œæœ‰å‡ ç§æ‰§è¡Œæ¨¡å¼ï¼Œbeanã€glueå’Œscriptï¼Œé€šå¸¸è‡ªå·±å®ç°çš„æ˜¯ç”¨beanæ¨¡å¼ï¼Œéœ€è¦éªŒè¯ä¸€ä¸‹</span></span><br><span class="line">Â  Â  <span class="comment">// éªŒè¯å¦‚æœåŸæ¥çš„jobHandlerä¸å¯¹ï¼Œé‚£ä¹ˆä¹Ÿè¦ç½®ç©º</span></span><br><span class="line">Â  Â  <span class="comment">// validï¼šjobHandler + jobThread</span></span><br><span class="line">Â  Â  GlueTypeEnum glueTypeEnum = GlueTypeEnum.match(triggerParam.getGlueType());</span><br><span class="line">Â  Â  <span class="keyword">if</span> (GlueTypeEnum.BEAN == glueTypeEnum) &#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// new jobhandler</span></span><br><span class="line">Â  Â  Â  Â  IJobHandler newJobHandler = XxlJobExecutor.loadJobHandler(triggerParam.getExecutorHandler());</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// valid old jobThread</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> (jobThread!=<span class="keyword">null</span> &amp;&amp; jobHandler != newJobHandler) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="comment">// change handler, need kill old thread</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  removeOldReason = <span class="string">&quot;æ›´æ¢JobHandleræˆ–æ›´æ¢ä»»åŠ¡æ¨¡å¼,ç»ˆæ­¢æ—§ä»»åŠ¡çº¿ç¨‹&quot;</span>;</span><br><span class="line">Â  Â  Â  Â  Â  Â  jobThread = <span class="keyword">null</span>;</span><br><span class="line">Â  Â  Â  Â  Â  Â  jobHandler = <span class="keyword">null</span>;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// valid handler</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> (jobHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  jobHandler = newJobHandler;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (jobHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;job handler [&quot;</span> + triggerParam.getExecutorHandler() + <span class="string">&quot;] not found.&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (GlueTypeEnum.GLUE_GROOVY == glueTypeEnum) &#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// valid old jobThread</span></span><br><span class="line">Â  Â  Â  Â  ...</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// valid handler</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> (jobHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">try</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  IJobHandler originJobHandler = GlueFactory.getInstance().loadNewInstance(triggerParam.getGlueSource());</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  jobHandler = <span class="keyword">new</span> GlueJobHandler(originJobHandler, triggerParam.getGlueUpdatetime());</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  logger.error(e.getMessage(), e);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, e.getMessage());</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (glueTypeEnum!=<span class="keyword">null</span> &amp;&amp; glueTypeEnum.isScript()) &#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// valid old jobThread</span></span><br><span class="line">Â  Â  Â  Â  ...</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// valid handler</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> (jobHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  jobHandler = <span class="keyword">new</span> ScriptJobHandler(triggerParam.getJobId(), triggerParam.getGlueUpdatetime(), triggerParam.getGlueSource(), GlueTypeEnum.match(triggerParam.getGlueType()));</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;glueType[&quot;</span> + triggerParam.getGlueType() + <span class="string">&quot;] is not valid.&quot;</span>);</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment">// æ ¹æ®è®¾ç½®çš„é˜»å¡ç­–ç•¥ï¼Œé€‰æ‹©æ˜¯å¦ä¸¢å¼ƒå·²æœ‰çº¿ç¨‹</span></span><br><span class="line">Â  Â  <span class="comment">// executor block strategy</span></span><br><span class="line">Â  Â  <span class="keyword">if</span> (jobThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  ExecutorBlockStrategyEnum blockStrategy = ExecutorBlockStrategyEnum.match(triggerParam.getExecutorBlockStrategy(), <span class="keyword">null</span>);</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> (ExecutorBlockStrategyEnum.DISCARD_LATER == blockStrategy) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="comment">// discard when running</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (jobThread.isRunningOrHasQueue()) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;é˜»å¡å¤„ç†ç­–ç•¥-ç”Ÿæ•ˆï¼š&quot;</span>+ExecutorBlockStrategyEnum.DISCARD_LATER.getTitle());</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ExecutorBlockStrategyEnum.COVER_EARLY == blockStrategy) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="comment">// kill running jobThread</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (jobThread.isRunningOrHasQueue()) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  removeOldReason = <span class="string">&quot;é˜»å¡å¤„ç†ç­–ç•¥-ç”Ÿæ•ˆï¼š&quot;</span> + ExecutorBlockStrategyEnum.COVER_EARLY.getTitle();</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  jobThread = <span class="keyword">null</span>;</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="comment">// just queue trigger</span></span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">Â  Â  <span class="comment">// æ³¨å†Œæ–°çš„ä»»åŠ¡çº¿ç¨‹å¹¶æ·»åŠ ä»»åŠ¡</span></span><br><span class="line">Â  Â  <span class="comment">// replace thread (new or exists invalid)</span></span><br><span class="line">Â  Â  <span class="keyword">if</span> (jobThread == <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  jobThread = XxlJobExecutor.registJobThread(triggerParam.getJobId(), jobHandler, removeOldReason);</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">Â  Â  <span class="comment">// push data to queue</span></span><br><span class="line">Â  Â  ReturnT&lt;String&gt; pushResult = jobThread.pushTriggerQueue(triggerParam);</span><br><span class="line">Â  Â  <span class="keyword">return</span> pushResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JobThread"><a href="#JobThread" class="headerlink" title="JobThread"></a>JobThread</h3><p>è¿™æ˜¯æœ€ç»ˆæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œé€šè¿‡å‰é¢çš„åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œä¸€é¡¹ä»»åŠ¡è¢«æœ€ç»ˆäº¤ä»˜ç»™äº†TriggerQueueï¼Œå¹¶ç­‰å¾…å®Œæˆæ‰§è¡Œå›è°ƒå®ç°å¼‚æ­¥æ‰§è¡Œã€‚</p><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯TriggerQueueï¼Ÿå®ƒæ˜¯ä¸€ä¸ªå­˜æ”¾Triggerå‚æ•°çš„<code>LinkedBlockingQueue</code>é˜»å¡é˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p><p><code>JobThread</code>ä¼šæŒ‰æŒ‡å®šçš„æ—¶é—´é—´éš”è½®è¯¢è¯¥é˜Ÿåˆ—ï¼Œå°è¯•å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚ä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œå°†ç»“æœäº¤ç»™Callbackçº¿ç¨‹æ‰§è¡Œå›è°ƒã€‚</p><p>è¿˜æœ‰ä¸€äº›å…¶ä»–ç»†èŠ‚ï¼Œä¾‹å¦‚å”¯ä¸€æ—¥å¿—IDçš„ç»´æŠ¤ï¼ˆé€šè¿‡Setï¼‰ï¼Œç»ˆæ­¢ä»»åŠ¡çš„å®ç°ï¼ˆå¤šç§æƒ…å†µï¼‰ï¼Œå¯ä»¥å‚è€ƒä»£ç åˆ†æã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(JobThread.class);</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">private</span> <span class="keyword">int</span> jobId;</span><br><span class="line">Â  Â  <span class="keyword">private</span> IJobHandler handler;</span><br><span class="line">Â  Â  <span class="keyword">private</span> LinkedBlockingQueue&lt;TriggerParam&gt; triggerQueue;</span><br><span class="line">Â  Â  <span class="keyword">private</span> ConcurrentHashSet&lt;Integer&gt; triggerLogIdSet; Â  Â  <span class="comment">// avoid repeat trigger for the same TRIGGER_LOG_ID</span></span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">private</span> <span class="keyword">boolean</span> toStop = <span class="keyword">false</span>;</span><br><span class="line">Â  Â  <span class="keyword">private</span> String stopReason;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="keyword">private</span> <span class="keyword">boolean</span> running = <span class="keyword">false</span>; Â  Â <span class="comment">// if running job</span></span><br><span class="line">Â  Â  <span class="keyword">private</span> <span class="keyword">int</span> idleTimes = <span class="number">0</span>; Â  Â  Â  Â  Â <span class="comment">// idel times</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="title">JobThread</span><span class="params">(<span class="keyword">int</span> jobId, IJobHandler handler)</span> </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">this</span>.jobId = jobId;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">this</span>.handler = handler;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">this</span>.triggerQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;TriggerParam&gt;();</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">this</span>.triggerLogIdSet = <span class="keyword">new</span> ConcurrentHashSet&lt;Integer&gt;();</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> IJobHandler <span class="title">getHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> handler;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment">/**</span></span><br><span class="line"><span class="comment">Â  Â  Â * new trigger to queue</span></span><br><span class="line"><span class="comment">Â  Â  Â *</span></span><br><span class="line"><span class="comment">Â  Â  Â * <span class="doctag">@param</span> triggerParam</span></span><br><span class="line"><span class="comment">Â  Â  Â * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">Â  Â  Â */</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">pushTriggerQueue</span><span class="params">(TriggerParam triggerParam)</span> </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">// avoid repeat</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> (triggerLogIdSet.contains(triggerParam.getLogId())) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; repeate trigger job, logId:&#123;&#125;&quot;</span>, triggerParam.getLogId());</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;repeate trigger job, logId:&quot;</span> + triggerParam.getLogId());</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  triggerLogIdSet.add(triggerParam.getLogId());</span><br><span class="line">Â  Â  Â  Â  triggerQueue.add(triggerParam);</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment">/**</span></span><br><span class="line"><span class="comment">Â  Â  Â * kill job thread</span></span><br><span class="line"><span class="comment">Â  Â  Â *</span></span><br><span class="line"><span class="comment">Â  Â  Â * <span class="doctag">@param</span> stopReason</span></span><br><span class="line"><span class="comment">Â  Â  Â */</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toStop</span><span class="params">(String stopReason)</span> </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="comment">/**</span></span><br><span class="line"><span class="comment">Â  Â  Â  Â  Â * Thread.interruptåªæ”¯æŒç»ˆæ­¢çº¿ç¨‹çš„é˜»å¡çŠ¶æ€(waitã€joinã€sleep)ï¼Œ</span></span><br><span class="line"><span class="comment">Â  Â  Â  Â  Â * åœ¨é˜»å¡å‡ºæŠ›å‡ºInterruptedExceptionå¼‚å¸¸,ä½†æ˜¯å¹¶ä¸ä¼šç»ˆæ­¢è¿è¡Œçš„çº¿ç¨‹æœ¬èº«ï¼›</span></span><br><span class="line"><span class="comment">Â  Â  Â  Â  Â * æ‰€ä»¥éœ€è¦æ³¨æ„ï¼Œæ­¤å¤„å½»åº•é”€æ¯æœ¬çº¿ç¨‹ï¼Œéœ€è¦é€šè¿‡å…±äº«å˜é‡æ–¹å¼ï¼›</span></span><br><span class="line"><span class="comment">Â  Â  Â  Â  Â */</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">this</span>.toStop = <span class="keyword">true</span>;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">this</span>.stopReason = stopReason;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="comment">/**</span></span><br><span class="line"><span class="comment">Â  Â  Â * is running job</span></span><br><span class="line"><span class="comment">Â  Â  Â * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">Â  Â  Â */</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRunningOrHasQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">return</span> running || triggerQueue.size()&gt;<span class="number">0</span>;</span><br><span class="line">Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  <span class="meta">@Override</span></span><br><span class="line">Â  Â  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  <span class="comment">// init</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">try</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  handler.init();</span><br><span class="line">Â  Â  Â  Â  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  logger.error(e.getMessage(), e);</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  <span class="comment">// execute</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">while</span>(!toStop)&#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  running = <span class="keyword">false</span>;</span><br><span class="line">Â  Â  Â  Â  Â  Â  idleTimes++;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  TriggerParam triggerParam = <span class="keyword">null</span>;</span><br><span class="line">Â  Â  Â  Â  Â  Â  ReturnT&lt;String&gt; executeResult = <span class="keyword">null</span>;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">try</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// to check toStop signal, we need cycle, so wo cannot use queue.take(), instand of poll(timeout)</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  triggerParam = triggerQueue.poll(<span class="number">3L</span>, TimeUnit.SECONDS);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (triggerParam!=<span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  running = <span class="keyword">true</span>;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  idleTimes = <span class="number">0</span>;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  triggerLogIdSet.remove(triggerParam.getLogId());</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// log filename, like &quot;logPath/yyyy-MM-dd/9999.log&quot;</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  String logFileName = XxlJobFileAppender.makeLogFileName(<span class="keyword">new</span> Date(triggerParam.getLogDateTim()), triggerParam.getLogId());</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  XxlJobFileAppender.contextHolder.set(logFileName);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ShardingUtil.setShardingVo(<span class="keyword">new</span> ShardingUtil.ShardingVO(triggerParam.getBroadcastIndex(), triggerParam.getBroadcastTotal()));</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// execute</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  XxlJobLogger.log(<span class="string">&quot;&lt;br&gt;----------- xxl-job job execute start -----------&lt;br&gt;----------- Param:&quot;</span> + triggerParam.getExecutorParams());</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  executeResult = handler.execute(triggerParam.getExecutorParams());</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (executeResult == <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  executeResult = IJobHandler.FAIL;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  XxlJobLogger.log(<span class="string">&quot;&lt;br&gt;----------- xxl-job job execute end(finish) -----------&lt;br&gt;----------- ReturnT:&quot;</span> + executeResult);</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (idleTimes &gt; <span class="number">30</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  XxlJobExecutor.removeJobThread(jobId, <span class="string">&quot;excutor idel times over limit.&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (toStop) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  XxlJobLogger.log(<span class="string">&quot;&lt;br&gt;----------- JobThread toStop, stopReason:&quot;</span> + stopReason);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  StringWriter stringWriter = <span class="keyword">new</span> StringWriter();</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  e.printStackTrace(<span class="keyword">new</span> PrintWriter(stringWriter));</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  String errorMsg = stringWriter.toString();</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  executeResult = <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, errorMsg);</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  XxlJobLogger.log(<span class="string">&quot;&lt;br&gt;----------- JobThread Exception:&quot;</span> + errorMsg + <span class="string">&quot;&lt;br&gt;----------- xxl-job job execute end(error) -----------&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span>(triggerParam != <span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// callback handler info</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// commonm</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  TriggerCallbackThread.pushCallBack(<span class="keyword">new</span> HandleCallbackParam(triggerParam.getLogId(), executeResult));</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// is killed</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ReturnT&lt;String&gt; stopResult = <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, stopReason + <span class="string">&quot; [ä¸šåŠ¡è¿è¡Œä¸­ï¼Œè¢«å¼ºåˆ¶ç»ˆæ­¢]&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  TriggerCallbackThread.pushCallBack(<span class="keyword">new</span> HandleCallbackParam(triggerParam.getLogId(), stopResult));</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  <span class="comment">// callback trigger request in queue</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">while</span>(triggerQueue !=<span class="keyword">null</span> &amp;&amp; triggerQueue.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  TriggerParam triggerParam = triggerQueue.poll();</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (triggerParam!=<span class="keyword">null</span>) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">// is killed</span></span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  ReturnT&lt;String&gt; stopResult = <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, stopReason + <span class="string">&quot; [ä»»åŠ¡å°šæœªæ‰§è¡Œï¼Œåœ¨è°ƒåº¦é˜Ÿåˆ—ä¸­è¢«ç»ˆæ­¢]&quot;</span>);</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  TriggerCallbackThread.pushCallBack(<span class="keyword">new</span> HandleCallbackParam(triggerParam.getLogId(), stopResult));</span><br><span class="line">Â  Â  Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  <span class="comment">// destroy</span></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">try</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  handler.destroy();</span><br><span class="line">Â  Â  Â  Â  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  logger.error(e.getMessage(), e);</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job JobThread stoped, hashCode:&#123;&#125;&quot;</span>, Thread.currentThread());</span><br><span class="line">Â  Â  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="TriggerCallbackThread"><a href="#TriggerCallbackThread" class="headerlink" title="TriggerCallbackThread"></a>TriggerCallbackThread</h3><p>å›è°ƒçº¿ç¨‹ï¼Œç”¨äºå¤„ç†æ‰§è¡Œå®Œçš„ä»»åŠ¡ç»“æœï¼Œé€šçŸ¥è°ƒåº¦ä¸­å¿ƒæ‰§è¡Œå®Œæ¯•ã€‚</p><p>åŒæ ·çš„ï¼Œä½¿ç”¨ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—å­˜æ”¾å¾…å›è°ƒçš„æ‰§è¡Œç»“æœã€‚</p><p>ä»£ç ç®€åŒ–åå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TriggerCallbackThread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TriggerCallbackThread instance = <span class="keyword">new</span> TriggerCallbackThread();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TriggerCallbackThread <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// job results callback queue</span></span><br><span class="line">    <span class="keyword">private</span> LinkedBlockingQueue&lt;HandleCallbackParam&gt; callBackQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;HandleCallbackParam&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pushCallBack</span><span class="params">(HandleCallbackParam callback)</span></span>&#123;</span><br><span class="line">        getInstance().callBackQueue.add(callback);</span><br><span class="line">        logger.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, push callback request, logId:&#123;&#125;&quot;</span>, callback.getLogId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// callback thread</span></span><br><span class="line">    <span class="keyword">private</span> Thread triggerCallbackThread;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> toStop = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        triggerCallbackThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// normal callback</span></span><br><span class="line">                <span class="keyword">while</span>(!toStop)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        HandleCallbackParam callback = getInstance().callBackQueue.take();</span><br><span class="line">                        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// callback list param</span></span><br><span class="line">                            List&lt;HandleCallbackParam&gt; callbackParamList = <span class="keyword">new</span> ArrayList&lt;HandleCallbackParam&gt;();</span><br><span class="line">                            <span class="keyword">int</span> drainToNum = getInstance().callBackQueue.drainTo(callbackParamList);</span><br><span class="line">                            callbackParamList.add(callback);</span><br><span class="line">                            <span class="comment">// callback, will retry if error</span></span><br><span class="line">                            <span class="keyword">if</span> (callbackParamList!=<span class="keyword">null</span> &amp;&amp; callbackParamList.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                                doCallback(callbackParamList);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        logger.error(e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// last callback</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    List&lt;HandleCallbackParam&gt; callbackParamList = <span class="keyword">new</span> ArrayList&lt;HandleCallbackParam&gt;();</span><br><span class="line">                    <span class="keyword">int</span> drainToNum = getInstance().callBackQueue.drainTo(callbackParamList);</span><br><span class="line">                    <span class="keyword">if</span> (callbackParamList!=<span class="keyword">null</span> &amp;&amp; callbackParamList.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                        doCallback(callbackParamList);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    logger.error(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        triggerCallbackThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        triggerCallbackThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toStop</span><span class="params">()</span></span>&#123;</span><br><span class="line">        toStop = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// interrupt and wait</span></span><br><span class="line">        triggerCallbackThread.interrupt();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            triggerCallbackThread.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do callback, will retry if error</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doCallback</span><span class="params">(List&lt;HandleCallbackParam&gt; callbackParamList)</span></span>&#123;</span><br><span class="line">        <span class="comment">// callback, will retry if error</span></span><br><span class="line">        <span class="keyword">for</span> (AdminBiz adminBiz: XxlJobExecutor.getAdminBizList()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ReturnT&lt;String&gt; callbackResult = adminBiz.callback(callbackParamList);</span><br><span class="line">                <span class="keyword">if</span> (callbackResult!=<span class="keyword">null</span> &amp;&amp; ReturnT.SUCCESS_CODE == callbackResult.getCode()) &#123;</span><br><span class="line">                    callbackResult = ReturnT.SUCCESS;</span><br><span class="line">                    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job callback success, callbackParamList:&#123;&#125;, callbackResult:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;callbackParamList, callbackResult&#125;);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job callback fail, callbackParamList:&#123;&#125;, callbackResult:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;callbackParamList, callbackResult&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job callback error, callbackParamListï¼š&#123;&#125;&quot;</span>, callbackParamList, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>æ€»ç»“ä¸€ä¸‹ï¼Œä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆrunè¯·æ±‚ï¼‰ä»è°ƒåº¦ä¸­å¿ƒå‡ºå‘åˆ°æ‰§è¡Œå®Œæ¯•çš„é“¾è·¯ä¸ºï¼š<br><code>JettyServer</code>-&gt;<br>    <code>JettyServerHandler</code>-&gt;<br>        <code>NetComServerFactory#invokeService</code>-&gt;<br>            <code>ExecutorBizImpl#run</code>-&gt;<br>                    <code>JobThread</code>-&gt;<br>                        <code>TriggerCallbackThread</code>-&gt;<br>                            <code>AdminBiz#callback</code></p><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;xxl-jobæºç é˜…è¯»ç¬¬ä¸€ç« ï¼šå®šæ—¶ä»»åŠ¡æ‰§è¡Œé“¾è·¯åˆ†æ&lt;/p&gt;
&lt;p&gt;ä¸€æ—¶å…´èµ·ï¼ŒèŠ±ä¸€ä¸‹åˆçœ‹äº†ä¸€éè¿™éƒ¨åˆ†æºç ï¼Œå†™çš„ä¸é”™ã€‚&lt;/p&gt;
&lt;p&gt;PSï¼šå†™å®Œæ‰å‘ç°æœ‰å®˜æ–¹æ–‡æ¡£è®²è§£â€¦å°´å°¬ğŸ˜…&lt;br&gt;</summary>
    
    
    
    
    <category term="Java" scheme="http://silencezheng.top/tags/Java/"/>
    
    <category term="æºç é˜…è¯»" scheme="http://silencezheng.top/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    
    <category term="xxl-job" scheme="http://silencezheng.top/tags/xxl-job/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨è®° EP3</title>
    <link href="http://silencezheng.top/2024/08/18/article134/"/>
    <id>http://silencezheng.top/2024/08/18/article134/</id>
    <published>2024-08-18T15:32:17.000Z</published>
    <updated>2024-08-18T15:33:52.391Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™å‘¨åŒå‘¨èµ›å’Œå‘¨èµ›éƒ½æ²¡æ‰“ï¼Œä¹‹å‰ä¸¤å‘¨ç§¯ç´¯çš„é—®é¢˜æœ‰äº›å¤šäº†ï¼Œå…ˆåªå¤„ç†æ¯æ—¥ä¸€é¢˜å§ã€‚</p><p>æœ¬å‘¨ä¸»é¢˜ï¼šåŠ¨æ€è§„åˆ’ã€è´ªå¿ƒ</p><p>é¢˜ç›®ï¼š</p><ul><li>240619æ¯æ—¥ä¸€é¢˜â€”<a href="https://leetcode.cn/problems/maximum-strictly-increasing-cells-in-a-matrix/description">Maximum Strictly Increasing Cells in a Matrix</a></li><li>240622æ¯æ—¥ä¸€é¢˜â€”<a href="https://leetcode.cn/problems/lexicographically-smallest-beautiful-string/">Lexicographically Smallest Beautiful String</a><span id="more"></span>è¿™ä¸¤é“Hardé¢˜ç¨å¾®çœ‹çœ‹ç†è§£ä¸€ä¸‹å°±è¡Œäº†ï¼Œæš‚æ—¶æ²¡å¤ªå¤šå¯å½’çº³çš„ï¼Œå¯è®°å¿†çš„ç‚¹å°±æ˜¯äºŒç»´æ’åºå’Œå›æ–‡åˆ¤åˆ«ï¼ˆåªè¦ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­çš„ä»»ä½•å­—ç¬¦ï¼Œéƒ½ä¸ä¸å®ƒå‰ä¸¤ä¸ªå­—ç¬¦ç›¸åŒï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å°±ä¸åŒ…å«ä»»ä½•é•¿åº¦ä¸º 2 æˆ–è€…æ›´é•¿çš„å›æ–‡å­—ç¬¦ä¸²ï¼‰ã€‚</li></ul><h1 id="åŠ¨æ€è§„åˆ’-â€”-Maximum-Strictly-Increasing-Cells-in-a-Matrix"><a href="#åŠ¨æ€è§„åˆ’-â€”-Maximum-Strictly-Increasing-Cells-in-a-Matrix" class="headerlink" title="åŠ¨æ€è§„åˆ’ â€” Maximum Strictly Increasing Cells in a Matrix"></a>åŠ¨æ€è§„åˆ’ â€” Maximum Strictly Increasing Cells in a Matrix</h1><blockquote><p>Maximum Strictly Increasing Cells in a Matrix</p><p>Given a 1-indexed m x n integer matrix mat, you can select any cell in the matrix as your starting cell.</p><p>From the starting cell, you can move to any other cell in the same row or column, but only if the value of the destination cell is strictly greater than the value of the current cell. You can repeat this process as many times as possible, moving from cell to cell until you can no longer make any moves.</p><p>Your task is to find the maximum number of cells that you can visit in the matrix by starting from some cell.</p><p>Return an integer denoting the maximum number of cells that can be visited.</p></blockquote><p>è®¾ <strong>$d[i][j]$ ä¸ºç§»åŠ¨åˆ°å•å…ƒæ ¼ $(i, j)$ çš„æœ€å¤§æ­¥æ•°</strong>, å…¶ä¸­ $(i, j)$ å¯ä»¥ä½œä¸ºèµ·å§‹å•å…ƒæ ¼, ä¹Ÿå¯ä»¥æ˜¯ä»å…¶ä»–å•å…ƒæ ¼ç§»åŠ¨è€Œæ¥ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¼šè€ƒè™‘ä»ç¬¬ $i$ è¡Œä»¥åŠç¬¬ $j$ åˆ—ä¸ŠçŸ©é˜µæ•°å€¼å°äº $\operatorname{mat}[i][j]$ çš„ä½ç½®è¿›è¡Œè½¬ç§», å³å–ä»¥ä¸‹æ•°å€¼ä¸­çš„æœ€å¤§å€¼:</p><ul><li>ç¬¬ $i$ è¡Œï¼š $\max \left(d[i]\left[j^{\prime}\right]+1\right)$ ï¼Œå…¶ä¸­ $\operatorname{mat}[i]\left[j^{\prime}\right]&lt;\operatorname{mat}[i][j]$ ï¼›</li><li>ç¬¬ $j$ åˆ—ï¼š $\max \left(d\left[l^{\prime}\right][j]+1\right)$ ï¼Œå…¶ä¸­ $\operatorname{mat}\left[i^{\prime}\right][j]&lt;\operatorname{mat}[[][j]$ ã€‚</li></ul><p>å› æ­¤, æ•´ä¸ªçŠ¶æ€ç©ºé—´åœ¨è¿›è¡Œè½¬ç§»æ—¶æ˜¯æœ‰åºçš„, æˆ‘ä»¬å¯ä»¥å¯¹ mat è¿›è¡Œæ’åº, ä»å°åˆ°å¤§è¿›è¡Œè½¬ç§»ã€‚ä½†åœ¨è½¬ç§»æ—¶, æ¯ä¸ªçŠ¶æ€éƒ½è¦æ‰«æä¸€éå¯¹åº”çš„è¡Œå’Œåˆ—, æ—¶é—´å¤æ‚åº¦ä¸º $O(n+m)$, è€Œæ•´ä½“æ±‚è§£çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(n m(n+m))$, å¯èƒ½ä¼šè¶…æ—¶, å› æ­¤éœ€è¦è¿›è¡Œä¼˜åŒ–ã€‚</p><p>è€ƒè™‘åˆ°æ‰€æœ‰çš„ $d[i][j]$ åœ¨æ›´æ–°æ—¶, å€¼åªä¼šè¶Šæ¥è¶Šå¤§, è€Œè½¬ç§»è¿‡ç¨‹ä¸­æˆ‘ä»¬åªè€ƒè™‘å¯¹åº”è¡Œå’Œå¯¹åº”åˆ—ä¸Š $d$ çš„æœ€å¤§å€¼ï¼ˆç”±äºå¤§äº mat $[i][j]$ çš„ä½ç½®è¿˜æœ«éå†åˆ°, å®ƒä»¬çš„çŠ¶æ€è¿˜æœ«æ›´æ–°, å¯è®¾ç½®ä¸º 0 )ã€‚å› æ­¤, è®¾ç½®é•¿åº¦ä¸º $m$ çš„æ•°ç»„ row æ¥ç»´æŠ¤æ¯ä¸€è¡Œ $d$ çš„æœ€å¤§å€¼, è®¾ç½®é•¿åº¦ä¸º $n$ çš„æ•°ç»„ $c o l$ æ¥ç»´æŠ¤æ¯ä¸€åˆ—çš„æœ€å¤§å€¼ï¼Œè¿™æ ·ä¸€æ¥:</p><script type="math/tex; mode=display">d[i][j]=\max (\operatorname{row}[i], \operatorname{col}[j])+1</script><p>åœ¨æ¯æ¬¡æ›´æ–°äº† $d[i][j]$ å, éœ€è¦æ›´æ–° $r o w[i]$ å’Œ $col[j]$ ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯, ç”±äº mat ä¸­å¯èƒ½åŒ…å«ç›¸åŒæ•°å­—, æˆ‘ä»¬éœ€è¦åŒæ—¶æ›´æ–°å®ƒä»¬çš„ $d$ å€¼, ç„¶åå†åŒæ—¶æ›´æ–°å®ƒä»¬å¯¹åº”çš„ row å’Œ colã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxIncreasingCells</span><span class="params">(<span class="keyword">int</span>[][] mat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> m = mat.length, n = mat[<span class="number">0</span>].length;</span><br><span class="line">        Map&lt;Integer, List&lt;<span class="keyword">int</span>[]&gt;&gt; mp = <span class="keyword">new</span> HashMap&lt;Integer, List&lt;<span class="keyword">int</span>[]&gt;&gt;();</span><br><span class="line">        <span class="keyword">int</span>[] row = <span class="keyword">new</span> <span class="keyword">int</span>[m];</span><br><span class="line">        <span class="keyword">int</span>[] col = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">                mp.putIfAbsent(mat[i][j], <span class="keyword">new</span> ArrayList&lt;<span class="keyword">int</span>[]&gt;());</span><br><span class="line">                mp.get(mat[i][j]).add(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;i, j&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Integer&gt; keys = <span class="keyword">new</span> ArrayList&lt;Integer&gt;(mp.keySet());</span><br><span class="line">        Collections.sort(keys);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> key : keys) &#123;</span><br><span class="line">            List&lt;<span class="keyword">int</span>[]&gt; pos = mp.get(key);</span><br><span class="line">            List&lt;Integer&gt; res = <span class="keyword">new</span> ArrayList&lt;Integer&gt;(); <span class="comment">// å­˜æ”¾ç›¸åŒæ•°å€¼çš„ç­”æ¡ˆï¼Œä¾¿äºåç»­æ›´æ–° row å’Œ col</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span>[] arr : pos) &#123;</span><br><span class="line">                res.add(Math.max(row[arr[<span class="number">0</span>]], col[arr[<span class="number">1</span>]]) + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pos.size(); i++) &#123;</span><br><span class="line">                <span class="keyword">int</span>[] arr = pos.get(i);</span><br><span class="line">                <span class="keyword">int</span> d = res.get(i);</span><br><span class="line">                row[arr[<span class="number">0</span>]] = Math.max(row[arr[<span class="number">0</span>]], d);</span><br><span class="line">                col[arr[<span class="number">1</span>]] = Math.max(col[arr[<span class="number">1</span>]], d);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(row).max().getAsInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="è´ªå¿ƒ-â€”-Lexicographically-Smallest-Beautiful-String"><a href="#è´ªå¿ƒ-â€”-Lexicographically-Smallest-Beautiful-String" class="headerlink" title="è´ªå¿ƒ â€” Lexicographically Smallest Beautiful String"></a>è´ªå¿ƒ â€” Lexicographically Smallest Beautiful String</h1><blockquote><p>Lexicographically Smallest Beautiful String</p><p>A string is beautiful if:</p><ul><li>It consists of the first k letters of the English lowercase alphabet.</li><li>It does not contain any substring of length 2 or more which is a palindrome.</li></ul><p>You are given a beautiful string s of length n and a positive integer k.</p><p>Return the lexicographically smallest string of length n, which is larger than s and is beautiful. If there is no such string, return an empty string.</p><p>A string a is lexicographically larger than a string b (of the same length) if in the first position where a and b differ, a has a character strictly larger than the corresponding character in b.</p><ul><li>For example, â€œabcdâ€ is lexicographically larger than â€œabccâ€ because the first position they differ is at the fourth character, and d is greater than c.</li></ul></blockquote><p>é¦–å…ˆåˆ†æä¸€ä¸‹ç¾ä¸½å­—ç¬¦ä¸²çš„ç¬¬äºŒä¸ªæ¡ä»¶ï¼šä¸åŒ…å«ä»»ä½•é•¿åº¦ä¸º 2 æˆ–è€…æ›´é•¿çš„å›æ–‡å­—ç¬¦ä¸²ã€‚é•¿åº¦ä¸º 2 çš„å›æ–‡å­—ç¬¦ä¸²æ˜¯ä¸¤ä¸ªç›¸åŒå­—ç¬¦æ„æˆçš„å­—ç¬¦ä¸²ã€‚é•¿åº¦ä¸º 3 çš„å›æ–‡å­—ç¬¦ä¸²ä¸­ä¹Ÿæœ‰ä¸¤ä¸ªç›¸åŒå­—ç¬¦ï¼Œä½†ä¸‹æ ‡ä¹‹å·®ä¸º 2ã€‚è€Œä»»ä½•é•¿åº¦ä¸º 2 æˆ–è€…æ›´é•¿çš„å›æ–‡å­—ç¬¦ä¸²ï¼Œéƒ½åŒ…å«ä¸€ä¸ªé•¿åº¦ä¸º 2 æˆ–è€… 3 çš„å›æ–‡å­—ç¬¦ä¸²ã€‚å› æ­¤ï¼Œ<strong>åªè¦ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­çš„ä»»ä½•å­—ç¬¦ï¼Œéƒ½ä¸ä¸å®ƒå‰ä¸¤ä¸ªå­—ç¬¦ç›¸åŒï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å°±ä¸åŒ…å«ä»»ä½•é•¿åº¦ä¸º 2 æˆ–è€…æ›´é•¿çš„å›æ–‡å­—ç¬¦ä¸²</strong>ã€‚</p><p>æ¥ä¸‹æ¥çœ‹å…¶ä»–è¦æ±‚ï¼Œè¿”å›çš„ç¾ä¸½å­—ç¬¦ä¸²éœ€è¦å­—å…¸åºå¤§äº s å¹¶ä¸”å­—å…¸åºæœ€å°ã€‚è´ªå¿ƒçš„æ€è·¯æ˜¯ä¿®æ”¹ s çš„æœ«å°¾å­—ç¬¦ï¼Œä¸€ç‚¹ç‚¹å°†å­—ç¬¦å˜å¤§ï¼Œå¦‚æœåœ¨å˜å¤§çš„åŒæ—¶èƒ½å¤Ÿæ»¡è¶³ç¾ä¸½å­—ç¬¦ä¸²çš„ä¸¤ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ‰¾åˆ°äº†è¦æ±‚çš„ç¾ä¸½å­—ç¬¦ä¸²ã€‚ä¿®æ”¹åçš„å­—ç¬¦ä¸èƒ½ä¸å‰ä¸¤ä¸ªå­—ç¬¦ç›¸åŒï¼Œå› æ­¤æˆ‘ä»¬åœ¨å°†å­—ç¬¦å˜å¤§çš„æ—¶å€™åªéœ€è¦å°†å­—ç¬¦é€æ­¥å˜å¤§ä¸‰æ¬¡ï¼Œå°±èƒ½åˆ¤æ–­å‡ºä¿®æ”¹å½“å‰å­—ç¬¦èƒ½å¦æ»¡è¶³ç¾ä¸½å­—ç¬¦ä¸²çš„æ¡ä»¶ã€‚å¦‚æœä¿®æ”¹æœ«å°¾å­—ç¬¦è¾¾ä¸åˆ°ç¾ä¸½å­—ç¬¦ä¸²çš„æ¡ä»¶ï¼Œåˆ™æˆ‘ä»¬éœ€è¦å°†è¢«ä¿®æ”¹çš„å­—ç¬¦æ”¹ä¸ºå€’æ•°ç¬¬äºŒä¸ªå­—ç¬¦ï¼Œä»ç„¶æŒ‰ç…§ä¹‹å‰çš„æ€è·¯ä¸€ç‚¹ç‚¹å¢å¤§ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ»¡è¶³ç¾ä¸½å­—ç¬¦ä¸²çš„ä¸¤ä¸ªæ¡ä»¶ã€‚æˆ‘ä»¬ä»æœ«å°¾å­—ç¬¦å¼€å§‹ï¼Œå¾€å‰ä¸€ç‚¹ç‚¹åˆ¤æ–­æ˜¯å¦å¯ä»¥ä¿®æ”¹å½“å‰å­—ç¬¦æ¥æ‰¾åˆ°ç›®æ ‡ç¾ä¸½å­—ç¬¦ä¸²ã€‚ä¸€æ—¦æˆ‘ä»¬ç¬¬ä¸€æ¬¡æ‰¾åˆ°äº†åˆé€‚çš„ä¸‹æ ‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥ä¿®æ”¹å­—ç¬¦æ¥è¾¾åˆ°ç›®æ ‡æ¡ä»¶ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¿®æ”¹å¯»æ‰¾åˆ°çš„ä¸‹æ ‡çš„å­—ç¬¦ï¼Œå°†å…¶ä¿®æ”¹ä¸ºæœ€å°çš„æ»¡è¶³ç¾ä¸½å­—ç¬¦ä¸²æ¡ä»¶çš„å­—ç¬¦ã€‚æ¥ä¸‹æ¥éœ€è¦ä¿®æ”¹å®ƒå³è¾¹çš„å­—ç¬¦ã€‚å› ä¸ºä¹‹å‰ä¿®æ”¹çš„å­—ç¬¦å·²ç»èƒ½ä¿è¯è¿”å›çš„å­—ç¬¦ä¸²åœ¨å­—å…¸åºä¸Šå¤§äº sï¼Œæˆ‘ä»¬åªéœ€è¦å°†åç»­çš„å­—ç¬¦ä¿®æ”¹å¾—å°½å¯èƒ½å°å³å¯ï¼Œå› ä¸ºæ¯ä¸ªå­—ç¬¦éœ€è¦ä¸å‰ä¸¤ä¸ªå­—ç¬¦ä¸åŒï¼Œå› æ­¤æ¯ä¸ªå­—ç¬¦åªéœ€è¦éå† <code>â€˜aâ€™âˆ¼â€˜câ€™</code> å³å¯ã€‚å› ä¸º $kâ‰¥ 4$ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ä¿®æ”¹çš„å­—ç¬¦ä¸€å®šéƒ½èƒ½æ»¡è¶³ç¾ä¸½å­—ç¬¦ä¸²çš„æ¡ä»¶ã€‚</p><p>åœ¨ä»£ç å®ç°ä¸Šï¼Œæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªå¾ªç¯ä» $nâˆ’1$ å¼€å§‹ï¼Œå¾€å‰éå†æ¥å¯»æ‰¾ç¬¬ä¸€ä¸ªè¢«ä¿®æ”¹çš„å­—ç¬¦ï¼Œæ‰¾åˆ°ä¹‹åï¼Œå†ç”¨å¦ä¸€ä¸ªå‡½æ•° $generate(s,idx,offset)$ æ¥ç”Ÿæˆä¿®æ”¹åçš„å­—ç¬¦ï¼Œå…¶ä¸­ $idx$ æ˜¯æˆ‘ä»¬æ‰¾åˆ°çš„ä¸‹æ ‡ï¼Œ$offset$ æ˜¯å°†è¿™ä¸ªä¸‹æ ‡çš„å­—ç¬¦å¢å¤§çš„åç§»é‡ã€‚æœ€åè¿”å›ä¿®æ”¹åçš„å­—ç¬¦ï¼Œå¦‚æœæˆ‘ä»¬æœªèƒ½æ‰¾åˆ°ç›®æ ‡ä¸‹æ ‡ï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">smallestBeautifulString</span><span class="params">(String s, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = s.length() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            Set&lt;Character&gt; blockedCharacters = <span class="keyword">new</span> HashSet&lt;Character&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i - j &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    blockedCharacters.add(s.charAt(i - j));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">                <span class="comment">// s.charAt(i) - &#x27;a&#x27; + j éœ€è¦+1æ‰èƒ½ä¸kæ¯”è¾ƒï¼Œå› ä¸ºkä»1è®¡æ•°</span></span><br><span class="line">                <span class="keyword">if</span> (s.charAt(i) - <span class="string">&#x27;a&#x27;</span> + j + <span class="number">1</span> &lt;= k &amp;&amp; !blockedCharacters.contains((<span class="keyword">char</span>) (s.charAt(i) + j))) &#123;</span><br><span class="line">                    <span class="keyword">return</span> generate(s, i, j);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">generate</span><span class="params">(String s, <span class="keyword">int</span> idx, <span class="keyword">int</span> offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[] res = s.toCharArray();</span><br><span class="line">        res[idx] += offset;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = idx + <span class="number">1</span>; i &lt; s.length(); i++) &#123;</span><br><span class="line">            Set&lt;Character&gt; blockedCharacters = <span class="keyword">new</span> HashSet&lt;Character&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i - j &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    blockedCharacters.add(res[i - j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) &#123;</span><br><span class="line">                <span class="comment">// abcé‡Œé¢ä¸€å®šæœ‰ä¸€ä¸ªå¯ç”¨çš„ï¼Œå› ä¸ºblockedCharactersåªæœ‰ä¸¤ä¸ªå­—ç¬¦</span></span><br><span class="line">                <span class="keyword">if</span> (!blockedCharacters.contains((<span class="keyword">char</span>) (<span class="string">&#x27;a&#x27;</span> + j))) &#123;</span><br><span class="line">                    res[i] = (<span class="keyword">char</span>) (<span class="string">&#x27;a&#x27;</span> + j);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] <a href="https://leetcode.cn/problems/maximum-strictly-increasing-cells-in-a-matrix/solutions/2809597/ju-zhen-zhong-yan-ge-di-zeng-de-dan-yuan-ff4v/">https://leetcode.cn/problems/maximum-strictly-increasing-cells-in-a-matrix/solutions/2809597/ju-zhen-zhong-yan-ge-di-zeng-de-dan-yuan-ff4v/</a><br>[2] <a href="https://leetcode.cn/problems/lexicographically-smallest-beautiful-string/solutions/2814311/zi-dian-xu-zui-xiao-de-mei-li-zi-fu-chua-dr81/">https://leetcode.cn/problems/lexicographically-smallest-beautiful-string/solutions/2814311/zi-dian-xu-zui-xiao-de-mei-li-zi-fu-chua-dr81/</a></p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;è¿™å‘¨åŒå‘¨èµ›å’Œå‘¨èµ›éƒ½æ²¡æ‰“ï¼Œä¹‹å‰ä¸¤å‘¨ç§¯ç´¯çš„é—®é¢˜æœ‰äº›å¤šäº†ï¼Œå…ˆåªå¤„ç†æ¯æ—¥ä¸€é¢˜å§ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬å‘¨ä¸»é¢˜ï¼šåŠ¨æ€è§„åˆ’ã€è´ªå¿ƒ&lt;/p&gt;
&lt;p&gt;é¢˜ç›®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;240619æ¯æ—¥ä¸€é¢˜â€”&lt;a href=&quot;https://leetcode.cn/problems/maximum-strictly-increasing-cells-in-a-matrix/description&quot;&gt;Maximum Strictly Increasing Cells in a Matrix&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;240622æ¯æ—¥ä¸€é¢˜â€”&lt;a href=&quot;https://leetcode.cn/problems/lexicographically-smallest-beautiful-string/&quot;&gt;Lexicographically Smallest Beautiful String&lt;/a&gt;</summary>
    
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://silencezheng.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    <category term="LeetCode" scheme="http://silencezheng.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨è®° EP2</title>
    <link href="http://silencezheng.top/2024/08/18/article133/"/>
    <id>http://silencezheng.top/2024/08/18/article133/</id>
    <published>2024-08-18T10:44:02.000Z</published>
    <updated>2024-08-18T10:52:27.748Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™å‘¨å‘¨èµ›èœäº†â€¦èµ¶ç´§è®°ä¸€ä¸‹ã€‚</p><p>æœ¬å‘¨ä¸»é¢˜ï¼šå·®åˆ†æ•°ç»„ã€åŠ¨æ€è§„åˆ’</p><p>é¢˜ç›®ï¼š</p><ul><li>240615æ¯æ—¥ä¸€é¢˜â€”<a href="https://leetcode.cn/problems/maximum-beauty-of-an-array-after-applying-operation/description/">Maximum Beauty of an Array After Applying Operation</a></li><li>240616å‘¨èµ›ç¬¬ä¸‰é¢˜â€”<a href="https://leetcode.cn/problems/maximum-total-damage-with-spell-casting/description/">Maximum Total Damage With Spell Casting</a></li><li>LC198æ‰“å®¶åŠ«èˆâ€”<a href="https://leetcode.cn/problems/house-robber/description/">House Robber</a><span id="more"></span></li></ul><h1 id="å·®åˆ†æ•°ç»„ï¼ˆDifference-Arrayï¼‰"><a href="#å·®åˆ†æ•°ç»„ï¼ˆDifference-Arrayï¼‰" class="headerlink" title="å·®åˆ†æ•°ç»„ï¼ˆDifference Arrayï¼‰"></a>å·®åˆ†æ•°ç»„ï¼ˆDifference Arrayï¼‰</h1><p>ä½œç”¨ï¼šå¼€è¾Ÿä¸€å—ç©ºé—´ç”¨äºå‹ç¼©å¯¹åŸæ•°ç»„ä¸Šè¿ç»­å­æ•°ç»„çš„æ“ä½œã€‚</p><h2 id="å¼•å‡º"><a href="#å¼•å‡º" class="headerlink" title="å¼•å‡º"></a>å¼•å‡º</h2><p>è€ƒè™‘æ•°ç»„ $a=[1,3,3,5,8]$ï¼Œå¯¹å…¶ä¸­çš„ç›¸é‚»å…ƒç´ ä¸¤ä¸¤ä½œå·®ï¼ˆå³è¾¹å‡å·¦è¾¹ï¼‰ï¼Œå¾—åˆ°æ•°ç»„ $[2,0,2,3]$ã€‚ç„¶ååœ¨å¼€å¤´è¡¥ä¸Š $a[0]$ï¼Œå¾—åˆ°å·®åˆ†æ•°ç»„ï¼š$d=[1,2,0,2,3]$</p><p>è¿™æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå¦‚æœä»å·¦åˆ°å³ç´¯åŠ  ddd ä¸­çš„å…ƒç´ ï¼Œæˆ‘ä»¬å°±ã€Œè¿˜åŸã€å›äº† $a$ æ•°ç»„ $[1,3,3,5,8]$ã€‚è¿™ç±»ä¼¼æ±‚å¯¼ä¸ç§¯åˆ†çš„æ¦‚å¿µã€‚</p><p>è¿™åˆæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿç°åœ¨æŠŠè¿ç»­å­æ•°ç»„ $a[1],a[2],a[3]$ éƒ½åŠ ä¸Š $10$ï¼Œå¾—åˆ° $aâ€™=[1,13,13,15,8]$ã€‚å†æ¬¡ä¸¤ä¸¤ä½œå·®ï¼Œå¹¶åœ¨å¼€å¤´è¡¥ä¸Š $aâ€™[0]$ï¼Œå¾—åˆ°å·®åˆ†æ•°ç»„ï¼š$dâ€™=[1,12,0,2,âˆ’7]$</p><p>å¯¹æ¯” $d$ å’Œ $dâ€™$ï¼Œå¯ä»¥å‘ç°åªæœ‰ $d[1]$ å’Œ $d[4]$ å˜åŒ–äº†ï¼Œè¿™æ„å‘³ç€<strong>å¯¹ $a$ ä¸­è¿ç»­å­æ•°ç»„çš„æ“ä½œï¼Œå¯ä»¥è½¬å˜æˆå¯¹å·®åˆ†æ•°ç»„ $d$ ä¸­ä¸¤ä¸ªæ•°çš„æ“ä½œ</strong>ã€‚</p><h2 id="å®šä¹‰å’Œæ€§è´¨"><a href="#å®šä¹‰å’Œæ€§è´¨" class="headerlink" title="å®šä¹‰å’Œæ€§è´¨"></a>å®šä¹‰å’Œæ€§è´¨</h2><p>å¯¹äºæ•°ç»„ $a$ï¼Œå®šä¹‰å…¶å·®åˆ†æ•°ç»„ï¼ˆdifference arrayï¼‰ä¸º</p><script type="math/tex; mode=display">d[i] = \begin{cases} a[0],&i=0\\ a[i]-a[i-1],&i\ge 1 \end{cases}â€‹</script><p>æ€§è´¨ 1ï¼šä»å·¦åˆ°å³ç´¯åŠ  $d$ ä¸­çš„å…ƒç´ ï¼Œå¯ä»¥å¾—åˆ°æ•°ç»„ $a$ã€‚</p><p>æ€§è´¨ 2ï¼šå¦‚ä¸‹ä¸¤ä¸ªæ“ä½œæ˜¯ç­‰ä»·çš„ã€‚</p><ul><li>æŠŠ $a$ çš„å­æ•°ç»„ $a[i],a[i+1],\cdots,a[j]$ éƒ½åŠ ä¸Š $x$ã€‚</li><li>æŠŠ $d[i]$ å¢åŠ  $x$ï¼ŒæŠŠ $d[j+1]$ å‡å°‘ $x$ã€‚</li></ul><p>åˆ©ç”¨æ€§è´¨ 2ï¼Œæˆ‘ä»¬åªéœ€è¦ $O(1)$ çš„æ—¶é—´å°±å¯ä»¥å®Œæˆå¯¹ $a$ çš„å­æ•°ç»„çš„æ“ä½œã€‚æœ€ååˆ©ç”¨æ€§è´¨ 1 ä»å·®åˆ†æ•°ç»„å¤åŸå‡ºæ•°ç»„ $a$ã€‚</p><p>æ³¨ï¼šä¹Ÿå¯ä»¥è¿™æ ·ç†è§£ï¼Œ$d[i]$ è¡¨ç¤ºæŠŠä¸‹æ ‡ $â‰¥i$ çš„æ•°éƒ½åŠ ä¸Š $d[i]$ã€‚</p><h2 id="ä¾‹é¢˜ï¼šMaximum-Beauty-of-an-Array-After-Applying-Operation"><a href="#ä¾‹é¢˜ï¼šMaximum-Beauty-of-an-Array-After-Applying-Operation" class="headerlink" title="ä¾‹é¢˜ï¼šMaximum Beauty of an Array After Applying Operation"></a>ä¾‹é¢˜ï¼šMaximum Beauty of an Array After Applying Operation</h2><blockquote><p><strong>Maximum Beauty of an Array After Applying Operation</strong></p><p>You are given a 0-indexed array nums and a non-negative integer k.</p><p>In one operation, you can do the following:</p><p>Choose an index i that hasnâ€™t been chosen before from the range [0, nums.length - 1].<br>Replace nums[i] with any integer from the range [nums[i] - k, nums[i] + k].<br>The beauty of the array is the length of the longest subsequence consisting of equal elements.</p><p>Return the maximum possible beauty of the array nums after applying the operation any number of times.</p><p>Note that you can apply the operation to each index only once.</p><p>A subsequence of an array is a new array generated from the original array by deleting some elements (possibly none) without changing the order of the remaining elements.</p><p>Constraints:</p><ul><li>1 &lt;= nums.length &lt;= 1e5</li><li>0 &lt;= nums[i], k &lt;= 1e5</li></ul></blockquote><p>è‡ªç„¶æƒ³åˆ°çš„æ€è·¯æ˜¯æŠŠæ¯ä¸ªå…ƒç´ çœ‹ä½œæ˜¯ä¸€ä¸ªå¯æ¢ç©ºé—´ï¼Œå°†æ‰€æœ‰å¯æ¢ç©ºé—´åœ¨ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç©ºé—´ä¸­è¿›è¡Œå åŠ ï¼Œè¢«æœ€å¤šå¯æ¢ç©ºé—´è¦†ç›–åˆ°çš„åœ°æ–¹å³ä¸ºæ‰€æ±‚ç»“æœã€‚æˆ–è€…ï¼ŒæŠŠæ¯ä¸ªå…ƒç´ è€ƒè™‘ä¸ºå¯¹å…¶å¯¹åº”å¯æ¢ç©ºé—´ä¸­çš„æ¯ä¸€ä¸ªä½ç½®æŠ•ä¸€ç¥¨ï¼Œæœ€ç»ˆç¥¨æ•°æœ€å¤šçš„ä½ç½®ä¸ºæ‰€æ±‚ç»“æœã€‚</p><p>ä»æ•°æ®èŒƒå›´ä¸Šåˆ†æï¼ŒåŒºé—´å¤§å°åº”è¯¥ä¸º[-1e5, 2e5]ã€‚å°†åŒºé—´ä¸ºè´Ÿæ•°çš„éƒ¨åˆ†ç”¨<code>offset</code>æ¥è¡¨ç¤ºï¼Œåˆ™å¯ä»¥å†™å‡ºä»¥ä¸‹è§£æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maximumBeauty</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>, n = nums.length;</span><br><span class="line">        <span class="comment">// å¤šå¼€3ä¸ªç©ºé—´ï¼Œä¸ºäº†å­˜0ã€å­˜å·®åˆ†æ•°ç»„ä¸Šé™å’ŒåŒ¹é…ä¸‹æ ‡</span></span><br><span class="line">        <span class="keyword">int</span>[] diffArr = <span class="keyword">new</span> <span class="keyword">int</span>[(<span class="keyword">int</span>)<span class="number">3e5</span>+<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">int</span> ofst = (<span class="keyword">int</span>)<span class="number">1e5</span>+<span class="number">1</span>; <span class="comment">// diffArr[ofst]ä¸º0æ‰€åœ¨ä½ç½®</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> x:nums)&#123;</span><br><span class="line">            diffArr[x-k+ofst]++;</span><br><span class="line">            diffArr[x+k+ofst+<span class="number">1</span>]--;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;diffArr.length;i++)&#123;</span><br><span class="line">            diffArr[i] += diffArr[i-<span class="number">1</span>];</span><br><span class="line">            res = Math.max(res, diffArr[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ‰“å®¶åŠ«èˆ"><a href="#æ‰“å®¶åŠ«èˆ" class="headerlink" title="æ‰“å®¶åŠ«èˆ"></a>æ‰“å®¶åŠ«èˆ</h1><p>å‘¨èµ›ç¬¬ä¸‰é¢˜å±äºå€¼åŸŸä¸Šçš„æ‰“å®¶åŠ«èˆï¼Œå› æ­¤å…ˆæ¥äº†è§£ä¸€ä¸‹æ‰“å®¶åŠ«èˆç±»å‹é¢˜ç›®ï¼Œå…¶ç‰¹ç‚¹æ˜¯<strong>å¯¹æŸä¸€å…ƒç´ çš„é€‰æ‹©ä¼šå¯¹å…¶ç›¸é‚»åŒºåŸŸé€ æˆå½±å“</strong>ã€‚æ­¤ç±»é—®é¢˜é€šå¸¸å¯ä»¥é€šè¿‡åŠ¨æ€è§„åˆ’æ±‚è§£ã€‚</p><blockquote><p>House Robber</p><p>You are a professional robber planning to rob houses along a street. Each house has a certain amount of money stashed, the only constraint stopping you from robbing each of them is that adjacent houses have security systems connected and it will automatically contact the police if two adjacent houses were broken into on the same night.</p><p>Given an integer array nums representing the amount of money of each house, return the maximum amount of money you can rob tonight without alerting the police.</p></blockquote><p>é¦–å…ˆè€ƒè™‘æœ€ç®€å•çš„æƒ…å†µã€‚å¦‚æœåªæœ‰ä¸€é—´æˆ¿å±‹ï¼Œåˆ™å·çªƒè¯¥æˆ¿å±‹ï¼Œå¯ä»¥å·çªƒåˆ°æœ€é«˜æ€»é‡‘é¢ã€‚å¦‚æœåªæœ‰ä¸¤é—´æˆ¿å±‹ï¼Œåˆ™ç”±äºä¸¤é—´æˆ¿å±‹ç›¸é‚»ï¼Œä¸èƒ½åŒæ—¶å·çªƒï¼Œåªèƒ½å·çªƒå…¶ä¸­çš„ä¸€é—´æˆ¿å±‹ï¼Œå› æ­¤é€‰æ‹©å…¶ä¸­é‡‘é¢è¾ƒé«˜çš„æˆ¿å±‹è¿›è¡Œå·çªƒï¼Œå¯ä»¥å·çªƒåˆ°æœ€é«˜æ€»é‡‘é¢ã€‚</p><p>å¦‚æœæˆ¿å±‹æ•°é‡å¤§äºä¸¤é—´ï¼Œåº”è¯¥å¦‚ä½•è®¡ç®—èƒ½å¤Ÿå·çªƒåˆ°çš„æœ€é«˜æ€»é‡‘é¢å‘¢ï¼Ÿå¯¹äºç¬¬ $k(k&gt;2)$ é—´æˆ¿å±‹ï¼Œæœ‰ä¸¤ä¸ªé€‰é¡¹:</p><ol><li>å·çªƒç¬¬ $k$ é—´æˆ¿å±‹ï¼Œé‚£ä¹ˆå°±ä¸èƒ½å·çªƒç¬¬ $k-1$ é—´æˆ¿å±‹ï¼Œå·çªƒæ€»é‡‘é¢ä¸ºå‰ $k-2$ é—´æˆ¿å±‹çš„æœ€é«˜æ€»é‡‘é¢ä¸ç¬¬ $k$ é—´æˆ¿å±‹çš„é‡‘é¢ä¹‹å’Œã€‚</li><li>ä¸å·çªƒç¬¬ $k$ é—´æˆ¿å±‹ï¼Œå·çªƒæ€»é‡‘é¢ä¸ºå‰ $k-1$ é—´æˆ¿å±‹çš„æœ€é«˜æ€»é‡‘é¢ã€‚</li></ol><p>åœ¨ä¸¤ä¸ªé€‰é¡¹ä¸­é€‰æ‹©å·çªƒæ€»é‡‘é¢è¾ƒå¤§çš„é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å¯¹åº”çš„å·çªƒæ€»é‡‘é¢å³ä¸ºå‰ $k$ é—´æˆ¿å±‹èƒ½å·çªƒåˆ°çš„æœ€é«˜æ€»é‡‘é¢ã€‚</p><p>ç”¨ $d p[i]$ è¡¨ç¤ºå‰ $i$ é—´æˆ¿å±‹èƒ½å·çªƒåˆ°çš„æœ€é«˜æ€»é‡‘é¢ï¼Œé‚£ä¹ˆå°±æœ‰å¦‚ä¸‹çš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š</p><script type="math/tex; mode=display">d p[i]=\max (d p[i-2]+\operatorname{nums}[i], d p[i-1])</script><p>è¾¹ç•Œæ¡ä»¶ä¸ºï¼š</p><script type="math/tex; mode=display">\begin{cases}d p[0]=\operatorname{nums}[0] & \text { åªæœ‰ä¸€é—´æˆ¿å±‹ï¼Œåˆ™å·çªƒè¯¥æˆ¿å±‹ } \\ d p[1]=\max (n u m s[0], n u m s[1]) & \text { åªæœ‰ä¸¤é—´æˆ¿å±‹ï¼Œé€‰æ‹©å…¶ä¸­é‡‘é¢è¾ƒé«˜çš„æˆ¿å±‹è¿›è¡Œå·çªƒ }\end{cases}</script><p>æœ€ç»ˆçš„ç­”æ¡ˆå³ä¸º $d p[n-1]$, å…¶ä¸­ $n$ æ˜¯æ•°ç»„çš„é•¿åº¦ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums == <span class="keyword">null</span> || nums.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> length = nums.length;</span><br><span class="line">        <span class="keyword">if</span> (length == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[length];</span><br><span class="line">        dp[<span class="number">0</span>] = nums[<span class="number">0</span>];</span><br><span class="line">        dp[<span class="number">1</span>] = Math.max(nums[<span class="number">0</span>], nums[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; length; i++) &#123;</span><br><span class="line">            dp[i] = Math.max(dp[i - <span class="number">2</span>] + nums[i], dp[i - <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[length - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ»šåŠ¨æ•°ç»„ä¼˜åŒ–ç©ºé—´ä½¿ç”¨ã€‚ä¸Šè¿°æ–¹æ³•ä½¿ç”¨äº†æ•°ç»„å­˜å‚¨ç»“æœï¼Œè€ƒè™‘åˆ°æ¯é—´æˆ¿å±‹çš„æœ€é«˜æ€»é‡‘é¢åªå’Œè¯¥æˆ¿å±‹çš„å‰ä¸¤é—´æˆ¿å±‹çš„æœ€é«˜æ€»é‡‘é¢ç›¸å…³ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨æ»šåŠ¨æ•°ç»„ï¼Œåœ¨æ¯ä¸ªæ—¶åˆ»åªéœ€è¦å­˜å‚¨å‰ä¸¤é—´æˆ¿å±‹çš„æœ€é«˜æ€»é‡‘é¢ã€‚å¾—åˆ°ä¼˜åŒ–è§£æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums == <span class="keyword">null</span> || nums.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> length = nums.length;</span><br><span class="line">        <span class="keyword">if</span> (length == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> first = nums[<span class="number">0</span>], second = Math.max(nums[<span class="number">0</span>], nums[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> temp = second;</span><br><span class="line">            second = Math.max(first + nums[i], second);</span><br><span class="line">            first = temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜ï¼šMaximum-Total-Damage-With-Spell-Casting"><a href="#ä¾‹é¢˜ï¼šMaximum-Total-Damage-With-Spell-Casting" class="headerlink" title="ä¾‹é¢˜ï¼šMaximum Total Damage With Spell Casting"></a>ä¾‹é¢˜ï¼šMaximum Total Damage With Spell Casting</h2><blockquote><p>Maximum Total Damage With Spell Casting</p><p>A magician has various spells.</p><p>You are given an array power, where each element represents the damage of a spell. Multiple spells can have the same damage value.</p><p>It is a known fact that if a magician decides to cast a spell with a damage of power[i], they cannot cast any spell with a damage of power[i] - 2, power[i] - 1, power[i] + 1, or power[i] + 2.</p><p>Each spell can be cast only once.</p><p>Return the maximum possible total damage that a magician can cast.</p></blockquote><p>è¿™é“é¢˜ä¸æ˜¯ä»ç©ºé—´ä¸Šé™åˆ¶é€‰å–ï¼Œè€Œæ˜¯ä»å€¼åŸŸä¸Šé™åˆ¶ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘å¯¹åŸæ•°ç»„è¿›è¡Œæ’åºï¼Œä½¿å…ƒç´ é€‰å–ä¸ç©ºåŸŸäº§ç”Ÿä¸€å®šç›¸å…³æ€§ï¼Œæ–¹ä¾¿çŠ¶æ€è®°å½•ã€‚æ’åºåï¼Œè€ƒè™‘èšåˆç›¸ç­‰å€¼çš„å…ƒç´ ï¼Œæ¯ä¸€æ­¥é€‰å–å®é™…ä¸Šéƒ½æ˜¯é€‰å–äº†ä¸€ç»„å…ƒç´ ã€‚</p><p>ç”¨$nums$è¡¨ç¤ºèšåˆåçš„æ’åºæ•°ç»„ï¼Œ$total(nums[k])$è¡¨ç¤ºå…ƒç´ $nums[k]$çš„å€¼æ€»å’Œï¼Œç”¨ $dp[i]$ è¡¨ç¤ºå‰ $i$ ä¸ªå…ƒç´ èƒ½é€ æˆçš„æœ€é«˜æ€»ä¼¤å®³ï¼Œé‚£ä¹ˆå¯¹äº$nums[k]$é€‰æˆ–ä¸é€‰ï¼š</p><ul><li>ä¸é€‰ï¼Œ$dp[i] = dp[i-1]$;</li><li>é€‰ï¼Œåˆ™å€¼åœ¨$[nums[k]-2, nums[k]-1]$çš„å…ƒç´ ä¸èƒ½é€‰ï¼Œä»¤$j$ä¸ºæœ€å°æ»¡è¶³$nums[j]&gt;=nums[k]-2$çš„å…ƒç´ ï¼Œåˆ™$dp[i] = dp[j-1] + total(nums[k])$ã€‚</li></ul><p>å¯¹ä¸¤ç§æƒ…å†µå–æœ€å¤§å€¼ï¼Œæœ‰å¦‚ä¸‹çš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š</p><script type="math/tex; mode=display">dp[i] = max(dp[i-1], dp[j-1] + total(nums[i]))</script><p>å‡è®¾ä¸€ç§æœ€åçš„æƒ…å†µï¼Œ$nums$ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆåœ¨é‡åˆ°å…ƒç´ $nums[i]$æ—¶ï¼Œæˆ‘ä»¬è‡³å°‘è¦ä¿å­˜ä¸‰ä¸ªçŠ¶æ€æ‰èƒ½å¤Ÿå®ŒæˆçŠ¶æ€è½¬ç§»ï¼Œå³$dp[i-1], dp[i-2], dp[i-3]$ï¼Œæ­¤æ—¶ä»–ä»¬çš„æœ«å°¾å€¼åˆ†åˆ«å¯¹åº”$nums[i]-1,nums[i]-2,nums[i]-3$ï¼Œåˆ™$j = i-2$ï¼ŒçŠ¶æ€å¯èƒ½ä»$dp[i-3]$è½¬ç§»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ$dp[j-1]$çš„å–å€¼èŒƒå›´æ˜¯$dp[i-1], dp[i-2], dp[i-3]$ã€‚</p><p>è¾¹ç•Œæ¡ä»¶ä¸ºï¼š</p><script type="math/tex; mode=display">\begin{cases}d p[0]=total(\operatorname{nums}[0]) \\ d p[1]=\begin{cases} \max (total(\operatorname{nums}[0]), total(\operatorname{nums}[1])),&nums[0]-2<=nums[1]<nums[0] \\ dp[0]+total(\operatorname{nums}[1]), &nums[0]<nums[1]-2 \end{cases}\end{cases}</script><p>æ­¤æ—¶å‘ç°é—®é¢˜ï¼šé¢å¯¹ä¸‹æ ‡ä¸º$2$çš„å…ƒç´ ï¼Œå¹¶ä¸å­˜åœ¨çŠ¶æ€$dp[-1]$ä¾›å…¶è½¬ç§»ï¼ˆ$dp[j-1]$çš„ä¸‹ç•Œï¼‰ã€‚äºæ˜¯å¦‚æœä»$nums[2]$å¼€å§‹éå†åˆ™åº”è¯¥æ·»åŠ æ­¤çŠ¶æ€ï¼ˆç½®0ï¼‰ï¼Œæˆ–ä»$nums[3]$å¼€å§‹éå†ã€‚</p><p>æ³¨æ„åˆ°å½“å‰çŠ¶æ€ä»…ä¸å‰ä¸‰ä¸ªçŠ¶æ€æœ‰å…³ï¼Œåˆ™å¯ä»¥ç”¨é•¿åº¦ä¸º$3$çš„æ»šåŠ¨æ•°ç»„è¿›è¡Œä¼˜åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">maximumTotalDamage</span><span class="params">(<span class="keyword">int</span>[] power)</span> </span>&#123;</span><br><span class="line">        Map&lt;Integer, Long&gt; map = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x : power) &#123;</span><br><span class="line">            map.merge(x, (<span class="keyword">long</span>) x, Long::sum);</span><br><span class="line">        &#125;</span><br><span class="line">        Integer[] nums = map.keySet().toArray(<span class="keyword">new</span> Integer[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">// ä¸‰ä¸ªçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">long</span>[] dp = <span class="keyword">new</span> <span class="keyword">long</span>[<span class="number">3</span>];</span><br><span class="line">        dp[<span class="number">1</span>] = map.get(nums[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span>(nums.length==<span class="number">1</span>) <span class="keyword">return</span> dp[<span class="number">1</span>]; </span><br><span class="line">        dp[<span class="number">2</span>] = nums[<span class="number">0</span>]&lt;nums[<span class="number">1</span>]-<span class="number">2</span>?dp[<span class="number">1</span>]+map.get(nums[<span class="number">1</span>]):Math.max(dp[<span class="number">1</span>], map.get(nums[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jæ”¾åˆ°å¤–é¢ï¼Œå¯ä»¥é¿å…æ¯æ¬¡éƒ½ä»0å¼€å§‹æŸ¥</span></span><br><span class="line">        <span class="keyword">int</span> j=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">            <span class="comment">// å®šä½j</span></span><br><span class="line">            <span class="keyword">while</span> (nums[j] &lt; nums[i]-<span class="number">2</span>) &#123;</span><br><span class="line">                j++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> pos = j==i?<span class="number">2</span>:(j==i-<span class="number">1</span>?<span class="number">1</span>:<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">long</span> tmp = dp[<span class="number">2</span>];</span><br><span class="line">            dp[<span class="number">2</span>] = Math.max(dp[<span class="number">2</span>], dp[pos]+map.get(nums[i]));</span><br><span class="line">            dp[<span class="number">0</span>] = dp[<span class="number">1</span>];</span><br><span class="line">            dp[<span class="number">1</span>] = tmp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dp[<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€è€ƒï¼šå¦‚æœæŠŠ2æ¢ä¸ºkå‘¢ï¼Ÿä¸€æ ·çš„ï¼Œå¤šå¢åŠ å‡ ä¸ªçŠ¶æ€å°±è¡Œäº†ï¼Œæ»šåŠ¨æ•°ç»„æ³•åªéœ€è¦k+1ä¸ªçŠ¶æ€ã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] <a href="https://leetcode.cn/problems/house-robber/solutions/263856/da-jia-jie-she-by-leetcode-solution/">https://leetcode.cn/problems/house-robber/solutions/263856/da-jia-jie-she-by-leetcode-solution/</a><br>[2] <a href="https://leetcode.cn/problems/maximum-total-damage-with-spell-casting/solutions/2812389/tao-lu-da-jia-jie-she-pythonjavacgo-by-e-p9b5/">https://leetcode.cn/problems/maximum-total-damage-with-spell-casting/solutions/2812389/tao-lu-da-jia-jie-she-pythonjavacgo-by-e-p9b5/</a></p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;è¿™å‘¨å‘¨èµ›èœäº†â€¦èµ¶ç´§è®°ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬å‘¨ä¸»é¢˜ï¼šå·®åˆ†æ•°ç»„ã€åŠ¨æ€è§„åˆ’&lt;/p&gt;
&lt;p&gt;é¢˜ç›®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;240615æ¯æ—¥ä¸€é¢˜â€”&lt;a href=&quot;https://leetcode.cn/problems/maximum-beauty-of-an-array-after-applying-operation/description/&quot;&gt;Maximum Beauty of an Array After Applying Operation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;240616å‘¨èµ›ç¬¬ä¸‰é¢˜â€”&lt;a href=&quot;https://leetcode.cn/problems/maximum-total-damage-with-spell-casting/description/&quot;&gt;Maximum Total Damage With Spell Casting&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;LC198æ‰“å®¶åŠ«èˆâ€”&lt;a href=&quot;https://leetcode.cn/problems/house-robber/description/&quot;&gt;House Robber&lt;/a&gt;</summary>
    
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://silencezheng.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    <category term="LeetCode" scheme="http://silencezheng.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨è®° EP1</title>
    <link href="http://silencezheng.top/2024/08/18/article132/"/>
    <id>http://silencezheng.top/2024/08/18/article132/</id>
    <published>2024-08-17T16:14:09.000Z</published>
    <updated>2024-08-17T16:15:40.843Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ–°å¼€ä¸€ä¸ªç³»åˆ—ï¼ŒLeetCodeåˆ·é¢˜å‘¨è®°ï¼Œæ¯å‘¨åˆ·é¢˜æœ‰æ„Ÿæ‚Ÿå¯ä»¥æ€»ç»“ä¸€ä¸‹ã€‚</p><p>æœ¬å‘¨ä¸»é¢˜ï¼šè®°å¿†åŒ–æœç´¢ã€åŠ¨æ€è§„åˆ’ã€01èƒŒåŒ…</p><p>é¢˜ç›®ï¼š</p><ul><li>240609æ¯æ—¥ä¸€é¢˜â€”<a href="https://leetcode.cn/problems/burst-balloons/description/">Burst Balloons</a></li><li>240608åŒå‘¨èµ›æœ€åä¸¤é¢˜â€”<a href="https://leetcode.cn/problems/find-the-maximum-length-of-a-good-subsequence-ii/description/">Find the Maximum Length of a Good Subsequence</a></li><li>240609å‘¨èµ›æœ€åä¸¤é¢˜â€”<a href="https://leetcode.cn/problems/maximum-total-reward-using-operations-ii/description/">Maximum Total Reward Using Operations</a><span id="more"></span><h1 id="è®°å¿†åŒ–æœç´¢"><a href="#è®°å¿†åŒ–æœç´¢" class="headerlink" title="è®°å¿†åŒ–æœç´¢"></a>è®°å¿†åŒ–æœç´¢</h1><blockquote><p><strong>Burst Balloons</strong><br>You are given n balloons, indexed from 0 to n - 1. Each balloon is painted with a number on it represented by an array nums. You are asked to burst all the balloons.</p><p>If you burst the ith balloon, you will get nums[i - 1] <em> nums[i] </em> nums[i + 1] coins. If i - 1 or i + 1 goes out of bounds of the array, then treat it as if there is a balloon with a 1 painted on it.</p><p>Return the maximum coins you can collect by bursting the balloons wisely.</p></blockquote></li></ul><p>è¿™é“é¢˜çš„ç¬¬ä¸€ä¸ªå…³é”®æ€è·¯æ˜¯é€†å‘æ€ç»´ï¼Œæˆ³æ°”çƒçš„æ“ä½œä¼šå¯¼è‡´ä¸¤ä¸ªæ°”çƒä»ä¸ç›¸é‚»å˜æˆç›¸é‚»ï¼Œä½¿åç»­æ“ä½œå¤„ç†å›°éš¾ï¼Œå°†æˆ³æ°”çƒçš„è¿‡ç¨‹åè¿‡æ¥çœ‹æˆæ¯æ¬¡æ·»åŠ ä¸€ä¸ªæ°”çƒï¼Œç›´åˆ°å½¢æˆåŸæ•°ç»„ã€‚å®šä¹‰æ–¹æ³• $solve$ï¼Œä»¤ $solve(i,j)$ è¡¨ç¤ºå°†å¼€åŒºé—´ $(i,j)$ å†…çš„ä½ç½®å…¨éƒ¨å¡«æ»¡æ°”çƒèƒ½å¤Ÿå¾—åˆ°çš„æœ€å¤šç¡¬å¸æ•°ã€‚ç”±äºæ˜¯å¼€åŒºé—´ï¼Œå› æ­¤åŒºé—´ä¸¤ç«¯çš„æ°”çƒçš„ç¼–å·å°±æ˜¯ $i$ å’Œ $j$ï¼Œå¯¹åº”ç€ $val[i]$ å’Œ $val[j]$ã€‚</p><p>ç¬¬äºŒä¸ªæ€è·¯æ¯”è¾ƒç®€å•ï¼Œåœ¨åŸæ•°ç»„å·¦å³å„å¢åŠ ä¸€ä¸ª$1$ï¼Œå³å·¦å³è¾¹ç•Œæ—¶çš„å¾—åˆ†ã€‚</p><p>ä¸‹é¢ï¼Œå¯¹äº$solve(i,j)$ï¼š</p><ul><li>å½“ $iâ‰¥jâˆ’1$ æ—¶ï¼Œå¼€åŒºé—´ä¸­æ²¡æœ‰æ°”çƒï¼Œ$solve(i,j)$ çš„å€¼ä¸º 0ï¼›</li><li>å½“ $i&lt;jâˆ’1$ æ—¶ï¼Œæˆ‘ä»¬æšä¸¾å¼€åŒºé—´å†…çš„å…¨éƒ¨ä½ç½® $mid$ï¼Œä»¤ $mid$ ä¸ºå½“å‰åŒºé—´ç¬¬ä¸€ä¸ªæ·»åŠ çš„æ°”çƒï¼Œè¯¥æ“ä½œèƒ½å¾—åˆ°çš„ç¡¬å¸æ•°ä¸º $val[i]Ã—val[mid]Ã—val[j]$ã€‚åŒæ—¶æˆ‘ä»¬é€’å½’åœ°è®¡ç®—åˆ†å‰²å‡ºçš„ä¸¤åŒºé—´å¯¹ $solve(i,j)$ çš„è´¡çŒ®ï¼Œè¿™ä¸‰é¡¹ä¹‹å’Œçš„æœ€å¤§å€¼ï¼Œå³ä¸º $solve(i,j)$ çš„å€¼ã€‚è¿™æ ·é—®é¢˜å°±è½¬åŒ–ä¸ºæ±‚ $solve(i,mid)$ å’Œ $solve(mid,j)$ ï¼Œå¯ä»¥å†™å‡ºæ–¹ç¨‹ï¼š<script type="math/tex; mode=display">{solve}(i,j)= \begin{cases}{} \displaystyle \max_{\textit{mid} = i + 1}^{j - 1}val[i] \times \textit{val}[\textit{mid}] \times \textit{val}[j] + \textit{solve}(i, \textit{mid}) + \textit{solve}(\textit{mid}, j) ,&i < j - 1 \\ 0, & i \geq j - 1 \end{cases}</script></li></ul><p>ç”±äºåœ¨æšä¸¾midçš„è¿‡ç¨‹ä¸­ï¼Œä¸€å®šä¼šäº§ç”Ÿç›¸åŒå­åŒºé—´ï¼Œå³å­˜åœ¨é‡å¤è®¡ç®—ï¼Œæ­¤æ—¶å¯ä»¥é‡‡ç”¨è®°å¿†åŒ–çš„æ–¹å¼å­˜å‚¨è®¡ç®—ç»“æœï¼Œä¼˜åŒ–æ—¶é—´å¤æ‚åº¦ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[][] rec;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] val;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxCoins</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = nums.length;</span><br><span class="line">        val = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">2</span>]; <span class="comment">// å¢åŠ è¾¹ç•Œ</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            val[i] = nums[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        val[<span class="number">0</span>] = val[n + <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        rec = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">2</span>][n + <span class="number">2</span>]; <span class="comment">// è®°å¿†åŒ–</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n + <span class="number">1</span>; i++) &#123;</span><br><span class="line">            Arrays.fill(rec[i], -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> solve(<span class="number">0</span>, n + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">solve</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left &gt;= right - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rec[left][right] != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> rec[left][right]; <span class="comment">// å·²è®¡ç®—</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = left + <span class="number">1</span>; i &lt; right; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> sum = val[left] * val[i] * val[right];</span><br><span class="line">            sum += solve(left, i) + solve(i, right);</span><br><span class="line">            rec[left][right] = Math.max(rec[left][right], sum);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rec[left][right];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä½œè€…ï¼šåŠ›æ‰£å®˜æ–¹é¢˜è§£</span><br><span class="line">é“¾æ¥ï¼šhttps:<span class="comment">//leetcode.cn/problems/burst-balloons/solutions/336390/chuo-qi-qiu-by-leetcode-solution/</span></span><br><span class="line">æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰</span><br><span class="line">è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</span><br></pre></td></tr></table></figure><h1 id="èƒŒåŒ…DP"><a href="#èƒŒåŒ…DP" class="headerlink" title="èƒŒåŒ…DP"></a>èƒŒåŒ…DP</h1><blockquote><p>æœ‰ $n$ ä¸ªç‰©å“å’Œä¸€ä¸ªå®¹é‡ä¸º $W$ çš„èƒŒåŒ…ï¼Œæ¯ä¸ªç‰©å“æœ‰é‡é‡ $w_{i}$ å’Œä»·å€¼ $v_{i}$ ä¸¤ç§å±æ€§ï¼Œè¦æ±‚é€‰è‹¥å¹²ç‰©å“æ”¾å…¥èƒŒåŒ…ä½¿èƒŒåŒ…ä¸­ç‰©å“çš„æ€»ä»·å€¼æœ€å¤§ä¸”èƒŒåŒ…ä¸­ç‰©å“çš„æ€»é‡é‡ä¸è¶…è¿‡èƒŒåŒ…çš„å®¹é‡ã€‚</p></blockquote><h2 id="0-1èƒŒåŒ…"><a href="#0-1èƒŒåŒ…" class="headerlink" title="0-1èƒŒåŒ…"></a>0-1èƒŒåŒ…</h2><p>åœ¨ä¸Šè¿°ä¾‹é¢˜ä¸­ï¼Œè‹¥æ¯ä¸ªç‰©ä½“åªæœ‰ä¸¤ç§å¯èƒ½çš„çŠ¶æ€ï¼ˆå–ä¸ä¸å–ï¼‰ï¼Œå¯¹åº”äºŒè¿›åˆ¶ä¸­çš„ 0 å’Œ 1ï¼Œè¿™ç±»é—®é¢˜ä¾¿è¢«ç§°ä¸ºã€Œ0-1 èƒŒåŒ…é—®é¢˜ã€ã€‚</p><p>ä¾‹é¢˜ä¸­å·²çŸ¥æ¡ä»¶æœ‰ç¬¬ $i$ ä¸ªç‰©å“çš„é‡é‡ $w_{i}$ï¼Œä»·å€¼ $v_{i}$ï¼Œä»¥åŠèƒŒåŒ…çš„æ€»å®¹é‡ $W$ã€‚</p><p>è®¾ DP çŠ¶æ€ $f_{i,j}$ ä¸ºåœ¨åªèƒ½æ”¾å‰ $i$ ä¸ªç‰©å“çš„æƒ…å†µä¸‹ï¼Œå®¹é‡ä¸º $j$ çš„èƒŒåŒ…æ‰€èƒ½è¾¾åˆ°çš„æœ€å¤§æ€»ä»·å€¼ã€‚</p><p>è€ƒè™‘è½¬ç§»ã€‚å‡è®¾å½“å‰å·²ç»å¤„ç†å¥½äº†å‰ $i-1$ ä¸ªç‰©å“çš„æ‰€æœ‰çŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹äºç¬¬ $i$ ä¸ªç‰©å“ï¼Œå½“å…¶ä¸æ”¾å…¥èƒŒåŒ…æ—¶ï¼ŒèƒŒåŒ…çš„å®¹é‡ä¸å˜ï¼ŒèƒŒåŒ…ä¸­ç‰©å“çš„æ€»ä»·å€¼ä¹Ÿä¸å˜ï¼Œæ•…è¿™ç§æƒ…å†µçš„æœ€å¤§ä»·å€¼ä¸º $f_{i-1,j}$ï¼›å½“å…¶æ”¾å…¥èƒŒåŒ…æ—¶ï¼ŒèƒŒåŒ…çš„å®¹é‡ä¼šå¢å¤§ $w_{i}$ï¼Œå³å‰ä¸€ä¸ªçŠ¶æ€çš„èƒŒåŒ…å®¹é‡å¿…é¡»æ˜¯ $j-w_{i}$ï¼Œé€šè¿‡æœ¬è½®åŠ ä¸Š $w_{i}$ è¾¾åˆ° $j$ï¼ŒåŒæ—¶èƒŒåŒ…ä¸­ç‰©å“çš„æ€»ä»·å€¼ä¼šå¢å¤§ $v_{i}$ï¼Œæ•…è¿™ç§æƒ…å†µä¸‹çš„æœ€å¤§ä»·å€¼ä¸º $f_{i-1,j-w_{i}}+v_{i}$ã€‚</p><p>ç”±æ­¤å¯ä»¥å¾—å‡ºçŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š</p><script type="math/tex; mode=display">f_{i,j}=\max(f_{i-1,j},f_{i-1,j-w_{i}}+v_{i})</script><p>ä¾æ®è¯¥çŠ¶æ€è½¬ç§»æ–¹ç¨‹å¯ä»¥å†™å‡ºè§£æ³•1:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> n = w.length;</span><br><span class="line"><span class="comment">// å®¹é‡ç»´åº¦å¤šå¼€è¾Ÿä¸€ä¸ªä½ç½®ï¼Œå› ä¸ºè¦ç”¨ç´¢å¼•è¡¨ç¤ºå®¹é‡ï¼Œéœ€è¦åŒ¹é…åˆ° W</span></span><br><span class="line"><span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n][W+<span class="number">1</span>];</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// å¯¹äºdp[0][j]ï¼Œæ‰€æœ‰j&lt;w[0]çš„ä½ç½®åˆå§‹åŒ–ä¸º0ï¼Œå…¶ä½™ä½ç½®åˆå§‹åŒ–ä¸º v[0]</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;=W;j++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(j&lt;w[<span class="number">0</span>])&#123;</span><br><span class="line">        dp[<span class="number">0</span>][j] = <span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        dp[<span class="number">0</span>][j] = v[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¯¹äºdp[i][0]ï¼ŒèƒŒåŒ…å®¹é‡ä¸º0æ—¶æ— æ³•è£…ç‰©ï¼Œä»·å€¼ä¸º0ï¼Œå¯¹äºå…¶ä½™ä½ç½®ï¼Œæ˜¯ç”±å…¶ä¸Šå±‚çš„çŠ¶æ€è®¡ç®—å‡ºçš„ï¼Œä¹Ÿä¸€å¹¶åˆå§‹åŒ–ä¸º0</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)&#123;</span><br><span class="line">    Arrays.fills(dp[i], <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¡ç®—</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=W;j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(j&gt;=w[i]) dp[i][j]=Math.max(dp[i-<span class="number">1</span>][j], dp[i-<span class="number">1</span>][j-w[i]]+v[i]);</span><br><span class="line">        <span class="keyword">else</span> dp[i][j]=dp[i-<span class="number">1</span>][j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// dp[n-1][W]å³ä¸ºç»“æœ</span></span><br></pre></td></tr></table></figure><p>å¦‚æœç›´æ¥é‡‡ç”¨äºŒç»´æ•°ç»„å¯¹çŠ¶æ€è¿›è¡Œè®°å½•ï¼Œå¯èƒ½ä¼šå‡ºç° MLEï¼ˆMemory Limit Exceededï¼‰ã€‚å¯ä»¥è€ƒè™‘æ”¹ç”¨<strong>æ»šåŠ¨æ•°ç»„</strong>çš„å½¢å¼æ¥ä¼˜åŒ–ã€‚</p><blockquote><p>æ»šåŠ¨æ•°ç»„</p><p>åœ¨åŠ¨æ€è§„åˆ’é—®é¢˜ä¸­ï¼Œé€šå¸¸éœ€è¦å­˜å‚¨ä¸€ç³»åˆ—çŠ¶æ€å€¼ï¼Œæ¯ä¸ªçŠ¶æ€å€¼å¯èƒ½ä¾èµ–äºå‰å‡ ä¸ªçŠ¶æ€ã€‚éšç€è®¡ç®—çš„è¿›è¡Œï¼Œè¾ƒæ—©çš„çŠ¶æ€å€¼å¯èƒ½ä¸å†éœ€è¦ã€‚ä¾‹å¦‚ï¼Œåœ¨æ±‚è§£æ–æ³¢é‚£å¥‘æ•°åˆ—æ—¶ï¼Œåªéœ€è¦ä¿ç•™æœ€è¿‘ä¸¤ä¸ªå€¼å³å¯è®¡ç®—ä¸‹ä¸€ä¸ªå€¼ï¼Œä¹‹å‰çš„å€¼åˆ™å¯ä»¥è¢«è¦†ç›–é‡ç”¨ã€‚</p><p>æ€æƒ³ï¼šé€šè¿‡è§‚å¯Ÿdpæ–¹ç¨‹æ¥åˆ¤æ–­éœ€è¦ä½¿ç”¨å“ªäº›æ•°æ®ï¼Œå¯ä»¥æŠ›å¼ƒå“ªäº›æ•°æ®ï¼Œä¸€æ—¦æ‰¾åˆ°å…³ç³»ï¼Œå°±å¯ä»¥ç”¨æ–°çš„æ•°æ®ä¸æ–­è¦†ç›–æ—§çš„æ•°æ®é‡æ¥å‡å°‘ç©ºé—´çš„ä½¿ç”¨ã€‚</p></blockquote><p>ç”±äºåœ¨äºŒç»´è§£æ³•ä¸­ï¼Œå¯¹äºå½“å‰å±‚ï¼ˆå½“å‰ç‰©å“ï¼‰çŠ¶æ€æœ‰å½±å“çš„åªæœ‰ä¸Šä¸€å±‚ï¼ˆå‰ä¸€ç‰©å“ï¼‰ï¼Œå³å¯¹ $f_i$ æœ‰å½±å“çš„åªæœ‰ $f_{i-1}$ï¼Œåˆ™å¯ä»¥å»æ‰ç¬¬ä¸€ç»´ï¼Œç”¨ä¸€ä¸ªé‡å¤æ›´æ–°çš„ä¸€ç»´æ•°ç»„è®°å½•çŠ¶æ€ï¼Œç›´æ¥ç”¨ $f_{j}$ æ¥è¡¨ç¤ºå¤„ç†åˆ°å½“å‰ç‰©å“æ—¶èƒŒåŒ…å®¹é‡ä¸º $j$ çš„æœ€å¤§ä»·å€¼ï¼Œå¾—å‡ºä»¥ä¸‹æ–¹ç¨‹ï¼š</p><script type="math/tex; mode=display">f_j=\max \left(f_j,f_{j-w_i}+v_i\right)</script><p>è¿™é‡Œï¼Œ$f_{j-w_i} + v_i$ä»£è¡¨å¦‚æœé€‰æ‹©æ”¾å…¥ç¬¬$i$ä¸ªç‰©å“ï¼Œåˆ™åœ¨èƒŒåŒ…å®¹é‡ä¸º$j-w_i$æ—¶çš„ä»·å€¼åŠ ä¸Šè¿™ä¸ªç‰©å“çš„ä»·å€¼ã€‚è€Œ$max$æ“ä½œä¿è¯äº†åœ¨æ˜¯å¦é€‰æ‹©æ”¾å…¥ç¬¬$i$ä¸ªç‰©å“ä¹‹é—´å–æœ€ä¼˜è§£ã€‚</p><p>å¤§éƒ¨åˆ†èƒŒåŒ…é—®é¢˜çš„è½¬ç§»æ–¹ç¨‹éƒ½æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šæ¨å¯¼å‡ºæ¥çš„ã€‚</p><p>å¯¹äºä»£ç å®ç°æ–¹é¢ï¼Œ<strong>æ»šåŠ¨æ•°ç»„çš„å®ç°è¦æ³¨æ„å†…å±‚å¾ªç¯åº”ä»åå‘å‰é€†åºéå†</strong>ï¼Œè¿™å¯ä»¥é¿å…åœ¨ $j\geqslant w_{i}$ æ—¶ï¼Œ$f_{i,j}$ è¢« $f_{i,j-w_{i}}$ æ‰€å½±å“ï¼Œå³é¿å…å°èƒŒåŒ…å®¹é‡ä¸‹å–ç‰©å¯¹åç»­å¤§èƒŒåŒ…å®¹é‡ä¸‹çŠ¶æ€è®¡ç®—çš„å½±å“ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾<em>ç‰©å“4</em>çš„é‡é‡ä¸º$1$ï¼Œåœ¨äºŒç»´è§£æ³•ä¸­<code>dp[4][5]</code>åº”è¯¥ç”±<code>dp[3][5]</code>å’Œ<code>dp[3][4]</code>å¾—å‡ºï¼Œ<code>dp[4][6]</code>åº”è¯¥ç”±<code>dp[3][6]</code>å’Œ<code>dp[3][5]</code>å¾—å‡ºï¼Œè€Œåœ¨æ­£åºéå†çš„ä¸€ç»´è§£æ³•ä¸­ï¼Œ<code>f[5]</code>ä¼šå…ˆè¢«è®¡ç®—ï¼Œå¯èƒ½å­˜åœ¨<code>f[5]</code>å­˜å‚¨<code>dp[3][4]</code>çŠ¶æ€çš„æƒ…å†µï¼Œæ­¤æ—¶<code>f[6]</code>çš„è®¡ç®—å°±æ— æ³•è·å–<code>dp[3][5]</code>ï¼Œé€ æˆè®¡ç®—é”™è¯¯ã€‚è¿™ä¸ªè®¡ç®—é”™è¯¯äº‹å®ä¸Šæ˜¯å¯¹<strong>åŒä¸€ç‰©å“çš„å¤šæ¬¡è£…åŒ…</strong>ï¼Œå› ä¸º<code>dp[3][4]</code>è¡¨ç¤ºå–<em>ç‰©å“4</em>(ä¸‹æ ‡ä¸º3)ï¼Œè‹¥ä¸‹ä¸€æ­¥<code>f[6]</code>å†é€‰æ‹©<code>f[5]+v[3]</code>åˆ™è¡¨ç¤ºåˆå–äº†ä¸€æ¬¡<em>ç‰©å“4</em>ï¼Œè¿™åœ¨01èƒŒåŒ…ä¸­æ˜¯ä¸å…è®¸çš„ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">13010</span>;</span><br><span class="line"><span class="keyword">int</span> n, W, w[maxn], v[maxn], f[maxn];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  cin &gt;&gt; n &gt;&gt; W;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) cin &gt;&gt; w[i] &gt;&gt; v[i];  <span class="comment">// è¯»å…¥æ•°æ®</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> l = W; l &gt;= w[i]; l--) <span class="comment">// l &gt;= w[i]ä¿è¯èƒŒåŒ…èƒ½è£…ä¸‹ï¼Œé˜²æ­¢è¶Šç•Œ</span></span><br><span class="line">      <span class="keyword">if</span> (f[l - w[i]] + v[i] &gt; f[l]) f[l] = f[l - w[i]] + v[i];  <span class="comment">// çŠ¶æ€æ–¹ç¨‹</span></span><br><span class="line">  cout &lt;&lt; f[W];</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”™è¯¯çš„ï¼š</span></span><br><span class="line"><span class="comment">// for (int i = 1; i &lt;= n; i++)</span></span><br><span class="line"><span class="comment">//   for (int l = 0; l &lt;= W - w[i]; l++)</span></span><br><span class="line"><span class="comment">//     f[l + w[i]] = max(f[l] + v[i], f[l + w[i]]);</span></span><br></pre></td></tr></table></figure><h2 id="å®Œå…¨èƒŒåŒ…"><a href="#å®Œå…¨èƒŒåŒ…" class="headerlink" title="å®Œå…¨èƒŒåŒ…"></a>å®Œå…¨èƒŒåŒ…</h2><p>å®Œå…¨èƒŒåŒ…æ¨¡å‹ä¸ 0-1 èƒŒåŒ…ç±»ä¼¼ï¼Œä¸ 0-1 èƒŒåŒ…çš„åŒºåˆ«ä»…åœ¨äºä¸€ä¸ªç‰©å“å¯ä»¥é€‰å–æ— é™æ¬¡ï¼Œè€Œéä»…èƒ½é€‰å–ä¸€æ¬¡ã€‚</p><p>å¯ä»¥å€Ÿé‰´ 0-1 èƒŒåŒ…çš„æ€è·¯ï¼Œè¿›è¡ŒçŠ¶æ€å®šä¹‰ï¼šè®¾ $f_{i,j}$ ä¸ºåªèƒ½é€‰å‰ $i$ ä¸ªç‰©å“æ—¶ï¼Œå®¹é‡ä¸º $j$ çš„èƒŒåŒ…å¯ä»¥è¾¾åˆ°çš„æœ€å¤§ä»·å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶å®šä¹‰ä¸ 0-1 èƒŒåŒ…ç±»ä¼¼ï¼Œä½†æ˜¯å…¶çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸ 0-1 èƒŒåŒ…å¹¶ä¸ç›¸åŒã€‚</p><p>å¯ä»¥è€ƒè™‘ä¸€ä¸ªæœ´ç´ çš„åšæ³•ï¼šå¯¹äºç¬¬ $i$ ä»¶ç‰©å“ï¼Œæšä¸¾å…¶é€‰äº†å¤šå°‘ä¸ªæ¥è½¬ç§»ã€‚è¿™æ ·åšçš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n^3)$ çš„ã€‚</p><p>çŠ¶æ€è½¬ç§»æ–¹ç¨‹å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">f_{i,j}=\max_{k=0}^{+\infty}(f_{i-1,j-k\times w_i}+v_i\times k)</script><p>è€ƒè™‘è¿›è¡Œä¼˜åŒ–ã€‚å¯ä»¥å‘ç°ï¼Œå¯¹äº $f_{i,j}$ï¼Œåªè¦é€šè¿‡ $f_{i,j-w_i}$ è½¬ç§»å°±å¯ä»¥äº†ã€‚å› æ­¤çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸ºï¼š</p><script type="math/tex; mode=display">f_{i,j}=\max(f_{i-1,j},f_{i,j-w_i}+v_i)</script><p>ç†ç”±æ˜¯å½“æˆ‘ä»¬è¿™æ ·è½¬ç§»æ—¶ï¼Œ$f_{i,j-w_i}$ å·²ç»ç”± $f_{i,j-2\times w_i}$ æ›´æ–°è¿‡ï¼Œé‚£ä¹ˆ $f_{i,j-w_i}$ å°±æ˜¯å……åˆ†è€ƒè™‘äº†ç¬¬ $i$ ä»¶ç‰©å“æ‰€é€‰æ¬¡æ•°åå¾—åˆ°çš„æœ€ä¼˜ç»“æœã€‚æ¢è¨€ä¹‹ï¼Œæˆ‘ä»¬é€šè¿‡å±€éƒ¨æœ€ä¼˜å­ç»“æ„çš„æ€§è´¨é‡å¤ä½¿ç”¨äº†ä¹‹å‰çš„æšä¸¾è¿‡ç¨‹ï¼Œä¼˜åŒ–äº†æšä¸¾çš„å¤æ‚åº¦ã€‚ä¸ 0-1 èƒŒåŒ…ç›¸åŒï¼Œæˆ‘ä»¬å¯ä»¥å°†ç¬¬ä¸€ç»´å»æ‰æ¥ä¼˜åŒ–ç©ºé—´å¤æ‚åº¦ã€‚</p><p>å®ç°ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">1e4</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxW = <span class="number">1e7</span> + <span class="number">5</span>;</span><br><span class="line"><span class="keyword">int</span> n, W, w[maxn], v[maxn];</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> f[maxW];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  cin &gt;&gt; W &gt;&gt; n;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) cin &gt;&gt; w[i] &gt;&gt; v[i];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> l = w[i]; l &lt;= W; l++)</span><br><span class="line">      <span class="keyword">if</span> (f[l - w[i]] + v[i] &gt; f[l]) f[l] = f[l - w[i]] + v[i];  <span class="comment">// æ ¸å¿ƒçŠ¶æ€æ–¹ç¨‹</span></span><br><span class="line">  cout &lt;&lt; f[W];</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="ä¾‹é¢˜1-Maximum-Total-Reward-Using-Operations"><a href="#ä¾‹é¢˜1-Maximum-Total-Reward-Using-Operations" class="headerlink" title="ä¾‹é¢˜1: Maximum Total Reward Using Operations"></a>ä¾‹é¢˜1: Maximum Total Reward Using Operations</h2><blockquote><p><strong>Maximum Total Reward Using Operations I &amp; II</strong></p><p>You are given an integer array rewardValues of length n, representing the values of rewards.</p><p>Initially, your total reward x is 0, and all indices are unmarked. You are allowed to perform the following operation any number of times:</p><ul><li>Choose an unmarked index i from the range [0, n - 1].</li><li>If rewardValues[i] is greater than your current total reward x, then add rewardValues[i] to x (i.e., x = x + rewardValues[i]), and mark the index i.</li></ul><p>Return an integer denoting the maximum total reward you can collect by performing the operations optimally.</p></blockquote><p>é¦–å…ˆï¼Œ<code>rewardValues</code>ä¸­çš„æ•°åº”è¯¥ä»å°åˆ°å¤§é€‰ï¼Œäºæ˜¯å¯ä»¥å¯¹å…¶è¿›è¡Œæ’åºã€‚æ’åºåï¼Œå¯ä»¥çœ‹ä½œ01èƒŒåŒ…é—®é¢˜å¤„ç†ï¼ŒèƒŒåŒ…çš„é‡é‡é™åˆ¶è½¬åŒ–æˆäº†<code>rewardValues[i]</code>ä¸reward<code>x</code>çš„åˆ¶çº¦å…³ç³»ã€‚å› æ­¤å®šä¹‰ <code>f[i][j]</code> è¡¨ç¤ºé€‰å–å‰<code>i</code>ä¸ª<code>rewardValues</code>ä¸‹<code>x</code>èƒ½è¾¾åˆ°çš„æœ€å¤§å€¼<code>j</code>ã€‚ç”±äº<code>x</code>æ‰€èƒ½è¾¾åˆ°çš„æœ€å¤§å€¼ä¸ç¡®å®šï¼Œåœ¨å®ç°ä¸­åº”é€‰å–ä¸€ä¸ªå°½å¯èƒ½å¤§çš„å€¼ã€‚</p><p>è€ƒè™‘è½¬ç§»ï¼Œå¯¹äº<code>f[i][j]</code>ï¼Œæ˜¯å¦é€‰æ‹©<code>rewardValues[i]</code>ï¼š</p><ul><li>ä¸é€‰ï¼Œ<code>f[i][j] = f[i-1][j]</code>ï¼Œå³åˆ†æ•°ä¸ä¸Šè½®ç›¸åŒã€‚</li><li>é€‰æ‹©ï¼Œ<code>f[i][j] = f[i-1][j-rewardValues[i]]</code>ï¼Œå³ä¸Šä¸€è½®çš„åˆ†æ•° <code>j-rewardValues[i]</code> å¿…é¡»æ»¡è¶³ <code>j-rewardValues[i]&lt;rewardValues[i]</code>, åŒæ—¶ä¸ºé˜²æ­¢è¶Šç•Œï¼Œ<code>j-rewardValues[i]</code>éœ€è¦å¤§äºç­‰äº0ã€‚ç»¼ä¸Šï¼Œéœ€æ»¡è¶³ <code>rewardValues[i] &lt;= j &lt; 2*rewardValues[i]</code>ã€‚</li></ul><p>è¿™é‡Œç”±äº<code>f[i][j]</code>ä¸éœ€è¦å­˜å‚¨â€œä»·å€¼â€ï¼Œ<code>j</code>è‡ªç„¶è¡¨ç¤ºäº†å¯ä»¥è¾¾åˆ°çš„æœ€å¤§å€¼ï¼Œå› æ­¤<code>f[i][j]</code>é€šè¿‡å¸ƒå°”å€¼è¡¨ç¤ºæ˜¯å¦å¯è¾¾å³å¯ï¼Œåˆ™æœ‰<code>f[i][j] = f[i-1][j] || f[i-1][j-rewardValues[i]]</code>ã€‚</p><p>å†™å‡ºäºŒç»´è§£æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxTotalReward</span><span class="params">(<span class="keyword">int</span>[] rewardValues)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = rewardValues.length;</span><br><span class="line">        <span class="keyword">int</span> m = <span class="number">10000</span>;</span><br><span class="line">        <span class="comment">// int m = Integer.MAX_VALUE;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯¹ç‰©å“ä»å°åˆ°å¤§æ’åº</span></span><br><span class="line">        Arrays.sort(rewardValues);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…¨éƒ¨åˆå§‹åŒ–ä¸ºfalse</span></span><br><span class="line">        <span class="keyword">boolean</span>[][] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[n][m];</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ç¬¬ä¸€è¡Œ</span></span><br><span class="line">        dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="keyword">true</span>; <span class="comment">// ä¸é€‰</span></span><br><span class="line">        dp[<span class="number">0</span>][rewardValues[<span class="number">0</span>]] = <span class="keyword">true</span>; <span class="comment">// é€‰</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼€å§‹è®¡ç®—dpæ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)&#123;</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–ç¬¬ä¸€åˆ—ï¼Œå³ä¸€ç›´ä¸é€‰ã€‚</span></span><br><span class="line">            dp[i][<span class="number">0</span>] = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// å¯¹äº[1, rewardValues[i]]åŒºé—´ï¼Œå¤åˆ¶ä¸Šä¸€å±‚è¡¨ç¤ºå¯ä»¥ä¸é€‰ã€‚</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;rewardValues[i];j++)&#123;</span><br><span class="line">                dp[i][j] = dp[i-<span class="number">1</span>][j];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¯¹äºå¯é€‰å–åŒºé—´ï¼Œè®¡ç®—æ–°å¾—åˆ†ã€‚</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=rewardValues[i];j&lt;<span class="number">2</span>*rewardValues[i];j++)&#123;</span><br><span class="line">                dp[i][j] = (dp[i-<span class="number">1</span>][j] || dp[i-<span class="number">1</span>][j-rewardValues[i]]);</span><br><span class="line">                <span class="comment">// if(dp[i][j]) System.out.println(i+&quot;, &quot;+j);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›æœ€åä¸€è¡Œçš„æœ€å¤§çœŸå€¼</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=m-<span class="number">1</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">            <span class="keyword">if</span>(dp[n-<span class="number">1</span>][i]) <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äºŒç»´è§£æ³•å¯¹äºæ•°æ®èŒƒå›´å¤§çš„æƒ…å†µä¼šå­˜åœ¨MLEï¼Œå› æ­¤å‚ç…§01èƒŒåŒ…é—®é¢˜ï¼Œè€ƒè™‘ä½¿ç”¨æ»šåŠ¨æ•°ç»„è¿›è¡Œä¼˜åŒ–ã€‚åŸè®¡ç®—å¯ä»¥ç®€åŒ–ä¸ºï¼š<code>f[j] = f[j] || f[j-rewardValues[i]]</code>ï¼ŒåŒæ—¶æ³¨æ„é€†åºéå†ã€‚å¦å¤–ï¼Œç”±äºæœ€ç»ˆç»“æœå¯ä»¥ç”±<code>j</code>çš„å€¼è¡¨ç¤ºï¼Œæ•…å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æ•°ç»„ä¸ºä½è¿ç®—ï¼Œé‡‡ç”¨ä¸€ä¸ª<code>BigInteger</code>è¡¨ç¤ºå¸ƒå°”æ•°ç»„ã€‚</p><p>ä¸‹é¢è€ƒè™‘å¦‚ä½•ç”¨ä½è¿ç®—è¡¨ç¤ºå¸ƒå°”è¿ç®—ï¼Œå‡è®¾ä¹‹å‰å·²ç»éå†è¿‡çš„å…ƒç´ ä¸º<code>1, 2, 3</code>ï¼Œåˆ™æ­¤æ—¶çŠ¶æ€åº”ä¸ºï¼š<code>0000 0011 1111</code>ï¼Œå³å¯è¾¾åˆ†æ•°åŒºé—´ä¸º<code>[0, 5]</code>ï¼Œæ­¤æ—¶å‡è®¾ä¸‹ä¸€ä¸ªå…ƒç´ ä¸º<code>5</code>ï¼Œåˆ™éœ€è¦å¯¹åŒºé—´<code>[5, 10)</code>è¿›è¡Œå¸ƒå°”è®¡ç®—ï¼Œè®¡ç®—çš„æœ¬è´¨æ˜¯å°†å½“å‰çŠ¶æ€çš„åŒºé—´<code>[0, 5)</code>ä¸åŒºé—´<code>[5, 10)</code>è¿›è¡Œ<code>or</code>è¿ç®—ã€‚å› æ­¤å¯ä»¥é€šè¿‡æ„é€ ä¸€ä¸ªâ€œ<em>æŠŠåŒºé—´<code>[0, 5)</code>ç§»åŠ¨åˆ°åŒºé—´<code>[5, 10)</code>ä½ç½®ä¸Šä¸”å…¶ä½™éƒ¨åˆ†ä¸º<code>0</code></em>â€çš„maskæ¥ä¸åŸçŠ¶æ€è¿›è¡Œ<code>or</code>è¿ç®—ï¼Œæ—¢è®¡ç®—äº†ç›®æ ‡åŒºé—´ï¼Œåˆä¸å½±å“å…¶ä»–çŠ¶æ€ã€‚æ„é€ çš„æ–¹æ³•æ˜¯å…ˆæ„é€ åŒºé—´<code>[0, 5)</code>ä¸Šå…¨ä¸º<code>1</code>çš„maskï¼Œè€Œåä¸åŸçŠ¶æ€è¿›è¡Œ<code>and</code>æ“ä½œæå–ç›®æ ‡åŒºé—´ï¼Œå†å°†ç›®æ ‡åŒºé—´å·¦ç§»åˆ°<code>[5, 10)</code>çš„ä½ç½®ä¸Šå¾—åˆ°æœ€ç»ˆçš„maskã€‚</p><p>å¯¹äºä¸Šé¢çš„ä¾‹å­æ¥è¯´ï¼Œæˆ‘ä»¬é¦–å…ˆæ„é€ ä¸€ä¸ªåˆå§‹mask<code>0000 0000 0001</code>ï¼Œè€Œåå¯¹å…¶å·¦ç§»<code>rewardValues[i]</code>ä½ï¼Œè¿™é‡Œå³$5$ä½ï¼Œå¾—åˆ°<code>0000 0001 0000</code>ï¼Œå‡$1$å¾—åˆ°ç›®æ ‡åŒºé—´å…¨çœŸå€¼mask<code>0000 0000 1111</code>ï¼Œå†å·¦ç§»<code>rewardValues[i]</code>ä½åˆ°ç›®æ ‡åŒºé—´ï¼Œå¾—åˆ°<code>0001 1110 0000</code>ï¼Œä¸åŸçŠ¶æ€è¿›è¡Œ<code>or</code>è¿ç®—ï¼Œå¾—åˆ°ï¼š<code>0001 1111 1111</code>ï¼Œå³å¯å–çš„åˆ†æ•°èŒƒå›´ä¸º<code>[0, 8]</code>ï¼Œç¬¦åˆé¢˜æ„ã€‚å‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxTotalReward</span><span class="params">(<span class="keyword">int</span>[] rewardValues)</span> </span>&#123;</span><br><span class="line">        BigInteger f = BigInteger.ONE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v : Arrays.stream(rewardValues).distinct().sorted().toArray()) &#123;</span><br><span class="line">            BigInteger mask = BigInteger.ONE.shiftLeft(v).subtract(BigInteger.ONE);</span><br><span class="line">            f = f.or(f.and(mask).shiftLeft(v));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> f.bitLength() - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜2-Find-the-Maximum-Length-of-a-Good-Subsequence"><a href="#ä¾‹é¢˜2-Find-the-Maximum-Length-of-a-Good-Subsequence" class="headerlink" title="ä¾‹é¢˜2: Find the Maximum Length of a Good Subsequence"></a>ä¾‹é¢˜2: Find the Maximum Length of a Good Subsequence</h2><blockquote><p>Find the Maximum Length of a Good Subsequence I &amp; II</p><p>You are given an integer array nums and a non-negative integer k. A sequence of integers seq is called good if there are at most k indices i in the range [0, seq.length - 2] such that seq[i] != seq[i + 1].</p><p>Return the maximum possible length of a good subsequence of nums.</p><p>A subsequence is an array that can be derived from another array by deleting some or no elements without changing the order of the remaining elements.</p></blockquote><p><code>Good Subsequence</code>é€šä¿—ç†è§£ä¸€ä¸‹å°±æ˜¯ä¸€ä¸ªæœ‰ä¸è¶…è¿‡<code>k</code>ä¸ª<strong>å‰åä¸ç›¸åŒå…ƒç´ å¯¹</strong>çš„å­åºåˆ—ï¼Œå³é¢˜ç›®éœ€è¦åœ¨å…ƒç´ å°½å¯èƒ½å°‘ä¸åŒçš„æƒ…å†µä¸‹ä½¿å­åºåˆ—å°½å¯èƒ½çš„é•¿ã€‚</p><p>è¿™é“01èƒŒåŒ…æ²¡æƒ³æ¸…æ¥šï¼Œå…ˆæ¥ç‰¹æ®Šæ€è·¯ï¼š<strong>å¤„ç†ç›¸é‚»å…ƒç´ ä¸åŒçš„DPé—®é¢˜</strong></p><p>æŠŠæœ‰$k$ä¸ªç›¸é‚»ä¸‹æ ‡å…ƒç´ ä¸åŒçš„å­åºåˆ—ç§°ä¸ºkåºåˆ—ã€‚ç”¨ $c n t[k]$ è®°å½•ä»¥ $x$ ç»“å°¾çš„ $k$ åºåˆ—çš„æœ€å¤§é•¿åº¦ã€‚è€ƒè™‘ä»¥ $nums[i]$ ç»“å°¾çš„ $k$ åºåˆ—, $nums [i]$ è¦ä¹ˆæ¥åœ¨ä»¥ $nums[i]$ ç»“å°¾çš„ $k$ åºåˆ—åï¼Œè¦ä¹ˆæ¥åœ¨æŸä¸ªä»¥ $n u m s<a href="j&lt;i">j</a>$ ç»“å°¾çš„ $k-1$ åºåˆ—åã€‚æ‰€ä»¥çŠ¶æ€è½¬ç§»æ–¹ç¨‹å³ä¸º</p><script type="math/tex; mode=display">\operatorname{cnt}[k][\operatorname{nums}[i]]=\max \left(\operatorname{cnt}[k][\operatorname{nums}[i]], \max _{j<i}\{\operatorname{cnt}[k-1][\operatorname{nums}[j]]\}\right)+1</script><p>è¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒæ˜¯å¦ $n u m s[j] \neq n u m s[i]$ ï¼Œå³ $k-1$ åºåˆ—æ˜¯å¦å·²ç»ä»¥ $nums[i]$ ç»“å°¾ï¼Œå› ä¸ºåœ¨åŒæ ·ä»¥ $nums[i]$ ç»“å°¾çš„æƒ…å†µä¸‹ï¼Œ $k-1$ åºåˆ—çš„é•¿åº¦ä¸€å®šå°äº $k$ åºåˆ—çš„é•¿åº¦ã€‚</p><p>$c n t[k-1]$ çš„æœ€å¤§å€¼å¯ä»¥åœ¨å“ˆå¸Œè¡¨åŸºç¡€ä¸Šç»´æŠ¤å€¼æœ‰åºæ¥å®ç°ã€‚ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¸éœ€è¦ç»´æŠ¤ $c n t[k-1]$ çš„æ‰€æœ‰å€¼, ç”±äº $k-1$ åºåˆ—çš„æœ€å¤§é•¿åº¦å•è°ƒä¸å‡, æ‰€ä»¥åªéœ€è¦ç»´æŠ¤ $c n t[k-1]$ çš„æœ€å¤§å€¼å°±å¯ä»¥äº†ã€‚</p><p>åœ¨ä¸€äº›è¦æ±‚ç›¸é‚»çŠ¶æ€ä¸åŒçš„DPé—®é¢˜ä¸­ï¼Œåœ¨å¤„ç†å½“å‰çŠ¶æ€æ—¶ï¼Œä¸ä¸€å®šéè¦ä¸æ‰€æœ‰å‰ç½®çŠ¶æ€æ¯”è¾ƒ, åªéœ€è¦è®°å½• $d p$ æœ€å¤§å’Œæ¬¡å¤§å€¼å¯¹åº”çš„å‰ç½®çŠ¶æ€å³å¯ã€‚è¿™æ ·çš„æ€è·¯åŒæ ·é€‚ç”¨äºæœ¬é¢˜ã€‚</p><p>æ³¨æ„ç”±äº$nums[i]$çš„èŒƒå›´æ¯”è¾ƒå¤§ï¼ŒJavaå®ç°çš„æ—¶å€™è¦ç”¨Mapæ¥å­˜é˜²æ­¢OOMã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maximumLength</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        Map&lt;Integer, Map&lt;Integer, Integer&gt;&gt; cnt = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span>[] mx = <span class="keyword">new</span> <span class="keyword">int</span>[k + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= k; i++) &#123;</span><br><span class="line">            cnt.put(i, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x : nums) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> kk = k; kk &gt;= <span class="number">0</span>; kk--) &#123;</span><br><span class="line">                <span class="comment">// è€ƒè™‘åˆ°æ›´æ–°é¡ºåºï¼Œéœ€è¦å€’åºæšä¸¾</span></span><br><span class="line">                <span class="keyword">int</span> currentValue = kk&gt;<span class="number">0</span>?mx[kk - <span class="number">1</span>]:<span class="number">0</span>;</span><br><span class="line">                currentValue = Math.max(currentValue, cnt.get(kk).getOrDefault(x, <span class="number">0</span>))+<span class="number">1</span>;</span><br><span class="line">                cnt.get(kk).put(x, currentValue);</span><br><span class="line">                mx[kk] = Math.max(mx[kk], cnt.get(kk).getOrDefault(x, <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getMax(mx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMax</span><span class="params">(<span class="keyword">int</span>[] mx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> value : mx) &#123;</span><br><span class="line">            max = Math.max(max, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] <a href="https://oi-wiki.org/dp">https://oi-wiki.org/dp</a><br>[2] <a href="https://leetcode.cn/problems/maximum-total-reward-using-operations-ii/solutions/2805413/bitset-you-hua-0-1-bei-bao-by-endlessche-m1xn/">https://leetcode.cn/problems/maximum-total-reward-using-operations-ii/solutions/2805413/bitset-you-hua-0-1-bei-bao-by-endlessche-m1xn/</a><br>[3] <a href="https://blog.csdn.net/txyyt_wst/article/details/130206572">https://blog.csdn.net/txyyt_wst/article/details/130206572</a><br>[4] <a href="https://blog.csdn.net/m0_46427179/article/details/107419492">https://blog.csdn.net/m0_46427179/article/details/107419492</a><br>[5] <a href="https://leetcode.cn/problems/find-the-maximum-length-of-a-good-subsequence-ii/solutions/2805181/chu-li-xiang-lin-yuan-su-bu-tong-de-dpwe-gobq/">https://leetcode.cn/problems/find-the-maximum-length-of-a-good-subsequence-ii/solutions/2805181/chu-li-xiang-lin-yuan-su-bu-tong-de-dpwe-gobq/</a></p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p><strong>å…³äºæœ€åä¸€ä¸ªä¾‹é¢˜æˆ‘è‡ªå·±çš„æ€è€ƒå¦‚ä¸‹ï¼ˆä¸çŸ¥é“ä¸ºä»€ä¹ˆæ˜¯é”™çš„ï¼‰ï¼Œæ²¡æ—¶é—´æµªè´¹äº†å…ˆå­˜æ¡£ä»¥åå†æ€è€ƒï¼Œå…ˆç†è§£æ­£ç¡®è§£æ³•ï¼š</strong></p><p><code>Good Subsequence</code>é€šä¿—ç†è§£ä¸€ä¸‹å°±æ˜¯ä¸€ä¸ªæœ‰ä¸è¶…è¿‡<code>k</code>ä¸ª<strong>å‰åä¸ç›¸åŒå…ƒç´ å¯¹</strong>çš„å­åºåˆ—ï¼Œå³é¢˜ç›®éœ€è¦åœ¨å…ƒç´ å°½å¯èƒ½å°‘ä¸åŒçš„æƒ…å†µä¸‹ä½¿å­åºåˆ—å°½å¯èƒ½çš„é•¿ã€‚</p><p>ç”±äº k æ˜¯éè´Ÿæ•´æ•°ï¼Œå› æ­¤é•¿åº¦ç­‰äº 1 çš„å­åºåˆ—ä¸€å®šæ˜¯å¥½å­åºåˆ—ã€‚å¯¹äºä»»æ„ä¸€ä¸ªå­åºåˆ—ï¼Œåœ¨åé¢æ·»åŠ ä¸€ä¸ªå…ƒç´ ä¹‹åï¼Œå­åºåˆ—çš„é•¿åº¦å¢åŠ  1ï¼Œç›¸é‚»ä¸åŒå…ƒç´ å¯¹çš„æ•°é‡ä¸å˜æˆ–å¢åŠ  1ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨åŠ¨æ€è§„åˆ’è®¡ç®—æœ€é•¿å¥½å­åºåˆ—çš„é•¿åº¦ã€‚</p><p>ç”±äºæ˜¯â€å­åºåˆ—â€œé—®é¢˜ï¼Œå…¶å®ä¹Ÿè¿˜æ˜¯ä»å…¨é›†ä¸­é€‰æ‹©è‹¥å¹²å…ƒç´ çš„é—®é¢˜ï¼Œç”±äºå…ƒç´ ä¸èƒ½é‡å¤é€‰ï¼Œåˆ™è¿˜æ˜¯0-1èƒŒåŒ…é—®é¢˜ã€‚è¿™é‡ŒèƒŒåŒ…çš„é‡é‡é™åˆ¶è½¬åŒ–ä¸º<strong>å‰åä¸ç›¸åŒå…ƒç´ å¯¹</strong>æ•°é‡çš„é™åˆ¶ï¼Œå¯¹äºå…ƒç´ <code>x = nums[i]</code>ï¼Œå®šä¹‰<code>dp[i][j]</code>ä¸ºéå†å‰<code>i</code>ä¸ªå…ƒç´ æ—¶<strong>å‰åä¸ç›¸åŒå…ƒç´ å¯¹</strong>æ•°é‡ä¸è¶…è¿‡<code>j</code>æ—¶çš„å­åºåˆ—æœ€å¤§é•¿åº¦ã€‚</p><p><strong>TODO:å¦‚æœå®šä¹‰ä¸ºå‰<code>i</code>ä¸ªå…ƒç´ ï¼Œåˆ™å®ç°æ—¶é‡åˆ°ç›¸ç­‰é•¿åº¦æƒ…å†µåº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿå³dp[a][j]==dp[b][j]ï¼Œå¦‚æœåªå–æœ€åä¸€ä¸ªï¼Œé‚£ä¹ˆåé¢å’Œdp[?][j-1]æ¯”çš„æ—¶å€™ä¹Ÿæ˜¯ç›¸åŒäº¦å¯ï¼Ÿ</strong></p><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹å¦‚ä½•å®šä¹‰ï¼Œå‚è€ƒ01èƒŒåŒ…é—®é¢˜ï¼Œâ€œå‰iä¸ªå…ƒç´ â€ä¸€è‡´ï¼Œâ€œèƒŒåŒ…å®¹é‡â€ä¸â€œå‰åä¸ç›¸åŒå…ƒç´ å¯¹æ•°é‡â€ä¸€è‡´ï¼Œä¸”æ­¤çº¦æŸæ¡ä»¶åº”è½¬æ¢ä¸ºä¸è¶…è¿‡<code>j</code>è€Œä¸æ˜¯ç­‰äº<code>j</code>ã€‚</p><p>åˆ™å¯¹äº<code>x</code>çš„é€‰å–åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><ol><li>ä¸é€‰ï¼Œ<code>dp[i][j] = dp[i-1][j]</code>ï¼›</li><li>é€‰æ‹©ï¼Œä¸”<code>x</code>ä¸å­åºåˆ—çš„å‰ä¸€ä¸ªæ•°ç›¸åŒï¼Œåˆ™<code>dp[i][j] = dp[?][j]+1</code>ï¼›</li><li>é€‰æ‹©ï¼Œä¸”<code>x</code>ä¸å­åºåˆ—çš„å‰ä¸€ä¸ªæ•°ä¸åŒï¼Œåˆ™<code>dp[i][j] = dp[?][j-1]+1</code>ã€‚</li></ol><p>è¿™é‡Œä½¿ç”¨äº†<code>?</code>æ¥è¡¨ç¤ºå‰ä¸€ä¸ªæ•°<code>y</code>çš„ä¸‹æ ‡ï¼Œ<code>y</code>éœ€è¦é€šè¿‡éå†å¾—åˆ°ã€‚</p><p>ç”±æ­¤å¯ä»¥å¾—åˆ°çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸ºï¼š</p><ul><li>æƒ…å†µAï¼ˆä¸é€‰ï¼‰ï¼š<code>dp[i][j] = dp[i-1][j]+1</code></li><li>æƒ…å†µBï¼ˆé€‰ï¼‰ï¼š<code>dp[i][j] = max(dp[?][j], dp[?][j-1])+1</code></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;æ–°å¼€ä¸€ä¸ªç³»åˆ—ï¼ŒLeetCodeåˆ·é¢˜å‘¨è®°ï¼Œæ¯å‘¨åˆ·é¢˜æœ‰æ„Ÿæ‚Ÿå¯ä»¥æ€»ç»“ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬å‘¨ä¸»é¢˜ï¼šè®°å¿†åŒ–æœç´¢ã€åŠ¨æ€è§„åˆ’ã€01èƒŒåŒ…&lt;/p&gt;
&lt;p&gt;é¢˜ç›®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;240609æ¯æ—¥ä¸€é¢˜â€”&lt;a href=&quot;https://leetcode.cn/problems/burst-balloons/description/&quot;&gt;Burst Balloons&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;240608åŒå‘¨èµ›æœ€åä¸¤é¢˜â€”&lt;a href=&quot;https://leetcode.cn/problems/find-the-maximum-length-of-a-good-subsequence-ii/description/&quot;&gt;Find the Maximum Length of a Good Subsequence&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;240609å‘¨èµ›æœ€åä¸¤é¢˜â€”&lt;a href=&quot;https://leetcode.cn/problems/maximum-total-reward-using-operations-ii/description/&quot;&gt;Maximum Total Reward Using Operations&lt;/a&gt;</summary>
    
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://silencezheng.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    <category term="LeetCode" scheme="http://silencezheng.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>LeetCodeå‘¨è®° EP7</title>
    <link href="http://silencezheng.top/2024/08/07/article131/"/>
    <id>http://silencezheng.top/2024/08/07/article131/</id>
    <published>2024-08-07T06:28:14.000Z</published>
    <updated>2024-08-19T16:23:04.104Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å›å›½äº†ï¼Œå¼€å§‹å¥½å¥½å‡†å¤‡æ‰¾å·¥ã€‚</p><p>æœ¬å‘¨ä¸»é¢˜ï¼šå¿«é€Ÿå¹‚</p><p>é¢˜ç›®ï¼š</p><ul><li>240730æ¯æ—¥ä¸€é¢˜â€”<a href="https://leetcode.cn/problems/double-modular-exponentiation/description">Double Modular Exponentiation</a><span id="more"></span></li></ul><h1 id="å¿«é€Ÿå¹‚"><a href="#å¿«é€Ÿå¹‚" class="headerlink" title="å¿«é€Ÿå¹‚"></a>å¿«é€Ÿå¹‚</h1><p>ã€Œå¿«é€Ÿå¹‚ç®—æ³•ã€çš„æœ¬è´¨æ˜¯åˆ†æ²»ç®—æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬è¦è®¡ç®— $x^{64}$ ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ï¼š</p><script type="math/tex; mode=display">x \rightarrow x^2 \rightarrow x^4 \rightarrow x^8 \rightarrow x^{16} \rightarrow x^{32} \rightarrow x^{64}</script><p>çš„é¡ºåºï¼Œä» $x$ å¼€å§‹ï¼Œæ¯æ¬¡ç›´æ¥æŠŠä¸Šä¸€æ¬¡çš„ç»“æœè¿›è¡Œå¹³æ–¹ï¼Œè®¡ç®— 6 æ¬¡å°±å¯ä»¥å¾—åˆ° $x^{64}$ çš„å€¼ï¼Œè€Œä¸éœ€è¦å¯¹ $x$ ä¹˜ 63 æ¬¡ $x$ ã€‚</p><p>å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬è¦è®¡ç®— $x^{77}$ ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ï¼š</p><script type="math/tex; mode=display">x \rightarrow x^2 \rightarrow x^4 \rightarrow x^9 \rightarrow x^{19} \rightarrow x^{38} \rightarrow x^{77}</script><p>çš„é¡ºåº, åœ¨ $x \rightarrow x^2, x^2 \rightarrow x^4, x^{19} \rightarrow x^{38}$ è¿™äº›æ­¥éª¤ä¸­, æˆ‘ä»¬ç›´æ¥æŠŠä¸Šä¸€æ¬¡çš„ç»“æœè¿›è¡Œå¹³æ–¹ï¼Œè€Œåœ¨ $x^4 \rightarrow x^9, x^9 \rightarrow x^{19}, x^{38} \rightarrow x^{77}$ è¿™äº›æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬æŠŠä¸Šä¸€æ¬¡çš„ç»“æœè¿›è¡Œå¹³æ–¹åï¼Œè¿˜è¦é¢å¤–ä¹˜ä¸€ä¸ª $x$ ã€‚</p><p>ç›´æ¥ä»å·¦åˆ°å³è¿›è¡Œæ¨å¯¼çœ‹ä¸Šå»å¾ˆå›°éš¾ï¼Œå› ä¸ºåœ¨æ¯ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬ä¸çŸ¥é“åœ¨å°†ä¸Šä¸€æ¬¡çš„ç»“æœå¹³æ–¹ä¹‹å, è¿˜éœ€ä¸éœ€è¦é¢å¤–ä¹˜ $x$ ã€‚ä½†å¦‚æœæˆ‘ä»¬ä»å³å¾€å·¦çœ‹, åˆ†æ²»çš„æ€æƒ³å°±ååˆ†æ˜æ˜¾äº†ï¼š</p><ul><li>å½“æˆ‘ä»¬è¦è®¡ç®— $x^n$ æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€’å½’åœ°è®¡ç®—å‡º $y=x^{\lfloor n / 2\rfloor}$ ï¼Œå…¶ä¸­ $\lfloor a\rfloor$è¡¨ç¤ºå¯¹ $a$ è¿›è¡Œä¸‹å–æ•´ï¼›</li><li>æ ¹æ®é€’å½’è®¡ç®—çš„ç»“æœ, å¦‚æœ $n$ ä¸ºå¶æ•°, é‚£ä¹ˆ $x^n=y^2$; å¦‚æœ $n$ ä¸ºå¥‡æ•°,é‚£ä¹ˆ $x^n=y^2 \times x$ ï¼›</li><li>é€’å½’çš„è¾¹ç•Œä¸º $n=0$, ä»»æ„æ•°çš„ 0 æ¬¡æ–¹å‡ä¸º 1 ã€‚</li></ul><p>ç”±äºæ¯æ¬¡é€’å½’éƒ½ä¼šä½¿å¾—æŒ‡æ•°å‡å°‘ä¸€åŠï¼Œå› æ­¤é€’å½’çš„å±‚æ•°ä¸º O(logn)ï¼Œç®—æ³•å¯ä»¥åœ¨å¾ˆå¿«çš„æ—¶é—´å†…å¾—åˆ°ç»“æœã€‚</p><p>ä¸‹é¢æ˜¯å¿«é€Ÿå¹‚ç®—æ³•çš„é€’å½’å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">myPow</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> N = n;</span><br><span class="line">        <span class="keyword">return</span> N &gt;= <span class="number">0</span> ? quickMul(x, N) : <span class="number">1.0</span> / quickMul(x, -N);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">quickMul</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">long</span> N)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> y = quickMul(x, N / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> N % <span class="number">2</span> == <span class="number">0</span> ? y * y : y * y * x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿›ä¸€æ­¥ï¼Œç”±äºé€’å½’éœ€è¦ä½¿ç”¨é¢å¤–çš„æ ˆç©ºé—´ï¼Œæˆ‘ä»¬è¯•ç€å°†é€’å½’è½¬å†™ä¸ºè¿­ä»£ã€‚æˆ‘ä»¬è¿˜æ˜¯ä»¥ $x^{77}$ ä½œä¸ºä¾‹å­ï¼š</p><script type="math/tex; mode=display">x \rightarrow x^2 \rightarrow x^4 \rightarrow^{+} x^9 \rightarrow^{+} x^{19} \rightarrow x^{38} \rightarrow^{+} x^{77}</script><p>å¹¶ä¸”æŠŠéœ€è¦é¢å¤–ä¹˜ $x$ çš„æ­¥éª¤æ‰“ä¸Šäº† + æ ‡è®°ã€‚å¯ä»¥å‘ç°ï¼š</p><ul><li>$x^{38} \rightarrow^{+} x^{77}$ ä¸­é¢å¤–ä¹˜çš„ $x$ åœ¨ $x^{77}$ ä¸­è´¡çŒ®äº† $x$ ï¼›</li><li>$x^9 \rightarrow^{+} x^{19}$ ä¸­é¢å¤–ä¹˜çš„ $x$ åœ¨ä¹‹åè¢«å¹³æ–¹äº† 2 æ¬¡ï¼Œå› æ­¤åœ¨ $x^{77}$ ä¸­è´¡çŒ®äº† $x^{2^2}=x^4$</li><li>$x^4 \rightarrow^{+} x^9$ ä¸­é¢å¤–ä¹˜çš„ $x$ åœ¨ä¹‹åè¢«å¹³æ–¹äº† 3 æ¬¡ï¼Œå› æ­¤åœ¨ $x^{77}$ ä¸­è´¡çŒ®äº† $x^{2^3}=x^8$</li><li>æœ€åˆçš„ $x$ åœ¨ä¹‹åè¢«å¹³æ–¹äº† 6 æ¬¡ï¼Œå› æ­¤åœ¨ $x^{77}$ ä¸­è´¡çŒ®äº† $x^{2^6}=x^{64}$ ã€‚</li></ul><p>æˆ‘ä»¬æŠŠè¿™äº›è´¡çŒ®ç›¸ä¹˜ï¼Œ $x \times x^4 \times x^8 \times x^{64}$ æ°å¥½ç­‰äº $x^{77}$ ã€‚è€Œè¿™äº›è´¡çŒ®çš„æŒ‡æ•°éƒ¨åˆ†åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒä»¬éƒ½æ˜¯ 2 çš„å¹‚æ¬¡ï¼Œè¿™æ˜¯å› ä¸ºæ¯ä¸ªé¢å¤–ä¹˜çš„ $x$ åœ¨ä¹‹åéƒ½ä¼šè¢«å¹³æ–¹è‹¥å¹²æ¬¡ã€‚è€Œè¿™äº›æŒ‡æ•° $1 ï¼Œ 4 ï¼Œ 8$ å’Œ $64 ï¼Œ$ æ°å¥½å°±å¯¹åº”äº† 77 çš„äºŒè¿›åˆ¶è¡¨ç¤º $(1001101)_2$ ä¸­çš„æ¯ä¸ª 1 ï¼</p><p>å› æ­¤æˆ‘ä»¬å€ŸåŠ©æ•´æ•°çš„äºŒè¿›åˆ¶æ‹†åˆ†ï¼Œå°±å¯ä»¥å¾—åˆ°è¿­ä»£è®¡ç®—çš„æ–¹æ³•ï¼Œä¸€èˆ¬åœ°ï¼Œå¦‚æœæ•´æ•° $n$ çš„äºŒè¿›åˆ¶æ‹†åˆ†ä¸º</p><script type="math/tex; mode=display">n=2^{i_0}+2^{i_1}+\cdots+2^{i_k}</script><p>é‚£ä¹ˆ</p><script type="math/tex; mode=display">x^n=x^{2^{i_0}} \times x^{2^{i_1}} \times \cdots \times x^{2^{i_k}}</script><p>è¿™æ ·ä»¥æ¥, æˆ‘ä»¬ä» $x$ å¼€å§‹ä¸æ–­åœ°è¿›è¡Œå¹³æ–¹, å¾—åˆ° $x^2, x^4, x^8, x^{16}, \cdots$, å¦‚æœ $n$çš„ç¬¬ $k$ ä¸ªï¼ˆä»å³å¾€å·¦ï¼Œä» 0 å¼€å§‹è®¡æ•°ï¼‰äºŒè¿›åˆ¶ä½ä¸º 1 ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°†å¯¹åº”çš„è´¡çŒ® $x^{2^k}$ è®¡å…¥ç­”æ¡ˆã€‚</p><p>ä¸‹é¢æ˜¯å¿«é€Ÿå¹‚çš„è¿­ä»£å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">myPow</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> N = n;</span><br><span class="line">        <span class="keyword">return</span> N &gt;= <span class="number">0</span> ? quickMul(x, N) : <span class="number">1.0</span> / quickMul(x, -N);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">quickMul</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">long</span> N)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> ans = <span class="number">1.0</span>;</span><br><span class="line">        <span class="comment">// è´¡çŒ®çš„åˆå§‹å€¼ä¸º x0</span></span><br><span class="line">        <span class="keyword">double</span> x_contribute = x;</span><br><span class="line">        <span class="comment">// åœ¨å¯¹ N è¿›è¡ŒäºŒè¿›åˆ¶æ‹†åˆ†çš„åŒæ—¶è®¡ç®—ç­”æ¡ˆ</span></span><br><span class="line">        <span class="keyword">while</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (N % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ N äºŒè¿›åˆ¶è¡¨ç¤ºçš„æœ€ä½ä½ä¸º 1ï¼Œé‚£ä¹ˆéœ€è¦è®¡å…¥è´¡çŒ®</span></span><br><span class="line">                ans *= x_contribute;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†è´¡çŒ®ä¸æ–­åœ°å¹³æ–¹</span></span><br><span class="line">            x_contribute *= x_contribute;</span><br><span class="line">            <span class="comment">// èˆå¼ƒ N äºŒè¿›åˆ¶è¡¨ç¤ºçš„æœ€ä½ä½ï¼Œè¿™æ ·æˆ‘ä»¬æ¯æ¬¡åªè¦åˆ¤æ–­æœ€ä½ä½å³å¯</span></span><br><span class="line">            N /= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="ä¾‹é¢˜ï¼šDouble-Modular-Exponentiation"><a href="#ä¾‹é¢˜ï¼šDouble-Modular-Exponentiation" class="headerlink" title="ä¾‹é¢˜ï¼šDouble Modular Exponentiation"></a>ä¾‹é¢˜ï¼šDouble Modular Exponentiation</h2><blockquote><p>Double Modular Exponentiation</p><p>You are given a 0-indexed 2D array variables where variables[i] = [ai, bi, ci, mi], and an integer target.</p><p>An index i is good if the following formula holds:</p><ul><li>0 &lt;= i &lt; variables.length</li><li>((ai^bi % 10)^ci) % mi == target</li></ul><p>Return an array consisting of good indices in any order.</p></blockquote><p>è®¡ç®—å¼ä¸­é‡å¤å‡ºç°çš„æ¨¡å¼æ˜¯â€œå¹‚+å–æ¨¡â€ï¼Œäºæ˜¯å¯ä»¥æŠŠå¿«é€Ÿå¹‚å’Œå–æ¨¡èåˆåœ¨ä¸€èµ·ã€‚</p><p>å¦ä¸€ä¸ªçŸ¥è¯†ç‚¹æ˜¯â€œåŠ æ³•å’Œä¹˜æ³•â€çš„å–æ¨¡ï¼Œæœ‰å¦‚ä¸‹å…¬å¼ï¼š<br>$(a+b) \bmod m=((a \bmod m)+(b \bmod m)) \bmod m$ $(a \cdot b) \bmod m=((a \bmod m) \cdot(b \bmod m)) \bmod m$</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è®¡ç®—è¿‡ç¨‹ä¸­ï¼ˆä¾‹å¦‚å¾ªç¯ï¼‰ï¼Œå¯¹åŠ æ³•å’Œä¹˜æ³•çš„ç»“æœå–æ¨¡ï¼Œè€Œä¸æ˜¯åœ¨å¾ªç¯ç»“æŸåå†å–æ¨¡ã€‚</p><p>æ›´å¤šæ¨¡ç›¸å…³çš„å†…å®¹è¯·çœ‹ï¼š<a href="https://leetcode.cn/circle/discuss/mDfnkW/">https://leetcode.cn/circle/discuss/mDfnkW/</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getGoodIndices</span><span class="params">(<span class="keyword">int</span>[][] variables, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; ans = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; variables.length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span>[] v = variables[i];</span><br><span class="line">            <span class="keyword">if</span> (powMod(powMod(v[<span class="number">0</span>], v[<span class="number">1</span>], <span class="number">10</span>), v[<span class="number">2</span>], v[<span class="number">3</span>]) == target) &#123;</span><br><span class="line">                ans.add(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">powMod</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> mod)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// (a*b) mod c = ((a mod c) * (b mod c)) mod c</span></span><br><span class="line">        <span class="keyword">while</span> (y != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((y &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                res = res * x % mod;</span><br><span class="line">            &#125;</span><br><span class="line">            x = x * x % mod;</span><br><span class="line">            y &gt;&gt;= <span class="number">1</span>; <span class="comment">// ç›¸å½“äºy/=2</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] <a href="https://leetcode.cn/circle/discuss/mDfnkW/">https://leetcode.cn/circle/discuss/mDfnkW/</a><br>[2] <a href="https://leetcode.cn/problems/powx-n/solutions/238559/powx-n-by-leetcode-solution/">https://leetcode.cn/problems/powx-n/solutions/238559/powx-n-by-leetcode-solution/</a></p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å›å›½äº†ï¼Œå¼€å§‹å¥½å¥½å‡†å¤‡æ‰¾å·¥ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬å‘¨ä¸»é¢˜ï¼šå¿«é€Ÿå¹‚&lt;/p&gt;
&lt;p&gt;é¢˜ç›®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;240730æ¯æ—¥ä¸€é¢˜â€”&lt;a href=&quot;https://leetcode.cn/problems/double-modular-exponentiation/description&quot;&gt;Double Modular Exponentiation&lt;/a&gt;</summary>
    
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://silencezheng.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    <category term="LeetCode" scheme="http://silencezheng.top/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>æ ‘çŠ¶æ•°ç»„ï¼ˆé€Ÿé£Ÿç‰ˆï¼‰</title>
    <link href="http://silencezheng.top/2024/06/06/article130/"/>
    <id>http://silencezheng.top/2024/06/06/article130/</id>
    <published>2024-06-05T19:43:00.000Z</published>
    <updated>2024-06-05T19:44:07.539Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å¿«é€Ÿè®¡ç®—ä»»æ„è¿ç»­å­æ•°ç»„å…ƒç´ å’Œçš„æ•°æ®ç»“æ„ã€‚</p><p>æ ‘çŠ¶æ•°ç»„æˆ–äºŒå…ƒç´¢å¼•æ ‘ï¼ˆè‹±è¯­ï¼šBinary Indexed Treeï¼‰ï¼Œåˆä»¥å…¶å‘æ˜è€…å‘½åä¸º<br>Fenwickæ ‘ã€‚æœ€æ—©ç”± PeterM.Fenwickäº1994å¹´ä»¥ ã€ŠA New Data Structure for Cumulative Frequency Tablesã€‹ä¸ºé¢˜å‘è¡¨åœ¨ ã€ŠSOFTWARE PRACTICE AND EXPERIENCEã€‹ã€‚<br><span id="more"></span></p><h1 id="æ ‘çŠ¶æ•°ç»„"><a href="#æ ‘çŠ¶æ•°ç»„" class="headerlink" title="æ ‘çŠ¶æ•°ç»„"></a>æ ‘çŠ¶æ•°ç»„</h1><blockquote><p>ç»™ä½ ä¸€ä¸ªæ•°ç»„ï¼Œå¦‚ä½•å¿«é€Ÿåœ°è®¡ç®—ä»»æ„ä¸€æ®µè¿ç»­å­æ•°ç»„çš„å…ƒç´ å’Œï¼Ÿ</p></blockquote><p><img src="/assets/post_img/article130/szsz.png" alt="bit"></p><h2 id="èµ·æº"><a href="#èµ·æº" class="headerlink" title="èµ·æº"></a>èµ·æº</h2><p>ä¸‹æ ‡ä» $left$ åˆ° $right$ çš„å­æ•°ç»„å…ƒç´ å’Œï¼Œå¯ä»¥çœ‹æˆæ˜¯ä¸‹æ ‡ä» 1 åˆ° $right$ çš„å­æ•°ç»„å…ƒç´ å’Œï¼Œå‡å»ä¸‹æ ‡ä» 1 åˆ° $leftâˆ’1$ çš„å­æ•°ç»„å…ƒç´ å’Œã€‚ä¾‹å¦‚æ•°ç»„ [3,1,4,1,5,9]ï¼Œå­æ•°ç»„ [4,1,5] çš„å…ƒç´ å’Œï¼Œç­‰äº [3,1,4,1,5] çš„å…ƒç´ å’Œï¼Œå‡å» [3,1] çš„å…ƒç´ å’Œã€‚</p><p>æŒ‰ç…§è¿™ä¸ªæ–¹æ³•ï¼Œç®—å‡ºæ¯ä¸ªå‰ç¼€ [1,i]ï¼ˆè¡¨ç¤ºä¸‹æ ‡ä» 1 åˆ° i çš„è¿ç»­å­æ•°ç»„ï¼‰çš„å…ƒç´ å’Œï¼Œå°±å¯ä»¥ $O(1)$ åœ°æŸ¥è¯¢ï¼ˆè®¡ç®—ä»»æ„è¿ç»­å­æ•°ç»„çš„å…ƒç´ å’Œï¼‰äº†ã€‚</p><h2 id="å¦‚æœæ›´æ–°å‘¢ï¼Ÿ"><a href="#å¦‚æœæ›´æ–°å‘¢ï¼Ÿ" class="headerlink" title="å¦‚æœæ›´æ–°å‘¢ï¼Ÿ"></a>å¦‚æœæ›´æ–°å‘¢ï¼Ÿ</h2><p>å¦‚æœä¿®æ”¹ä¸‹æ ‡ä¸º1çš„å…ƒç´ ï¼Œåˆ™æ‰€æœ‰å‰ç¼€éƒ½éœ€è¦æ›´æ–°ï¼ˆå› ä¸ºæ‰€æœ‰å‰ç¼€åŒ…å«è¯¥å…ƒç´ ï¼‰ï¼Œæ„å‘³ç€æ›´æ–°æ“ä½œæ—¶é—´å¤æ‚åº¦ä¸º$O(n)$ã€‚æ­¤æ—¶æŸ¥è¯¢ä¸æ›´æ–°çš„ç»¼åˆæ—¶é—´å¤æ‚åº¦è¿˜æ˜¯$O(n)$ã€‚</p><p>è‡ªç„¶çš„ï¼Œæƒ³åˆ°åº”è¯¥å°†å‰ç¼€å…ƒç´ å’Œç»§ç»­è¿›è¡Œæ‹†åˆ†ï¼Œä»¤æ›´æ–°æŸå…ƒç´ æ—¶ï¼Œä»…å½±å“éƒ¨åˆ†â€œå­å‰ç¼€â€ï¼Œæ­¤æ—¶åªéœ€è¦æ›´æ–°å½±å“åˆ°çš„éƒ¨åˆ†å³å¯ã€‚</p><p>å› æ­¤ï¼Œéœ€è¦æ‰¾åˆ°ä¸€ç§åˆé€‚çš„æ‹†åˆ†æ–¹æ³•ï¼Œèƒ½å¤ŸæŠŠä»»æ„å‰ç¼€æ‹†åˆ†æˆè‹¥å¹²<strong>å­å‰ç¼€</strong>ï¼Œä½¿æ›´æ–°æ“ä½œçš„æ‰§è¡ŒèŒƒå›´ç¼©å°åˆ°éƒ¨åˆ†å­å‰ç¼€ä¸­ã€‚</p><h2 id="å¯¹äºæƒ³ç»§ç»­æ¢ç´¢çš„åŒå­¦"><a href="#å¯¹äºæƒ³ç»§ç»­æ¢ç´¢çš„åŒå­¦" class="headerlink" title="å¯¹äºæƒ³ç»§ç»­æ¢ç´¢çš„åŒå­¦"></a>å¯¹äºæƒ³ç»§ç»­æ¢ç´¢çš„åŒå­¦</h2><p>æ¨èæ–‡çŒ®[3]ï¼Œè¾ƒä¸ºå…¨é¢çš„é˜è¿°äº†æ ‘çŠ¶æ•°ç»„çš„æ¥ä¸–ä»Šç”Ÿï¼Œæœ¬æ–‡ä»¥è®©è¯»è€…å°½å¿«æŒæ¡ç”¨æ³•ä¸ºä¸»ï¼Œä¸è¿‡å¤šå±•å¼€æ·±å…¥ã€‚</p><h2 id="lowbit"><a href="#lowbit" class="headerlink" title="lowbit"></a>lowbit</h2><p>BITçš„é‡è¦æ¦‚å¿µï¼ŒæŠ›å¼€ç›¸å…³æ€§è´¨ä¸è°ˆï¼Œå…ˆè¯´è®¡ç®—ï¼Œlowbit(x)è¡¨ç¤ºå–æ•°xçš„æœ€ä½ä½1ï¼Œå¸¸ç”¨<code>lowbit(x) = x &amp; -x</code>è®¡ç®—ã€‚</p><p>ä¸¾ä¾‹ï¼š<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">x</span> <span class="operator">=</span> <span class="number">1010</span><span class="punctuation">,</span> lowbit(<span class="keyword">x</span>) <span class="operator">=</span> <span class="keyword">x</span> &amp; -<span class="keyword">x</span> <span class="operator">=</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">è®¡ç®—è¿‡ç¨‹ï¼š</span><br><span class="line">   <span class="keyword">x</span> <span class="operator">=</span> <span class="number">1010</span></span><br><span class="line">  -<span class="keyword">x</span> <span class="operator">=</span> <span class="number">0110</span></span><br><span class="line"><span class="keyword">x</span>&amp;-<span class="keyword">x</span> <span class="operator">=</span> <span class="number">0010</span></span><br></pre></td></tr></table></figure></p><h2 id="æ ‘çŠ¶æ•°ç»„-c-n-çš„æŸ¥è¯¢ä¸æ›´æ–°"><a href="#æ ‘çŠ¶æ•°ç»„-c-n-çš„æŸ¥è¯¢ä¸æ›´æ–°" class="headerlink" title="æ ‘çŠ¶æ•°ç»„ c[n] çš„æŸ¥è¯¢ä¸æ›´æ–°"></a>æ ‘çŠ¶æ•°ç»„ <code>c[n]</code> çš„æŸ¥è¯¢ä¸æ›´æ–°</h2><p>å¯¹äºåŸæ•°ç»„<code>a[n]</code>æ„å»ºå¯¹åº”çš„æ ‘çŠ¶æ•°ç»„<code>c[n]</code>ï¼Œå¯æ¨å¯¼å¾—å‡ºï¼š<code>c[x] = a[x-lowbit(x)+1] + ... + a[x]</code>ï¼Œå³åŒºé—´<code>[x-lowbit(x)+1, x]</code>çš„å…ƒç´ å’Œã€‚</p><p>å®šä¹‰<code>query(x)</code>ä¸ºæŸ¥è¯¢åŸæ•°ç»„åŒºé—´<code>[1, x]</code>ä¸Šçš„å…ƒç´ å’Œï¼Œåˆ™å¯å†™å‡ºåˆ©ç”¨<code>c[n]</code>å®ç°$O(logn)$çš„æŸ¥è¯¢ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å‡å»æ‰€æœ‰çš„lowbitåiä¸º0</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = x; i ; i -= lowbit(i))</span><br><span class="line">            ans += c[i];</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (x &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        ans += c[x];</span><br><span class="line">        x -= lowbit(x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰<code>add(x, v)</code>ä¸ºä¿®æ”¹ä½ç½®ä¸ºåœ¨ç´¢å¼•<code>x</code>çš„å…ƒç´ ï¼ŒåŠ ä¸Š<code>v</code>ã€‚åˆ™å¯å†™å‡ºåˆ©ç”¨<code>c[n]</code>å®ç°$O(logn)$çš„æ›´æ–°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// n = æ ‘çŠ¶æ•°ç»„é•¿åº¦</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (x &lt;= n)&#123;</span><br><span class="line">        c[x] += v;</span><br><span class="line">        x += lowbit(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå†…å®¹å¾ˆå¥½ç†è§£ï¼ŒæŠ“ä½<code>c[x]</code>çš„å®šä¹‰å°±è¡Œäº†ã€‚</p><h2 id="æ ‘çŠ¶æ•°ç»„-c-n-çš„æ„é€ "><a href="#æ ‘çŠ¶æ•°ç»„-c-n-çš„æ„é€ " class="headerlink" title="æ ‘çŠ¶æ•°ç»„ c[n] çš„æ„é€ "></a>æ ‘çŠ¶æ•°ç»„ <code>c[n]</code> çš„æ„é€ </h2><p>æœ€ç®€å•çš„ï¼Œéå†åŸæ•°ç»„ï¼Œè°ƒç”¨<code>n</code>æ¬¡<code>add</code>æ–¹æ³•è¿›è¡Œæ„é€ ï¼Œæ—¶é—´å¤æ‚åº¦$O(nlogn)$ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">        add(i, a[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ›´å¿«é€Ÿçš„ï¼Œè€ƒè™‘<code>c[x]</code>è¡¨ç¤ºåŸæ•°ç»„åŒºé—´<code>[x-lowbit(x)+1, x]</code>çš„å…ƒç´ å’Œï¼Œå¯ä»¥å…ˆå¯¹åŸæ•°ç»„æ±‚ä¸€ä¸ªå‰ç¼€å’Œæ•°ç»„<code>s[n]</code>ï¼Œåˆ©ç”¨å‰ç¼€å’Œæ¥æ›´æ–°æ ‘çŠ¶æ•°ç»„ï¼Œå³<code>c[x] = s[x] - s[x-lowbit(x)]</code>ï¼Œæ­¤æ—¶æ„é€ çš„æ—¶é—´å¤æ‚åº¦ä¸º$O(n)$ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) <span class="comment">// æ±‚açš„å‰ç¼€å’Œ</span></span><br><span class="line">        s[i] = s[i - <span class="number">1</span>] + a[i];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) <span class="comment">// ç”¨å‰ç¼€å’Œæ±‚å‡ºc</span></span><br><span class="line">c[i] = s[i] - s[i - lowbit(i)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ‹†åˆ†è§„åˆ™â€”é€†åº"><a href="#æ‹†åˆ†è§„åˆ™â€”é€†åº" class="headerlink" title="æ‹†åˆ†è§„åˆ™â€”é€†åº"></a>æ‹†åˆ†è§„åˆ™â€”é€†åº</h2><p>æŒ‰ç…§é€†åºå¤„ç†ï¼Œæ¯æ¬¡å¤„ç†çš„bitéƒ½æ˜¯å½“å‰ç¼–å·çš„æœ€åçš„ä¸º1ä½ã€‚å°†æ¯æ¬¡å¤„ç†çš„bitå®šä¹‰ä¸º<strong>lowbit</strong>ã€‚</p><p>å¯¹äºå‰ç¼€ $[1,i]$ï¼š</p><ul><li>å¦‚æœ $i$ æ˜¯ 2 çš„å¹‚ï¼Œé‚£ä¹ˆ $[1,i]$ æ— éœ€æ‹†åˆ†ã€‚</li><li>å¦‚æœ $i$ ä¸æ˜¯ 2 çš„å¹‚ï¼Œé‚£ä¹ˆå…ˆæ‹†åˆ†å‡ºä¸€ä¸ªé•¿ä¸º $lowbit(i)$ çš„å…³é”®åŒºé—´ $[iâˆ’lowbit(i)+1,i]$ï¼Œé—®é¢˜è½¬æ¢æˆå‰©ä¸‹çš„ $[1,iâˆ’lowbit(i)]$ å¦‚ä½•æ‹†åˆ†ï¼Œè¿™æ˜¯ä¸€ä¸ªè§„æ¨¡æ›´å°çš„å­é—®é¢˜ã€‚</li></ul><h1 id="ä¾‹é¢˜ä¸€ï¼šåˆ†æ•°å­—åˆ°ä¸¤ä¸ªæ•°ç»„"><a href="#ä¾‹é¢˜ä¸€ï¼šåˆ†æ•°å­—åˆ°ä¸¤ä¸ªæ•°ç»„" class="headerlink" title="ä¾‹é¢˜ä¸€ï¼šåˆ†æ•°å­—åˆ°ä¸¤ä¸ªæ•°ç»„"></a>ä¾‹é¢˜ä¸€ï¼š<a href="https://leetcode.cn/problems/distribute-elements-into-two-arrays-ii/description/">åˆ†æ•°å­—åˆ°ä¸¤ä¸ªæ•°ç»„</a></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinaryIndexedTree</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] tree;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lowbit</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> i &amp; -i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BinaryIndexedTree</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        tree = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; tree.length) &#123;</span><br><span class="line">            tree[i]++;</span><br><span class="line">            i += lowbit(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            sum += tree[i];</span><br><span class="line">            i -= lowbit(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] resultArray(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">        <span class="keyword">int</span> n = nums.length;</span><br><span class="line">        <span class="keyword">int</span>[] sortedNums = Arrays.copyOf(nums, n);</span><br><span class="line">        Arrays.sort(sortedNums);</span><br><span class="line"></span><br><span class="line">        Map&lt;Integer, Integer&gt; index = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            index.put(sortedNums[i], i + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; arr1 = <span class="keyword">new</span> ArrayList&lt;&gt;(List.of(nums[<span class="number">0</span>]));</span><br><span class="line">        List&lt;Integer&gt; arr2 = <span class="keyword">new</span> ArrayList&lt;&gt;(List.of(nums[<span class="number">1</span>]));</span><br><span class="line">        BinaryIndexedTree tree1 = <span class="keyword">new</span> BinaryIndexedTree(n);</span><br><span class="line">        BinaryIndexedTree tree2 = <span class="keyword">new</span> BinaryIndexedTree(n);</span><br><span class="line">        tree1.add(index.get(nums[<span class="number">0</span>]));</span><br><span class="line">        tree2.add(index.get(nums[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> count1 = arr1.size() - tree1.get(index.get(nums[i]));</span><br><span class="line">            <span class="keyword">int</span> count2 = arr2.size() - tree2.get(index.get(nums[i]));</span><br><span class="line">            <span class="keyword">if</span> (count1 &gt; count2 || (count1 == count2 &amp;&amp; arr1.size() &lt;= arr2.size())) &#123;</span><br><span class="line">                arr1.add(nums[i]);</span><br><span class="line">                tree1.add(index.get(nums[i]));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                arr2.add(nums[i]);</span><br><span class="line">                tree2.add(index.get(nums[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> a: arr1) &#123;</span><br><span class="line">            nums[i++] = a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> a: arr2) &#123;</span><br><span class="line">            nums[i++] = a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nums;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] <a href="https://leetcode.cn/problems/range-sum-query-mutable/solutions/2524481/dai-ni-fa-ming-shu-zhuang-shu-zu-fu-shu-lyfll/">https://leetcode.cn/problems/range-sum-query-mutable/solutions/2524481/dai-ni-fa-ming-shu-zhuang-shu-zu-fu-shu-lyfll/</a><br>[2] <a href="https://blog.csdn.net/qq_63786973/article/details/127416700">https://blog.csdn.net/qq_63786973/article/details/127416700</a><br>[3] <a href="https://www.cnblogs.com/Last--Whisper/p/13823614.html">https://www.cnblogs.com/Last--Whisper/p/13823614.html</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å¿«é€Ÿè®¡ç®—ä»»æ„è¿ç»­å­æ•°ç»„å…ƒç´ å’Œçš„æ•°æ®ç»“æ„ã€‚&lt;/p&gt;
&lt;p&gt;æ ‘çŠ¶æ•°ç»„æˆ–äºŒå…ƒç´¢å¼•æ ‘ï¼ˆè‹±è¯­ï¼šBinary Indexed Treeï¼‰ï¼Œåˆä»¥å…¶å‘æ˜è€…å‘½åä¸º&lt;br&gt;Fenwickæ ‘ã€‚æœ€æ—©ç”± PeterM.Fenwickäº1994å¹´ä»¥ ã€ŠA New Data Structure for Cumulative Frequency Tablesã€‹ä¸ºé¢˜å‘è¡¨åœ¨ ã€ŠSOFTWARE PRACTICE AND EXPERIENCEã€‹ã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://silencezheng.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>æ’åˆ—ç»„åˆ</title>
    <link href="http://silencezheng.top/2024/06/01/article129/"/>
    <id>http://silencezheng.top/2024/06/01/article129/</id>
    <published>2024-06-01T12:59:03.000Z</published>
    <updated>2024-08-23T17:06:48.025Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ’åˆ—ç»„åˆè®¡ç®—å…¬å¼æ¨å¯¼åŠä»£ç å®ç°ã€‚<br><span id="more"></span></p><h1 id="åŠ æ³•åŸç†ã€ä¹˜æ³•åŸç†"><a href="#åŠ æ³•åŸç†ã€ä¹˜æ³•åŸç†" class="headerlink" title="åŠ æ³•åŸç†ã€ä¹˜æ³•åŸç†"></a>åŠ æ³•åŸç†ã€ä¹˜æ³•åŸç†</h1><p><strong>åˆ†ç±»è®¡æ•°åŸç†</strong>ï¼šå®Œæˆä¸€ä»¶äº‹æƒ…ï¼Œå­˜åœ¨$n$ç±»æ–¹æ³•ï¼Œç¬¬1ç±»æœ‰$m_1$ç§æ–¹å¼ï¼Œç¬¬2ç±»æœ‰$m_2$ç§æ–¹å¼ï¼Œâ€¦ï¼Œç¬¬$n$ç±»æœ‰$m_n$ç§æ–¹å¼ï¼Œåˆ™å®Œæˆæ­¤äº‹å…±æœ‰$N = m_1 + m_2 + â€¦ + m_n$ç§ä¸åŒæ–¹æ³•ã€‚ </p><p><strong>åˆ†æ­¥è®¡æ•°åŸç†</strong>ï¼šè‹¥å®ŒæˆæŸäº‹éœ€ç»è¿‡$n$ä¸ªæ­¥éª¤ï¼Œç¬¬1æ­¥æœ‰$m_1$ç§æ–¹æ³•ï¼Œç¬¬2æ­¥æœ‰$m_2$ç§æ–¹æ³•ï¼Œâ€¦ï¼Œç¬¬$n$æ­¥æœ‰$m_n$ç§æ–¹æ³•ï¼Œåˆ™æ€»å…±æœ‰$N = m_1 \times m_2 \times \cdots \times m_n$ç§ä¸åŒæ–¹æ³•ã€‚</p><p><strong>åŒºåˆ«</strong>ï¼šåˆ†ç±»è®¡æ•°åŸç†æ˜¯åŠ æ³•è§„åˆ™ï¼Œå„ç±»æ–¹æ³•æ•°ç›¸åŠ æ±‚å’Œï¼›åˆ†æ­¥è®¡æ•°åŸç†æ˜¯ä¹˜æ³•è§„åˆ™ï¼Œå„æ­¥éª¤æ–¹æ³•æ•°ç›¸ä¹˜å¾—æ€»æ•°ã€‚</p><h1 id="æ’åˆ—ï¼ˆArrangementï¼‰"><a href="#æ’åˆ—ï¼ˆArrangementï¼‰" class="headerlink" title="æ’åˆ—ï¼ˆArrangementï¼‰"></a>æ’åˆ—ï¼ˆArrangementï¼‰</h1><h2 id="æ’åˆ—æ•°"><a href="#æ’åˆ—æ•°" class="headerlink" title="æ’åˆ—æ•°"></a>æ’åˆ—æ•°</h2><p>ä»$n$ä¸ªä¸åŒå…ƒç´ ä¸­é€‰å–$m(m \leq n)$ä¸ªå…ƒç´ çš„æ‰€æœ‰ä¸åŒæ’åˆ—çš„ä¸ªæ•°ï¼Œå«åšä»$n$ä¸ªä¸åŒå…ƒç´ ä¸­é€‰å–$m$ä¸ªå…ƒç´ çš„æ’åˆ—æ•°ï¼Œè®°ä½œ$\mathrm{A}_n^m$ã€‚ </p><h2 id="æ’åˆ—æ•°å…¬å¼"><a href="#æ’åˆ—æ•°å…¬å¼" class="headerlink" title="æ’åˆ—æ•°å…¬å¼"></a>æ’åˆ—æ•°å…¬å¼</h2><script type="math/tex; mode=display">\mathrm{A}_n^m = n(n-1)(n-2)\cdots(n-m+1) = \frac{n!}{(n-m)!}, \quad n, m \in \mathbb{N}^*, m \leq n</script><p>æ¨å¯¼ï¼šä»$n$ä¸ªä¸åŒå…ƒç´ ä¸­é€‰å–$m$ä¸ªå…ƒç´ è¿›è¡Œæ’åºï¼ŒæŒ‰è®¡æ•°åŸç†åˆ†å¸ƒè¿›è¡Œï¼Œå–ç¬¬ä¸€ä¸ªæœ‰$n$ç§å–æ³•ï¼Œå–ç¬¬äºŒä¸ªæœ‰$n-1$ç§å–æ³•â€¦å–ç¬¬$m$ä¸ªæœ‰$n-m+1$ç§å–æ³•ï¼Œæ ¹æ®åˆ†æ­¥ä¹˜æ³•åŸç†æ¨å¯¼å‡ºä¸Šå¼ã€‚</p><h2 id="æ’åˆ—æ•°æ€§è´¨"><a href="#æ’åˆ—æ•°æ€§è´¨" class="headerlink" title="æ’åˆ—æ•°æ€§è´¨"></a>æ’åˆ—æ•°æ€§è´¨</h2><ul><li>$\mathrm{A}_n^m = n\mathrm{A}_{n-1}^{m-1}$ï¼šä¸ºâ€œæŸç‰¹å®šä½ç½®â€å…ˆå®‰æ’ï¼Œå†å®‰æ’å…¶ä½™ä½ç½®ã€‚</li><li>$\mathrm{A}_n^m = m\mathrm{A}_{n-1}^{m-1} + \mathrm{A}_{n-1}^m$ï¼šå«ç‰¹å®šå…ƒç´ çš„æ’åˆ—æœ‰$m\mathrm{A}_{n-1}^{m-1}$ç§ï¼Œä¸å«ç‰¹å®šå…ƒç´ çš„æ’åˆ—æœ‰$\mathrm{A}_{n-1}^m$ç§ã€‚</li></ul><h1 id="ç»„åˆï¼ˆCombinationï¼‰"><a href="#ç»„åˆï¼ˆCombinationï¼‰" class="headerlink" title="ç»„åˆï¼ˆCombinationï¼‰"></a>ç»„åˆï¼ˆCombinationï¼‰</h1><h2 id="ç»„åˆæ•°"><a href="#ç»„åˆæ•°" class="headerlink" title="ç»„åˆæ•°"></a>ç»„åˆæ•°</h2><p>ä»$n$ä¸ªä¸åŒå…ƒç´ ä¸­é€‰å–$m$ï¼ˆ$m \leq n$ï¼‰ä¸ªå…ƒç´ çš„æ‰€æœ‰ä¸åŒç»„åˆçš„æ•°ç›®ï¼Œç§°ä¸ºä»$n$ä¸ªä¸åŒå…ƒç´ ä¸­å–å‡º$m$ä¸ªå…ƒç´ çš„ç»„åˆæ•°ï¼Œç”¨ç¬¦å·$\mathrm{C}_n^m$è¡¨ç¤ºã€‚</p><h2 id="ç»„åˆæ•°å…¬å¼"><a href="#ç»„åˆæ•°å…¬å¼" class="headerlink" title="ç»„åˆæ•°å…¬å¼"></a>ç»„åˆæ•°å…¬å¼</h2><script type="math/tex; mode=display">\mathrm{C}_n^m=\frac{\mathrm{A}_n^m}{\mathrm{A}_m^m}=\frac{n(n-1)(n-2)\cdots(n-m+1)}{m!}=\frac{n!}{m!(n-m)!},\quad n,m\in \mathbb{N}^*,m\leq n</script><script type="math/tex; mode=display">\mathrm{C}_n^0=\mathrm{C}_n^n=1</script><p>è¯æ˜ï¼šé€šè¿‡æ’åˆ—ä¸ç»„åˆçš„å…³ç³»ä»¥åŠæ’åˆ—å…¬å¼æ¨å¯¼è¯æ˜ã€‚</p><p>å°†æ’åˆ—é—®é¢˜$\mathrm{A}_n^m$åˆ†ä¸ºä¸¤æ­¥ï¼š</p><ol><li><p><strong>ç¬¬ä¸€æ­¥</strong>ï¼šä»$n$ä¸ªçƒä¸­æŠ½å–$m$ä¸ªï¼Œä¸è€ƒè™‘é¡ºåºï¼Œå³ç»„åˆé—®é¢˜$\mathrm{C}_n^m$ï¼›</p></li><li><p><strong>ç¬¬äºŒæ­¥</strong>ï¼šå°†æŠ½å‡ºçš„$m$ä¸ªçƒæ’åºï¼Œå³å…¨æ’åˆ—$\mathrm{A}_m^m$ã€‚</p></li></ol><p>ä¾æ®ä¹˜æ³•åŸç†ï¼Œ$\mathrm{A}_n^m=\mathrm{C}_n^m \mathrm{A}_m^m$ï¼Œå› æ­¤</p><script type="math/tex; mode=display">\mathrm{C}_n^m=\frac{\mathrm{A}_n^m}{\mathrm{A}_m^m}=\frac{n(n-1)(n-2)\cdots(n-m+1)}{m!}=\frac{n!}{m!(n-m)!}</script><h2 id="ç»„åˆæ•°çš„æ€§è´¨"><a href="#ç»„åˆæ•°çš„æ€§è´¨" class="headerlink" title="ç»„åˆæ•°çš„æ€§è´¨"></a>ç»„åˆæ•°çš„æ€§è´¨</h2><ul><li>$\mathrm{C}_n^m = \mathrm{C}_n^{n-m}$ï¼šåè½¬ç»„åˆï¼Œæœªé€‰çš„å˜é€‰ï¼Œé€‰äº†çš„å˜æœªé€‰ï¼Œç»„åˆæ•°ç›¸åŒã€‚</li><li>é€’æ¨å…¬å¼$\mathrm{C}_n^m=\mathrm{C}_{n-1}^m+\mathrm{C}_{n-1}^{m-1}$ï¼šå«ç‰¹å®šå…ƒç´ ç»„åˆæ•°ä¸º$\mathrm{C}_{n-1}^{m-1}$ï¼Œä¸å«ç‰¹å®šå…ƒç´ ç»„åˆæ•°ä¸º$\mathrm{C}_{n-1}^m$ã€‚</li></ul><p><strong>ç¤ºä¾‹</strong><br>ä»¤ï¼ˆ$n=5$ï¼‰ï¼Œ($m=2$)ã€‚</p><p>ä»1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ä¸­å–å‡º2ä¸ªå…ƒç´ çš„ç»„åˆ$\mathrm{C}_n^m$ï¼š</p><p>12 13 14 15 23 24 25 34 35 45</p><p>è¿™äº›ç»„åˆè¦ä¹ˆå«â€1â€ï¼Œè¦ä¹ˆä¸å«ã€‚</p><ul><li>å«â€1â€çš„ç»„åˆï¼š12 13 14 15 â†’ æŒ–å»â€1â€å¾—2 3 4 5 â†’ ç­‰ä»·äºä»2ï¼Œ3ï¼Œ4ï¼Œ5ä¸­å–å‡º1ä¸ªå…ƒç´ çš„ç»„åˆã€‚ï¼ˆæ­¤å¤„m-1ä¸º1ï¼‰</li><li>ä¸å«â€1â€çš„ç»„åˆï¼š23 24 25 34 35 45 â†’ ç­‰ä»·äºä»2ï¼Œ3ï¼Œ4ï¼Œ5ä¸­å–å‡º2ä¸ªå…ƒç´ çš„ç»„åˆã€‚ï¼ˆæ­¤å¤„mä¸º2ï¼‰</li></ul><p>æ€»æ–¹æ¡ˆæ•°æ˜¯ä¸Šè¿°ä¸¤ç§æƒ…å†µçš„å’Œï¼Œå³$\mathrm{C}_n^m=\mathrm{C}_{n-1}^m+\mathrm{C}_{n-1}^{m-1}$ã€‚</p><h2 id="ç»„åˆæ•°æ±‚å’Œå…¬å¼"><a href="#ç»„åˆæ•°æ±‚å’Œå…¬å¼" class="headerlink" title="ç»„åˆæ•°æ±‚å’Œå…¬å¼"></a>ç»„åˆæ•°æ±‚å’Œå…¬å¼</h2><script type="math/tex; mode=display">\sum_{i=0}^{n} \mathrm{C}_n^i=2^n</script><p>ç›´è§‚ç†è§£ï¼šä»$n$ä¸ªçƒä¸­æŠ½å–0åˆ°$n$ä¸ªçƒçš„ç»„åˆæ•°ä¹‹å’Œã€‚</p><p>ä¸¥è°¨è¯æ˜å¯é‡‡ç”¨æ•°å­¦å½’çº³æ³•ï¼š</p><ol><li>å½“$n=1$ï¼Œ$\mathrm{C}_1^0+\mathrm{C}_1^1=2=2$æˆç«‹ã€‚</li><li>å‡è®¾$n=k$æ—¶å…¬å¼æˆç«‹ï¼Œ$\sum_{i=0}^{k} \mathrm{C}_k^i=2^n$ï¼Œåˆ™$n=k+1$æ—¶äº¦æˆç«‹ã€‚</li><li>ç”±1ã€2å½’çº³å¾—å…¬å¼å¯¹æ‰€æœ‰$n\in \mathbb{N}^*$æˆç«‹ã€‚</li></ol><p>æˆ–ç”¨äºŒé¡¹å¼å®šç†ç®€è¯ï¼š</p><script type="math/tex; mode=display">(a+b)^n=\sum_{k=0}^{n}\mathrm{C}_n^k a^{n-k}b^k</script><p>è®¾$a=b=1$ï¼Œ</p><script type="math/tex; mode=display">\sum_{i=0}^{n} \mathrm{C}_n^i=2^n</script><h3 id="ç›¸å…³å…¬å¼"><a href="#ç›¸å…³å…¬å¼" class="headerlink" title="ç›¸å…³å…¬å¼"></a>ç›¸å…³å…¬å¼</h3><p>ç”±$\mathrm{C}_n^m = \mathrm{C}_n^{n-m}$æ¨å¯¼ï¼š</p><script type="math/tex; mode=display">\mathrm{C}_n^0 + \mathrm{C}_n^2 + \mathrm{C}_n^4 + ... = \mathrm{C}_n^1 + \mathrm{C}_n^3 + \mathrm{C}_n^5 + ... =2^{n-1}</script><h2 id="Javaï¼šç»„åˆæ±‚å’Œ"><a href="#Javaï¼šç»„åˆæ±‚å’Œ" class="headerlink" title="Javaï¼šç»„åˆæ±‚å’Œ"></a>Javaï¼šç»„åˆæ±‚å’Œ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">factorialWithRecursion</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span> || n == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> n * factorialWithRecursion(n - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">combination</span><span class="params">(<span class="keyword">long</span> n, <span class="keyword">long</span> m)</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> numerator = factorialWithRecursion(n);</span><br><span class="line">    <span class="keyword">long</span> denominator1 = factorialWithRecursion(m);</span><br><span class="line">    <span class="keyword">long</span> denominator2 = factorialWithRecursion(n-m);</span><br><span class="line">    <span class="keyword">return</span> numerator/(denominator1*denominator2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ‹“å±•ï¼šç»„åˆæ•°çš„åŠ æƒæ±‚å’Œå…¬å¼"><a href="#æ‹“å±•ï¼šç»„åˆæ•°çš„åŠ æƒæ±‚å’Œå…¬å¼" class="headerlink" title="æ‹“å±•ï¼šç»„åˆæ•°çš„åŠ æƒæ±‚å’Œå…¬å¼"></a>æ‹“å±•ï¼šç»„åˆæ•°çš„åŠ æƒæ±‚å’Œå…¬å¼</h2><script type="math/tex; mode=display">\sum_{i=0}^{n} i \binom{n}{i} = n \cdot 2^{n-1}</script><p>é€šå¸¸è¢«ç§°ä¸º <strong>ç»„åˆæ•°çš„åŠ æƒæ±‚å’Œå…¬å¼</strong> æˆ–è€… <strong>ç»„åˆæ•°çš„åŠ æƒå’Œå…¬å¼</strong>ã€‚è¿™ä¸ªå…¬å¼ç”¨äºè®¡ç®—ç»„åˆæ•° $\binom{n}{i}$ ä¸ä¸‹æ ‡ $i$ çš„ä¹˜ç§¯ä¹‹å’Œã€‚</p><h3 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h3><ul><li><strong>äºŒé¡¹å¼ç³»æ•°</strong>ï¼š$\binom{n}{i}$ æ˜¯ä» $n$ ä¸ªå…ƒç´ ä¸­é€‰æ‹© $i$ ä¸ªå…ƒç´ çš„ä¸åŒæ–¹å¼çš„æ•°é‡ã€‚</li><li><strong>äºŒé¡¹å¼å®šç†</strong>ï¼š$\sum_{i=0}^{n} \binom{n}{i} = 2^n$ï¼Œè¡¨ç¤ºæ‰€æœ‰äºŒé¡¹å¼ç³»æ•°çš„å’Œç­‰äº $2^n$ã€‚</li></ul><h3 id="è¯æ˜"><a href="#è¯æ˜" class="headerlink" title="è¯æ˜"></a>è¯æ˜</h3><ol><li><strong>ç®€åŒ–æ±‚å’Œ</strong>ï¼šä» $i=1$ å¼€å§‹æ±‚å’Œï¼Œå› ä¸º $i=0$ æ—¶ $i \binom{n}{i} = 0$ã€‚</li><li><strong>åˆ©ç”¨ç»„åˆæ•°æ€§è´¨</strong>ï¼š$i \binom{n}{i} = n \binom{n-1}{i-1}$ã€‚</li><li><strong>æ”¹å˜æ±‚å’Œå˜é‡</strong>ï¼šä»¤ $j = i-1$ï¼Œåˆ™ $i = j + 1$ã€‚</li><li><strong>åˆ©ç”¨äºŒé¡¹å¼å®šç†</strong>ï¼š$\sum_{j=0}^{n-1} \binom{n-1}{j} = 2^{n-1}$ã€‚</li></ol><p>æœ€ç»ˆå¾—åˆ°å…¬å¼ï¼š</p><script type="math/tex; mode=display">\sum_{i=0}^{n} i \binom{n}{i} = n \cdot 2^{n-1}</script><p>è¿™ä¸ªå…¬å¼æ˜¯ç»„åˆæ•°å­¦ä¸­çš„ä¸€ä¸ªé‡è¦ç»“è®ºï¼Œæœ‰åŠ©äºå¿«é€Ÿè®¡ç®—ç»„åˆæ•°çš„åŠ æƒæ±‚å’Œã€‚</p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] <a href="https://www.cnblogs.com/1024th/p/10623541.html">https://www.cnblogs.com/1024th/p/10623541.html</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;æ’åˆ—ç»„åˆè®¡ç®—å…¬å¼æ¨å¯¼åŠä»£ç å®ç°ã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="http://silencezheng.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>MyBatis-Plusä¹‹é¢„å®šä¹‰CRUD</title>
    <link href="http://silencezheng.top/2024/03/24/article128/"/>
    <id>http://silencezheng.top/2024/03/24/article128/</id>
    <published>2024-03-24T08:54:43.000Z</published>
    <updated>2024-08-19T15:18:57.831Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ¢ç©¶MyBatis Plusæä¾›çš„é¢„å®šä¹‰CRUDæ¥å£çš„å®ç°æ–¹å¼ã€‚<br><span id="more"></span></p><h1 id="ä¸¤ç§æ–¹å¼"><a href="#ä¸¤ç§æ–¹å¼" class="headerlink" title="ä¸¤ç§æ–¹å¼"></a>ä¸¤ç§æ–¹å¼</h1><p>MBPæä¾›ä¸¤ç§åŒ…å«é¢„å®šä¹‰CRUDçš„æ¥å£ï¼š</p><ol><li><code>com.baomidou.mybatisplus.extension.service.IService</code></li><li><code>com.baomidou.mybatisplus.core.mapper.BaseMapper</code></li></ol><p>å…¶ä¸­<code>IService</code>æ¥å£æ˜¯é’ˆå¯¹ä¸šåŠ¡é€»è¾‘å±‚çš„å°è£…ï¼Œå¹¶æä¾›äº†æ‰¹å¤„ç†æ“ä½œã€‚<code>BaseMapper</code>åˆ™æ˜¯å¯¹DAOå±‚CRUDçš„å°è£…ã€‚</p><h1 id="BaseMapper"><a href="#BaseMapper" class="headerlink" title="BaseMapper"></a>BaseMapper</h1><p><code>BaseMapper</code>çš„æ¥å£è§„èŒƒå¾ˆç®€å•ï¼Œçœ‹ä»£ç å°±èƒ½æ˜ç™½ï¼Œé‡ç‚¹æ˜¯äº†è§£MBPå¦‚ä½•å®ç°çš„<code>BaseMapper</code>ã€‚</p><p>åœ¨ä½¿ç”¨MyBatisçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å®šä¹‰äº†Mapperæ¥å£ï¼Œç„¶åä¼šåœ¨å¯¹åº”çš„XMLæ–‡ä»¶ä¸­æä¾›åŠ¨æ€SQLåŠæ˜ å°„å…³ç³»ï¼Œæˆ–è€…ç›´æ¥åœ¨Mapperæ¥å£æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ï¼ŒMyBatiså°†XMLä¸­çš„é…ç½®æˆ–è€…æ³¨è§£ä½œä¸ºå…ƒæ•°æ®è¿›è¡Œè§£æï¼Œç„¶åå°†è§£æåçš„SQLè¯­å¥å­˜è‡³<code>org.apache.ibatis.session.Configuration</code>ã€‚MBPåœ¨MyBatisçš„åŸºç¡€ä¸Šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œåˆ™åªè¦èƒ½å¤Ÿå®ç°åŸpipelineå°†å…ƒæ•°æ®è§£ææˆåŠ¨æ€SQLå­˜è‡³<code>org.apache.ibatis.session.Configuration</code>å³å¯ã€‚</p><p>MyBatis Plusçš„æ•´ä½“æ€è·¯æ˜¯ä½¿ç”¨è‡ªå·±çš„ç»„ä»¶æ›¿æ¢MyBatisä¸­çš„ç»„ä»¶ï¼Œä»¥å®ç°è‡ªå®šä¹‰çš„é€»è¾‘ã€‚å…¶ä¸­<code>MybatisPlusAutoConfiguration</code>ç±»æ›¿ä»£äº†MyBatisçš„è‡ªåŠ¨é…ç½®ç±»ï¼Œè¿™ä¸ªç±»ä¸­åŒ…å«<code>MybatisPlusProperties</code>å±æ€§ã€‚<code>MybatisPlusProperties</code>åŒ…å«<code>mapperLocations</code>å­—æ®µç”¨äºè§£æMapper XMLæ–‡ä»¶çš„ä½ç½®ï¼Œå¹¶æ±‡æ€»ä¸º<code>Resource</code>æ•°ç»„ã€‚</p><p>åœ¨<code>MybatisPlusAutoConfiguration#sqlSessionFactory</code>å‡½æ•°ä¸­ï¼ŒåŒ…å«XMLä½ç½®çš„<code>Resource</code>æ•°ç»„è¢«è®¾ç½®åˆ°<code>MybatisSqlSessionFactoryBean.mapperLocations</code>ä¸‹ï¼ˆ<code>MybatisSqlSessionFactoryBean</code>ä¹Ÿæ˜¯MBPæ›¿æ¢ç»„ä»¶ï¼‰ã€‚è€Œååœ¨<code>MybatisSqlSessionFactoryBean#buildSqlSessionFactory</code>å‡½æ•°ä¸­ï¼ŒXMLæ–‡ä»¶è¢«é€ä¸ªè¯»å–å¹¶è§£æã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.mapperLocations != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.mapperLocations.length == <span class="number">0</span>) &#123;</span><br><span class="line">        LOGGER.warn(() -&gt; <span class="string">&quot;Property &#x27;mapperLocations&#x27; was specified but matching resources are not found.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Resource mapperLocation : <span class="keyword">this</span>.mapperLocations) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mapperLocation == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                XMLMapperBuilder xmlMapperBuilder = <span class="keyword">new</span> XMLMapperBuilder(mapperLocation.getInputStream(),</span><br><span class="line">                    targetConfiguration, mapperLocation.toString(), targetConfiguration.getSqlFragments());</span><br><span class="line">                xmlMapperBuilder.parse();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NestedIOException(<span class="string">&quot;Failed to parse mapping resource: &#x27;&quot;</span> + mapperLocation + <span class="string">&quot;&#x27;&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ErrorContext.instance().reset();</span><br><span class="line">            &#125;</span><br><span class="line">            LOGGER.debug(() -&gt; <span class="string">&quot;Parsed mapper file: &#x27;&quot;</span> + mapperLocation + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    LOGGER.debug(() -&gt; <span class="string">&quot;Property &#x27;mapperLocations&#x27; was not specified.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>XMLMapperBuilder</code>åœ¨è§£æè¿‡ç¨‹ä¸­ä¼šè°ƒç”¨<code>XMLMapperBuilder#bindMapperForNamespace</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindMapperForNamespace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String namespace = <span class="keyword">this</span>.builderAssistant.getCurrentNamespace();</span><br><span class="line">    <span class="keyword">if</span> (namespace != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; boundType = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            boundType = Resources.classForName(namespace);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var4) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (boundType != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.configuration.hasMapper(boundType)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.configuration.addLoadedResource(<span class="string">&quot;namespace:&quot;</span> + namespace);</span><br><span class="line">            <span class="keyword">this</span>.configuration.addMapper(boundType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„<code>configuration</code>ä¸º<code>MybatisSqlSessionFactoryBean</code>ä¼ å…¥çš„<code>targetConfiguration</code>ï¼Œå³<code>MybatisConfiguration</code>ï¼ˆMBPæ›¿æ¢ç»„ä»¶ï¼‰ã€‚æ­¤æ—¶<code>MybatisMapperRegistry#addMapper</code>è°ƒç”¨<code>MybatisMapperRegistry#addMapper</code>æ–¹æ³•ã€‚</p><p><code>MybatisMapperRegistry</code>ä¹Ÿæ˜¯ä¸€ä¸ªMBPæ›¿æ¢ç»„ä»¶ï¼Œç»§æ‰¿å¹¶æ›¿æ¢æ‰åŸæœ¬çš„<code>MapperRegistry</code>ï¼Œå…¶<code>addMapper</code>æ–¹æ³•å¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (type.isInterface()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.hasMapper(type)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> loadCompleted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.knownMappers.put(type, <span class="keyword">new</span> MybatisMapperProxyFactory(type));</span><br><span class="line">            MybatisMapperAnnotationBuilder parser = <span class="keyword">new</span> MybatisMapperAnnotationBuilder(<span class="keyword">this</span>.config, type);</span><br><span class="line">            parser.parse();</span><br><span class="line">            loadCompleted = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!loadCompleted) &#123;</span><br><span class="line">                <span class="keyword">this</span>.knownMappers.remove(type);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨MBPè‡ªå®šä¹‰çš„<code>MybatisMapperAnnotationBuilder#parse</code>æ–¹æ³•ï¼Œå¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String resource = type.toString();</span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">        loadXmlResource();</span><br><span class="line">        configuration.addLoadedResource(resource);</span><br><span class="line">        String mapperName = type.getName();</span><br><span class="line">        assistant.setCurrentNamespace(mapperName);</span><br><span class="line">        parseCache();</span><br><span class="line">        parseCacheRef();</span><br><span class="line">        InterceptorIgnoreHelper.InterceptorIgnoreCache cache = InterceptorIgnoreHelper.initSqlParserInfoCache(type);</span><br><span class="line">        <span class="keyword">for</span> (Method method : type.getMethods()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!canHaveStatement(method)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (getAnnotationWrapper(method, <span class="keyword">false</span>, Select.class, SelectProvider.class).isPresent()</span><br><span class="line">                &amp;&amp; method.getAnnotation(ResultMap.class) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                parseResultMap(method);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                InterceptorIgnoreHelper.initSqlParserInfoCache(cache, mapperName, method);</span><br><span class="line">                parseStatement(method);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">                configuration.addIncompleteMethod(<span class="keyword">new</span> MybatisMethodResolver(<span class="keyword">this</span>, method));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ³¨å…¥ CURD åŠ¨æ€ SQL</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (GlobalConfigUtils.isSupperMapperChildren(configuration, type)) &#123;</span><br><span class="line">                parserInjector();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">            configuration.addIncompleteMethod(<span class="keyword">new</span> InjectorResolver(<span class="keyword">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    parsePendingMethods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å…¨å±€ç¼“å­˜å·¥å…·<code>GlobalConfigUtils</code>è·å–<code>ISqlInjector</code>å®ä¾‹ï¼Œè°ƒç”¨<code>ISqlInjector#inspectInject</code>æ–¹æ³•è¿›è¡ŒCRUDæ–¹æ³•æ³¨å…¥ã€‚åœ¨å®ç°ä¸Šï¼Œå®é™…ä¸Šæ˜¯ç”±<code>AbstractSqlInjector</code>å®ç°äº†<code>ISqlInjector</code>æ¥å£ï¼Œç„¶ååˆç”±<code>DefaultSqlInjector</code>ç»§æ‰¿<code>AbstractSqlInjector</code>å®ç°æœ€ç»ˆæ³¨å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractSqlInjector</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSqlInjector</span> <span class="keyword">implements</span> <span class="title">ISqlInjector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inspectInject</span><span class="params">(MapperBuilderAssistant builderAssistant, Class&lt;?&gt; mapperClass)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; modelClass = ReflectionKit.getSuperClassGenericType(mapperClass, Mapper.class, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (modelClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String className = mapperClass.toString();</span><br><span class="line">            Set&lt;String&gt; mapperRegistryCache = GlobalConfigUtils.getMapperRegistryCache(builderAssistant.getConfiguration());</span><br><span class="line">            <span class="keyword">if</span> (!mapperRegistryCache.contains(className)) &#123;</span><br><span class="line">                TableInfo tableInfo = TableInfoHelper.initTableInfo(builderAssistant, modelClass);</span><br><span class="line">                List&lt;AbstractMethod&gt; methodList = <span class="keyword">this</span>.getMethodList(mapperClass, tableInfo);</span><br><span class="line">                <span class="keyword">if</span> (CollectionUtils.isNotEmpty(methodList)) &#123;</span><br><span class="line">                    <span class="comment">// å¾ªç¯æ³¨å…¥è‡ªå®šä¹‰æ–¹æ³•</span></span><br><span class="line">                    methodList.forEach(m -&gt; m.inject(builderAssistant, mapperClass, modelClass, tableInfo));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.debug(mapperClass.toString() + <span class="string">&quot;, No effective injection method was found.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mapperRegistryCache.add(className);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * è·å– æ³¨å…¥çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mapperClass å½“å‰mapper</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ³¨å…¥çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 3.1.2 add  mapperClass</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;AbstractMethod&gt; <span class="title">getMethodList</span><span class="params">(Class&lt;?&gt; mapperClass,TableInfo tableInfo)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultSqlInjector</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSqlInjector</span> <span class="keyword">extends</span> <span class="title">AbstractSqlInjector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;AbstractMethod&gt; <span class="title">getMethodList</span><span class="params">(Class&lt;?&gt; mapperClass, TableInfo tableInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableInfo.havePK()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Stream.of(</span><br><span class="line">                <span class="keyword">new</span> Insert(),</span><br><span class="line">                <span class="keyword">new</span> Delete(),</span><br><span class="line">                <span class="keyword">new</span> DeleteByMap(),</span><br><span class="line">                <span class="keyword">new</span> DeleteById(),</span><br><span class="line">                <span class="keyword">new</span> DeleteBatchByIds(),</span><br><span class="line">                <span class="keyword">new</span> Update(),</span><br><span class="line">                <span class="keyword">new</span> UpdateById(),</span><br><span class="line">                <span class="keyword">new</span> SelectById(),</span><br><span class="line">                <span class="keyword">new</span> SelectBatchByIds(),</span><br><span class="line">                <span class="keyword">new</span> SelectByMap(),</span><br><span class="line">                <span class="keyword">new</span> SelectCount(),</span><br><span class="line">                <span class="keyword">new</span> SelectMaps(),</span><br><span class="line">                <span class="keyword">new</span> SelectMapsPage(),</span><br><span class="line">                <span class="keyword">new</span> SelectObjs(),</span><br><span class="line">                <span class="keyword">new</span> SelectList(),</span><br><span class="line">                <span class="keyword">new</span> SelectPage()</span><br><span class="line">            ).collect(toList());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(String.format(<span class="string">&quot;%s ,Not found @TableId annotation, Cannot use Mybatis-Plus &#x27;xxById&#x27; Method.&quot;</span>,</span><br><span class="line">                tableInfo.getEntityType()));</span><br><span class="line">            <span class="keyword">return</span> Stream.of(</span><br><span class="line">                <span class="keyword">new</span> Insert(),</span><br><span class="line">                <span class="keyword">new</span> Delete(),</span><br><span class="line">                <span class="keyword">new</span> DeleteByMap(),</span><br><span class="line">                <span class="keyword">new</span> Update(),</span><br><span class="line">                <span class="keyword">new</span> SelectByMap(),</span><br><span class="line">                <span class="keyword">new</span> SelectCount(),</span><br><span class="line">                <span class="keyword">new</span> SelectMaps(),</span><br><span class="line">                <span class="keyword">new</span> SelectMapsPage(),</span><br><span class="line">                <span class="keyword">new</span> SelectObjs(),</span><br><span class="line">                <span class="keyword">new</span> SelectList(),</span><br><span class="line">                <span class="keyword">new</span> SelectPage()</span><br><span class="line">            ).collect(toList());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ¯ä¸€ä¸ªå‡½æ•°éƒ½æ˜¯ç»§æ‰¿äº†<code>com.baomidou.mybatisplus.core.injector.AbstractMethod</code>çš„ç±»ï¼ŒåŒ…å«ä¸€ä¸ª<code>inject</code>æ³¨å…¥æ–¹æ³•ã€‚</p><h1 id="IService"><a href="#IService" class="headerlink" title="IService"></a>IService</h1><p><code>IService</code>çš„å®ç°åœ¨<code>com.baomidou.mybatisplus.extension.service.impl.ServiceImpl</code>ã€‚</p><p><code>IService</code>ä¾èµ–äºSpringå®¹å™¨ï¼Œè€Œ<code>BaseMapper</code>ä¸ä¾èµ–ï¼ŒåŸå› æ˜¯<code>IService</code>å®ä¾‹ä¸­ä¼šæ³¨å…¥ä¸€ä¸ª<code>BaseMapper</code>å®ä¾‹ç”¨äºåšCRUDæ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„é‚£ä¸€å¥—ã€‚</p><p><code>IService</code>è¿˜æ”¯æŒæ‰¹é‡æ“ä½œï¼Œè¿™éƒ¨åˆ†æºç æ¯”è¾ƒå¥½çœ‹ï¼Œè°ƒç”¨é“¾è·¯æ˜¯ï¼š<code>com.baomidou.mybatisplus.extension.toolkit.SqlHelper#executeBatch -&gt; org.apache.ibatis.session#flushStatements</code></p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] <a href="https://blog.csdn.net/wjw465150/article/details/126896276">https://blog.csdn.net/wjw465150/article/details/126896276</a><br>[2] <a href="https://blog.csdn.net/zzuhkp/article/details/120174101">https://blog.csdn.net/zzuhkp/article/details/120174101</a></p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;æ¢ç©¶MyBatis Plusæä¾›çš„é¢„å®šä¹‰CRUDæ¥å£çš„å®ç°æ–¹å¼ã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="Java" scheme="http://silencezheng.top/tags/Java/"/>
    
    <category term="MyBatis" scheme="http://silencezheng.top/tags/MyBatis/"/>
    
    <category term="æºç é˜…è¯»" scheme="http://silencezheng.top/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>å›å½’é—®é¢˜æŒ‡æ ‡è®¡ç®—</title>
    <link href="http://silencezheng.top/2024/03/10/article127/"/>
    <id>http://silencezheng.top/2024/03/10/article127/</id>
    <published>2024-03-10T10:56:26.000Z</published>
    <updated>2024-05-01T17:34:10.716Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å›å½’é—®é¢˜æŒ‡æ ‡è®¡ç®—å…¥é—¨ã€‚<br><span id="more"></span></p><h1 id="RSE-Relative-Squared-Error"><a href="#RSE-Relative-Squared-Error" class="headerlink" title="RSE (Relative Squared Error)"></a><strong>RSE (Relative Squared Error)</strong></h1><p>ç›¸å¯¹å¹³æ–¹è¯¯å·®æ˜¯é¢„æµ‹å€¼ä¸å®é™…å€¼ä¹‹é—´çš„å¹³æ–¹å·®ä¸å®é™…å€¼çš„å¹³æ–¹å·®çš„æ¯”ç‡ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">RSE = \frac{\sum_{i=1}^{n} (y_i - \hat{y}_i)^2}{\sum_{i=1}^{n} (y_i - \bar{y})^2}</script><p>å…¶ä¸­ï¼Œ$ y_i $ æ˜¯ç¬¬ $ i $ ä¸ªè§‚æµ‹å€¼ï¼Œ$ \hat{y}_i $ æ˜¯å¯¹åº”çš„é¢„æµ‹å€¼ï¼Œ$ \bar{y} $ æ˜¯è§‚æµ‹å€¼çš„å‡å€¼ï¼Œ$ n $ æ˜¯æ ·æœ¬æ•°é‡ã€‚</p><h1 id="RAE-Relative-Absolute-Error"><a href="#RAE-Relative-Absolute-Error" class="headerlink" title="RAE (Relative Absolute Error)"></a><strong>RAE (Relative Absolute Error)</strong></h1><p>ç›¸å¯¹ç»å¯¹è¯¯å·®æ˜¯é¢„æµ‹å€¼ä¸å®é™…å€¼ä¹‹é—´çš„ç»å¯¹å·®ä¸å®é™…å€¼çš„ç»å¯¹å·®çš„æ¯”ç‡ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">RAE = \frac{\sum_{i=1}^{n} |y_i - \hat{y}_i|}{\sum_{i=1}^{n} |y_i - \bar{y}|}</script><h1 id="MSE-Mean-Squared-Error"><a href="#MSE-Mean-Squared-Error" class="headerlink" title="MSE (Mean Squared Error)"></a><strong>MSE (Mean Squared Error)</strong></h1><p>å‡æ–¹è¯¯å·®æ˜¯é¢„æµ‹å€¼ä¸å®é™…å€¼ä¹‹é—´çš„å¹³æ–¹å·®çš„å¹³å‡å€¼ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">MSE = \frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2</script><h1 id="RMSE-Root-Mean-Squared-Error"><a href="#RMSE-Root-Mean-Squared-Error" class="headerlink" title="RMSE (Root Mean Squared Error)"></a><strong>RMSE (Root Mean Squared Error)</strong></h1><p>å‡æ–¹æ ¹è¯¯å·®æ˜¯å‡æ–¹è¯¯å·®çš„å¹³æ–¹æ ¹ï¼Œå®ƒæä¾›äº†é¢„æµ‹è¯¯å·®çš„æ ‡å‡†åŒ–åº¦é‡ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">RMSE = \sqrt{MSE}</script><h1 id="MAE-Mean-Absolute-Error"><a href="#MAE-Mean-Absolute-Error" class="headerlink" title="MAE (Mean Absolute Error)"></a><strong>MAE (Mean Absolute Error)</strong></h1><p>å¹³å‡ç»å¯¹è¯¯å·®æ˜¯ä¸€ç§å¸¸ç”¨çš„å›å½’é—®é¢˜è¯„ä»·æŒ‡æ ‡ï¼Œç”¨äºè¡¡é‡é¢„æµ‹å€¼ä¸çœŸå®å€¼ä¹‹é—´çš„åå·®ç¨‹åº¦ã€‚å®ƒçš„è®¡ç®—åŸºäºæ‰€æœ‰é¢„æµ‹å€¼ä¸å¯¹åº”çœŸå®å€¼ä¹‹é—´ç»å¯¹è¯¯å·®çš„å¹³å‡å€¼ï¼Œå› æ­¤å¯¹æ‰€æœ‰ä¸ªä½“é”™è¯¯ç»™äºˆç›¸åŒæƒé‡ï¼Œä¸è€ƒè™‘è¯¯å·®çš„æ–¹å‘ï¼Œåªå…³æ³¨å…¶å¤§å°ã€‚MAEçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\text{MAE} = \frac{1}{n} \sum_{i=1}^{n} |y_i - \hat{y}_i|</script><p>å…¶ä¸­ï¼š</p><ul><li>$n$ è¡¨ç¤ºæ ·æœ¬çš„æ•°é‡ã€‚</li><li>$y_i$ è¡¨ç¤ºç¬¬ $ i $ ä¸ªæ ·æœ¬çš„çœŸå®å€¼ã€‚</li><li>$ \hat{y}_i $ è¡¨ç¤ºç¬¬ $ i $ ä¸ªæ ·æœ¬çš„é¢„æµ‹å€¼ã€‚</li><li>$ | \cdot | $ è¡¨ç¤ºç»å¯¹å€¼å‡½æ•°ï¼Œç¡®ä¿è¯¯å·®å€¼ä¸ºéè´Ÿã€‚</li></ul><h1 id="MAPE-Mean-Absolute-Percentage-Error"><a href="#MAPE-Mean-Absolute-Percentage-Error" class="headerlink" title="MAPE (Mean Absolute Percentage Error)"></a><strong>MAPE (Mean Absolute Percentage Error)</strong></h1><p>å¹³å‡ç»å¯¹ç™¾åˆ†æ¯”è¯¯å·®æ˜¯é¢„æµ‹å€¼ä¸å®é™…å€¼ä¹‹é—´çš„ç»å¯¹ç™¾åˆ†æ¯”è¯¯å·®çš„å¹³å‡å€¼ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">MAPE = \frac{100}{n} \sum_{i=1}^{n} \left| \frac{y_i - \hat{y}_i}{y_i} \right|</script><h1 id="Correlation-Pearson-Correlation-Coefficient"><a href="#Correlation-Pearson-Correlation-Coefficient" class="headerlink" title="Correlation (Pearson Correlation Coefficient)"></a><strong>Correlation (Pearson Correlation Coefficient)</strong></h1><p>ç›¸å…³ç³»æ•°è¡¡é‡äº†é¢„æµ‹å€¼ä¸å®é™…å€¼ä¹‹é—´çš„çº¿æ€§å…³ç³»å¼ºåº¦å’Œæ–¹å‘ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\text{Correlation} = \frac{\sum_{i=1}^{n} (y_i - \bar{y})(\hat{y}_i - \bar{\hat{y}})}{\sqrt{\sum_{i=1}^{n} (y_i - \bar{y})^2 \sum_{i=1}^{n} (\hat{y}_i - \bar{\hat{y}})^2}}</script><p>å…¶ä¸­ï¼Œ$ \bar{y} $ å’Œ $ \bar{\hat{y}} $ åˆ†åˆ«æ˜¯è§‚æµ‹å€¼å’Œé¢„æµ‹å€¼çš„å‡å€¼ã€‚</p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å›å½’é—®é¢˜æŒ‡æ ‡è®¡ç®—å…¥é—¨ã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="æœºå™¨å­¦ä¹ " scheme="http://silencezheng.top/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>VS Code æ’ä»¶å¼€å‘ä½“éªŒ</title>
    <link href="http://silencezheng.top/2024/02/08/article126/"/>
    <id>http://silencezheng.top/2024/02/08/article126/</id>
    <published>2024-02-07T18:40:36.000Z</published>
    <updated>2024-02-07T18:44:03.600Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>VS Codeæ˜¯æˆ‘çš„ä¸»åŠ›æ–‡å­—ç¼–è¾‘å™¨ï¼Œç›®å‰æˆ‘çš„æ‰€æœ‰åšå®¢ä¸è¯¾é¢˜è°ƒç ”å·¥ä½œéƒ½æ˜¯ä½¿ç”¨å®ƒè¿›è¡Œç¼–è¾‘çš„ã€‚Markdownæ ¼å¼ä¹Ÿæ˜¯æˆ‘æœ€å–œæ¬¢çš„æ–‡æœ¬æ ¼å¼ï¼Œå®ƒè®©æˆ‘å¯ä»¥å¿«é€Ÿæ•´ç†æƒ³æ³•è€Œä»…ä»…è€ƒè™‘åŸºæœ¬çš„æ ¼å¼ã€‚</p><p>ä½†åœ¨åšè¯¾é¢˜è°ƒç ”æ—¶æˆ‘ä¹ æƒ¯ä½¿ç”¨<code>[n]</code>ä½œä¸ºå‚è€ƒæ–‡çŒ®åºå·ï¼ŒVS Codeä¸èƒ½å¯¹è¿™ç§åºå·è¿›è¡Œè‡ªåŠ¨é€’å¢å’Œé‡æ–°ç´¢å¼•ï¼Œäºæ˜¯æˆ‘æƒ³å¼€å‘ä¸€æ¬¾æ’ä»¶å®ç°è¿™ä¸¤ä¸ªåŠŸèƒ½ï¼Œæ’ä»¶çš„åå­—å°±å«<code>Reference Extension</code>å§ã€‚<br><span id="more"></span></p><h1 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h1><p>0ã€æ›´æ–°npmã€cnpmï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nvm install 18</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…cnpm</span></span><br><span class="line">npm install -g cnpm -registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure></p><p>1ã€å®‰è£… Yeoman å’Œ VS Code Extension Generatorï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install -g yo generator-code</span><br></pre></td></tr></table></figure></p><p>2ã€åˆ›å»ºä¸€ä¸ªæ–°çš„æ’ä»¶é¡¹ç›®<code>Reference Extension</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yo code</span><br><span class="line"></span><br><span class="line"><span class="comment"># ? What type of extension do you want to create? New Extension (TypeScript)</span></span><br><span class="line"><span class="comment"># ? What&#x27;s the name of your extension? Reference Extension</span></span><br><span class="line"><span class="comment"># ? What&#x27;s the identifier of your extension? reference-extension</span></span><br><span class="line"><span class="comment"># ? What&#x27;s the description of your extension? Literature Citation Extension</span></span><br><span class="line"><span class="comment"># ? Initialize a git repository? Yes</span></span><br><span class="line"><span class="comment"># ? Bundle the source code with webpack? Yes</span></span><br><span class="line"><span class="comment"># ? Which package manager to use? npm</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> reference-extension</span><br></pre></td></tr></table></figure></p><h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><p>ä¸»è¦å®ç°ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ol><li><code>[n]</code>æ ¼å¼ç´¢å¼•å¢åŠ é¡¹æ—¶è‡ªåŠ¨é€’å¢ï¼ˆå®é™…åªå®ç°äº†ä¸€éƒ¨åˆ†ï¼‰ã€‚</li><li><code>[n]</code>æ ¼å¼ç´¢å¼•é‡æ–°ç´¢å¼•ï¼ŒåŒ…å«åˆ é™¤é¡¹ä¸å¢åŠ é¡¹ï¼ˆå®é™…åªå®ç°äº†ä¸€éƒ¨åˆ†ï¼‰ã€‚</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¼å…¥ VSCode æ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> vscode <span class="keyword">from</span> <span class="string">&#x27;vscode&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¿€æ´»æ’ä»¶çš„å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">activate</span>(<span class="params">context: vscode.ExtensionContext</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å†Œå‘½ä»¤ï¼šè‡ªåŠ¨é€’å¢ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">let</span> disposableAutoIncrement = vscode.commands.registerTextEditorCommand(<span class="string">&#x27;rext.autoIncrement&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰æ´»åŠ¨çš„æ–‡æœ¬ç¼–è¾‘å™¨</span></span><br><span class="line">        <span class="keyword">const</span> editor = vscode.window.activeTextEditor;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (editor) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰å…‰æ ‡ä½ç½®</span></span><br><span class="line">            <span class="keyword">const</span> currentPosition = editor.selection.active;</span><br><span class="line">            <span class="keyword">const</span> currentLine = currentPosition.line;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–å½“å‰è¡Œçš„æ–‡æœ¬å†…å®¹ï¼Œå¹¶åŒ¹é…æ˜¯å¦ä»¥ [n] æ ¼å¼ç»“å°¾</span></span><br><span class="line">            <span class="keyword">const</span> currentLineText = editor.document.lineAt(currentLine).text;</span><br><span class="line">            <span class="keyword">const</span> match = currentLineText.match(<span class="regexp">/\[(\d+)\]\s+(.*)/</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (match) &#123;</span><br><span class="line">                <span class="comment">// è·å–åŒ¹é…åˆ°çš„æ•°å­—ï¼Œå¹¶è®¡ç®—ä¸‹ä¸€ä¸ªæ•°å­—</span></span><br><span class="line">                <span class="keyword">const</span> currentNumber = <span class="built_in">parseInt</span>(match[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">const</span> nextNumber = currentNumber + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è‡ªå¢é€»è¾‘</span></span><br><span class="line">                editor.edit(<span class="function"><span class="params">editBuilder</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="comment">// TODOï¼š è¿™æ®µæœ‰é—®é¢˜ï¼Œè¦ä¿®æ”¹ï¼Œè€Œä¸”è¿˜æ˜¯æ²¡æœ‰åšåˆ°å›è½¦å‰è§¦å‘ã€‚</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">let</span> line = currentLine + <span class="number">1</span>; line &lt; editor.document.lineCount; line++) &#123;</span><br><span class="line">                        <span class="keyword">const</span> lineText = editor.document.lineAt(line).text;</span><br><span class="line">                        <span class="keyword">const</span> matchBelow = lineText.match(<span class="regexp">/\[(\d+)\]\s+(.*)/</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (matchBelow) &#123;</span><br><span class="line">                            <span class="keyword">const</span> currentNumberBelow = <span class="built_in">parseInt</span>(matchBelow[<span class="number">1</span>]);</span><br><span class="line">                            <span class="keyword">const</span> newIndexBelow = currentNumberBelow + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// æ›¿æ¢ä¸‹æ–¹æ–¹æ‹¬å·ä¸­çš„æ•°å­—</span></span><br><span class="line">                            <span class="keyword">const</span> startPosBelow = <span class="keyword">new</span> vscode.Position(line, <span class="number">0</span>);</span><br><span class="line">                            <span class="keyword">const</span> endPosBelow = <span class="keyword">new</span> vscode.Position(line, matchBelow[<span class="number">0</span>].length);</span><br><span class="line">                            editBuilder.replace(<span class="keyword">new</span> vscode.Range(startPosBelow, endPosBelow), <span class="string">`[<span class="subst">$&#123;newIndexBelow&#125;</span>] <span class="subst">$&#123;matchBelow[<span class="number">2</span>]&#125;</span>`</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœä¸‹æ–¹æ²¡æœ‰ç¬¦åˆ [n] æ ¼å¼ç´¢å¼•çš„é¡¹ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">const</span> newPosition = <span class="keyword">new</span> vscode.Position(currentLine + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                    editBuilder.insert(newPosition, <span class="string">`[<span class="subst">$&#123;nextNumber&#125;</span>] `</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œå‘½ä»¤ï¼šé‡æ–°ç´¢å¼•æ‰€æœ‰è¡Œçš„æ–¹æ‹¬å·</span></span><br><span class="line">    <span class="comment">// TODOï¼šå®é™…ä¸Šåªå®ç°äº†åˆ é™¤ä¸€ä¸ªç´¢å¼•æ—¶å°†ä¸‹æ–¹ç´¢å¼•éƒ½è‡ªåŠ¨å‡1</span></span><br><span class="line">    <span class="keyword">let</span> disposableReindex = vscode.commands.registerCommand(<span class="string">&#x27;rext.reindex&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰æ´»åŠ¨çš„æ–‡æœ¬ç¼–è¾‘å™¨</span></span><br><span class="line">        <span class="keyword">const</span> editor = vscode.window.activeTextEditor;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (editor) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰è¡Œçš„è¡Œå·</span></span><br><span class="line">            <span class="keyword">const</span> currentLine = editor.selection.active.line;</span><br><span class="line">            <span class="keyword">const</span> startLine = currentLine;</span><br><span class="line">            <span class="keyword">const</span> endLine = editor.document.lineCount;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®šä¹‰å½“å‰åˆ—è¡¨çš„ç´¢å¼•</span></span><br><span class="line">            <span class="keyword">let</span> currentListIndex: <span class="built_in">number</span> | <span class="literal">undefined</span> = <span class="literal">undefined</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// TEMPï¼šåŒ¹é…ä¸€ä¸‹</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> æŸ¥æ‰¾å½“å‰åˆ—è¡¨çš„ç´¢å¼•</span></span><br><span class="line">            <span class="keyword">const</span> lineText = editor.document.lineAt(startLine).text;</span><br><span class="line">            <span class="keyword">const</span> match = lineText.match(<span class="regexp">/\[(\d+)\]\s+(.*)/</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (match) &#123;</span><br><span class="line">                currentListIndex = <span class="built_in">parseInt</span>(match[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// TEMPï¼šè‡ªåŠ¨å‡1</span></span><br><span class="line">            <span class="keyword">if</span> (currentListIndex !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                <span class="comment">// TODOï¼šé‡æ–°ç´¢å¼•åˆ—è¡¨ä¸­çš„æ–¹æ‹¬å·æ•°å­—</span></span><br><span class="line">                editor.edit(<span class="function"><span class="params">editBuilder</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">let</span> line = startLine; line &lt; endLine; line++) &#123;</span><br><span class="line">                        <span class="keyword">const</span> lineText = editor.document.lineAt(line).text;</span><br><span class="line">                        <span class="keyword">const</span> match = lineText.match(<span class="regexp">/\[(\d+)\]\s+(.*)/</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (match) &#123;</span><br><span class="line">                            <span class="comment">// è·å–å½“å‰æ–¹æ‹¬å·ä¸­çš„æ•°å­—å’Œæ–°ç´¢å¼•</span></span><br><span class="line">                            <span class="keyword">const</span> currentNumber = <span class="built_in">parseInt</span>(match[<span class="number">1</span>]);</span><br><span class="line">                            <span class="keyword">const</span> newIndex = currentNumber - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// å¦‚æœå½“å‰æ•°å­—ä¸ç­‰äºæ–°ç´¢å¼•ï¼Œæ›¿æ¢æ–¹æ‹¬å·ä¸­çš„æ•°å­—</span></span><br><span class="line">                            <span class="keyword">if</span> (currentNumber !== newIndex) &#123;</span><br><span class="line">                                <span class="keyword">const</span> startPos = <span class="keyword">new</span> vscode.Position(line, match.index!);</span><br><span class="line">                                <span class="keyword">const</span> endPos = <span class="keyword">new</span> vscode.Position(line, match.index! + match[<span class="number">0</span>].length);</span><br><span class="line">                                editBuilder.replace(<span class="keyword">new</span> vscode.Range(startPos, endPos), <span class="string">`[<span class="subst">$&#123;newIndex&#125;</span>] `</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬æ–‡æ¡£å†…å®¹å˜åŒ–äº‹ä»¶</span></span><br><span class="line">    vscode.workspace.onDidChangeTextDocument(<span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event.document.languageId === <span class="string">&#x27;markdown&#x27;</span> &amp;&amp; event.document.fileName.endsWith(<span class="string">&#x27;.md&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">const</span> range = event.contentChanges[<span class="number">0</span>].range;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº†å›è½¦é”®</span></span><br><span class="line">            <span class="keyword">if</span> (event.contentChanges[<span class="number">0</span>].text === <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                vscode.commands.executeCommand(<span class="string">&#x27;rext.autoIncrement&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ£€æŸ¥æ˜¯å¦åˆ é™¤äº†æŸä¸€è¡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (event.contentChanges[<span class="number">0</span>].text === <span class="string">&#x27;&#x27;</span> &amp;&amp; range.start.line !== range.end.line) &#123;</span><br><span class="line">                vscode.commands.executeCommand(<span class="string">&#x27;rext.reindex&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å‘½ä»¤æ³¨å†Œåˆ°ä¸Šä¸‹æ–‡è®¢é˜…ä¸­ï¼Œç¡®ä¿æ’ä»¶åœ¨æ¿€æ´»æœŸé—´æœ‰æ•ˆ</span></span><br><span class="line">    context.subscriptions.push(disposableAutoIncrement, disposableReindex);</span><br><span class="line"></span><br><span class="line">    process.stdout.write(<span class="string">&#x27;Debugging message\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ’ä»¶è¢«åœç”¨æ—¶è°ƒç”¨çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">deactivate</span>(<span class="params"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä»£ç å†™çš„å¾ˆç³™ï¼Œåªå®ç°äº†éƒ¨åˆ†åŠŸèƒ½ï¼Œä½†æ˜¯ä¹Ÿç¡®å®æ²¡æ—¶é—´å»å­¦<code>markdown-it</code>çš„æ’ä»¶å®ç°äº†ï¼Œä»¥åå†å»å®ç°å§ï¼ˆæ­£å¸¸æ¥è¯´æˆ‘è¦å®ç°çš„ä¸œè¥¿é€šè¿‡<code>markdown-it</code>è‡ªå®šä¹‰æ’ä»¶æ’å…¥çš„å½¢å¼å®ç°æ›´æ–¹ä¾¿â€¦åœ¨æ’ä»¶ä¸Šå†™æ’ä»¶ğŸ˜‚ï¼‰ã€‚</p><h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><p>é¡¹ç›®F5è¿›è¡Œè°ƒè¯•ï¼Œåˆ›å»ºä¸€ä¸ªMarkdownæ–‡ä»¶ï¼Œå†™å…¥å¯¹åº”æƒ…æ™¯å†…å®¹ï¼Œåˆ«å¿˜äº†åœ¨<code>package.json</code>ä¸­è®¾ç½®è§¦å‘æ¡ä»¶ã€‚</p><h1 id="æ‰“åŒ…å‘å¸ƒ"><a href="#æ‰“åŒ…å‘å¸ƒ" class="headerlink" title="æ‰“åŒ…å‘å¸ƒ"></a>æ‰“åŒ…å‘å¸ƒ</h1><p>è¦æƒ³å‘å¸ƒæ’ä»¶åˆ°å¸‚åœºï¼Œéœ€è¦åˆ›å»ºåœ¨Azure DevOpsä¸Šåˆ›å»ºä¸ªäººè®¿é—®ä»¤ç‰Œï¼Œå¦‚æœæ²¡æœ‰ç»„ç»‡åˆ™éœ€è¦å…ˆåˆ›å»ºç»„ç»‡ã€‚å¯ä»¥ç”¨GitHubè´¦æˆ·ç™»é™†Azure DevOpsåˆ›å»ºç»„ç»‡ï¼Œæ¯”å¦‚<code>dev.azure.com/SilenceZheng66</code>ã€‚</p><p>ç„¶ååˆ›å»ºé¡¹ç›®ï¼Œåœ¨é¡¹ç›®ä¸­åˆ›å»ºPATï¼ˆPersonal Access Tokensï¼‰å¹¶è®°ä½å®ƒã€‚ä¸‹é¢éœ€è¦åœ¨<a href="https://marketplace.visualstudio.com/manage/createpublisher">Visual Studio Marketplace</a>åˆ›å»ºä¸€ä¸ªpublisherï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œå¿…é¡»ä½¿ç”¨åˆšæ‰åˆ›å»ºä¸ªäººè®¿é—®ä»¤ç‰Œçš„å¾®è½¯è´¦å·ï¼Œè¿™é‡Œçš„publisheréœ€è¦å’Œpackage.jsoné‡Œçš„publisherå­—æ®µä¸€è‡´ã€‚</p><p>å‡†å¤‡å°±ç»ªåï¼Œä¸‹è½½<code>vsce</code>ï¼Œç”¨æ¥æ‰“åŒ…/å‘å¸ƒ/ç®¡ç†æ’ä»¶çš„å‘½ä»¤è¡Œå·¥å…·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install -g vsce</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘å¸ƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç™»å½•</span></span><br><span class="line">vsce login SilenceZheng66</span><br><span class="line"><span class="comment"># å‘å¸ƒ</span></span><br><span class="line">vsce publish --no-dependencies</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨webpackæ‰“åŒ…æ’ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cnpm i --save-dev webpack webpack-cli ts-loader</span><br><span class="line"></span><br><span class="line"><span class="comment"># package.json è„šæœ¬å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;vscode:prepublish&quot;</span>: <span class="string">&quot;webpack --mode production&quot;</span>,</span><br><span class="line"><span class="string">&quot;compile&quot;</span>: <span class="string">&quot;webpack --mode none&quot;</span>,</span><br><span class="line"><span class="string">&quot;watch&quot;</span>: <span class="string">&quot;webpack --mode none --watch&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] <a href="https://rackar.github.io/vscode-ext-doccn/get-started/your-first-extension.html">https://rackar.github.io/vscode-ext-doccn/get-started/your-first-extension.html</a><br>[2] <a href="https://github.com/yzhang-gh/vscode-markdown">https://github.com/yzhang-gh/vscode-markdown</a><br>[3] <a href="https://juejin.cn/post/7327570230775201826">https://juejin.cn/post/7327570230775201826</a><br>[4] <a href="https://zhuanlan.zhihu.com/p/459554765">https://zhuanlan.zhihu.com/p/459554765</a><br>[5] <a href="https://juejin.cn/post/6844903921555603470">https://juejin.cn/post/6844903921555603470</a><br>[6] <a href="https://markdown-it.github.io">https://markdown-it.github.io</a><br>[7] <a href="https://juejin.cn/post/7076649162653040647">https://juejin.cn/post/7076649162653040647</a></p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;VS Codeæ˜¯æˆ‘çš„ä¸»åŠ›æ–‡å­—ç¼–è¾‘å™¨ï¼Œç›®å‰æˆ‘çš„æ‰€æœ‰åšå®¢ä¸è¯¾é¢˜è°ƒç ”å·¥ä½œéƒ½æ˜¯ä½¿ç”¨å®ƒè¿›è¡Œç¼–è¾‘çš„ã€‚Markdownæ ¼å¼ä¹Ÿæ˜¯æˆ‘æœ€å–œæ¬¢çš„æ–‡æœ¬æ ¼å¼ï¼Œå®ƒè®©æˆ‘å¯ä»¥å¿«é€Ÿæ•´ç†æƒ³æ³•è€Œä»…ä»…è€ƒè™‘åŸºæœ¬çš„æ ¼å¼ã€‚&lt;/p&gt;
&lt;p&gt;ä½†åœ¨åšè¯¾é¢˜è°ƒç ”æ—¶æˆ‘ä¹ æƒ¯ä½¿ç”¨&lt;code&gt;[n]&lt;/code&gt;ä½œä¸ºå‚è€ƒæ–‡çŒ®åºå·ï¼ŒVS Codeä¸èƒ½å¯¹è¿™ç§åºå·è¿›è¡Œè‡ªåŠ¨é€’å¢å’Œé‡æ–°ç´¢å¼•ï¼Œäºæ˜¯æˆ‘æƒ³å¼€å‘ä¸€æ¬¾æ’ä»¶å®ç°è¿™ä¸¤ä¸ªåŠŸèƒ½ï¼Œæ’ä»¶çš„åå­—å°±å«&lt;code&gt;Reference Extension&lt;/code&gt;å§ã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="VSCode" scheme="http://silencezheng.top/tags/VSCode/"/>
    
  </entry>
  
  <entry>
    <title>SpELä½¿ç”¨å…¥é—¨</title>
    <link href="http://silencezheng.top/2023/12/30/article125/"/>
    <id>http://silencezheng.top/2023/12/30/article125/</id>
    <published>2023-12-29T17:00:25.000Z</published>
    <updated>2023-12-29T17:02:59.158Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>SpELå³Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆSpring Expression Languageï¼‰ï¼Œå®ƒèƒ½åœ¨è¿è¡Œæ—¶æ„å»ºå¤æ‚è¡¨è¾¾å¼ã€å­˜å–å¯¹è±¡å›¾å±æ€§ã€å¯¹è±¡æ–¹æ³•è°ƒç”¨ç­‰ç­‰ï¼Œå¹¶ä¸”èƒ½ä¸SpringåŠŸèƒ½å®Œç¾æ•´åˆã€‚</p><p>SpELæ˜¯å•ç‹¬æ¨¡å—ï¼ˆ<code>org.springframework.expression</code>ï¼‰ï¼Œåªä¾èµ–äºcoreæ¨¡å—ï¼Œä¸ä¾èµ–äºå…¶ä»–æ¨¡å—ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨ã€‚<br><span id="more"></span></p><h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><p>é¦–å…ˆä»ä¸€ä¸ªç®€å•çš„â€œliteral string expressionâ€ä¾‹å­å¼•å…¥ï¼Œæ‰€è°“â€œliteral stringâ€å°±æ˜¯æŒ‡ä»£ç ä¸­ç›´æ¥ä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„å­—ç¬¦ä¸²ï¼ˆèµ·ç åœ¨Javaä¸‹æ˜¯è¿™æ ·ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;Hello World&#x27;&quot;</span>);</span><br><span class="line">String message = (String) exp.getValue();</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†è§£æå™¨<code>ExpressionParser</code>ï¼Œè´Ÿè´£è§£æè¡¨è¾¾å¼å­—ç¬¦ä¸²ï¼Œè¡¨è¾¾å¼å­—ç¬¦ä¸²æ˜¯ç”±å‘¨å›´çš„å•å¼•å·è¡¨ç¤ºçš„å­—ç¬¦ä¸²å­—é¢é‡ã€‚è€Œåè§£æè¡¨è¾¾å¼ï¼Œ<code>Expression</code>æ¥å£è´Ÿè´£è¯„ä¼°æ‰€å®šä¹‰çš„è¡¨è¾¾å¼å­—ç¬¦ä¸²ã€‚æœ€åå¯¹è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼ï¼Œè·å–ä¿¡æ¯ã€‚</p><p>é€šè¿‡è¿™ä¸€æµç¨‹å¯ä»¥æ€»ç»“SpELåœ¨æ±‚è¡¨è¾¾å¼å€¼æ—¶çš„ä¸€èˆ¬æ­¥éª¤ï¼š</p><ol><li>åˆ›å»ºè§£æå™¨</li><li>è§£æè¡¨è¾¾å¼</li><li>æ„é€ ä¸Šä¸‹æ–‡</li><li>è¡¨è¾¾å¼æ±‚å€¼</li></ol><p>å…¶ä¸­ç¬¬ä¸‰æ­¥æ„é€ ä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ªå¯é€‰æ­¥éª¤ï¼Œå½“éœ€è¦å‡†å¤‡ä¸Šä¸‹æ–‡å˜é‡æ—¶ä¼šä½¿ç”¨ã€‚</p><p>PSï¼šåœ¨è°ƒç”¨ <code>parser.parseExpression</code> å’Œ <code>exp.getValue</code> æ—¶ï¼Œå¯èƒ½åˆ†åˆ«æŠ›å‡ºä¸¤ä¸ªå¼‚å¸¸ï¼š<code>ParseException</code> å’Œ <code>EvaluationException</code>ã€‚<br>PPSï¼šEvaluateå¯ä»¥ç†è§£ä¸ºâ€œæ±‚å€¼â€æˆ–â€œè®¡ç®—â€ã€‚</p><h2 id="ä¸€äº›åŠŸèƒ½"><a href="#ä¸€äº›åŠŸèƒ½" class="headerlink" title="ä¸€äº›åŠŸèƒ½"></a>ä¸€äº›åŠŸèƒ½</h2><p>SpELæ”¯æŒå¤šç§åŠŸèƒ½ï¼Œå¦‚è°ƒç”¨æ–¹æ³•ã€è®¿é—®å±æ€§å’Œè°ƒç”¨æ„é€ å‡½æ•°ï¼Œè¿™é‡Œç”¨ä¸€ä¸ªä¾‹å­å¿«é€Ÿè¿‡ä¸€ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨concatæ–¹æ³•</span></span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;Hello World&#x27;.concat(&#x27;!&#x27;)&quot;</span>);</span><br><span class="line">String message = (String) exp.getValue();  <span class="comment">// Hello World!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¿é—®å±æ€§ï¼Œinvokes &#x27;getBytes()&#x27;</span></span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;Hello World&#x27;.bytes&quot;</span>);</span><br><span class="line"><span class="keyword">byte</span>[] bytes = (<span class="keyword">byte</span>[]) exp.getValue();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¿é—®åµŒå¥—å±æ€§ï¼Œinvokes &#x27;getBytes().length&#x27;</span></span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;Hello World&#x27;.bytes.length&quot;</span>); </span><br><span class="line"><span class="keyword">int</span> length = (Integer) exp.getValue();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨æ„é€ å‡½æ•°</span></span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;new String(&#x27;hello world&#x27;).toUpperCase()&quot;</span>);</span><br><span class="line">String message = exp.getValue(String.class); <span class="comment">// HELLO WORLD</span></span><br></pre></td></tr></table></figure><h2 id="æ›´å¸¸è§çš„ç”¨æ³•"><a href="#æ›´å¸¸è§çš„ç”¨æ³•" class="headerlink" title="æ›´å¸¸è§çš„ç”¨æ³•"></a>æ›´å¸¸è§çš„ç”¨æ³•</h2><p>SpELæ›´å¸¸è§çš„ç”¨æ³•æ˜¯æä¾›ä¸€ä¸ªè¡¨è¾¾å¼å­—ç¬¦ä¸²ï¼Œé’ˆå¯¹ç‰¹å®šå¯¹è±¡å®ä¾‹ï¼ˆç§°ä¸ºæ ¹å¯¹è±¡ï¼‰è¿›è¡Œæ±‚å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºå¹¶è®¾ç½®ä¸€ä¸ªæ—¥å†å¯¹è±¡</span></span><br><span class="line">GregorianCalendar c = <span class="keyword">new</span> GregorianCalendar();</span><br><span class="line">c.set(<span class="number">1856</span>, <span class="number">7</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ å‡½æ•°å‚æ•°åˆ†åˆ«ä¸ºname, birthday, nationality</span></span><br><span class="line">Inventor tesla = <span class="keyword">new</span> Inventor(<span class="string">&quot;Nikola Tesla&quot;</span>, c.getTime(), <span class="string">&quot;Serbian&quot;</span>);</span><br><span class="line"></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"></span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;name&quot;</span>); <span class="comment">// å°†&quot;name&quot;è§£æä¸ºè¡¨è¾¾å¼</span></span><br><span class="line">String name = (String) exp.getValue(tesla);</span><br><span class="line"><span class="comment">// name == &quot;Nikola Tesla&quot;</span></span><br></pre></td></tr></table></figure><h2 id="å…¨éƒ¨è¯­æ³•"><a href="#å…¨éƒ¨è¯­æ³•" class="headerlink" title="å…¨éƒ¨è¯­æ³•"></a>å…¨éƒ¨è¯­æ³•</h2><p>å…³äºå¦‚ä½•ç¼–å†™æ­£ç¡®çš„è¡¨è¾¾å¼ï¼Œå¯ä»¥å‚è§ <a href="https://docs.spring.io/spring-framework/reference/core/expressions/language-ref.html">https://docs.spring.io/spring-framework/reference/core/expressions/language-ref.html</a></p><h1 id="EvaluationContextï¼ˆæ±‚å€¼ä¸Šä¸‹æ–‡ï¼‰"><a href="#EvaluationContextï¼ˆæ±‚å€¼ä¸Šä¸‹æ–‡ï¼‰" class="headerlink" title="EvaluationContextï¼ˆæ±‚å€¼ä¸Šä¸‹æ–‡ï¼‰"></a>EvaluationContextï¼ˆæ±‚å€¼ä¸Šä¸‹æ–‡ï¼‰</h1><p><code>EvaluationContext</code>æ¥å£ç”¨äºè®¡ç®—è¡¨è¾¾å¼ï¼Œä»¥è§£æå±æ€§ã€æ–¹æ³•æˆ–å­—æ®µï¼Œå¹¶å¸®åŠ©æ‰§è¡Œç±»å‹è½¬æ¢ã€‚Spring æä¾›äº†ä¸¤ç§å®ç°ï¼š</p><ul><li><p><code>SimpleEvaluationContext</code>ï¼šè¯¥æ¥å£å…¬å¼€äº†åŸºæœ¬ SpEL åŠŸèƒ½å’Œé…ç½®é€‰é¡¹çš„å­é›†ï¼Œé€‚ç”¨äºä¸éœ€è¦å®Œæ•´ SpEL è¯­è¨€è¯­æ³•ä¸”åº”å—åˆ°æœ‰æ„ä¹‰é™åˆ¶çš„è¡¨è¾¾å¼ç±»åˆ«ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºæ•°æ®ç»‘å®šè¡¨è¾¾å¼å’ŒåŸºäºå±æ€§çš„è¿‡æ»¤å™¨ã€‚</p></li><li><p><code>StandardEvaluationContext</code>ï¼šæä¾›å…¨å¥— SpEL åŠŸèƒ½å’Œé…ç½®é€‰é¡¹ï¼Œå¯ä»¥ç”¨å®ƒæ¥æŒ‡å®šé»˜è®¤æ ¹å¯¹è±¡ï¼Œå¹¶é…ç½®æ‰€æœ‰å¯ç”¨çš„æ±‚å€¼ç›¸å…³ç­–ç•¥ã€‚</p></li></ul><p><code>SimpleEvaluationContext</code> åªæ”¯æŒ SpEL è¯­æ³•çš„ä¸€ä¸ªå­é›†ã€‚å®ƒä¸åŒ…æ‹¬ Java ç±»å‹å¼•ç”¨ã€æ„é€ å‡½æ•°å’Œ Bean å¼•ç”¨ã€‚å®ƒè¿˜è¦æ±‚ä½¿ç”¨è€…æ˜ç¡®é€‰æ‹©å¯¹è¡¨è¾¾å¼ä¸­å±æ€§å’Œæ–¹æ³•çš„æ”¯æŒçº§åˆ«ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>create()</code>é™æ€å·¥å‚æ–¹æ³•åªèƒ½å¯¹å±æ€§è¿›è¡Œè¯»å–è®¿é—®ã€‚ç”¨æˆ·è¿˜å¯ä»¥è·å–ä¸€ä¸ªæ„å»ºå™¨æ¥é…ç½®æ‰€éœ€çš„ç‰¹å®šæ”¯æŒçº§åˆ«ï¼Œé’ˆå¯¹ä»¥ä¸‹ä¸€ç§æˆ–å‡ ç§ç»„åˆï¼š</p><ul><li>Custom PropertyAccessor only (no reflection)</li><li>Data binding properties for read-only access</li><li>Data binding properties for read and write</li></ul><h2 id="ç±»å‹è½¬æ¢"><a href="#ç±»å‹è½¬æ¢" class="headerlink" title="ç±»å‹è½¬æ¢"></a>ç±»å‹è½¬æ¢</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpEL ä½¿ç”¨ Spring core ä¸­çš„è½¬æ¢æœåŠ¡ï¼ˆorg.springframework.core.convert.ConversionServiceï¼‰ã€‚è¯¥è½¬æ¢æœåŠ¡ä¸ºå¸¸è§è½¬æ¢æä¾›äº†è®¸å¤šå†…ç½®è½¬æ¢å™¨ï¼Œä½†ä¹Ÿå…·æœ‰å®Œå…¨å¯æ‰©å±•æ€§ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨ç±»å‹é—´æ·»åŠ è‡ªå®šä¹‰è½¬æ¢ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜å…·æœ‰æ³›å‹æ„ŸçŸ¥åŠŸèƒ½ã€‚è¿™æ„å‘³ç€ï¼Œå½“æ‚¨åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨æ³›å‹ç±»å‹æ—¶ï¼ŒSpEL ä¼šå°è¯•è¿›è¡Œè½¬æ¢ï¼Œä»¥ä¿æŒé‡åˆ°çš„ä»»ä½•å¯¹è±¡çš„ç±»å‹æ­£ç¡®æ€§ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½¿ç”¨ <code>setValue()</code> è¿›è¡Œèµ‹å€¼æ˜¯ä¸ºäº†è®¾ç½® List å±æ€§ã€‚è¯¥å±æ€§çš„ç±»å‹å®é™…ä¸Šæ˜¯ <code>List&lt;Boolean&gt;</code>ã€‚SpELä¼šè¯†åˆ«åˆ°åœ¨å°†åˆ—è¡¨å…ƒç´ æ”¾å…¥å…¶ä¸­ä¹‹å‰ï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºå¸ƒå°”å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Simple</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> List&lt;Boolean&gt; booleanList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Simple simple = <span class="keyword">new</span> Simple();</span><br><span class="line">simple.booleanList.add(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">EvaluationContext context = SimpleEvaluationContext.forReadOnlyDataBinding().build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;false&quot; is passed in here as a String. SpEL and the conversion service</span></span><br><span class="line"><span class="comment">// will recognize that it needs to be a Boolean and convert it accordingly.</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;booleanList[0]&quot;</span>).setValue(context, simple, <span class="string">&quot;false&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// b is false</span></span><br><span class="line">Boolean b = simple.booleanList.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><h1 id="è§£æå™¨é…ç½®"><a href="#è§£æå™¨é…ç½®" class="headerlink" title="è§£æå™¨é…ç½®"></a>è§£æå™¨é…ç½®</h1><p>å¯ä»¥ä½¿ç”¨è§£æå™¨é…ç½®å¯¹è±¡ï¼ˆorg.springframework.expression.spel.SpelParserConfigurationï¼‰æ¥é…ç½® SpEL è¡¨è¾¾å¼è§£æå™¨ï¼Œè¯¥é…ç½®å¯¹è±¡å¯æ§åˆ¶æŸäº›è¡¨è¾¾å¼ç»„ä»¶çš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œåœ¨å¯¹æ•°ç»„æˆ–é›†åˆè¿›è¡Œç´¢å¼•æ—¶ï¼ŒæŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ ä¸ºç©ºï¼ŒSpEL ä¼šè‡ªåŠ¨åˆ›å»ºè¯¥å…ƒç´ ã€‚è¿™åœ¨ä½¿ç”¨ç”±ä¸€è¿ä¸²å±æ€§å¼•ç”¨ç»„æˆçš„è¡¨è¾¾å¼æ—¶éå¸¸æœ‰ç”¨ã€‚å¦‚æœç”¨æˆ·å¯¹æ•°ç»„æˆ–åˆ—è¡¨è¿›è¡Œç´¢å¼•ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªè¶…å‡ºæ•°ç»„æˆ–åˆ—è¡¨å½“å‰å¤§å°çš„ç´¢å¼•ï¼ŒSpEL å¯ä»¥è‡ªåŠ¨å¢é•¿æ•°ç»„æˆ–åˆ—è¡¨ä»¥å®¹çº³è¯¥ç´¢å¼•ã€‚ä¸ºäº†åœ¨æŒ‡å®šçš„ç´¢å¼•å¤„æ·»åŠ å…ƒç´ ï¼ŒSpEL å°†å°è¯•ä½¿ç”¨å…ƒç´ ç±»å‹çš„é»˜è®¤æ„é€ å‡½æ•°åˆ›å»ºå…ƒç´ ï¼Œç„¶åå†è®¾ç½®æŒ‡å®šçš„å€¼ã€‚å¦‚æœå…ƒç´ ç±»å‹æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œåˆ™ä¼šå°†ç©ºå€¼æ·»åŠ åˆ°æ•°ç»„æˆ–åˆ—è¡¨ä¸­ã€‚å¦‚æœæ²¡æœ‰è½¬æ¢å™¨ï¼ˆå†…ç½®æˆ–è‡ªå®šä¹‰çš„ï¼‰çŸ¥é“å¦‚ä½•è®¾ç½®å€¼ï¼Œç©ºå€¼å°†ä¿ç•™åœ¨æ•°ç»„æˆ–åˆ—è¡¨çš„æŒ‡å®šç´¢å¼•å¤„ã€‚</p><p>ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•è‡ªåŠ¨å¢é•¿åˆ—è¡¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Turn on:</span></span><br><span class="line"><span class="comment">// - auto null reference initialization</span></span><br><span class="line"><span class="comment">// - auto collection growing</span></span><br><span class="line">SpelParserConfiguration config = <span class="keyword">new</span> SpelParserConfiguration(<span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser(config);</span><br><span class="line"></span><br><span class="line">Expression expression = parser.parseExpression(<span class="string">&quot;list[3]&quot;</span>);</span><br><span class="line"></span><br><span class="line">Demo demo = <span class="keyword">new</span> Demo();</span><br><span class="line"></span><br><span class="line">Object o = expression.getValue(demo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// demo.list will now be a real collection of 4 entries</span></span><br><span class="line"><span class="comment">// Each entry is a new empty String</span></span><br></pre></td></tr></table></figure><h1 id="è¡¨è¾¾å¼ç¼–è¯‘ï¼ˆæå‡æ±‚å€¼é€Ÿåº¦ï¼‰"><a href="#è¡¨è¾¾å¼ç¼–è¯‘ï¼ˆæå‡æ±‚å€¼é€Ÿåº¦ï¼‰" class="headerlink" title="è¡¨è¾¾å¼ç¼–è¯‘ï¼ˆæå‡æ±‚å€¼é€Ÿåº¦ï¼‰"></a>è¡¨è¾¾å¼ç¼–è¯‘ï¼ˆæå‡æ±‚å€¼é€Ÿåº¦ï¼‰</h1><p>Spring Framework 4.1 åŒ…å«ä¸€ä¸ªåŸºæœ¬çš„è¡¨è¾¾å¼ç¼–è¯‘å™¨ã€‚è¡¨è¾¾å¼é€šå¸¸æ˜¯<strong>è§£é‡Šå‹</strong>çš„ï¼Œè¿™åœ¨æ±‚å€¼è¿‡ç¨‹ä¸­æä¾›äº†å¾ˆå¤§çš„åŠ¨æ€çµæ´»æ€§ï¼Œä½†æ— æ³•æä¾›æœ€ä½³æ€§èƒ½ã€‚å¯¹äºå¶å°”ä½¿ç”¨è¡¨è¾¾å¼çš„æƒ…å†µï¼Œè¿™å¹¶æ— å¤§ç¢ï¼Œä½†å½“å…¶ä»–ç»„ä»¶ï¼ˆå¦‚ Spring Integrationï¼‰ä½¿ç”¨è¡¨è¾¾å¼æ—¶ï¼Œæ€§èƒ½å¯èƒ½ä¼šå˜å¾—éå¸¸é‡è¦ï¼Œè€Œä¸”å¯¹åŠ¨æ€æ€§ä¹Ÿæ²¡æœ‰çœŸæ­£çš„éœ€æ±‚ã€‚</p><p>SpEL ç¼–è¯‘å™¨æ—¨åœ¨æ»¡è¶³è¿™ä¸€éœ€æ±‚ã€‚åœ¨è¯„ä¼°è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ª Java ç±»ï¼Œåœ¨è¿è¡Œæ—¶ä½“ç°è¡¨è¾¾å¼çš„è¡Œä¸ºï¼Œå¹¶ä½¿ç”¨è¯¥ç±»å®ç°æ›´å¿«çš„è¡¨è¾¾å¼æ±‚å€¼ã€‚ç”±äºç¼ºä¹å›´ç»•è¡¨è¾¾å¼çš„ç±»å‹ï¼Œç¼–è¯‘å™¨åœ¨æ‰§è¡Œç¼–è¯‘æ—¶ä¼šä½¿ç”¨åœ¨è¡¨è¾¾å¼çš„è§£é‡Šæ±‚å€¼è¿‡ç¨‹ä¸­æ”¶é›†åˆ°çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œç¼–è¯‘å™¨å¹¶ä¸èƒ½çº¯ç²¹ä»è¡¨è¾¾å¼ä¸­çŸ¥é“å±æ€§å¼•ç”¨çš„ç±»å‹ï¼Œä½†åœ¨ç¬¬ä¸€æ¬¡è§£é‡Šæ±‚å€¼æ—¶ï¼Œç¼–è¯‘å™¨å°±èƒ½çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆç±»å‹ã€‚å½“ç„¶ï¼Œå¦‚æœå„ç§è¡¨è¾¾å¼å…ƒç´ çš„ç±»å‹éšç€æ—¶é—´çš„æ¨ç§»è€Œå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆæ ¹æ®è¿™äº›æ´¾ç”Ÿä¿¡æ¯è¿›è¡Œç¼–è¯‘å°±ä¼šå¸¦æ¥éº»çƒ¦ã€‚å› æ­¤ï¼Œç¼–è¯‘æœ€é€‚åˆç±»å‹ä¿¡æ¯ä¸ä¼šåœ¨é‡å¤æ±‚å€¼æ—¶å‘ç”Ÿå˜åŒ–çš„è¡¨è¾¾å¼ã€‚</p><p>ä¾‹å¦‚å¯¹äºåŸºæœ¬è¡¨è¾¾å¼<code>someArray[0].someProperty.someOtherProperty &lt; 0.1</code>æ¥è¯´ï¼Œç”±äºæ¶‰åŠæ•°ç»„è®¿é—®ã€ä¸€äº›å±æ€§å»å¼•ç”¨å’Œæ•°å€¼æ“ä½œï¼Œå› æ­¤æ€§èƒ½æå‡éå¸¸æ˜æ˜¾ã€‚åœ¨ä¸€ä¸ªè¿­ä»£ 50000 æ¬¡çš„å¾®å‹åŸºå‡†è¿è¡Œç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨è§£é‡Šå™¨æ±‚å€¼éœ€è¦ 75 æ¯«ç§’ï¼Œè€Œä½¿ç”¨è¯¥è¡¨è¾¾å¼çš„ç¼–è¯‘ç‰ˆæœ¬ä»…éœ€ 3 æ¯«ç§’ã€‚</p><h2 id="ç¼–è¯‘å™¨é…ç½®"><a href="#ç¼–è¯‘å™¨é…ç½®" class="headerlink" title="ç¼–è¯‘å™¨é…ç½®"></a>ç¼–è¯‘å™¨é…ç½®</h2><p>ç¼–è¯‘å™¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸å¼€å¯çš„ï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§ä¸åŒçš„æ–¹å¼å¼€å¯å®ƒã€‚</p><ol><li>é€šè¿‡ä½¿ç”¨è§£æå™¨é…ç½®è¿‡ç¨‹æ‰“å¼€</li><li>åœ¨å°†SpELåµŒå…¥åˆ°å…¶ä»–ç»„ä»¶ä¸­æ—¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨Springå±æ€§æ¥æ‰“å¼€</li></ol><p>ç¼–è¯‘å™¨å¯ä»¥åœ¨ä¸‰ç§æ¨¡å¼ä¸‹è¿è¡Œï¼Œè¿™äº›æ¨¡å¼åœ¨ org.springframework.expression.spel.SpelCompilerMode æšä¸¾ä¸­ï¼š</p><ul><li><code>OFF</code> (é»˜è®¤)ï¼šç¼–è¯‘å™¨å…³é—­ã€‚</li><li><code>IMMEDIATE</code>ï¼šåœ¨ç«‹å³æ¨¡å¼ä¸‹ï¼Œè¡¨è¾¾å¼ä¼šå°½å¿«ç¼–è¯‘ã€‚é€šå¸¸æ˜¯åœ¨ç¬¬ä¸€æ¬¡è§£é‡Šæ±‚å€¼ä¹‹åã€‚å¦‚æœç¼–è¯‘è¡¨è¾¾å¼å¤±è´¥ï¼ˆé€šå¸¸æ˜¯ç”±äºç±»å‹æ”¹å˜ï¼‰ï¼Œè¡¨è¾¾å¼æ±‚å€¼çš„è°ƒç”¨è€…å°†æ”¶åˆ°å¼‚å¸¸ã€‚</li><li><code>MIXED</code>ï¼šåœ¨æ··åˆæ¨¡å¼ä¸‹ï¼Œè¡¨è¾¾å¼ä¼šéšç€æ—¶é—´çš„æ¨ç§»åœ¨è§£é‡Šæ¨¡å¼å’Œç¼–è¯‘æ¨¡å¼ä¹‹é—´é»˜é»˜åˆ‡æ¢ã€‚ç»è¿‡ä¸€å®šæ¬¡æ•°çš„è§£é‡Šè¿è¡Œåï¼Œå®ƒä»¬ä¼šåˆ‡æ¢åˆ°ç¼–è¯‘å½¢å¼ï¼Œå¦‚æœç¼–è¯‘å½¢å¼å‡ºäº†é—®é¢˜ï¼ˆå¦‚å‰é¢æ‰€è¿°çš„ç±»å‹æ”¹å˜ï¼‰ï¼Œè¡¨è¾¾å¼ä¼šè‡ªåŠ¨å†æ¬¡åˆ‡æ¢å›è§£é‡Šå½¢å¼ã€‚ä¹‹åï¼Œå®ƒå¯èƒ½ä¼šç”Ÿæˆå¦ä¸€ä¸ªç¼–è¯‘å½¢å¼å¹¶åˆ‡æ¢åˆ°å®ƒã€‚åŸºæœ¬ä¸Šï¼Œç”¨æˆ·åœ¨ <code>IMMEDIATE</code> æ¨¡å¼ä¸‹è·å¾—çš„å¼‚å¸¸ä¼šåœ¨å†…éƒ¨å¤„ç†ã€‚</li></ul><p><code>IMMEDIATE</code> æ¨¡å¼ä¹‹æ‰€ä»¥å­˜åœ¨ï¼Œæ˜¯å› ä¸º <code>MIXED</code> æ¨¡å¼å¯èƒ½ä¼šç»™æœ‰å‰¯ä½œç”¨çš„è¡¨è¾¾å¼é€ æˆé—®é¢˜ã€‚å¦‚æœä¸€ä¸ªç¼–è¯‘è¡¨è¾¾å¼åœ¨éƒ¨åˆ†æˆåŠŸåå´©æºƒï¼Œé‚£ä¹ˆå®ƒå¯èƒ½å·²ç»æ‰§è¡Œäº†å½±å“ç³»ç»ŸçŠ¶æ€çš„æ“ä½œã€‚å¦‚æœå‘ç”Ÿäº†è¿™ç§æƒ…å†µï¼Œè°ƒç”¨è€…å¯èƒ½ä¸å¸Œæœ›å®ƒåœ¨è§£é‡Šæ¨¡å¼ä¸‹é™é»˜åœ°é‡æ–°è¿è¡Œï¼Œå› ä¸ºè¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†å¯èƒ½ä¼šè¿è¡Œä¸¤æ¬¡ã€‚</p><p>é€‰æ‹©æ¨¡å¼åï¼Œä½¿ç”¨ <code>SpelParserConfiguration</code> é…ç½®è§£æå™¨ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•è¿›è¡Œé…ç½®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SpelParserConfiguration config = <span class="keyword">new</span> SpelParserConfiguration(SpelCompilerMode.IMMEDIATE,</span><br><span class="line"><span class="keyword">this</span>.getClass().getClassLoader());</span><br><span class="line"></span><br><span class="line">SpelExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser(config);</span><br><span class="line"></span><br><span class="line">Expression expr = parser.parseExpression(<span class="string">&quot;payload&quot;</span>);</span><br><span class="line"></span><br><span class="line">MyMessage message = <span class="keyword">new</span> MyMessage();</span><br><span class="line"></span><br><span class="line">Object payload = expr.getValue(message);</span><br></pre></td></tr></table></figure><p>åœ¨æŒ‡å®šç¼–è¯‘å™¨æ¨¡å¼æ—¶ï¼Œè¿˜å¯ä»¥æŒ‡å®šä¸€ä¸ªç±»åŠ è½½å™¨ï¼ˆå…è®¸ä¼ é€’ç©ºå€¼ï¼‰ã€‚ç¼–è¯‘åçš„è¡¨è¾¾å¼å°†å®šä¹‰åœ¨ä¸€ä¸ªå­ç±»åŠ è½½å™¨ä¸­ï¼Œè¯¥ç±»åŠ è½½å™¨å°†æ ¹æ®æ‰€æä¾›çš„ä»»ä½•ç±»å‹åˆ›å»ºã€‚é‡è¦çš„æ˜¯ï¼Œå¦‚æœæŒ‡å®šäº†ç±»åŠ è½½å™¨ï¼Œè¦ç¡®ä¿å®ƒèƒ½çœ‹åˆ°è¡¨è¾¾å¼æ±‚å€¼è¿‡ç¨‹ä¸­æ¶‰åŠçš„æ‰€æœ‰ç±»å‹ã€‚å¦‚æœæœªæŒ‡å®šç±»åŠ è½½å™¨ï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤ç±»åŠ è½½å™¨ï¼ˆé€šå¸¸æ˜¯è¡¨è¾¾å¼æ±‚å€¼è¿‡ç¨‹ä¸­è¿è¡Œçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼‰ã€‚</p><p>é…ç½®ç¼–è¯‘å™¨çš„ç¬¬äºŒç§æ–¹æ³•é€‚ç”¨äº SpEL åµŒå…¥å…¶ä»–ç»„ä»¶çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹å¯èƒ½æ— æ³•é€šè¿‡é…ç½®å¯¹è±¡è¿›è¡Œé…ç½®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ JVM ç³»ç»Ÿå±æ€§ï¼ˆæˆ– SpringProperties æœºåˆ¶ï¼‰å°† <code>spring.expression.compiler.mode</code> å±æ€§è®¾ç½®ä¸º<code>SpelCompilerMode</code>æšä¸¾å€¼ã€‚</p><h2 id="ç¼–è¯‘å™¨çš„å±€é™æ€§"><a href="#ç¼–è¯‘å™¨çš„å±€é™æ€§" class="headerlink" title="ç¼–è¯‘å™¨çš„å±€é™æ€§"></a>ç¼–è¯‘å™¨çš„å±€é™æ€§</h2><p>è‡ª Spring Framework 4.1 ä»¥æ¥ï¼ŒåŸºæœ¬çš„ç¼–è¯‘æ¡†æ¶å·²ç»åˆ°ä½ã€‚ä¸è¿‡ï¼Œè¯¥æ¡†æ¶è¿˜ä¸æ”¯æŒç¼–è¯‘æ‰€æœ‰ç±»å‹çš„è¡¨è¾¾å¼ã€‚æœ€åˆçš„é‡ç‚¹æ˜¯å¯èƒ½åœ¨æ€§èƒ½å…³é”®å‹ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨çš„å¸¸è§è¡¨è¾¾å¼ã€‚ä»¥ä¸‹å‡ ç§è¡¨è¾¾å¼æš‚æ—¶æ— æ³•ç¼–è¯‘ï¼š</p><ul><li>æ¶‰åŠèµ‹å€¼çš„è¡¨è¾¾å¼</li><li>ä¾èµ–è½¬æ¢æœåŠ¡çš„è¡¨è¾¾å¼</li><li>ä½¿ç”¨è‡ªå®šä¹‰è§£æå™¨æˆ–è®¿é—®å™¨çš„è¡¨è¾¾å¼</li><li>ä½¿ç”¨é€‰æ‹©æˆ–æŠ•å½±çš„è¡¨è¾¾å¼</li></ul><h1 id="ä½¿ç”¨SpELå®šä¹‰Bean"><a href="#ä½¿ç”¨SpELå®šä¹‰Bean" class="headerlink" title="ä½¿ç”¨SpELå®šä¹‰Bean"></a>ä½¿ç”¨SpELå®šä¹‰Bean</h1><p>ç”¨æˆ·å¯ä»¥åœ¨åŸºäºXMLæˆ–æ³¨è§£çš„é…ç½®å…ƒæ•°æ®ä¸­ä½¿ç”¨SpELè¡¨è¾¾å¼æ¥å®šä¹‰<code>BeanDefinition</code>å®ä¾‹ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œå®šä¹‰è¡¨è¾¾å¼çš„è¯­æ³•å½¢å¼ä¸º<code>#&#123; &lt;expression string&gt; &#125;</code>ã€‚è¿™é‡Œå¿½ç•¥XMLé…ç½®æ–¹å¼ï¼Œç”¨çš„ä¸å¤šäº†ã€‚</p><h2 id="åŸºäºæ³¨è§£çš„é…ç½®"><a href="#åŸºäºæ³¨è§£çš„é…ç½®" class="headerlink" title="åŸºäºæ³¨è§£çš„é…ç½®"></a>åŸºäºæ³¨è§£çš„é…ç½®</h2><p>è¦æŒ‡å®šé»˜è®¤å€¼ï¼Œå¯åœ¨å­—æ®µã€æ–¹æ³•ã€æ–¹æ³•æˆ–æ„é€ å‡½æ•°å‚æ•°ä¸Šæ·»åŠ <code>@Value</code>æ³¨è§£ã€‚</p><p>1ã€è®¾ç½®ä¸€ä¸ªå­—æ®µçš„é»˜è®¤å€¼ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldValueTestBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;#&#123; systemProperties[&#x27;user.region&#x27;] &#125;&quot;)</span> <span class="comment">// è¯»å–çš„æ˜¯æœåŠ¡éƒ¨ç½²æœºå™¨çš„region</span></span><br><span class="line"><span class="keyword">private</span> String defaultLocale;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultLocale</span><span class="params">(String defaultLocale)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.defaultLocale = defaultLocale;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDefaultLocale</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.defaultLocale;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2ã€æ³¨å…¥å±æ€§setæ–¹æ³•é»˜è®¤å€¼ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyValueTestBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String defaultLocale;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;#&#123; systemProperties[&#x27;user.region&#x27;] &#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultLocale</span><span class="params">(String defaultLocale)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.defaultLocale = defaultLocale;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDefaultLocale</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.defaultLocale;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå½“Springå®¹å™¨åˆ›å»º <code>PropertyValueTestBean</code> å¯¹è±¡æ—¶ï¼Œå®ƒå°†è°ƒç”¨ <code>setDefaultLocale</code> æ–¹æ³•å¹¶ä¼ å…¥ç³»ç»Ÿå±æ€§ä¸­ â€˜user.regionâ€™ å¯¹åº”çš„å€¼ï¼Œä»è€Œè®¾ç½® <code>defaultLocale</code> æˆå‘˜å˜é‡çš„å€¼ã€‚</p><p>3ã€<code>@Autowired</code>å’Œæ„é€ å‡½æ•°ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>@Value</code> æ³¨è§£<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Case1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleMovieLister</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> MovieFinder movieFinder;</span><br><span class="line"><span class="keyword">private</span> String defaultLocale;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(MovieFinder movieFinder,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="meta">@Value(&quot;#&#123; systemProperties[&#x27;user.region&#x27;] &#125;&quot;)</span> String defaultLocale)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.movieFinder = movieFinder;</span><br><span class="line"><span class="keyword">this</span>.defaultLocale = defaultLocale;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Case2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieRecommender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String defaultLocale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> CustomerPreferenceDao customerPreferenceDao;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MovieRecommender</span><span class="params">(CustomerPreferenceDao customerPreferenceDao,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="meta">@Value(&quot;#&#123;systemProperties[&#x27;user.country&#x27;]&#125;&quot;)</span> String defaultLocale)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.customerPreferenceDao = customerPreferenceDao;</span><br><span class="line"><span class="keyword">this</span>.defaultLocale = defaultLocale;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="æ›´å¤šåŠŸèƒ½"><a href="#æ›´å¤šåŠŸèƒ½" class="headerlink" title="æ›´å¤šåŠŸèƒ½"></a>æ›´å¤šåŠŸèƒ½</h1><p>ä¸€äº›å€¼å¾—å…³æ³¨çš„åŠŸèƒ½â€¦</p><h2 id="ClassTypeè¡¨è¾¾å¼"><a href="#ClassTypeè¡¨è¾¾å¼" class="headerlink" title="ClassTypeè¡¨è¾¾å¼"></a>ClassTypeè¡¨è¾¾å¼</h2><p>ä½¿ç”¨<code>T(Type)</code>æ¥è¡¨ç¤º<code>java.lang.Class</code>å®ä¾‹ï¼Œ<code>Type</code>å¿…é¡»æ˜¯ç±»å…¨é™å®šåï¼ˆ<code>java.lang</code>åŒ…ä¸‹çš„ç±»é™¤å¤–ï¼‰ã€‚ä½¿ç”¨ClassTypeè¡¨è¾¾å¼è¿˜å¯ä»¥è®¿é—®ç±»é™æ€æ–¹æ³•åŠç±»é™æ€å­—æ®µã€‚</p><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ClassTypeè¡¨è¾¾å¼å’Œå¦‚ä½•è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.langåŒ…å†…çš„ä¸éœ€è¦ä½¿ç”¨å…¨é™å®šå</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;T(String)&quot;</span>).getValue(Class.class);</span><br><span class="line"><span class="comment">// ç±»é™æ€å­—æ®µè®¿é—®</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;T(Integer).MAX_VALUE&quot;</span>).getValue(<span class="keyword">int</span>.class);</span><br><span class="line"><span class="comment">// ç±»é™æ€æ–¹æ³•è°ƒç”¨</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;#&#123;T(java.lang.Math).random() * 100.0&#125;&quot;</span>, ParserContext.TEMPLATE_EXPRESSION).getValue(Double.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¡ä»¶åˆ¤æ–­ï¼š</span></span><br><span class="line"><span class="comment">// ç®—æ•°è¿ç®—è¡¨è¾¾å¼</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;1 + 1&quot;</span>).getValue(Integer.class);</span><br><span class="line"><span class="comment">// å…³ç³»è¡¨è¾¾å¼</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;2==2&quot;</span>).getValue(Boolean.class);</span><br><span class="line"><span class="comment">// é€»è¾‘è¡¨è¾¾å¼</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;2&gt;1 and (NOT true or NOT false)&quot;</span>).getValue(<span class="keyword">boolean</span>.class);</span><br><span class="line"><span class="comment">// instanceofè¡¨è¾¾å¼</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;&#x27;xyz&#x27; instanceof T(Integer)&quot;</span>).getValue(Boolean.class);</span><br><span class="line"><span class="comment">// æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">parser.parseExpression(<span class="string">&quot;&#x27;5.00&#x27; matches &#x27;^-?\\d+(\\.\\d&#123;2&#125;)?$&#x27;&quot;</span>).getValue(Boolean.class);</span><br></pre></td></tr></table></figure></p><h2 id="å‡½æ•°ã€å¯¹è±¡ã€å˜é‡çš„å®šä¹‰åŠå¼•ç”¨"><a href="#å‡½æ•°ã€å¯¹è±¡ã€å˜é‡çš„å®šä¹‰åŠå¼•ç”¨" class="headerlink" title="å‡½æ•°ã€å¯¹è±¡ã€å˜é‡çš„å®šä¹‰åŠå¼•ç”¨"></a>å‡½æ•°ã€å¯¹è±¡ã€å˜é‡çš„å®šä¹‰åŠå¼•ç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpELTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">reverseString</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        StringBuilder backwards = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; input.length(); i++) &#123;</span><br><span class="line">            backwards.append(input.charAt(input.length() - <span class="number">1</span> - i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> backwards.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line">        ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">        StandardEvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">        <span class="comment">// å®šä¹‰å˜é‡</span></span><br><span class="line">        context.setVariable(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;è·¯äººç”²java&quot;</span>);</span><br><span class="line">        context.setVariable(<span class="string">&quot;lesson&quot;</span>, <span class="string">&quot;Springç³»åˆ—&quot;</span>);</span><br><span class="line">        <span class="comment">//è·å–nameå˜é‡ï¼Œlessonå˜é‡</span></span><br><span class="line">        String name = parser.parseExpression(<span class="string">&quot;#name&quot;</span>).getValue(context, String.class);</span><br><span class="line">        log.info(name);</span><br><span class="line">        String lesson = parser.parseExpression(<span class="string">&quot;#lesson&quot;</span>).getValue(context, String.class);</span><br><span class="line">        log.info(lesson);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// StandardEvaluationContextæ„é€ å™¨ä¼ å…¥rootå¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡#rootæ¥è®¿é—®rootå¯¹è±¡</span></span><br><span class="line">        context = <span class="keyword">new</span> StandardEvaluationContext(<span class="string">&quot;æˆ‘æ˜¯rootå¯¹è±¡&quot;</span>);</span><br><span class="line">        String rootObj = parser.parseExpression(<span class="string">&quot;#root&quot;</span>).getValue(context, String.class);</span><br><span class="line">        log.info(rootObj);</span><br><span class="line">        <span class="comment">// #thisç”¨æ¥è®¿é—®å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„å¯¹è±¡</span></span><br><span class="line">        String thisObj = parser.parseExpression(<span class="string">&quot;#this&quot;</span>).getValue(context, String.class);</span><br><span class="line">        log.info(thisObj);</span><br><span class="line">        <span class="comment">// å®šä¹‰Listå¯¹è±¡ï¼Œè¿‡æ»¤Listå¹¶åšæŠ•å½±è¿ç®—</span></span><br><span class="line">        List&lt;Integer&gt; primes = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">17</span>));</span><br><span class="line">        context.setVariable(<span class="string">&quot;primes&quot;</span>, primes);  <span class="comment">// æ³¨å†Œå¯¹è±¡å˜é‡</span></span><br><span class="line">        List&lt;Integer&gt; primesGreaterThanTen = (List&lt;Integer&gt;) parser.parseExpression(<span class="string">&quot;#primes.?[#this&gt;10]&quot;</span>).getValue(context);</span><br><span class="line">        log.info(primesGreaterThanTen.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰æ–¹æ³•</span></span><br><span class="line">        context.registerFunction(<span class="string">&quot;reverseString&quot;</span>, SpELTest.class.getDeclaredMethod(<span class="string">&quot;reverseString&quot;</span>, String.class));</span><br><span class="line">        log.info(parser.parseExpression(<span class="string">&quot;#reverseString(&#x27;hello&#x27;)&quot;</span>).getValue(context, String.class));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç©ºå€¼å¤„ç†"><a href="#ç©ºå€¼å¤„ç†" class="headerlink" title="ç©ºå€¼å¤„ç†"></a>ç©ºå€¼å¤„ç†</h2><p>SpELå¼•å…¥äº†Groovyè¯­è¨€ä¸­çš„å®‰å…¨å¯¼èˆªè¿ç®—ç¬¦<code>(å¯¹è±¡|å±æ€§)?.å±æ€§</code>ï¼Œç”¨æ¥é¿å…<code>?.</code>å‰è¾¹çš„è¡¨è¾¾å¼ä¸ºnullæ—¶æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œè½¬è€Œè¿”å›nullã€‚è¿˜å¯ä»¥ä½¿ç”¨<code>?:</code>é€‰æ‹©åœ¨è¡¨è¾¾å¼ä¸ºnullæ—¶è¿”å›é»˜è®¤å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Inventor tesla = <span class="keyword">new</span> Inventor(<span class="string">&quot;Nikola Tesla&quot;</span>, <span class="keyword">new</span> Date(), <span class="string">&quot;Serbian&quot;</span>);</span><br><span class="line">EvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext(tesla);</span><br><span class="line">tesla.setName(<span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// nullæ—¶å–é»˜è®¤å€¼</span></span><br><span class="line">log.info(parser.parseExpression(<span class="string">&quot;name?:&#x27;Unknown&#x27;&quot;</span>).getValue(context, String.class));</span><br><span class="line"><span class="comment">// nullæ—¶å®‰å…¨è°ƒç”¨</span></span><br><span class="line">log.info(parser.parseExpression(<span class="string">&quot;name?.length()&quot;</span>).getValue(context, Integer.class).toString());</span><br></pre></td></tr></table></figure><h2 id="Listè¿ç®—"><a href="#Listè¿ç®—" class="headerlink" title="Listè¿ç®—"></a>Listè¿ç®—</h2><p>åœ¨ SpEL ä¸­ï¼Œ<code>?[]</code> å’Œ <code>![]</code> åˆ†åˆ«è¡¨ç¤ºé›†åˆé€‰æ‹©ï¼ˆcollection selectionï¼‰å’Œé›†åˆæŠ•å½±ï¼ˆcollection projectionï¼‰ã€‚<code>?[]</code> è¡¨è¾¾å¼ç”¨äºé€‰æ‹©æ»¡è¶³æŒ‡å®šæ¡ä»¶çš„é›†åˆå…ƒç´ ï¼Œ<code>![]</code> è¡¨è¾¾å¼ç”¨äºå¯¹é›†åˆè¿›è¡ŒæŠ•å½±æ“ä½œã€‚</p><blockquote><p>é›†åˆæŠ•å½±æˆ–é›†åˆæ˜ å°„çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šé€šè¿‡å¯¹é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ åº”ç”¨ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„é›†åˆï¼Œè¯¥é›†åˆåŒ…å«äº†åŸå§‹é›†åˆä¸­çš„å…ƒç´ ç»è¿‡æŸç§è½¬æ¢åçš„å€¼ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpELCollectionTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Inventor</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> String nationality;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Inventor tesla = <span class="keyword">new</span> Inventor(<span class="string">&quot;Nikola Tesla&quot;</span>, <span class="string">&quot;Bei Jin&quot;</span>);</span><br><span class="line">        Inventor tesla1 = <span class="keyword">new</span> Inventor(<span class="string">&quot;Nikola Tesla1&quot;</span>, <span class="string">&quot;Shang Hai&quot;</span>);</span><br><span class="line">        Inventor tesla2 = <span class="keyword">new</span> Inventor(<span class="string">&quot;Nikola Tesla2&quot;</span>, <span class="string">&quot;New York&quot;</span>);</span><br><span class="line">        Inventor tesla3 = <span class="keyword">new</span> Inventor(<span class="string">&quot;Nikola Tesla3&quot;</span>, <span class="string">&quot;Serbian&quot;</span>);</span><br><span class="line">        Inventor tesla4 = <span class="keyword">new</span> Inventor(<span class="string">&quot;Nikola Tesla4&quot;</span>, <span class="string">&quot;Serbian&quot;</span>);</span><br><span class="line">        List&lt;Inventor&gt; inventors = Arrays.asList(tesla, tesla1, tesla2, tesla3, tesla4);</span><br><span class="line"></span><br><span class="line">        ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">        EvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">        context.setVariable(<span class="string">&quot;inventors&quot;</span>, inventors);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯¹Liståšå„ç±»è¿ç®—ï¼š</span></span><br><span class="line">        <span class="comment">// è¿‡æ»¤ï¼Œé€‰æ‹©æ‰€æœ‰ nationality å­—æ®µä¸º &#x27;Serbian&#x27; çš„ Inventor å¯¹è±¡</span></span><br><span class="line">        List&lt;Inventor&gt; list = (List&lt;Inventor&gt;) parser.parseExpression(<span class="string">&quot;#inventors.?[nationality==&#x27;Serbian&#x27;]&quot;</span>).getValue(context);</span><br><span class="line">        log.info(list.toString());</span><br><span class="line">        <span class="comment">// æŠ•å½±ï¼Œé€‰æ‹©æ‰€æœ‰ Inventor å¯¹è±¡çš„ nationality å­—æ®µï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ List</span></span><br><span class="line">        List&lt;Inventor&gt; list1 = (List&lt;Inventor&gt;) parser.parseExpression(<span class="string">&quot;#inventors.![nationality]&quot;</span>).getValue(context);</span><br><span class="line">        log.info(list1.toString());</span><br><span class="line">        <span class="comment">// æŠ•å½±ï¼Œå¯¹æ‰€æœ‰å¯¹è±¡çš„ nationality å­—æ®µæ˜¯å¦ä¸º &#x27;Serbian&#x27; è¿›è¡Œåˆ¤æ–­ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„å¸ƒå°”ç±»å‹List</span></span><br><span class="line">        List&lt;Inventor&gt; list2 = (List&lt;Inventor&gt;) parser.parseExpression(<span class="string">&quot;#inventors.![nationality==&#x27;Serbian&#x27;]&quot;</span>).getValue(context);</span><br><span class="line">        log.info(list2.toString());</span><br><span class="line">        <span class="comment">// æŠ•å½±ï¼Œé€‰æ‹©æ‰€æœ‰ Inventor å¯¹è±¡çš„ serbian å­—æ®µï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ Listï¼Œä¸list1ç­‰åŒã€‚</span></span><br><span class="line">        List&lt;Inventor&gt; list3 = (List&lt;Inventor&gt;) parser.parseExpression(<span class="string">&quot;#inventors.![#this.getNationality()]&quot;</span>).getValue(context);</span><br><span class="line">        log.info(list3.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è®¿é—®Map"><a href="#è®¿é—®Map" class="headerlink" title="è®¿é—®Map"></a>è®¿é—®Map</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¿é—®map</span></span><br><span class="line">Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">params.put(<span class="string">&quot;backOrderCode&quot;</span>, <span class="string">&quot;H12345764564&quot;</span>);</span><br><span class="line">context.setVariable(<span class="string">&quot;params&quot;</span>, params);</span><br><span class="line">Object object = parser.parseExpression(<span class="string">&quot;#params[backOrderCode]&quot;</span>).getValue(context);</span><br><span class="line">log.info(object.toString());</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><p>[1] <a href="https://zhuanlan.zhihu.com/p/174786047">https://zhuanlan.zhihu.com/p/174786047</a><br>[2] <a href="https://zhuanlan.zhihu.com/p/149920813">https://zhuanlan.zhihu.com/p/149920813</a><br>[3] <a href="https://docs.spring.io/spring-framework/reference/core/expressions.html">https://docs.spring.io/spring-framework/reference/core/expressions.html</a></p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;SpELå³Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆSpring Expression Languageï¼‰ï¼Œå®ƒèƒ½åœ¨è¿è¡Œæ—¶æ„å»ºå¤æ‚è¡¨è¾¾å¼ã€å­˜å–å¯¹è±¡å›¾å±æ€§ã€å¯¹è±¡æ–¹æ³•è°ƒç”¨ç­‰ç­‰ï¼Œå¹¶ä¸”èƒ½ä¸SpringåŠŸèƒ½å®Œç¾æ•´åˆã€‚&lt;/p&gt;
&lt;p&gt;SpELæ˜¯å•ç‹¬æ¨¡å—ï¼ˆ&lt;code&gt;org.springframework.expression&lt;/code&gt;ï¼‰ï¼Œåªä¾èµ–äºcoreæ¨¡å—ï¼Œä¸ä¾èµ–äºå…¶ä»–æ¨¡å—ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨ã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="Java" scheme="http://silencezheng.top/tags/Java/"/>
    
    <category term="Spring" scheme="http://silencezheng.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>ç©ºæ´å·ç§¯</title>
    <link href="http://silencezheng.top/2023/12/25/article124/"/>
    <id>http://silencezheng.top/2023/12/25/article124/</id>
    <published>2023-12-24T18:01:57.000Z</published>
    <updated>2023-12-24T18:07:32.871Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç©ºæ´å·ç§¯ï¼ŒDilated Convolutionï¼Œä¹Ÿå¯è¯‘ä¸ºè†¨èƒ€å·ç§¯æˆ–æ‰©å¼ å·ç§¯ï¼Œå¯ä»¥ä½¿ç½‘ç»œåœ¨ä¸å¢åŠ å‚æ•°æ•°é‡çš„æƒ…å†µä¸‹æ‹¥æœ‰æ›´å¤§çš„æ„Ÿå—åŸŸã€‚<br><span id="more"></span></p><h2 id="æå‡º"><a href="#æå‡º" class="headerlink" title="æå‡º"></a>æå‡º</h2><p>ç©ºæ´å·ç§¯æœ€åˆçš„æå‡ºæ˜¯ä¸ºäº†è§£å†³å›¾åƒåˆ†å‰²çš„é—®é¢˜ï¼Œå¸¸è§çš„å›¾åƒåˆ†å‰²ç®—æ³•é€šå¸¸ä½¿ç”¨æ± åŒ–å±‚å’Œå·ç§¯å±‚æ¥å¢åŠ æ„Ÿå—åŸŸï¼ŒåŒæ—¶ä¹Ÿç¼©å°äº†ç‰¹å¾å›¾å°ºå¯¸(resolution)ï¼Œç„¶åå†åˆ©ç”¨ä¸Šé‡‡æ ·è¿˜åŸå›¾åƒå°ºå¯¸ï¼Œç‰¹å¾å›¾ç¼©å°å†æ”¾å¤§çš„è¿‡ç¨‹é€ æˆäº†ç²¾åº¦ä¸Šçš„æŸå¤±ï¼Œå› æ­¤éœ€è¦ä¸€ç§æ“ä½œå¯ä»¥åœ¨å¢åŠ æ„Ÿå—åŸŸçš„åŒæ—¶ä¿æŒç‰¹å¾å›¾çš„å°ºå¯¸ä¸å˜ï¼Œä»è€Œä»£æ›¿ä¸‹é‡‡æ ·å’Œä¸Šé‡‡æ ·æ“ä½œï¼Œåœ¨è¿™ç§éœ€æ±‚ä¸‹ï¼Œç©ºæ´å·ç§¯å°±è¯ç”Ÿäº†ã€‚å½“ç„¶ï¼Œè·³è·ƒè¿æ¥ï¼ˆskip connectionï¼‰ä¹Ÿæ˜¯å¦ä¸€ç§å¼¥è¡¥ä¿¡æ¯æŸå¤±çš„æ–¹æ³•ã€‚</p><p>ç©ºæ´å·ç§¯è‡ª2016åœ¨ICLRä¸Šè¢«æå‡ºåï¼Œæœ¬èº«æ˜¯ç”¨åœ¨å›¾åƒåˆ†å‰²é¢†åŸŸï¼Œä½†ç«‹é©¬è¢«Deepmindæ‹¿æ¥åº”ç”¨åˆ°è¯­éŸ³(WaveNet)å’ŒNLPé¢†åŸŸï¼Œå®ƒåœ¨ç‰©ä½“æ£€æµ‹ä¹Ÿå‘æŒ¥äº†é‡è¦çš„ä½œç”¨ã€‚</p><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>åœ¨å¸¸è§„å·ç§¯è¿ç®—ä¸­ï¼Œå›ºå®šå¤§å°çš„æ»¤æ³¢å™¨åœ¨è¾“å…¥ç‰¹å¾å›¾ä¸Šæ»‘åŠ¨ï¼Œæ»¤æ³¢å™¨ä¸­çš„å€¼ä¸è¾“å…¥ç‰¹å¾å›¾ä¸­çš„ç›¸åº”å€¼ç›¸ä¹˜ä»¥äº§ç”Ÿå•ä¸ªè¾“å‡ºå€¼ã€‚è¾“å‡ºç‰¹å¾å›¾ä¸­ç¥ç»å…ƒçš„æ„Ÿå—åŸŸè¢«å®šä¹‰ä¸ºæ»¤æ³¢å™¨å¯ä»¥â€œçœ‹åˆ°â€çš„è¾“å…¥ç‰¹å¾å›¾ä¸­çš„åŒºåŸŸã€‚æ„Ÿå—åŸŸçš„å¤§å°ç”±æ»¤æ³¢å™¨çš„å¤§å°å’Œå·ç§¯çš„æ­¥é•¿å†³å®šã€‚</p><p>ç›¸åï¼Œåœ¨è†¨èƒ€å·ç§¯è¿ç®—ä¸­ï¼Œé€šè¿‡åœ¨æ»¤æ³¢å™¨å€¼ä¹‹é—´æ’å…¥é—´éš™æ¥â€œæ‰©å¼ â€æ»¤æ³¢å™¨ã€‚<strong>è†¨èƒ€ç‡</strong>(dilation rate) å†³å®šäº†é—´éš™çš„å¤§å°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯ä»¥è°ƒæ•´çš„è¶…å‚æ•°ã€‚å½“è†¨èƒ€ç‡ä¸º 1 æ—¶ï¼Œè†¨èƒ€å·ç§¯ç®€åŒ–ä¸ºå¸¸è§„å·ç§¯ã€‚</p><p>è†¨èƒ€ç‡åœ¨ä¸å¢åŠ å‚æ•°æ•°é‡çš„æƒ…å†µä¸‹æœ‰æ•ˆåœ°å¢åŠ äº†æ»¤æ³¢å™¨çš„æ„Ÿå—åŸŸï¼Œå› ä¸ºæ»¤æ³¢å™¨çš„å¤§å°ä»ç„¶ç›¸åŒï¼Œä½†å€¼ä¹‹é—´æœ‰é—´éš™ã€‚è¿™åœ¨éœ€è¦æ›´å¤§æ„Ÿå—åŸŸçš„æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ï¼Œä½†å¢åŠ æ»¤æ³¢å™¨çš„å¤§å°ä¼šå¯¼è‡´å‚æ•°æ•°é‡å’Œè®¡ç®—å¤æ‚æ€§çš„å¢åŠ ã€‚</p><p>ä¸‹å›¾æè¿°äº†æ­£å¸¸å·ç§¯ä¸æ‰©å¼ å·ç§¯ä¹‹é—´çš„å·®å¼‚ï¼Œé™„åŠ å‚æ•°$l$ï¼ˆè†¨èƒ€å› å­ï¼‰è¡¨ç¤ºè¾“å…¥æ‰©å¼ äº†å¤šå°‘ã€‚æ¢å¥è¯è¯´ï¼Œæ ¹æ®è¯¥å‚æ•°çš„å€¼ï¼Œæ»¤æ³¢å™¨ä¸­ä¼šè·³è¿‡$(l-1)$ä¸ªåƒç´ ã€‚</p><p><img src="/assets/post_img/article124/normalvsdilatedconv.png" alt="dc"></p><p>è†¨èƒ€å·ç§¯çš„å…¬å¼å¯è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\left(F_{* l} k\right)(p)=\sum_{(s+l t=p)} F(s) k(t)</script><p>å…¶ä¸­ï¼Œ$F(s)$ä¸ºè¾“å…¥ç‰¹å¾ï¼Œ$s$ä¸ºå„é‡‡æ ·ä½ç½®ï¼Œ$k(t)$è¡¨ç¤ºå·ç§¯æ ¸$k$åœ¨$t$å¤„çš„æƒé‡ï¼Œ${*l}$è¡¨ç¤ºè†¨èƒ€å› å­ä¸º$l$çš„è†¨èƒ€å·ç§¯ã€‚</p><p>$(F_{* l} k)(p)$ä¸ºåœ¨ä½ç½®$p$å¤„çš„è¾“å‡ºã€‚æ±‚å’Œæ¡ä»¶è¿˜éœ€è¦å†çœ‹ä¸‹â€¦</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>åœ¨Pytorchä¸­å®ç°ç©ºæ´å·ç§¯ååˆ†ç®€å•ï¼Œåªéœ€è¦æŒ‡å®šdilationå‚æ•°å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DilatedCNN</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="built_in">super</span>(DilatedCNN,self).__init__()</span><br><span class="line">    self.convlayers = nn.Sequential(</span><br><span class="line">      nn.Conv2d(in_channels = <span class="number">3</span>, out_channels = <span class="number">6</span>, kernel_size = <span class="number">9</span>, stride = <span class="number">1</span>, padding = <span class="number">0</span>, dilation=<span class="number">2</span>),</span><br><span class="line">      nn.ReLU(),</span><br><span class="line">      nn.Conv2d(in_channels=<span class="number">6</span>, out_channels=<span class="number">16</span>, kernel_size = <span class="number">3</span>, stride = <span class="number">1</span>, padding= <span class="number">0</span>, dilation = <span class="number">2</span>),</span><br><span class="line">      nn.ReLU(),</span><br><span class="line">    )</span><br><span class="line">    self.fclayers = nn.Sequential(</span><br><span class="line">      nn.Linear(<span class="number">2304</span>,<span class="number">120</span>),</span><br><span class="line">      nn.ReLU(),</span><br><span class="line">      nn.Linear(<span class="number">120</span>,<span class="number">84</span>),</span><br><span class="line">      nn.ReLU(),</span><br><span class="line">      nn.Linear(<span class="number">84</span>,<span class="number">10</span>)</span><br><span class="line">    )</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self,x</span>):</span></span><br><span class="line">    x = self.convlayers(x)</span><br><span class="line">    x = x.view(-<span class="number">1</span>,<span class="number">2304</span>)</span><br><span class="line">    x = self.fclayers(x)</span><br><span class="line">    <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><h2 id="å¯èƒ½äº§ç”Ÿçš„é—®é¢˜"><a href="#å¯èƒ½äº§ç”Ÿçš„é—®é¢˜" class="headerlink" title="å¯èƒ½äº§ç”Ÿçš„é—®é¢˜"></a>å¯èƒ½äº§ç”Ÿçš„é—®é¢˜</h2><ol><li>ç½‘æ ¼æ•ˆåº”ï¼ˆThe Gridding Effectï¼‰</li><li>Long-ranged information might be not relevant.</li></ol><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><p>[1] <a href="https://zhuanlan.zhihu.com/p/113285797">https://zhuanlan.zhihu.com/p/113285797</a><br>[2] <a href="https://www.geeksforgeeks.org/dilated-convolution/">https://www.geeksforgeeks.org/dilated-convolution/</a><br>[3] <a href="https://developer.orbbec.com.cn/v/blog_detail/892">https://developer.orbbec.com.cn/v/blog_detail/892</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç©ºæ´å·ç§¯ï¼ŒDilated Convolutionï¼Œä¹Ÿå¯è¯‘ä¸ºè†¨èƒ€å·ç§¯æˆ–æ‰©å¼ å·ç§¯ï¼Œå¯ä»¥ä½¿ç½‘ç»œåœ¨ä¸å¢åŠ å‚æ•°æ•°é‡çš„æƒ…å†µä¸‹æ‹¥æœ‰æ›´å¤§çš„æ„Ÿå—åŸŸã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="Python" scheme="http://silencezheng.top/tags/Python/"/>
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="http://silencezheng.top/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨Springé¡¹ç›®ä¸­ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡</title>
    <link href="http://silencezheng.top/2023/11/24/article123/"/>
    <id>http://silencezheng.top/2023/11/24/article123/</id>
    <published>2023-11-24T15:48:44.000Z</published>
    <updated>2023-11-24T15:57:36.987Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è°ˆè®ºä¸€åˆ‡ä¹‹å‰ï¼Œä½¿ç”¨çš„æ•°æ®åº“ä¸€å®šè¦æ”¯æŒäº‹åŠ¡ï¼Œæœ¬æ–‡ä»¥MySQL InnoDBå­˜å‚¨å¼•æ“ä¸ºä¾‹ï¼Œä»æ•°æ®åº“äº‹åŠ¡åŸºæœ¬åŸç†å‡ºå‘ï¼Œç®€è¦è¯´æ˜äº‹åŠ¡ç›¸å…³çš„ä¸»è¦çŸ¥è¯†ï¼Œä»¥åŠå¦‚ä½•åœ¨Springé¡¹ç›®ä¸­ä½¿ç”¨ï¼Œå¯¹äºç»†èŠ‚çš„æè¿°å°‘ä¸”æ¨¡ç³Šï¼Œéœ€è¦ä¸æ–­å®Œå–„ã€‚</p><p>ç›¸å…³å†…å®¹ï¼šInnoDBäº‹åŠ¡å®ç°ã€Springäº‹åŠ¡ä¼ æ’­æœºåˆ¶ç­‰ã€‚<br><span id="more"></span></p><h1 id="ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼ˆTransactionï¼‰"><a href="#ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼ˆTransactionï¼‰" class="headerlink" title="ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼ˆTransactionï¼‰"></a>ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼ˆTransactionï¼‰</h1><p><strong>äº‹åŠ¡æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ</strong>ã€‚äº‹åŠ¡æ˜¯ä¸€ç§ç”¨äºç»´æŠ¤æ•°æ®ä¸€è‡´æ€§çš„æœºåˆ¶ï¼Œå®ƒç¡®ä¿äº†æ•°æ®åº“åœ¨å¤šä¸ªå¹¶å‘æ“ä½œä¸‹ä»ç„¶ä¿æŒä¸€è‡´æ€§ã€‚</p><p>äº‹åŠ¡ï¼ˆæœ€å°æ“ä½œå•å…ƒï¼‰å­˜åœ¨çš„ä¸»è¦æ„å›¾ï¼š</p><ul><li>åœ¨æœ€å°æ“ä½œå•å…ƒä¸­ä¿æŒç¨³å®šçš„æ“ä½œï¼Œå³ä½¿åœ¨æ•…éšœæ—¶ä¹Ÿèƒ½æ¢å¤åˆ°æ“ä½œä¹‹å‰çš„çŠ¶æ€ä¿æŒæ•°æ®ä¸€è‡´æ€§ã€‚</li><li>ä¿æŒå„ä¸ªæœ€å°æ“ä½œå•å…ƒä¹‹é—´äº’ç›¸éš”ç¦»ï¼Œä»¥é˜²æ­¢äº’ç›¸äº¤äº’äº§ç”Ÿçš„è¦†ç›–æ€§é”™è¯¯ã€‚</li></ul><p>äº‹åŠ¡ç»“æŸçš„ä¸¤ç§å¯èƒ½æ–¹å¼ï¼š</p><ul><li><code>commit</code>ï¼šæäº¤æœ€å°æ“ä½œå•å…ƒä¸­çš„æ‰€æœ‰æ“ä½œã€‚</li><li><code>terminate</code>ï¼šæ“ä½œç»ˆæ­¢ï¼Œæœ€å°æ“ä½œå•å…ƒä¸­æ‰€æœ‰ä¿®æ”¹æ— æ•ˆã€‚</li></ul><p>æ•°æ®åº“æ“ä½œçš„ç¯å¢ƒï¼š</p><ul><li>å…±äº«-å¤šç”¨æˆ·å¹¶å‘è®¿é—®</li><li>ä¸ç¨³å®š-æ½œåœ¨çš„ç¡¬ä»¶/è½¯ä»¶æ•…éšœ</li></ul><p>äº‹åŠ¡æ‰€éœ€ç¯å¢ƒï¼š</p><ul><li>ä¸å…±äº« - ä¸€ä¸ªäº‹åŠ¡å†…çš„æ“ä½œä¸å—å…¶ä»–äº‹åŠ¡å½±å“</li><li>ç¨³å®š - å³ä½¿é¢å¯¹ç³»ç»Ÿæ•…éšœï¼Œå½“å‰äº‹åŠ¡çš„æ“ä½œä¹Ÿèƒ½ä¿ç•™ç°åœº</li></ul><p>ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦å¼€å§‹ï¼Œåˆ™å¿…é¡»ç¡®ä¿ï¼š</p><ul><li>æ‰€æœ‰æ“ä½œå¿…é¡»å¯å›æº¯</li><li>æ‰€æœ‰æ“ä½œå¯¹åç»­æ“ä½œçš„å½±å“å¿…é¡»æ˜¯å¯è§çš„</li></ul><p>ä¸€ä¸ªäº‹åŠ¡å¼€å§‹çš„è¿‡ç¨‹ä¸­å¿…é¡»ç¡®ä¿ï¼šåœ¨è¯¥äº‹åŠ¡ç»“æŸä¹‹å‰å…¶ä»–äº‹åŠ¡çœ‹ä¸åˆ°å®ƒçš„ç»“æœã€‚å¦‚æœäº‹åŠ¡ä¸­æ­¢ï¼Œå¿…é¡»ç¡®ä¿å½“å‰äº‹åŠ¡æ‰€æœ‰å¯èƒ½å½±å“æ•°æ®ä¸€è‡´æ€§çš„æ“ä½œéƒ½ä¼šè¢«æ¸…ç†ã€‚å¦‚æœç³»ç»Ÿå‡ºç°æ•…éšœï¼Œå¿…é¡»ç¡®ä¿é‡æ–°å¯åŠ¨æ—¶æ‰€æœ‰æœªæäº¤çš„äº‹åŠ¡éƒ½ä¼šè¢«æ¸…ç†ã€‚</p><p>å…³ç³»å‹æ•°æ®åº“å¤§å¤šéµå¾ªäº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼š</p><ol><li>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸæ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šã€‚å¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªæ“ä½œå¤±è´¥ï¼Œé‚£ä¹ˆæ•´ä¸ªäº‹åŠ¡éƒ½ä¼šè¢«å›æ»šåˆ°åˆå§‹çŠ¶æ€ã€‚</li><li>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡åœ¨æ‰§è¡Œå‰åï¼Œæ•°æ®åº“å¿…é¡»ä¿æŒä¸€è‡´æ€§çŠ¶æ€ã€‚è¿™æ„å‘³ç€äº‹åŠ¡æ‰§è¡Œåï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸä»ç„¶å¾—ä»¥ç»´æŠ¤ï¼Œä»¥è½¬è´¦ä¸šåŠ¡ä¸ºä¾‹ï¼ŒåŒæ–¹å­˜æ¬¾æ€»é¢åº”ä¸å˜ã€‚</li><li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šäº‹åŠ¡çš„æ‰§è¡Œåº”è¯¥ä¸å…¶ä»–äº‹åŠ¡ç›¸äº’éš”ç¦»ï¼Œå³ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”è¯¥å½±å“å…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œã€‚è¿™ç¡®ä¿äº†å¹¶å‘äº‹åŠ¡ä¹‹é—´çš„æ•°æ®ä¸ä¼šäº’ç›¸å¹²æ‰°ã€‚</li><li>æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šä¸€æ—¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œå¯¹æ•°æ®åº“çš„ä¿®æ”¹åº”è¯¥æ°¸ä¹…ä¿å­˜ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰å½±å“ã€‚</li></ol><p>å…³äºå››å¤§ç‰¹æ€§çš„ä¸€äº›ç†è§£ï¼š</p><blockquote><p>åŸå­æ€§ï¼Œéš”ç¦»æ€§å’ŒæŒä¹…æ€§æ˜¯æ•°æ®åº“çš„å±æ€§ï¼Œè€Œä¸€è‡´æ€§ï¼ˆåœ¨ ACID æ„ä¹‰ä¸Šï¼‰æ˜¯åº”ç”¨ç¨‹åºçš„å±æ€§ã€‚åº”ç”¨å¯èƒ½ä¾èµ–æ•°æ®åº“çš„åŸå­æ€§å’Œéš”ç¦»å±æ€§æ¥å®ç°ä¸€è‡´æ€§ï¼Œä½†è¿™å¹¶ä¸ä»…å–å†³äºæ•°æ®åº“ã€‚åªæœ‰ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€åŸå­æ€§ã€éš”ç¦»æ€§ä¹‹åï¼Œä¸€è‡´æ€§æ‰å¯èƒ½å¾—åˆ°ä¿éšœã€‚</p></blockquote><ul><li>åªæœ‰æ»¡è¶³ä¸€è‡´æ€§ï¼Œäº‹åŠ¡çš„æ‰§è¡Œç»“æœæ‰æ˜¯æ­£ç¡®çš„ã€‚</li><li>åœ¨æ— å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œéš”ç¦»æ€§ä¸€å®šèƒ½å¤Ÿæ»¡è¶³ã€‚æ­¤æ—¶åªè¦èƒ½æ»¡è¶³åŸå­æ€§ï¼Œå°±ä¸€å®šèƒ½æ»¡è¶³ä¸€è‡´æ€§ã€‚ åœ¨å¹¶å‘çš„æƒ…å†µä¸‹å¤šä¸ªäº‹åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œäº‹åŠ¡ä¸ä»…è¦æ»¡è¶³åŸå­æ€§ï¼Œè¿˜éœ€è¦æ»¡è¶³éš”ç¦»æ€§ï¼Œæ‰èƒ½æ»¡è¶³ä¸€è‡´æ€§ã€‚</li><li>äº‹åŠ¡æ»¡è¶³æŒä¹…æ€§æ˜¯ä¸ºäº†èƒ½åº”å¯¹æ•°æ®åº“å´©æºƒçš„æƒ…å†µã€‚</li></ul><h1 id="InnoDBäº‹åŠ¡å®ç°"><a href="#InnoDBäº‹åŠ¡å®ç°" class="headerlink" title="InnoDBäº‹åŠ¡å®ç°"></a>InnoDBäº‹åŠ¡å®ç°</h1><p>MySQLæä¾›æ’ä»¶å¼å­˜å‚¨å¼•æ“ï¼Œè¿™äº›å­˜å‚¨å¼•æ“æ˜¯åŸºäºè¡¨çš„ï¼Œè€Œä¸æ˜¯æ•°æ®åº“ã€‚</p><p>InnoDBå­˜å‚¨å¼•æ“æ”¯æŒäº‹åŠ¡ï¼Œå…¶è®¾è®¡ç›®æ ‡ä¸»è¦é¢å‘åœ¨çº¿äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰çš„åº”ç”¨ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯è¡Œé”è®¾è®¡ï¼Œæ”¯æŒå¤–é”®ï¼Œå¹¶æ”¯æŒéé”å®šè¯»ï¼Œå³é»˜è®¤è¯»å–æ“ä½œä¸ä¼šäº§ç”Ÿé”ã€‚ä»MySQLæ•°æ®åº“5.5.8ç‰ˆæœ¬å¼€å§‹ï¼ŒInnoDBå­˜å‚¨å¼•æ“æ˜¯MySQLé»˜è®¤çš„å­˜å‚¨å¼•æ“ã€‚</p><p>åœ¨InnoDBå¼•æ“ä¸­å®ç°äº‹åŠ¡æœ€é‡è¦çš„ä¸œè¥¿å°±æ˜¯æ—¥å¿—ç³»ç»Ÿï¼Œä¿è¯äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ä¸»è¦ä¾é è¿™ä¸¤å¤§æ—¥å¿—ï¼š</p><ul><li><strong>redo log</strong>ï¼šä¿è¯äº‹åŠ¡æŒä¹…æ€§</li><li><strong>undo log</strong>ï¼šå›æ»šæ—¥å¿—ï¼Œä¿è¯äº‹åŠ¡åŸå­æ€§</li></ul><p>ä¸¤å¤§æ—¥å¿—ç³»ç»Ÿåˆ†åˆ«ä¿è¯äº†æŒä¹…æ€§å’ŒåŸå­æ€§ï¼Œéš”ç¦»æ€§åˆ™æ˜¯é€šè¿‡<strong>MVCCæœºåˆ¶</strong>å’Œ<strong>é”æœºåˆ¶</strong>æ¥æ§åˆ¶å®ç°ã€‚</p><h2 id="Logical-logs-amp-Physical-logs"><a href="#Logical-logs-amp-Physical-logs" class="headerlink" title="Logical logs &amp; Physical logs"></a>Logical logs &amp; Physical logs</h2><p><strong>é€»è¾‘æ—¥å¿—ï¼ˆLogical Logsï¼‰ï¼š</strong></p><ol><li><strong>è®°å½•å†…å®¹</strong>ï¼šé€»è¾‘æ—¥å¿—è®°å½•çš„æ˜¯æ•°æ®åº“æ“ä½œçš„é€»è¾‘ä¿¡æ¯ï¼Œä¾‹å¦‚SQLè¯­å¥ã€è¡¨å’Œåˆ—çš„åç§°ã€æ•°æ®çš„é€»è¾‘ç»“æ„ç­‰ã€‚å®ƒä¸å…³å¿ƒåº•å±‚æ•°æ®çš„ç‰©ç†å­˜å‚¨æ–¹å¼ã€‚</li><li><strong>ç”¨é€”</strong>ï¼šé€»è¾‘æ—¥å¿—ä¸»è¦ç”¨äºæ•°æ®å¯¼å…¥ã€å¯¼å‡ºã€å¤‡ä»½å’Œæ¢å¤ç­‰é«˜å±‚æ¬¡çš„æ•°æ®æ“ä½œã€‚å®ƒå…è®¸å°†æ•°æ®ä»ä¸€ä¸ªæ•°æ®åº“å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ•°æ®åº“ï¼Œè€Œä¸å¿…è€ƒè™‘åº•å±‚æ•°æ®çš„ç‰©ç†ç»“æ„ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼šMySQLçš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰æ˜¯ä¸€ç§é€»è¾‘æ—¥å¿—ï¼Œè®°å½•äº†SQLè¯­å¥çš„æ‰§è¡Œé¡ºåºï¼Œä»¥ä¾¿åœ¨å¤åˆ¶æ•°æ®æˆ–è¿›è¡Œæ•°æ®å¤‡ä»½æ—¶ä½¿ç”¨ã€‚</li></ol><p><strong>ç‰©ç†æ—¥å¿—ï¼ˆPhysical Logsï¼‰ï¼š</strong></p><ol><li><strong>è®°å½•å†…å®¹</strong>ï¼šç‰©ç†æ—¥å¿—è®°å½•çš„æ˜¯æ•°æ®åº“æ“ä½œå¯¹åº•å±‚ç‰©ç†æ•°æ®çš„å®é™…ä¿®æ”¹ï¼ŒåŒ…æ‹¬æ•°æ®é¡µçš„è¯»å†™ã€ç£ç›˜å—çš„åˆ†é…å’Œé‡Šæ”¾ç­‰ã€‚å®ƒå…³æ³¨æ•°æ®çš„ç‰©ç†å­˜å‚¨ç»†èŠ‚ã€‚</li><li><strong>ç”¨é€”</strong>ï¼šç‰©ç†æ—¥å¿—ä¸»è¦ç”¨äºç¡®ä¿äº‹åŠ¡çš„æŒä¹…æ€§å’Œæ¢å¤èƒ½åŠ›ã€‚å®ƒå…è®¸åœ¨ç³»ç»Ÿå´©æºƒæˆ–æ•…éšœåæ¢å¤æœªæäº¤çš„äº‹åŠ¡ï¼Œä»¥åŠå°†äº‹åŠ¡çš„ä¿®æ”¹åº”ç”¨åˆ°æ•°æ®åº“ä¸­ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼šMySQLçš„é‡åšæ—¥å¿—ï¼ˆredo logï¼‰æ˜¯ä¸€ç§ç‰©ç†æ—¥å¿—ï¼Œè®°å½•äº†äº‹åŠ¡å¯¹æ•°æ®é¡µçš„ä¿®æ”¹ï¼Œä»¥ä¾¿åœ¨äº‹åŠ¡æäº¤åå°†è¿™äº›ä¿®æ”¹åº”ç”¨åˆ°æ•°æ®æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åœ¨ç³»ç»Ÿæ•…éšœæ—¶æ¢å¤æ•°æ®ä¸€è‡´æ€§ã€‚</li></ol><p>ä»¥ä¸Šåªæ˜¯ç®€è¦çš„æ¦‚å¿µè§£é‡Šï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥å‚è§[6]ã€‚</p><h2 id="Binlog"><a href="#Binlog" class="headerlink" title="Binlog"></a>Binlog</h2><p>åœ¨ä»‹ç»InnoDBçš„ä¸¤å¤§æ ¸å¿ƒæ—¥å¿—å‰ï¼Œå…ˆç®€å•èŠä¸€ä¸‹MySQLçš„äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå¯¹ç†è§£Redo logçš„ä½œç”¨æœ‰å¸®åŠ©ã€‚</p><p>binlog = binary logï¼ŒäºŒè¿›åˆ¶æ—¥å¿—ï¼Œå®ƒè®°å½•äº†é™¤äº† select ä¹‹å¤–æ‰€æœ‰çš„ DDL å’Œ DML è¯­å¥ã€‚ä»¥äº‹ä»¶å½¢å¼è®°å½•ï¼Œè¿˜åŒ…å«è¯­å¥æ‰€æ‰§è¡Œçš„æ¶ˆè€—çš„æ—¶é—´ï¼ŒMySQL çš„äºŒè¿›åˆ¶æ—¥å¿—æ˜¯äº‹åŠ¡å®‰å…¨å‹çš„ã€‚binlogæ˜¯MySQLçš„é€»è¾‘æ—¥å¿—ï¼Œå¹¶ä¸”ç”±Serverå±‚è¿›è¡Œè®°å½•ï¼Œä½¿ç”¨ä»»ä½•å­˜å‚¨å¼•æ“çš„MySQLéƒ½ä¼šè®°å½•binlogæ—¥å¿—ã€‚</p><p>binlogæ—¥å¿—æœ‰ä¸¤ä¸ªæœ€é‡è¦çš„ä½¿ç”¨åœºæ™¯ï¼š</p><ul><li>ä¸»ä»å¤åˆ¶ï¼šmysql replication åœ¨ master ç«¯å¼€å¯ binlogï¼Œmaster æŠŠå®ƒçš„äºŒè¿›åˆ¶æ—¥å¿—ä¼ é€’ç»™ slaves æ¥è¾¾åˆ° master-slave æ•°æ®ä¸€è‡´çš„ç›®çš„ã€‚</li><li>æ•°æ®æ¢å¤ï¼šé€šè¿‡ mysqlbinlog å·¥å…·æ¥æ¢å¤æ•°æ®ã€‚</li></ul><p>binlog æ—¥å¿—åŒ…æ‹¬ä¸¤ç±»æ–‡ä»¶ï¼š</p><ol><li>äºŒè¿›åˆ¶æ—¥å¿—ç´¢å¼•æ–‡ä»¶ï¼ˆæ–‡ä»¶ååç¼€ä¸º .indexï¼‰ç”¨äºè®°å½•æ‰€æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li><li>äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼ˆæ–‡ä»¶ååç¼€ä¸º .00000*ï¼‰è®°å½•æ•°æ®åº“æ‰€æœ‰çš„ DDL å’Œ DML è¯­å¥äº‹ä»¶ã€‚</li></ol><p>binlogæ–‡ä»¶æ˜¯é€šè¿‡è¿½åŠ çš„æ–¹å¼å†™å…¥çš„ï¼Œå¯é€šè¿‡é…ç½®å‚æ•°<code>max_binlog_size</code>è®¾ç½®æ¯ä¸ª binlog æ–‡ä»¶çš„å¤§å°ï¼Œå½“æ–‡ä»¶å¤§å°å¤§äºç»™å®šå€¼åï¼Œæ—¥å¿—ä¼šå‘ç”Ÿæ»šåŠ¨ï¼Œä¹‹åçš„æ—¥å¿—è®°å½•åˆ°æ–°çš„æ–‡ä»¶ä¸Šã€‚</p><p>binlogæ—¥å¿—æœ‰ä¸‰ç§æ ¼å¼ï¼Œåˆ†åˆ«ä¸ºSTATMENTã€ROWå’ŒMIXEDã€‚åœ¨ MySQL 5.7.7ä¹‹å‰ï¼Œé»˜è®¤çš„æ ¼å¼æ˜¯STATEMENTï¼ŒMySQL 5.7.7ä¹‹åï¼Œé»˜è®¤å€¼æ˜¯ROWã€‚æ—¥å¿—æ ¼å¼é€šè¿‡<code>binlog-format</code>æŒ‡å®šã€‚</p><p>æˆ‘ä»¬å‡è®¾æ•°æ®åº“åªæœ‰ binlogï¼Œé‚£ä¹ˆæ•°æ®æ–‡ä»¶çš„æ›´æ–°å’Œå†™å…¥ binlog åªæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ol><li>å…ˆæ›´æ–°æ•°æ®æ–‡ä»¶ï¼Œå†å†™å…¥ binlogã€‚</li><li>å…ˆå†™å…¥ binlogï¼Œå†æ›´æ–°æ•°æ®æ–‡ä»¶ã€‚</li></ol><p>å¦‚æœå…ˆæ›´æ–°æ•°æ®æ–‡ä»¶ï¼Œæ¥ç€æœåŠ¡å™¨å®•æœºï¼Œåˆ™å¯¼è‡´ binlog ä¸­ç¼ºå°‘æœ€åçš„æ›´æ–°ä¿¡æ¯ï¼›å¦‚æœå…ˆå†™ binlog å†æ›´æ–°æ•°æ®åˆ™å¯èƒ½å¯¼è‡´æ•°æ®æ–‡ä»¶æœªè¢«æ›´æ–°ã€‚æ‰€ä»¥åœ¨åªæœ‰ binlog çš„ç¯å¢ƒä¸­çš„ MySQL æ˜¯ä¸å…·å¤‡ crash-safe çš„èƒ½åŠ›ã€‚</p><p>PSï¼šè¿™é‡Œå…³äºbinlogçš„å†™å…¥æœºåˆ¶ä¸åšè¿‡å¤šå±•å¼€ï¼Œä½†ä¹Ÿæ˜¯åˆ†writeå’Œfsyncä¸¤ä¸ªæ­¥éª¤ï¼Œæ—¶æœºç”±å‚æ•°<code>sync_binlog</code>æ§åˆ¶ã€‚</p><h2 id="Write-Ahead-Logging"><a href="#Write-Ahead-Logging" class="headerlink" title="Write-Ahead Logging"></a>Write-Ahead Logging</h2><p>Write-Ahead Loggingç­–ç•¥æ˜¯ä¸€ç§ç”¨äºç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œæ¢å¤èƒ½åŠ›çš„é‡è¦æŠ€æœ¯ï¼Œä¸ºäº†ä¿è¯æ¢å¤æ—¶å¯ä»¥ä»æ—¥å¿—ä¸­çœ‹åˆ°æœ€æ–°çš„æ•°æ®åº“çŠ¶æ€ï¼Œè¦æ±‚æ—¥å¿—å…ˆäºæ•°æ®å†…å®¹è½ç›˜ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ä¿®æ”¹æ•°æ®ä¹‹å‰ï¼Œé¦–å…ˆå°†è¿™äº›ä¿®æ”¹æ“ä½œè®°å½•åˆ°ä¸€ä¸ªæŒä¹…æ€§çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œç„¶åå†å°†è¿™äº›æ“ä½œåº”ç”¨åˆ°å®é™…çš„æ•°æ®æ–‡ä»¶ã€‚æ³¨æ„è¿™é‡Œçš„æ—¥å¿—æ˜¯æ¯”binlogæ›´ç»†ç²’åº¦çš„æ—¥å¿—ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œäº‹åŠ¡å®Œæˆæäº¤å‰è¿˜éœ€è¦åœ¨æ—¥å¿—ä¸­è®°å½•å¯¹åº”çš„Commitæ ‡è®°ï¼Œä»¥ä¾›æ¢å¤æ—¶äº†è§£å½“å‰çš„äº‹åŠ¡çŠ¶æ€ï¼Œå› æ­¤è¿˜éœ€è¦å…³æ³¨Commitæ ‡è®°å’Œäº‹åŠ¡ä¸­æ•°æ®å†…å®¹çš„è½ç›˜é¡ºåºã€‚æ ¹æ®æ—¥å¿—ä¸­è®°å½•çš„å†…å®¹å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š<strong>Undo-Only</strong>ï¼Œ<strong>Redo-Only</strong>ï¼Œ<strong>Redo-Undo</strong>ã€‚</p><h3 id="Undo-Only-Logging"><a href="#Undo-Only-Logging" class="headerlink" title="Undo-Only Logging"></a>Undo-Only Logging</h3><p>Undo-Only Loggingçš„Logè®°å½•å¯ä»¥è¡¨ç¤ºä¸º<code>&lt;T, X, v&gt;</code>ï¼Œäº‹åŠ¡$T$ä¿®æ”¹äº†$X$çš„å€¼ï¼Œ$X$çš„æ—§å€¼æ˜¯vã€‚äº‹åŠ¡æäº¤æ—¶ï¼Œéœ€è¦é€šè¿‡å¼ºåˆ¶Flushä¿è¯Commitæ ‡è®°è½ç›˜å‰ï¼Œå¯¹åº”äº‹åŠ¡çš„æ‰€æœ‰æ•°æ®è½ç›˜ï¼Œå³è½ç›˜é¡ºåºä¸ºLogè®°å½•-&gt;Data-&gt;Commitæ ‡è®°ã€‚æ¢å¤æ—¶å¯ä»¥æ ¹æ®Commitæ ‡è®°åˆ¤æ–­äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é€šè¿‡Undo Logä¸­è®°å½•çš„æ—§å€¼å°†æœªæäº¤äº‹åŠ¡çš„ä¿®æ”¹å›æ»šã€‚æˆ‘ä»¬æ¥å®¡è§†ä¸€ä¸‹Undo-Onlyå¯¹DurabilityåŠAtomicçš„ä¿è¯ï¼š</p><ul><li>Durability of Updatesï¼šDataå¼ºåˆ¶åˆ·ç›˜ä¿è¯ï¼Œå·²ç»Commitçš„äº‹åŠ¡ç”±äºå…¶æ‰€æœ‰Dataéƒ½å·²ç»åœ¨Commitæ ‡è®°ä¹‹å‰è½ç›˜ï¼Œå› æ­¤ä¼šä¸€ç›´å­˜åœ¨ï¼›</li><li>Failure Atomicï¼šUndo Logå†…å®¹ä¿è¯ï¼Œå¤±è´¥äº‹åŠ¡çš„å·²åˆ·ç›˜çš„ä¿®æ”¹ä¼šåœ¨æ¢å¤é˜¶æ®µé€šè¿‡Undoæ—¥å¿—å›æ»šï¼Œä¸å†å¯è§ã€‚<br>ç„¶è€ŒUndo-Onlyä¾ç„¶æœ‰ä¸èƒ½Pageå†…å¹¶å‘çš„é—®é¢˜ï¼Œå¦‚æœä¸¤ä¸ªäº‹åŠ¡çš„ä¿®æ”¹è½åˆ°ä¸€ä¸ªPageä¸­ï¼Œä¸€ä¸ªäº‹åŠ¡æäº¤å‰éœ€è¦çš„å¼ºåˆ¶Flushæ“ä½œï¼Œä¼šå¯¼è‡´åŒPageæ‰€æœ‰äº‹åŠ¡çš„Dataè½ç›˜ï¼Œå¯èƒ½ä¼šæ—©äºå¯¹åº”çš„Logé¡¹ä»è€ŒæŸå®³WALã€‚åŒæ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´å…³é”®è·¯å¾„ä¸Šè¿‡äºé¢‘ç¹çš„ç£ç›˜éšæœºè®¿é—®ã€‚</li></ul><h3 id="Redo-Only-Logging"><a href="#Redo-Only-Logging" class="headerlink" title="Redo-Only Logging"></a>Redo-Only Logging</h3><p>ä¸åŒäºUndo-Onlyï¼Œé‡‡ç”¨Redo-Onlyçš„Logä¸­è®°å½•çš„æ˜¯ä¿®æ”¹åçš„æ–°å€¼ã€‚å¯¹åº”åœ°ï¼ŒCommitæ—¶éœ€è¦ä¿è¯ï¼ŒLogä¸­çš„Commitæ ‡è®°åœ¨äº‹åŠ¡çš„ä»»ä½•æ•°æ®ä¹‹å‰è½ç›˜ï¼Œå³è½ç›˜é¡ºåºä¸ºLogè®°å½•-&gt;Commitæ ‡è®°-&gt;Dataã€‚æ¢å¤æ—¶åŒæ ·æ ¹æ®Commitæ ‡è®°åˆ¤æ–­äº‹åŠ¡çŠ¶æ€ï¼Œå¹¶é€šè¿‡Redo Logä¸­è®°å½•çš„æ–°å€¼å°†å·²ç»Commitï¼Œä½†æ•°æ®æ²¡æœ‰è½ç›˜çš„äº‹åŠ¡ä¿®æ”¹é‡æ”¾ã€‚</p><ul><li>Durability of Updatesï¼šRedo Logå†…å®¹ä¿è¯ï¼Œå·²æäº¤äº‹åŠ¡çš„æœªåˆ·ç›˜çš„ä¿®æ”¹ï¼Œåˆ©ç”¨Redo Logä¸­çš„å†…å®¹é‡æ”¾ï¼Œä¹‹åå¯è§ï¼›</li><li>Failure Atomicï¼šé˜»æ­¢Commitå‰Dataè½ç›˜ä¿è¯ï¼Œå¤±è´¥äº‹åŠ¡çš„ä¿®æ”¹ä¸ä¼šå‡ºç°åœ¨ç£ç›˜ä¸Šï¼Œè‡ªç„¶ä¸å¯è§ã€‚<br>Redo-OnlyåŒæ ·æœ‰ä¸èƒ½Pageå†…å¹¶å‘çš„é—®é¢˜ï¼ŒPageä¸­çš„å¤šä¸ªä¸åŒäº‹åŠ¡ï¼Œ<strong>åªè¦æœ‰ä¸€ä¸ªæœªæäº¤å°±ä¸èƒ½åˆ·ç›˜ï¼Œè¿™äº›æ•°æ®å…¨éƒ¨éƒ½éœ€è¦ç»´æŠ¤åœ¨å†…å­˜ä¸­ï¼Œé€ æˆè¾ƒå¤§çš„å†…å­˜å‹åŠ›</strong>ã€‚</li></ul><h3 id="Redo-Undo-Logging"><a href="#Redo-Undo-Logging" class="headerlink" title="Redo-Undo Logging"></a>Redo-Undo Logging</h3><p>å¯ä»¥çœ‹å‡ºçš„åªæœ‰Undoæˆ–Redoçš„é—®é¢˜ï¼Œä¸»è¦æ¥è‡ªäºå¯¹Commitæ ‡è®°åŠDataè½ç›˜é¡ºåºçš„é™åˆ¶ï¼Œè€Œè¿™ç§é™åˆ¶å½’æ ¹ç»“åº•æ¥æºäºLogä¿¡æ¯ä¸­å¯¹æ–°å€¼æˆ–æ—§å€¼çš„ç¼ºå¤±ã€‚å› æ­¤Redo-Undoé‡‡ç”¨åŒæ—¶è®°å½•æ–°å€¼å’Œæ—§å€¼çš„æ–¹å¼ï¼Œæ¥æ¶ˆé™¤Commitå’ŒDataä¹‹é—´åˆ·ç›˜é¡ºåºçš„é™åˆ¶ã€‚</p><ul><li>Durability of Updatesï¼šRedo å†…å®¹ä¿è¯ï¼Œå·²æäº¤äº‹åŠ¡çš„æœªåˆ·ç›˜çš„ä¿®æ”¹ï¼Œåˆ©ç”¨Redo Logä¸­çš„å†…å®¹é‡æ”¾ï¼Œä¹‹åå¯è§ï¼›</li><li>Failure Atomicï¼šUndoå†…å®¹ä¿è¯ï¼Œå¤±è´¥äº‹åŠ¡çš„å·²åˆ·ç›˜çš„ä¿®æ”¹ä¼šåœ¨æ¢å¤é˜¶æ®µé€šè¿‡Undoæ—¥å¿—å›æ»šï¼Œä¸å†å¯è§ã€‚<br>å¦‚æ­¤ä¸€æ¥ï¼ŒåŒPageçš„ä¸åŒäº‹åŠ¡æäº¤å°±å˜å¾—éå¸¸ç®€å•ã€‚åŒæ—¶å¯ä»¥å°†è¿ç»­çš„æ•°æ®æ”’ç€è¿›è¡Œæ‰¹é‡çš„åˆ·ç›˜å·²åˆ©ç”¨ç£ç›˜è¾ƒé«˜çš„é¡ºåºå†™æ€§èƒ½ã€‚</li></ul><h2 id="è„é¡µ"><a href="#è„é¡µ" class="headerlink" title="è„é¡µ"></a>è„é¡µ</h2><p>å½“å†…å­˜æ•°æ®é¡µè·Ÿç£ç›˜æ•°æ®é¡µå†…å®¹ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªå†…å­˜é¡µä¸ºâ€œè„é¡µâ€ã€‚å†…å­˜æ•°æ®å†™å…¥ç£ç›˜åï¼Œå†…å­˜å’Œç£ç›˜ä¸Šçš„æ•°æ®é¡µå†…å®¹å°±ä¸€è‡´äº†ï¼Œç§°ä¸ºâ€œå¹²å‡€é¡µâ€ã€‚åˆ·è„é¡µï¼Œå³æŠŠè„é¡µï¼ˆå†…å­˜ä¸­çš„ä¿®æ”¹è¿‡çš„æ•°æ®é¡µï¼‰åˆ·æ–°ï¼ˆflushï¼‰åˆ°ç£ç›˜ä¸Šã€‚</p><p>å¯¹äº InnoDB å­˜å‚¨å¼•æ“ï¼Œç¼“å†²æ± ï¼ˆbuffer poolï¼‰æ˜¯å†…å­˜ä¸­çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ã€‚å½“æŸ¥è¯¢éœ€è¦è¯»å–æ•°æ®æ—¶ï¼Œæ•°æ®åº“é¦–å…ˆæŸ¥çœ‹ç¼“å†²æ± ä¸­æ˜¯å¦å·²ç»æœ‰ç›¸åº”çš„æ•°æ®é¡µã€‚å¦‚æœæ•°æ®é¡µåœ¨ç¼“å†²æ± ä¸­ï¼ŒæŸ¥è¯¢å¯ä»¥ç«‹å³ä»å†…å­˜ä¸­è·å–æ•°æ®ï¼Œè€Œä¸å¿…è¿›è¡Œç£ç›˜è¯»å–ï¼Œè¿™å¤§å¤§æé«˜äº†æ€§èƒ½ã€‚å¦‚æœæ•°æ®é¡µä¸åœ¨ç¼“å†²æ± ä¸­ï¼ˆç¼“å†²æ± æœªå‘½ä¸­ï¼‰ï¼Œæ•°æ®åº“ç³»ç»Ÿå°†ä»ç£ç›˜è¯»å–è¯¥æ•°æ®é¡µï¼Œå¹¶å°†å…¶æ”¾å…¥ç¼“å†²æ± ä¸­ï¼Œä»¥ä¾¿å°†æ¥çš„æŸ¥è¯¢å¯ä»¥æ›´å¿«åœ°è®¿é—®ã€‚ç¼“å†²æ± çš„å¤§å°é€šå¸¸æ˜¯å¯ä»¥é…ç½®çš„ï¼Œæ•°æ®åº“ç®¡ç†å‘˜å¯ä»¥æ ¹æ®ç³»ç»Ÿçš„å†…å­˜å’Œæ€§èƒ½éœ€æ±‚æ¥è°ƒæ•´ç¼“å†²æ± çš„å¤§å°ã€‚</p><p>å¯¹äºäº‹åŠ¡å¤„ç†ï¼Œæ•°æ®çš„ä¿®æ”¹é€šå¸¸é¦–å…ˆåœ¨å†…å­˜ä¸­è¿›è¡Œï¼Œç„¶åç­‰å¾…äº‹åŠ¡æäº¤ã€‚åœ¨äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­è¢«è®¤ä¸ºæ˜¯è„çš„ï¼Œå› ä¸ºå®ƒä»¬è¿˜æœªè¢«å†™å…¥åˆ°ç£ç›˜ã€‚ä¸‹é¢æœ‰ä¸€æ®µæ–‡å­—å¯ä»¥ä¹Ÿå¯ä»¥å¸®åŠ©å¼•å‡ºRedo logçš„ä½œç”¨ã€‚</p><blockquote><p>InnoDB æœ‰ ç¼“å†²æ± ï¼ˆbuffer poolï¼‰ã€‚ç¼“å†²æ± æ˜¯ç‰©ç†é¡µçš„ç¼“å­˜ï¼Œå¯¹ InnoDB çš„ä»»ä½•ä¿®æ”¹æ“ä½œéƒ½ä¼šé¦–å…ˆåœ¨ç¼“å†²æ± çš„ page ä¸Šè¿›è¡Œï¼Œç„¶åè¿™æ ·çš„é¡µé¢å°†è¢«æ ‡è®°ä¸º dirty å¹¶è¢«æ”¾åˆ°ä¸“é—¨çš„ flush list ä¸Šï¼Œåç»­å°†ç”±ä¸“é—¨çš„åˆ·è„çº¿ç¨‹é˜¶æ®µæ€§çš„å°†è¿™äº›é¡µé¢å†™å…¥ç£ç›˜ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯é¿å…æ¯æ¬¡å†™æ“ä½œéƒ½æ“ä½œç£ç›˜å¯¼è‡´å¤§é‡çš„éšæœºIOï¼Œé˜¶æ®µæ€§çš„åˆ·è„å¯ä»¥å°†å¤šæ¬¡å¯¹é¡µé¢çš„ä¿®æ”¹ merge æˆä¸€æ¬¡IOæ“ä½œï¼ŒåŒæ—¶å¼‚æ­¥å†™å…¥ä¹Ÿé™ä½äº†è®¿é—®çš„æ—¶å»¶ã€‚</p><p>ç„¶è€Œï¼Œå¦‚æœåœ¨ dirty page è¿˜æœªåˆ·å…¥ç£ç›˜æ—¶ï¼Œserveréæ­£å¸¸å…³é—­ï¼Œè¿™äº›ä¿®æ”¹æ“ä½œå°†ä¼šä¸¢å¤±ï¼Œå¦‚æœå†™å…¥æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œç”šè‡³ä¼šç”±äºæŸåæ•°æ®æ–‡ä»¶å¯¼è‡´æ•°æ®åº“ä¸å¯ç”¨ã€‚ä¸ºäº†é¿å…ä¸Šè¿°é—®é¢˜çš„å‘ç”Ÿï¼ŒInnodb å°†æ‰€æœ‰å¯¹é¡µé¢çš„ä¿®æ”¹æ“ä½œå†™å…¥ä¸€ä¸ªä¸“é—¨çš„æ–‡ä»¶ï¼Œå¹¶åœ¨æ•°æ®åº“å¯åŠ¨æ—¶ä»æ­¤æ–‡ä»¶è¿›è¡Œæ¢å¤æ“ä½œï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯ redo log fileã€‚è¿™æ ·çš„æŠ€æœ¯æ¨è¿Ÿäº†ç¼“å†²æ± é¡µé¢çš„åˆ·æ–°ï¼Œä»è€Œæå‡äº†æ•°æ®åº“çš„ååï¼Œæœ‰æ•ˆçš„é™ä½äº†è®¿é—®æ—¶å»¶ã€‚å¸¦æ¥çš„é—®é¢˜æ˜¯é¢å¤–çš„å†™ redo log æ“ä½œçš„å¼€é”€ï¼ˆé¡ºåº IOï¼Œæ¯”éšæœº IO å¿«å¾ˆå¤šï¼‰ï¼Œä»¥åŠæ•°æ®åº“å¯åŠ¨æ—¶æ¢å¤æ“ä½œæ‰€éœ€çš„æ—¶é—´ã€‚</p></blockquote><h2 id="Redo-log-Durability"><a href="#Redo-log-Durability" class="headerlink" title="Redo log (Durability)"></a>Redo log (Durability)</h2><p>Redo logåŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªæ˜¯å†…å­˜ä¸­çš„æ—¥å¿—ç¼“å†²(redo log buffer)ï¼Œå¦ä¸€ä¸ªæ˜¯ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶(redo log file)ã€‚</p><p>åœ¨è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ç©ºé—´(user space)ä¸‹çš„ç¼“å†²åŒºæ•°æ®ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ— æ³•ç›´æ¥å†™å…¥ç£ç›˜çš„ï¼Œä¸­é—´å¿…é¡»ç»è¿‡æ“ä½œç³»ç»Ÿå†…æ ¸ç©ºé—´(kernel space)ç¼“å†²åŒº(OS Buffer)ã€‚å› æ­¤ï¼Œredo log bufferå†™å…¥redo log fileå®é™…ä¸Šæ˜¯å…ˆå†™å…¥æ–‡ä»¶ç³»ç»Ÿpage cacheï¼Œç„¶åå†é€šè¿‡ç³»ç»Ÿè°ƒç”¨fsyncå°†å…¶åˆ·åˆ°redo log fileä¸­ã€‚ç”±æ­¤å¯ä»¥å¾—åˆ°redo logçš„ä¸‰ç§çŠ¶æ€ï¼š</p><ol><li>å­˜åœ¨ redo log buffer ä¸­ï¼Œç‰©ç†ä¸Šæ˜¯åœ¨ MySQL è¿›ç¨‹å†…å­˜ä¸­ã€‚</li><li>å†™åˆ°ç£ç›˜ (write)ï¼Œä½†æ˜¯æ²¡æœ‰æŒä¹…åŒ–ï¼Œç‰©ç†ä¸Šæ˜¯åœ¨æ–‡ä»¶ç³»ç»Ÿçš„ page cache é‡Œé¢ã€‚</li><li>è°ƒç”¨fsyncï¼ŒæŒä¹…åŒ–åˆ°ç£ç›˜ã€‚</li></ol><p>äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹å†…å­˜ä¸­æ•°æ®é¡µè¿›è¡Œä¿®æ”¹å°†ç”Ÿæˆredo logï¼Œç”Ÿæˆçš„ redo log æ˜¯å…ˆå†™åˆ° redo log buffer ä¸­ï¼Œç„¶åé€šè¿‡æŸäº›æ–¹å¼åˆ·å…¥ç£ç›˜ã€‚è¿™é‡Œæ‰€æŒ‡çš„æ–¹å¼ï¼Œä¸ªäººç†è§£ä¸»è¦æœ‰äº”ç§ï¼š</p><ol><li>åå°çº¿ç¨‹æ¯ç§’ä¸€æ¬¡æ‰§è¡Œåˆ·ç›˜ï¼Œå¹¶è¡Œè½®è¯¢ã€‚</li><li>æ¯ä¸ªäº‹åŠ¡æäº¤æ—¶ä¾æ®ç­–ç•¥åˆ·ç›˜ã€‚</li><li>å½“redo log bufferç¼“å­˜å¯ç”¨ç©ºé—´å°äºä¸€åŠçš„æ—¶å€™åˆ·ç›˜ï¼Œæ•´ä½“ç©ºé—´å—<code>innodb_log_buffer_size</code>æ§åˆ¶ã€‚è¿™ä¸ªæƒ…å†µçš„åˆ·ç›˜ä»…æŒ‡writeï¼Œç„¶åå¯èƒ½è¢«åå°çº¿ç¨‹åˆ·ç›˜ï¼Œè¿™ä¹Ÿæ˜¯æœªæäº¤redo logåˆ·ç›˜çš„å¯èƒ½æƒ…å†µä¹‹ä¸€ã€‚</li><li>æ•°æ®åº“æœåŠ¡å™¨æ­£å¸¸å…³é—­æ—¶ã€‚</li><li>æ£€æŸ¥ç‚¹ï¼Œ<strong>checkpoints</strong>ã€‚</li></ol><p>PSï¼šå¦å¤–ä¸¤ç§æƒ…å†µæ˜¯ï¼š1ã€äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ redo log ä¹Ÿæ˜¯ç›´æ¥å†™åœ¨ redo log buffer ä¸­çš„ï¼Œå³å°†äº‹åŠ¡çš„ä¿®æ”¹æš‚æ—¶ä¿å­˜äºå†…å­˜ä¸­ï¼Œè¿™äº› redo log ä¹Ÿä¼šè¢«åå°çº¿ç¨‹ä¸€èµ·æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚å³ä¸€ä¸ªæ²¡æœ‰æäº¤çš„äº‹åŠ¡çš„ redo logï¼Œä¹Ÿæ˜¯å¯èƒ½å·²ç»æŒä¹…åŒ–åˆ°ç£ç›˜çš„ã€‚2ã€äº‹åŠ¡å¹¶è¡Œï¼Œå…ˆæäº¤çš„äº‹åŠ¡æŠŠå…¶ä»–äº‹åŠ¡çš„redo log bufferåˆ·ç›˜ã€‚</p><p>Redo logçš„åœ¨äº‹åŠ¡æäº¤æ—¶çš„å†™å…¥ç­–ç•¥ç”±å‚æ•°<code>innodb_flush_log_at_trx_commit</code>æ§åˆ¶ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§å–å€¼é€‰é¡¹ï¼š</p><ol><li>è®¾ç½®ä¸º<code>0</code>çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠ redo log ç•™åœ¨ redo log buffer ä¸­ ;</li><li>è®¾ç½®ä¸º<code>1</code>çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½å°† redo log ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ˆé»˜è®¤ï¼‰ï¼›</li><li>è®¾ç½®ä¸º<code>2</code>çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæ˜¯æŠŠ redo log å†™åˆ° page cacheã€‚</li></ol><p>ï¼ˆTODOï¼šè¿™ä¸€éƒ¨åˆ†åº”è¯¥æœ‰é—®é¢˜ï¼Œå†…å­˜ä¸­çš„æ•°æ®ä¹Ÿä¼šå†™å…¥ï¼Œä¸è¿‡è¿™æ—¶å€™è½ç›˜çš„è„æ•°æ®å°±é undoäº†ï¼‰é‚£ä¹ˆäº†è§£äº†redo logçš„å†™å…¥æœºåˆ¶åï¼Œå®ƒåˆ°åº•æ˜¯å¦‚ä½•å®ç°ä¿è¯æ•°æ®åº“æŒä¹…æ€§çš„å‘¢ï¼Ÿä¸‹é¢æˆ‘å°è¯•ä»ä¸€ä¸ªäº‹åŠ¡çš„å¼€å§‹è¿›è¡Œåˆ†æã€‚</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Chain1:</span> äº‹åŠ¡å¼€å§‹ -&gt; æ•°æ®é¡µè¯»å– -&gt; äº‹åŠ¡æ‰§è¡Œï¼ˆæ•°æ®é¡µä¿®æ”¹ &amp; <span class="keyword">redo</span> logç”Ÿæˆï¼‰-&gt; äº‹åŠ¡æäº¤ -&gt; äº‹åŠ¡ç»“æŸ</span><br><span class="line"><span class="symbol">Chain2:</span>                           æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿ<span class="keyword">redo</span> logåˆ·ç›˜  ä¾æ®ç­–ç•¥å†³å®šæ˜¯å¦ç›´æ¥åˆ·ç›˜    </span><br></pre></td></tr></table></figure><p>æˆ‘æŠŠæ‰§è¡Œæµç¨‹åˆ†ä¸ºäº†ä¸¤ä¸ªé“¾æ¡ï¼Œchain1æ˜¯äº‹åŠ¡æ‰§è¡Œçš„æµç¨‹ï¼Œchain2æ˜¯redo logéƒ¨åˆ†InnoDBåœ¨å¯¹åº”ä½ç½®å¯èƒ½é‡‡å–çš„æ“ä½œã€‚ä¸‹é¢æˆ‘ä»¬åœ¨chain1çš„æ¯ä¸ªéƒ¨åˆ†æ¨¡æ‹Ÿæ‰ç”µå…³æœºï¼Œçœ‹ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚ç”±äºè¿™ä¸€å—å†…å®¹å®é™…ä¸Šæ˜¯å´©æºƒæ¢å¤ç›¸å…³å†…å®¹ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰<strong>æ­£å¸¸çŠ¶æ€</strong>ï¼Œ<strong>æ­£å¸¸çŠ¶æ€</strong>æŒ‡çš„æ˜¯ MySQL å´©æºƒä¹‹å‰ï¼Œæ•°æ®é¡µæœ€åä¸€æ¬¡æ­£ç¡®çš„åˆ·æ–°åˆ°ç£ç›˜çš„çŠ¶æ€ã€‚</p><p>1ã€æ•°æ®é¡µè¯»å–ï¼šå¯¹æ•°æ®åº“å®Œæ•´æ€§æ— å½±å“ã€‚<br>2ã€äº‹åŠ¡æ‰§è¡Œï¼ˆredo logç”Ÿæˆæœªè½ç›˜ï¼‰ï¼šæ— å½±å“ï¼Œäº‹åŠ¡æœªæäº¤ã€‚<br>3ã€äº‹åŠ¡æ‰§è¡Œï¼ˆredo logç”Ÿæˆå·²è½ç›˜ï¼‰ï¼šæ— å½±å“ï¼Œäº‹åŠ¡æœªæäº¤ã€‚<br>4ã€äº‹åŠ¡æäº¤ï¼ˆredo logå†™å…¥ç­–ç•¥=1ï¼‰ï¼šä»»æ„æ—¶é—´å´©æºƒï¼Œéƒ½å¯ä»¥é€šè¿‡redo logæ‰§è¡Œæ¢å¤ï¼ŒæŸåçš„æ•°æ®é¡µå¯ä»¥é€šè¿‡<strong>double write</strong>ä¿®å¤åå†æ‰§è¡Œæ¢å¤ã€‚<br>5ã€äº‹åŠ¡æäº¤ï¼ˆredo logå†™å…¥ç­–ç•¥=2ï¼‰ï¼šå¦‚æœåœ¨redo logåˆšå†™å…¥æœªåˆ·ç›˜æ—¶æ–­ç”µï¼Œåˆ™ä¼šä¸¢å¤±ä¸Šä¸€ç§’çš„æ•°æ®ï¼Œä»…mysqldå´©æºƒä¸ä¼šä¸¢å¤±æ•°æ®ã€‚<br>6ã€äº‹åŠ¡æäº¤ï¼ˆredo logå†™å…¥ç­–ç•¥=0ï¼‰ï¼šä¸ä¸Šä¸€æƒ…å†µç›¸åŒï¼Œä½†å¦‚æœå´©æºƒæƒ…å†µé™çº§ï¼Œä¾‹å¦‚mysqldå´©æºƒï¼Œä¹Ÿä¼šä¸¢å¤±æ•°æ®ã€‚</p><p>æ³¨æ„ä»¥ä¸Šåˆ†æä»…æ˜¯ç®€åŒ–ç‰ˆï¼Œæ›´å¤šç»†èŠ‚å¦‚Checkpointsã€Double writeã€LSNã€Mini-Transactionç­‰â€¦éœ€è¦å¤šè¯»ä¹¦å®è·µæ‰èƒ½é€šé€äº†ï¼Œéœ€è¦æ—¶å†å­¦ä¹ å§ã€‚</p><h2 id="Undo-log-Atomicity"><a href="#Undo-log-Atomicity" class="headerlink" title="Undo log (Atomicity)"></a>Undo log (Atomicity)</h2><p>Undo Logæ˜¯InnoDBååˆ†é‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼Œå®ƒçš„ä½œç”¨æ¨ªè´¯InnoDBä¸­ä¸¤ä¸ªæœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œå¹¶å‘æ§åˆ¶ï¼ˆConcurrency Controlï¼‰å’Œæ•…éšœæ¢å¤ï¼ˆCrash Recoveryï¼‰ï¼ŒInnoDBä¸­undo logçš„å®ç°äº¦æ—¥å¿—äº¦æ•°æ®ã€‚</p><p>ä¸ºä¿è¯åŸå­æ€§ï¼ŒInnoDBä¼šåœ¨æ­£å¸¸äº‹åŠ¡è¿›è¡Œä¸­ï¼Œå°±ä¸æ–­çš„è¿ç»­å†™å…¥undo logï¼Œæ¥è®°å½•æœ¬æ¬¡ä¿®æ”¹ä¹‹å‰çš„å†å²å€¼ã€‚å½“æ•…éšœçœŸæ­£å‘ç”Ÿæ—¶ï¼Œå¯ä»¥åœ¨recoveryè¿‡ç¨‹ä¸­é€šè¿‡å›æ”¾undo logå°†æœªæäº¤äº‹åŠ¡çš„ä¿®æ”¹æŠ¹æ‰ã€‚æ­¤å¤–ï¼Œundo logä¹Ÿå¯ä»¥ç”¨æ¥æ”¯æŒæ­»é”å¤„ç†æˆ–ç”¨æˆ·è¯·æ±‚çš„äº‹åŠ¡å›æ»šã€‚</p><p>åœ¨å¹¶å‘æ§åˆ¶ä¸­ï¼Œä¸»æµæ•°æ®åº“é‡‡ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œä¸ºæ¯æ¡è®°å½•ä¿å­˜å¤šä»½å†å²æ•°æ®ä¾›è¯»äº‹åŠ¡è®¿é—®ï¼Œæ–°çš„å†™å…¥åªéœ€è¦æ·»åŠ æ–°çš„ç‰ˆæœ¬å³å¯ï¼ŒInnoDBåˆ©ç”¨undo logæä¾›æ­¤åŠŸèƒ½ã€‚</p><p>åœ¨è®¾è®¡æ–¹é¢ï¼Œundo logéœ€è¦çš„æ˜¯äº‹åŠ¡ä¹‹é—´çš„å¹¶å‘ï¼Œä»¥åŠæ–¹ä¾¿çš„å¤šç‰ˆæœ¬æ•°æ®ç»´æŠ¤ï¼Œå…¶é‡æ”¾é€»è¾‘ä¸å¸Œæœ›å› æ•°æ®åº“ç‰©ç†å­˜å‚¨å˜åŒ–è€Œå˜åŒ–ï¼Œå› æ­¤InnoDBä¸­çš„undo logé‡‡ç”¨<strong>é€»è¾‘æ—¥å¿—</strong>ã€‚åŒæ—¶ï¼ŒInnoDBæ˜¯æŠŠundo logå½“åšä¸€ç§æ•°æ®æ¥ç»´æŠ¤å’Œä½¿ç”¨çš„ï¼Œå…¶æœ¬èº«ä¹Ÿåƒå…¶ä»–çš„æ•°æ®åº“æ•°æ®ä¸€æ ·ï¼Œä¼šå†™è‡ªå·±å¯¹åº”çš„redo logï¼Œä»¥æ­¤ä¿è¯è‡ªå·±ä¸å‡ºé”™ã€‚</p><h3 id="Undo-Recordçš„å†…å®¹"><a href="#Undo-Recordçš„å†…å®¹" class="headerlink" title="Undo Recordçš„å†…å®¹"></a>Undo Recordçš„å†…å®¹</h3><p>æ¯å½“InnoDBä¸­éœ€è¦ä¿®æ”¹æŸæ¡è®°å½•æ—¶ï¼Œéƒ½ä¼šå°†å…¶å†å²ç‰ˆæœ¬å†™å…¥ä¸€ä¸ªundo logä¸­ï¼Œå¯¹åº”çš„undo recordæ˜¯Updateç±»å‹ã€‚å½“æ’å…¥æ–°çš„è®°å½•æ—¶ï¼Œè¿˜æ²¡æœ‰ä¸€ä¸ªå†å²ç‰ˆæœ¬ï¼Œä½†ä¸ºäº†æ–¹ä¾¿äº‹åŠ¡å›æ»šæ—¶åšé€†å‘ï¼ˆDeleteï¼‰æ“ä½œï¼Œè¿˜æ˜¯ä¼šå†™å…¥ä¸€ä¸ªInsertç±»å‹çš„undo recordã€‚</p><p>å¯¹äºInsertç±»å‹çš„undo recordï¼Œå®ƒä»…ä»…æ˜¯ä¸ºäº†å¯èƒ½çš„äº‹åŠ¡å›æ»šå‡†å¤‡çš„ï¼Œå¹¶ä¸åœ¨MVCCåŠŸèƒ½ä¸­æ‰¿æ‹…ä½œç”¨ï¼Œå› æ­¤åªéœ€è¦ç”¨<strong>Key Fields</strong>è®°å½•å¯¹åº”æ•°æ®åº“è®°å½•çš„ä¸»é”®ï¼Œä¾›å›æ»šæ—¶æŸ¥æ‰¾è®°å½•ä½ç½®å³å¯ã€‚</p><p><img src="/assets/post_img/article123/insert_undo_record.png" alt=""></p><p>å…¶ä¸­Undo Numberæ˜¯Undoçš„ä¸€ä¸ªé€’å¢ç¼–å·ï¼ŒTable IDç”¨æ¥è¡¨ç¤ºæ˜¯å“ªå¼ è¡¨çš„ä¿®æ”¹ã€‚ä¸‹é¢ä¸€ç»„Key Fieldsçš„é•¿åº¦ä¸å®šï¼Œå› ä¸ºå¯¹åº”è¡¨çš„ä¸»é”®å¯èƒ½ç”±å¤šä¸ªfieldç»„æˆï¼Œè¿™é‡Œéœ€è¦å­˜å‚¨æ•°æ®åº“è®°å½•å®Œæ•´çš„ä¸»é”®ä¿¡æ¯ï¼Œå›æ»šçš„æ—¶å€™å¯ä»¥é€šè¿‡è¿™ä¸ªä¿¡æ¯åœ¨ç´¢å¼•ä¸­å®šä½åˆ°å¯¹åº”çš„è®°å½•ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨Undo Recordçš„å¤´å°¾è¿˜å„ç•™äº†ä¸¤ä¸ªå­—èŠ‚ç”¨æˆ·è®°å½•å…¶å‰åºå’Œåç»§Undo Recordçš„ä½ç½®ã€‚</p><p>å¯¹äºUpdateç±»å‹çš„undo recordï¼Œæƒ…å†µç¨å¾®å¤æ‚ä¸€äº›ï¼Œç”±äºMVCCéœ€è¦ä¿ç•™è®°å½•çš„å¤šä¸ªå†å²ç‰ˆæœ¬ï¼Œå½“æŸä¸ªè®°å½•çš„å†å²ç‰ˆæœ¬è¿˜åœ¨è¢«ä½¿ç”¨æ—¶ï¼Œè¿™ä¸ªè®°å½•æ˜¯ä¸èƒ½è¢«çœŸæ­£çš„åˆ é™¤çš„ã€‚å› æ­¤ï¼Œå½“éœ€è¦åˆ é™¤æ—¶ï¼Œå…¶å®åªæ˜¯ä¿®æ”¹å¯¹åº”è®°å½•çš„Delete Markæ ‡è®°ã€‚å¯¹åº”çš„ï¼Œå¦‚æœè¿™æ—¶è¿™ä¸ªè®°å½•åˆé‡æ–°æ’å…¥ï¼Œå…¶å®ä¹Ÿåªæ˜¯ä¿®æ”¹ä¸€ä¸‹Delete Markæ ‡è®°ï¼Œä¹Ÿå°±æ˜¯å°†è¿™ä¸¤ç§æƒ…å†µçš„åˆ é™¤å’Œæ’å…¥è½¬å˜æˆäº†æ›´æ–°æ“ä½œã€‚å†åŠ ä¸Šå¸¸è§„çš„æ›´æ–°è®°å½•ï¼Œè¿™ç§ç±»å‹çš„undo recordå­˜åœ¨ä¸‰ç§ç±»å‹ï¼š<code>TRX_UNDO_UPD_EXIST_REC, TRX_UNDO_DEL_MARK_REC, TRX_UNDO_UPD_DEL_REC</code>ã€‚</p><p><img src="/assets/post_img/article123/update_undo_record.png" alt=""></p><p>é™¤äº†<strong>Key Fields</strong>å¤–ï¼ŒUpdateç±»å‹çš„undo recordå¢åŠ äº†ä»¥ä¸‹å†…å®¹ï¼š</p><ol><li>Transaction Idï¼Œè®°å½•äº†äº§ç”Ÿè¿™ä¸ªå†å²ç‰ˆæœ¬äº‹åŠ¡IDï¼Œç”¨ä½œåç»­MVCCä¸­çš„ç‰ˆæœ¬å¯è§æ€§åˆ¤æ–­ã€‚</li><li>RollPtrï¼ŒæŒ‡å‘çš„æ˜¯è¯¥è®°å½•çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ä½ç½®ï¼Œæ²¿ç€RollPtrå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªè®°å½•çš„æ‰€æœ‰å†å²ç‰ˆæœ¬ã€‚</li><li>Update Fieldsï¼Œå…¶ä¸­è®°å½•çš„å°±æ˜¯å½“å‰è¿™ä¸ªè®°å½•ç‰ˆæœ¬ç›¸å¯¹äºå…¶ä¹‹åçš„ä¸€æ¬¡ä¿®æ”¹çš„Deltaä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€æœ‰è¢«ä¿®æ”¹çš„Fieldçš„ç¼–å·ï¼Œé•¿åº¦å’Œå†å²å€¼ã€‚</li></ol><h3 id="Undo-Recordçš„ç»„ç»‡æ–¹å¼"><a href="#Undo-Recordçš„ç»„ç»‡æ–¹å¼" class="headerlink" title="Undo Recordçš„ç»„ç»‡æ–¹å¼"></a>Undo Recordçš„ç»„ç»‡æ–¹å¼</h3><p>æ¯ä¸€æ¬¡çš„ä¿®æ”¹éƒ½ä¼šäº§ç”Ÿè‡³å°‘ä¸€ä¸ªUndo Recordï¼Œç°åœ¨è€ƒè™‘å¤§é‡Undo Recordå¦‚ä½•ç»„ç»‡èµ·æ¥æ”¯æŒé«˜æ•ˆè®¿é—®ä¸ç®¡ç†ã€‚é¦–å…ˆæ˜¯åœ¨ä¸è€ƒè™‘ç‰©ç†å­˜å‚¨çš„æƒ…å†µä¸‹çš„é€»è¾‘ç»„ç»‡æ–¹å¼ï¼›ä¹‹åï¼Œç‰©ç†ç»„ç»‡æ–¹å¼ä»‹ç»å¦‚ä½•å°†å…¶å­˜å‚¨åˆ°åˆ°å®é™…16KBç‰©ç†å—ä¸­ï¼›ç„¶åæ–‡ä»¶ç»„ç»‡æ–¹å¼ä»‹ç»æ•´ä½“çš„æ–‡ä»¶ç»“æ„ï¼›æœ€åå†ä»‹ç»å…¶åœ¨å†…å­˜ä¸­çš„ç»„ç»‡æ–¹å¼ã€‚</p><h4 id="é€»è¾‘ç»„ç»‡æ–¹å¼-Undo-Log"><a href="#é€»è¾‘ç»„ç»‡æ–¹å¼-Undo-Log" class="headerlink" title="é€»è¾‘ç»„ç»‡æ–¹å¼ - Undo Log"></a>é€»è¾‘ç»„ç»‡æ–¹å¼ - Undo Log</h4><p>æ¯ä¸ªäº‹åŠ¡ä¼šä¿®æ”¹ä¸€ç»„æ•°æ®åº“è®°å½•ï¼Œå¯¹åº”çš„ä¼šäº§ç”Ÿä¸€ç»„Undo Recordï¼Œè¿™äº›Undo Recordé¦–å°¾ç›¸è¿ç»„æˆäº†è¿™ä¸ªäº‹åŠ¡çš„Undo Logã€‚é™¤äº†ä¸€ä¸ªä¸ªçš„Undo Recordä¹‹å¤–ï¼Œè¿˜åœ¨å¼€å¤´å¢åŠ äº†ä¸€ä¸ªUndo Log Headeræ¥è®°å½•ä¸€äº›å¿…è¦çš„æ§åˆ¶ä¿¡æ¯ï¼Œå› æ­¤ï¼Œä¸€ä¸ªUndo Logçš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/assets/post_img/article123/undo_log.png" alt=""></p><p><strong>Undo Log Header</strong>ä¸­è®°å½•äº†äº§ç”Ÿè¿™ä¸ªUndo Logçš„äº‹åŠ¡çš„Trx IDï¼›Trx Noæ˜¯äº‹åŠ¡çš„æäº¤é¡ºåºï¼Œä¹Ÿä¼šç”¨è¿™ä¸ªæ¥åˆ¤æ–­æ˜¯å¦èƒ½Purgeï¼Œè¿™ä¸ªåœ¨åé¢ä¼šè¯¦ç»†ä»‹ç»ï¼›Delete Markæ ‡æ˜è¯¥Undo Logä¸­æœ‰æ²¡æœ‰<code>TRX_UNDO_DEL_MARK_REC</code>ç±»å‹çš„Undo Recordï¼Œé¿å…Purgeæ—¶ä¸å¿…è¦çš„æ‰«æï¼›Log Start Offsetä¸­è®°å½•Undo Log Headerçš„ç»“æŸä½ç½®ï¼Œæ–¹ä¾¿ä¹‹åHeaderä¸­å¢åŠ å†…å®¹æ—¶çš„å…¼å®¹ï¼›ä¹‹åæ˜¯ä¸€äº›Flagä¿¡æ¯ï¼›Next Undo LogåŠPrev Undo Logæ ‡è®°å‰åä¸¤ä¸ªUndo Logï¼Œè¿™ä¸ªä¼šåœ¨æ¥ä¸‹æ¥ä»‹ç»ï¼›æœ€åé€šè¿‡History List Nodeå°†è‡ªå·±æŒ‚è½½åˆ°ä¸ºPurgeå‡†å¤‡çš„History Listä¸­ã€‚</p><p>ç´¢å¼•ä¸­çš„åŒä¸€ä¸ªæ•°æ®åº“è®°å½•è¢«ä¸åŒäº‹åŠ¡ä¿®æ”¹ï¼Œä¼šäº§ç”Ÿä¸åŒçš„å†å²ç‰ˆæœ¬ï¼Œè¿™äº›å†å²ç‰ˆæœ¬åˆé€šè¿‡<strong>Rollptr</strong>ç©¿æˆä¸€ä¸ªé“¾è¡¨ï¼Œä¾›MVCCä½¿ç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/assets/post_img/article123/undo_logical.png" alt=""></p><p>ç¤ºä¾‹ä¸­æœ‰ä¸‰ä¸ªäº‹åŠ¡æ“ä½œäº†è¡¨$t$ä¸Šï¼Œä¸»é”®idæ˜¯1çš„è®°å½•ï¼Œé¦–å…ˆäº‹åŠ¡$I$æ’å…¥äº†è¿™æ¡è®°å½•å¹¶ä¸”è®¾ç½®å­—æ®µ$a$çš„å€¼ä¸ºAï¼Œä¹‹åäº‹åŠ¡$J$å’Œäº‹åŠ¡$K$åˆ†åˆ«å°†è¿™æ¡idä¸º1çš„è®°å½•ä¸­çš„å­—æ®µ$a$çš„å€¼ä¿®æ”¹ä¸ºäº†Bå’ŒCã€‚$I$ï¼Œ$J$ï¼Œ$K$ä¸‰ä¸ªäº‹åŠ¡åˆ†åˆ«æœ‰è‡ªå·±çš„é€»è¾‘ä¸Šè¿ç»­çš„ä¸‰æ¡Undo Logï¼Œæ¯æ¡Undo Logæœ‰è‡ªå·±çš„Undo Log Headerã€‚ä»ç´¢å¼•ä¸­çš„è¿™æ¡æ•°æ®åº“è®°å½•æ²¿ç€<strong>Rollptr</strong>å¯ä»¥ä¾æ¬¡æ‰¾åˆ°è¿™ä¸‰ä¸ªäº‹åŠ¡Undo Logä¸­å…³äºè¿™æ¡è®°å½•çš„å†å²ç‰ˆæœ¬ã€‚åŒæ—¶å¯ä»¥çœ‹å‡ºï¼ŒInsertç±»å‹Undo Recordä¸­åªè®°å½•äº†å¯¹åº”çš„ä¸»é”®å€¼ï¼š<code>id=1</code>ï¼Œè€ŒUpdateç±»å‹çš„Undo Recordä¸­è¿˜è®°å½•äº†å¯¹åº”çš„å†å²ç‰ˆæœ¬çš„ç”Ÿæˆäº‹åŠ¡Trx_idï¼Œä»¥åŠè¢«ä¿®æ”¹çš„å­—æ®µ$a$çš„å†å²å€¼ã€‚</p><h4 id="ç‰©ç†ç»„ç»‡æ ¼å¼-Undo-Segment"><a href="#ç‰©ç†ç»„ç»‡æ ¼å¼-Undo-Segment" class="headerlink" title="ç‰©ç†ç»„ç»‡æ ¼å¼ - Undo Segment"></a>ç‰©ç†ç»„ç»‡æ ¼å¼ - Undo Segment</h4><p>ä¸€ä¸ªäº‹åŠ¡ä¼šäº§ç”Ÿå¤šå¤§çš„Undo Logæœ¬èº«æ˜¯ä¸å¯æ§çš„ï¼Œè€Œæœ€ç»ˆå†™å…¥ç£ç›˜å´æ˜¯æŒ‰ç…§å›ºå®šçš„å—å¤§å°ä¸ºå•ä½çš„ï¼ŒInnoDBä¸­é»˜è®¤æ˜¯16KBï¼Œå› æ­¤éœ€è¦è€ƒè™‘å¦‚ä½•ç”¨å›ºå®šçš„å—å¤§å°æ‰¿è½½ä¸å®šé•¿çš„Undo Logï¼Œä»¥å®ç°é«˜æ•ˆçš„ç©ºé—´åˆ†é…ã€å¤ç”¨ï¼Œé¿å…ç©ºé—´æµªè´¹ã€‚InnoDBçš„åŸºæœ¬æ€è·¯æ˜¯è®©å¤šä¸ªè¾ƒå°çš„Undo Logç´§å‡‘å­˜åœ¨ä¸€ä¸ªUndo Pageä¸­ï¼Œè€Œå¯¹è¾ƒå¤§çš„Undo Logåˆ™éšç€ä¸æ–­çš„å†™å…¥ï¼ŒæŒ‰éœ€åˆ†é…è¶³å¤Ÿå¤šçš„Undo Pageåˆ†æ•£æ‰¿è½½ã€‚ä¸‹é¢æ¥çœ‹è¿™éƒ¨åˆ†çš„ç‰©ç†å­˜å‚¨æ–¹å¼ï¼š</p><p><img src="/assets/post_img/article123/undo_physical.png" alt=""></p><p>æ¯ä¸ªå†™äº‹åŠ¡å¼€å§‹å†™æ“ä½œä¹‹å‰éƒ½éœ€è¦æŒæœ‰ä¸€ä¸ªUndo Segmentï¼Œä¸€ä¸ªUndo Segmentä¸­çš„æ‰€æœ‰ç£ç›˜ç©ºé—´çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯16KB Pageçš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œéƒ½æ˜¯ç”±ä¸€ä¸ªFSP Segmentç®¡ç†çš„ã€‚</p><blockquote><p>FSPï¼ˆFile Space Pageï¼‰æ˜¯InnoDBå­˜å‚¨å¼•æ“ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œè¡¨ç¤ºæ–‡ä»¶ç©ºé—´æ®µï¼ˆSegmentï¼‰ã€‚æ¯ä¸ªFSP Segmentå¯¹åº”äºä¸€ä¸ªè¡¨ç©ºé—´ï¼ˆtablespaceï¼‰ï¼Œç”¨äºå­˜å‚¨æ•°æ®å’Œç´¢å¼•ã€‚</p><p>åœ¨InnoDBä¸­ï¼Œæ•°æ®å’Œç´¢å¼•è¢«ç»„ç»‡ä¸ºä¸€ä¸ªä¸ªé¡µé¢ï¼ˆPageï¼‰ï¼Œè€Œè¿™äº›é¡µé¢åˆæŒ‰ç…§ä¸€å®šçš„æ–¹å¼æ¥ç»„ç»‡å¹¶ä¿å­˜åœ¨FSP Segmentä¸­ã€‚FSP Segmentæ˜¯InnoDBå­˜å‚¨å¼•æ“ç®¡ç†å­˜å‚¨ç©ºé—´çš„åŸºæœ¬å•ä½ã€‚</p><p>FSP SegmentåŒ…å«å¤šä¸ªè¿ç»­çš„æ–‡ä»¶ç©ºé—´é¡µï¼ˆFile Space Pagesï¼‰ï¼Œè¿™äº›é¡µé¢å¯ä»¥æ˜¯æ•°æ®é¡µã€ç´¢å¼•é¡µæˆ–å…¶ä»–ç±»å‹çš„é¡µï¼Œä»¥æ»¡è¶³ä¸åŒçš„å­˜å‚¨éœ€æ±‚ã€‚æ¯ä¸ªFSP Segmentéƒ½æœ‰è‡ªå·±çš„FSP IDï¼ˆFile Space Page IDï¼‰ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†å®ƒã€‚</p></blockquote><p>Undo Segmentä¼šæŒæœ‰è‡³å°‘ä¸€ä¸ªUndo Pageï¼Œæ¯ä¸ªUndo Pageä¼šåœ¨å¼€å¤´38å­—èŠ‚åˆ°56å­—èŠ‚è®°å½•Undo Page Headerï¼Œå…¶ä¸­è®°å½•Undo Pageçš„ç±»å‹ã€æœ€åä¸€æ¡Undo Recordçš„ä½ç½®ï¼Œå½“å‰Pageè¿˜ç©ºé—²éƒ¨åˆ†çš„å¼€å¤´ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€æ¡Undo Recordè¦å†™å…¥çš„ä½ç½®ã€‚Undo Segmentä¸­çš„ç¬¬ä¸€ä¸ªUndo Pageè¿˜ä¼šåœ¨56å­—èŠ‚åˆ°86å­—èŠ‚è®°å½•<strong>Undo Segment Header</strong>ï¼Œè¿™å°±æ˜¯è¿™ä¸ªUndo Segmentä¸­ç£ç›˜ç©ºé—´ç®¡ç†çš„Handleï¼Œå…¶ä¸­è®°å½•çš„æ˜¯è¿™ä¸ªUndo Segmentçš„çŠ¶æ€ï¼ˆStateï¼‰ï¼ŒåŒ…æ‹¬TRX_UNDO_CACHEDã€TRX_UNDO_TO_PURGEç­‰ï¼Œè¿˜è®°å½•äº†è¿™ä¸ªUndo Segmentä¸­æœ€åä¸€æ¡Undo Recordçš„ä½ç½®ã€è¿™ä¸ªFSP Segmentçš„Headerä»¥åŠå½“å‰åˆ†é…å‡ºæ¥çš„æ‰€æœ‰Undo Pageçš„é“¾è¡¨ã€‚</p><p>Undo Pageå‰©ä½™çš„ç©ºé—´éƒ½æ˜¯ç”¨æ¥å­˜æ”¾Undo Logçš„ï¼Œå¯¹äºåƒä¸Šå›¾Undo Log 1ï¼ŒUndo Log 2è¿™ç§è¾ƒçŸ­çš„Undo Logï¼Œä¸ºäº†é¿å…Pageå†…çš„ç©ºé—´æµªè´¹ï¼ŒInnoDBä¼šå¤ç”¨Undo Pageæ¥å­˜æ”¾å¤šä¸ªUndo Logï¼Œè€Œå¯¹äºåƒUndo Log 3è¿™ç§æ¯”è¾ƒé•¿çš„Undo Logå¯èƒ½ä¼šåˆ†é…å¤šä¸ªUndo Pageæ¥å­˜æ”¾ã€‚éœ€è¦æ³¨æ„çš„æ˜¯Undo Pageçš„å¤ç”¨åªä¼šå‘ç”Ÿåœ¨ç¬¬ä¸€ä¸ªPageã€‚</p><h4 id="æ–‡ä»¶ç»„ç»‡æ–¹å¼-Undo-Tablespace"><a href="#æ–‡ä»¶ç»„ç»‡æ–¹å¼-Undo-Tablespace" class="headerlink" title="æ–‡ä»¶ç»„ç»‡æ–¹å¼ - Undo Tablespace"></a>æ–‡ä»¶ç»„ç»‡æ–¹å¼ - Undo Tablespace</h4><p>æ¯ä¸€æ—¶åˆ»ä¸€ä¸ªUndo Segmentéƒ½æ˜¯è¢«ä¸€ä¸ªäº‹åŠ¡ç‹¬å çš„ã€‚æ¯ä¸ªå†™äº‹åŠ¡éƒ½ä¼šæŒæœ‰è‡³å°‘ä¸€ä¸ªUndo Segmentï¼Œå½“æœ‰å¤§é‡å†™äº‹åŠ¡å¹¶å‘è¿è¡Œæ—¶ï¼Œå°±éœ€è¦å­˜åœ¨å¤šä¸ªUndo Segmentã€‚InnoDBä¸­çš„Undoæ–‡ä»¶ä¸­å‡†å¤‡äº†å¤§é‡çš„Undo Segmentçš„æ§½ä½ï¼ŒæŒ‰ç…§1024ä¸€ç»„åˆ’åˆ†ä¸º<strong>Rollback Segment</strong>ã€‚æ¯ä¸ª<strong>Undo Tablespace</strong>æœ€å¤šä¼šåŒ…å«128ä¸ªRollback Segmentï¼ŒUndo Tablespaceæ–‡ä»¶ä¸­çš„ç¬¬ä¸‰ä¸ªPageä¼šå›ºå®šä½œä¸ºè¿™128ä¸ªRollback Segmentçš„ç›®å½•ï¼Œä¹Ÿå°±æ˜¯<strong>Rollback Segment Arrary Header</strong>ï¼Œå…¶ä¸­æœ€å¤šä¼šæœ‰128ä¸ªæŒ‡é’ˆæŒ‡å‘å„ä¸ªRollback Segment Headeræ‰€åœ¨çš„Pageã€‚Rollback Segment Headeræ˜¯æŒ‰éœ€åˆ†é…çš„ï¼Œå…¶ä¸­åŒ…å«1024ä¸ªSlotï¼Œæ¯ä¸ª<strong>Slot</strong>å å››ä¸ªå­—èŠ‚ï¼ŒæŒ‡å‘ä¸€ä¸ªUndo Segmentçš„First Pageã€‚é™¤æ­¤ä¹‹å‰è¿˜ä¼šè®°å½•è¯¥Rollback Segmentä¸­å·²æäº¤äº‹åŠ¡çš„History Listï¼Œåç»­çš„Purgeè¿‡ç¨‹ä¼šé¡ºåºä»è¿™é‡Œå¼€å§‹å›æ”¶å·¥ä½œã€‚</p><p>å¯ä»¥çœ‹å‡ºRollback Segmentçš„ä¸ªæ•°ä¼šç›´æ¥å½±å“InnoDBæ”¯æŒçš„æœ€å¤§äº‹åŠ¡å¹¶å‘æ•°ã€‚MySQL 8.0ç”±äºæ”¯æŒäº†æœ€å¤š127ä¸ªç‹¬ç«‹çš„Undo Tablespaceï¼Œä¸€æ–¹é¢é¿å…äº†ibdata1çš„è†¨èƒ€ï¼Œæ–¹ä¾¿undoç©ºé—´å›æ”¶ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¤§å¤§å¢åŠ äº†æœ€å¤§çš„Rollback Segmentçš„ä¸ªæ•°ï¼Œå¢åŠ äº†å¯æ”¯æŒçš„æœ€å¤§å¹¶å‘å†™äº‹åŠ¡æ•°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/assets/post_img/article123/undo_tablespace.png" alt=""></p><h4 id="å†…å­˜ç»„ç»‡ç»“æ„"><a href="#å†…å­˜ç»„ç»‡ç»“æ„" class="headerlink" title="å†…å­˜ç»„ç»‡ç»“æ„"></a>å†…å­˜ç»„ç»‡ç»“æ„</h4><p>ä¸Šé¢ä»‹ç»çš„éƒ½æ˜¯Undoæ•°æ®åœ¨ç£ç›˜ä¸Šçš„ç»„ç»‡ç»“æ„ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåœ¨å†…å­˜ä¸­ä¹Ÿä¼šç»´æŠ¤å¯¹åº”çš„æ•°æ®ç»“æ„æ¥ç®¡ç†Undo Logï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/assets/post_img/article123/undo_memory.png" alt=""></p><p>å¯¹åº”æ¯ä¸ªç£ç›˜Undo Tablespaceä¼šæœ‰ä¸€ä¸ª<strong>undo::Tablespace</strong>çš„å†…å­˜ç»“æ„ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„å°±æ˜¯ä¸€ç»„<strong>trx_rseg_t</strong>çš„é›†åˆï¼Œtrx_rseg_tå¯¹åº”çš„å°±æ˜¯ä¸Šé¢ä»‹ç»è¿‡çš„ä¸€ä¸ªRollback Segment Headerï¼ˆç›®å½•ï¼‰ï¼Œé™¤äº†ä¸€äº›åŸºæœ¬çš„å…ƒä¿¡æ¯ä¹‹å¤–ï¼Œtrx_rseg_tä¸­ç»´æŠ¤äº†å››ä¸ªtrx_undo_tçš„é“¾è¡¨ï¼ŒUpdate Listä¸­æ˜¯æ­£åœ¨è¢«ä½¿ç”¨çš„ç”¨äºå†™å…¥Updateç±»å‹Undoçš„Undo Segmentï¼›Update Cache Listä¸­æ˜¯ç©ºé—²ç©ºé—´æ¯”è¾ƒå¤šï¼Œå¯ä»¥è¢«åç»­äº‹åŠ¡å¤ç”¨çš„Updateç±»å‹Undo Segment;å¯¹åº”çš„ï¼ŒInsert Listå’ŒInsert Cache Liståˆ†åˆ«æ˜¯æ­£åœ¨ä½¿ç”¨ä¸­çš„Insertç±»å‹Undo Segmentï¼Œå’Œç©ºé—´ç©ºé—´è¾ƒå¤šï¼Œå¯ä»¥è¢«åç»­å¤ç”¨çš„Insertç±»å‹Undo Segmentã€‚å› æ­¤<strong>trx_undo_tå¯¹åº”çš„å°±æ˜¯ä¸Šé¢ä»‹ç»è¿‡çš„Undo Segment</strong>ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä»Undoçš„å†™å…¥ã€Undoç”¨äºRollbackã€MVCCã€Crash Recoveryä»¥åŠå¦‚ä½•æ¸…ç†Undoç­‰æ–¹é¢æ¥ä»‹ç»InnoDBä¸­Undoçš„è§’è‰²å’ŒåŠŸèƒ½ã€‚</p><h3 id="Undo-Logçš„å†™å…¥"><a href="#Undo-Logçš„å†™å…¥" class="headerlink" title="Undo Logçš„å†™å…¥"></a>Undo Logçš„å†™å…¥</h3><p>å½“å†™äº‹åŠ¡å¼€å§‹æ—¶ï¼Œä¼šå…ˆé€šè¿‡<strong>trx_assign_rseg_durable</strong>æ“ä½œåˆ†é…ä¸€ä¸ªRollback Segmentï¼Œè¯¥äº‹åŠ¡çš„å†…å­˜ç»“æ„<strong>trx_t</strong>ä¹Ÿä¼šé€šè¿‡rsegsæŒ‡é’ˆæŒ‡å‘å¯¹åº”çš„trx_rseg_tå†…å­˜ç»“æ„ï¼Œè¿™é‡Œçš„åˆ†é…ç­–ç•¥å¾ˆç®€å•ï¼Œå°±æ˜¯ä¾æ¬¡å°è¯•ä¸‹ä¸€ä¸ªActiveçš„Rollback Segmentã€‚ä¹‹åå½“ç¬¬ä¸€æ¬¡çœŸæ­£äº§ç”Ÿä¿®æ”¹éœ€è¦å†™Undo Recordçš„æ—¶ï¼Œä¼šè°ƒç”¨<strong>trx_undo_assign_undo</strong>æ“ä½œæ¥è·å¾—ä¸€ä¸ªUndo Segmentã€‚è¿™é‡Œä¼šä¼˜å…ˆå¤ç”¨trx_rseg_tä¸Š<strong>Cached List</strong>ä¸­çš„trx_undo_tï¼Œä¹Ÿå°±æ˜¯å·²ç»åˆ†é…å‡ºæ¥ä½†æ²¡æœ‰è¢«æ­£åœ¨ä½¿ç”¨çš„Undo Segmentï¼Œå¦‚æœæ²¡æœ‰æ‰è°ƒç”¨<strong>trx_undo_create</strong>æ“ä½œåˆ›å»ºæ–°çš„Undo Segmentï¼Œtrx_undo_createä¸­ä¼šè½®è¯¢é€‰æ‹©å½“å‰Rollback Segmentä¸­å¯ç”¨çš„Slotï¼Œä¹Ÿæ˜¯å°±å€¼FIL_NULçš„Slotï¼Œç”³è¯·æ–°çš„Undo Pageï¼Œåˆå§‹åŒ–Undo Page Headerï¼ŒUndo Segment Headerç­‰ä¿¡æ¯ï¼Œåˆ›å»ºæ–°çš„trx_undo_tå†…å­˜ç»“æ„å¹¶æŒ‚åˆ°trx_rseg_tçš„å¯¹åº”Listä¸­ã€‚</p><p>è·å¾—äº†å¯ç”¨çš„Undo Segmentä¹‹åï¼Œè¯¥äº‹åŠ¡ä¼šåœ¨åˆé€‚çš„ä½ç½®åˆå§‹åŒ–è‡ªå·±çš„Undo Log Headerï¼Œä¹‹åï¼Œå…¶æ‰€æœ‰ä¿®æ”¹äº§ç”Ÿçš„Undo Recordéƒ½ä¼šé¡ºåºçš„é€šè¿‡<strong>trx_undo_report_row_operation</strong>æ“ä½œé¡ºåºçš„å†™å…¥å½“å‰çš„Undo Logï¼Œå…¶ä¸­ä¼šæ ¹æ®æ˜¯insertè¿˜æ˜¯updateç±»å‹ï¼Œåˆ†åˆ«è°ƒç”¨trx_undo_page_report_insertæˆ–è€…trx_undo_page_report_modifyã€‚æœ¬æ–‡å¼€å§‹å·²ç»ä»‹ç»è¿‡äº†å…·ä½“çš„Undo Recordå†…å®¹ã€‚ç®€å•çš„è®²ï¼Œinsertç±»å‹ä¼šè®°å½•æ’å…¥Recordçš„ä¸»é”®ï¼Œupdateç±»å‹é™¤äº†è®°å½•ä¸»é”®ä»¥å¤–è¿˜ä¼šæœ‰ä¸€ä¸ªupdate filedsè®°å½•è¿™ä¸ªå†å²å€¼è·Ÿç´¢å¼•å€¼çš„diffã€‚ä¹‹åæŒ‡å‘å½“å‰Undo Recordä½ç½®çš„Rollpträ¼šè¿”å›å†™å…¥ç´¢å¼•çš„Recordä¸Šã€‚</p><p>å½“ä¸€ä¸ªPageå†™æ»¡åï¼Œä¼šè°ƒç”¨<strong>trx_undo_add_page</strong>æ¥åœ¨å½“å‰çš„Undo Segmentä¸Šæ·»åŠ æ–°çš„Pageï¼Œæ–°Pageå†™å…¥Undo Page Headerä¹‹åç»§ç»­ä¾›äº‹åŠ¡å†™å…¥Undo Recordï¼Œä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶å°±æ˜¯å•æ¡Undo Recordä¸è·¨pageï¼Œå¦‚æœå½“å‰Pageæ”¾ä¸ä¸‹ï¼Œä¼šå°†æ•´ä¸ªUndo Recordå†™å…¥ä¸‹ä¸€ä¸ªPageã€‚</p><p>å½“äº‹åŠ¡ç»“æŸï¼ˆcommitæˆ–è€…rollbackï¼‰ä¹‹åï¼Œå¦‚æœåªå ç”¨äº†ä¸€ä¸ªUndo Pageï¼Œä¸”å½“å‰Undo Pageä½¿ç”¨ç©ºé—´å°äºpageçš„3/4ï¼Œè¿™ä¸ªUndo Segmentä¼šä¿ç•™å¹¶åŠ å…¥åˆ°å¯¹åº”çš„insert/update cached listä¸­ã€‚å¦åˆ™ï¼Œinsertç±»å‹çš„Undo Segmentä¼šç›´æ¥å›æ”¶ï¼Œè€Œupdateç±»å‹çš„Undo Segmentä¼šç­‰å¾…åå°çš„Purgeåšå®Œåå›æ”¶ã€‚æ ¹æ®ä¸åŒçš„æƒ…å†µï¼ŒUndo Segment Headerä¸­çš„Stateä¼šè¢«ä»<code>TRX_UNDO_ACTIVE</code>æ”¹æˆ<code>TRX_UNDO_TO_FREE</code>ï¼Œ<code>TRX_UNDO_TO_PURGE</code>æˆ–<code>TRX_UNDO_CACHED</code>ï¼Œè¿™ä¸ªä¿®æ”¹å…¶å®å°±æ˜¯InnoDBçš„äº‹åŠ¡ç»“æŸçš„æ ‡å¿—ï¼Œæ— è®ºæ˜¯Rollbackè¿˜æ˜¯Commitï¼Œåœ¨è¿™ä¸ªä¿®æ”¹å¯¹åº”çš„Redoè½ç›˜ä¹‹åï¼Œå°±å¯ä»¥è¿”å›ç”¨æˆ·ç»“æœï¼Œå¹¶ä¸”Crash Recoveryä¹‹åä¹Ÿä¸ä¼šå†åšå›æ»šå¤„ç†ã€‚</p><h3 id="Undo-Logä¹‹å›æ»š"><a href="#Undo-Logä¹‹å›æ»š" class="headerlink" title="Undo Logä¹‹å›æ»š"></a>Undo Logä¹‹å›æ»š</h3><p>InnoDBä¸­çš„äº‹åŠ¡å¯èƒ½ä¼šç”±ç”¨æˆ·ä¸»åŠ¨è§¦å‘Rollbackï¼›ä¹Ÿå¯èƒ½å› ä¸ºé‡åˆ°æ­»é”å¼‚å¸¸Rollbackï¼›æˆ–è€…å‘ç”ŸCrashï¼Œé‡å¯åå¯¹æœªæäº¤çš„äº‹åŠ¡å›æ»šã€‚åœ¨Undoå±‚é¢æ¥çœ‹ï¼Œè¿™äº›å›æ»šçš„æ“ä½œæ˜¯ä¸€è‡´çš„ï¼ŒåŸºæœ¬çš„è¿‡ç¨‹å°±æ˜¯ä»è¯¥äº‹åŠ¡çš„Undo Logä¸­ï¼Œä»åå‘å‰ä¾æ¬¡è¯»å–Undo Recordï¼Œå¹¶æ ¹æ®å…¶ä¸­å†…å®¹åšé€†å‘æ“ä½œï¼Œæ¢å¤ç´¢å¼•è®°å½•ã€‚</p><p>å›æ»šçš„å…¥å£æ˜¯å‡½æ•°<strong>row_undo</strong>ï¼Œå…¶ä¸­ä¼šå…ˆè°ƒç”¨trx_roll_pop_top_rec_of_trxè·å–å¹¶åˆ é™¤è¯¥äº‹åŠ¡çš„æœ€åä¸€æ¡Undo Recordã€‚å¦‚ä¸‹å›¾ä¾‹å­ä¸­çš„Undo LogåŒ…æ‹¬ä¸‰æ¡Undo Recordsï¼Œå…¶ä¸­Record 1åœ¨Undo Page 1ä¸­ï¼ŒRecord 2ï¼Œ3åœ¨Undo Page 2ä¸­ï¼Œå…ˆé€šè¿‡ä»Undo Segment Headerä¸­è®°å½•çš„Page Listæ‰¾åˆ°å½“å‰äº‹åŠ¡çš„æœ€åä¸€ä¸ªUndo Pageçš„Headerï¼Œå¹¶æ ¹æ®Undo Page 2çš„Headerä¸Šè®°å½•çš„Free Space Offsetå®šä½æœ€åä¸€æ¡Undo Recordç»“æŸçš„ä½ç½®ï¼Œå½“ç„¶å®é™…è¿è¡Œæ—¶ï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¯ç¼“å­˜åœ¨trx_undo_tçš„top_page_noå’Œtop_offsetä¸­çš„ã€‚åˆ©ç”¨Prev Record Offsetå¯ä»¥æ‰¾åˆ°Undo Record 3ï¼Œåšå®Œå¯¹åº”çš„å›æ»šæ“ä½œä¹‹åï¼Œå†é€šè¿‡å‰åºæŒ‡é’ˆPrev Record Offsetæ‰¾åˆ°å‰ä¸€ä¸ªUndo Recordï¼Œä¾æ¬¡è¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œå½“å‰Pageä¸­çš„æ‰€æœ‰Undo Recordsåï¼Œå†æ²¿ç€Undo Page Headerä¸­çš„Listæ‰¾åˆ°å‰ä¸€ä¸ªUndo Pageï¼Œé‡å¤å‰é¢çš„è¿‡ç¨‹ï¼Œå®Œæˆä¸€ä¸ªäº‹åŠ¡æ‰€æœ‰Pageä¸Šçš„æ‰€æœ‰Undo Recordsçš„å›æ»šã€‚</p><p><img src="/assets/post_img/article123/undo_rollback.png" alt=""></p><p>æ‹¿åˆ°ä¸€ä¸ªUndo Recordä¹‹åï¼Œè‡ªç„¶åœ°ï¼Œå°±æ˜¯å¯¹å…¶ä¸­å†…å®¹çš„è§£æï¼Œè¿™é‡Œä¼šè°ƒç”¨row_undo_ins_parse_undo_recï¼Œä»Undo Recordä¸­è·å–ä¿®æ”¹è¡Œçš„tableï¼Œè§£æå‡ºå…¶ä¸­è®°å½•çš„ä¸»é”®ä¿¡æ¯ï¼Œå¦‚æœæ˜¯updateç±»å‹ï¼Œè¿˜ä¼šæ‹¿åˆ°ä¸€ä¸ªupdate vectorè®°å½•å…¶ç›¸å¯¹äºæ›´æ–°çš„ä¸€ä¸ªç‰ˆæœ¬çš„å˜åŒ–ã€‚</p><p><code>TRX_UNDO_INSERT_REC</code>ç±»å‹çš„Undoå›æ»šåœ¨row_undo_insä¸­è¿›è¡Œï¼Œinsertçš„é€†å‘æ“ä½œå½“ç„¶å°±æ˜¯deleteï¼Œæ ¹æ®ä»Undo Recordä¸­è§£æå‡ºæ¥çš„ä¸»é”®ï¼Œç”¨row_undo_search_clust_to_pcurå®šä½åˆ°å¯¹åº”çš„ROWï¼Œ åˆ†åˆ«è°ƒç”¨row_undo_ins_remove_sec_recå’Œrow_undo_ins_remove_clust_recåœ¨äºŒçº§ç´¢å¼•å’Œä¸»ç´¢å¼•ä¸Šå°†å½“å‰è¡Œåˆ é™¤ã€‚</p><p>updateç±»å‹çš„undoåŒ…æ‹¬<code>TRX_UNDO_UPD_EXIST_REC</code>ï¼Œ<code>TRX_UNDO_DEL_MARK_REC</code>å’Œ<code>TRX_UNDO_UPD_DEL_REC</code>ä¸‰ç§æƒ…å†µï¼Œä»–ä»¬çš„Undoå›æ»šéƒ½æ˜¯åœ¨row_undo_modä¸­è¿›è¡Œï¼Œé¦–å…ˆä¼šè°ƒç”¨row_undo_mod_del_unmark_sec_and_undo_updateï¼Œå…¶ä¸­æ ¹æ®ä»Undo Recordä¸­è§£æå‡ºçš„update vectoræ¥å›é€€è¿™æ¬¡æ“ä½œåœ¨æ‰€æœ‰äºŒçº§ç´¢å¼•ä¸Šçš„å½±å“ï¼Œå¯èƒ½åŒ…æ‹¬é‡æ–°æ’å…¥è¢«åˆ é™¤çš„äºŒçº§ç´¢å¼•è®°å½•ã€å»é™¤å…¶ä¸­çš„Delete Markæ ‡è®°ï¼Œæˆ–è€…ç”¨update vectorä¸­çš„diffä¿¡æ¯å°†äºŒçº§ç´¢å¼•è®°å½•ä¿®æ”¹ä¹‹å‰çš„å€¼ã€‚ä¹‹åè°ƒç”¨row_undo_mod_cluståŒæ ·åˆ©ç”¨update vectorä¸­è®°å½•çš„diffä¿¡æ¯å°†ä¸»ç´¢å¼•è®°å½•ä¿®æ”¹å›ä¹‹å‰çš„å€¼ã€‚</p><p>å®Œæˆå›æ»šçš„Undo Logéƒ¨åˆ†ï¼Œä¼šè°ƒç”¨trx_roll_try_truncateè¿›è¡Œå›æ”¶ï¼Œå¯¹ä¸å†ä½¿ç”¨çš„pageè°ƒç”¨trx_undo_free_last_pageå°†ç£ç›˜ç©ºé—´äº¤è¿˜ç»™Undo Segmentï¼Œè¿™ä¸ªæ˜¯å†™å…¥è¿‡ç¨‹ä¸­trx_undo_add_pageçš„é€†æ“ä½œã€‚</p><h3 id="Undo-Logä¹‹æ•…éšœæ¢å¤"><a href="#Undo-Logä¹‹æ•…éšœæ¢å¤" class="headerlink" title="Undo Logä¹‹æ•…éšœæ¢å¤"></a>Undo Logä¹‹æ•…éšœæ¢å¤</h3><p>Crash Recoveryæ—¶ï¼Œéœ€è¦åˆ©ç”¨Undoä¸­çš„ä¿¡æ¯å°†æœªæäº¤çš„äº‹åŠ¡çš„æ‰€æœ‰å½±å“å›æ»šï¼Œä»¥ä¿è¯æ•°æ®åº“çš„Failure Atomicã€‚å‰é¢æåˆ°è¿‡ï¼ŒInnoDBä¸­çš„Undoå…¶å®æ˜¯åƒæ•°æ®ä¸€æ ·å¤„ç†çš„ï¼Œä¹Ÿä»ä¸Šé¢çš„ç»„ç»‡ç»“æ„ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼ŒUndoæœ¬èº«æœ‰ç€æ¯”Redo Logå¤æ‚å¾—å¤šã€æŒ‰äº‹åŠ¡åˆ†é…è€Œä¸æ˜¯é¡ºåºå†™å…¥çš„ç»„ç»‡ç»“æ„ï¼Œå…¶æœ¬èº«çš„DurabilityåƒInnoDBä¸­å…¶ä»–çš„æ•°æ®ä¸€æ ·ï¼Œéœ€è¦é Redoæ¥ä¿è¯ã€‚é™¤äº†é€šç”¨çš„ä¸€äº›MLOG_2BYTESã€MLOG_4BYTESç±»å‹ä¹‹å¤–ï¼ŒUndoæœ¬èº«ä¹Ÿæœ‰è‡ªå·±å¯¹åº”çš„Redo Logç±»å‹ï¼š<strong>MLOG_UNDO_INIT</strong>ç±»å‹åœ¨Undo Pageèˆ’é€‚åŒ–çš„æ—¶å€™è®°å½•åˆå§‹åŒ–ï¼›åœ¨åˆ†é…Undo Logçš„æ—¶å€™ï¼Œéœ€è¦é‡ç”¨Undo Log Headeræˆ–éœ€è¦åˆ›å»ºæ–°çš„Undo Log Headerçš„æ—¶å€™ï¼Œä¼šåˆ†åˆ«è®°å½•<strong>MLOG_UNDO_HDR_REUSE</strong>å’Œ<strong>MLOG_UNDO_HDR_CREATE</strong>ç±»å‹çš„Redo Recordï¼›<strong>MLOG_UNDO_INSERT</strong>æ˜¯æœ€å¸¸è§çš„ï¼Œåœ¨Undo Logé‡Œå†™å…¥æ–°çš„Undo Recordéƒ½å¯¹åº”çš„å†™è¿™ä¸ªæ—¥å¿—è®°å½•å†™å…¥Undoä¸­çš„æ‰€æœ‰å†…å®¹ï¼›æœ€åï¼Œ<strong>MLOG_UNDO_ERASE_END</strong>å¯¹åº”Undo Logè·¨Undo Pageæ—¶æŠ¹é™¤æœ€åä¸€ä¸ªä¸å®Œæ•´çš„Undo</p><blockquote><p>ARIESï¼ˆAlgorithms for Recovery and Isolation Exploiting Semanticsï¼‰æ˜¯ä¸€ç§äº‹åŠ¡æ¢å¤åè®®ï¼Œç”¨äºæ•°æ®åº“ç³»ç»Ÿä¸­çš„å´©æºƒæ¢å¤å’Œå¹¶å‘æ§åˆ¶ã€‚å®ƒæ˜¯ä¸€ä¸ªç»å…¸çš„æ¢å¤ç®—æ³•ï¼Œå¹¶è¢«å¹¿æ³›åº”ç”¨äºè®¸å¤šå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆRDBMSï¼‰ã€‚</p><p>ARIESæœ¬è´¨æ˜¯ä¸€ç§Redo-Undoçš„WALå®ç°ã€‚å…¶æ­£å¸¸è¿è¡Œè¿‡ç¨‹ä¸ºï¼šä¿®æ”¹æ•°æ®ä¹‹å‰å…ˆè¿½åŠ Logè®°å½•ï¼ŒLogå†…å®¹åŒæ—¶åŒ…æ‹¬Redoå’ŒUndoä¿¡æ¯ï¼Œæ¯ä¸ªæ—¥å¿—è®°å½•äº§ç”Ÿä¸€ä¸ªæ ‡è®°å…¶åœ¨æ—¥å¿—ä¸­ä½ç½®çš„é€’å¢LSNï¼ˆLog Sequence Numberï¼‰ï¼›æ•°æ®é¡µä¸­è®°å½•æœ€åä¿®æ”¹çš„æ—¥å¿—é¡¹LSNï¼Œä»¥æ­¤æ¥åˆ¤æ–­Pageä¸­çš„å†…å®¹çš„æ–°æ—§ç¨‹åº¦ï¼Œå®ç°å¹‚ç­‰ã€‚æ•…éšœæ¢å¤é˜¶æ®µéœ€è¦é€šè¿‡Logä¸­çš„å†…å®¹æ¢å¤æ•°æ®åº“çŠ¶æ€ï¼Œä¸ºäº†å‡å°‘æ¢å¤æ—¶éœ€è¦å¤„ç†çš„æ—¥å¿—é‡ï¼ŒARIESä¼šåœ¨æ­£å¸¸è¿è¡ŒæœŸé—´å‘¨æœŸæ€§çš„ç”ŸæˆCheckpointï¼ŒCheckpointä¸­é™¤äº†å½“å‰çš„æ—¥å¿—LSNä¹‹å¤–ï¼Œè¿˜éœ€è¦è®°å½•å½“å‰æ´»è·ƒäº‹åŠ¡çš„æœ€æ–°LSNï¼Œä»¥åŠæ‰€æœ‰è„é¡µï¼Œä¾›æ¢å¤æ—¶å†³å®šé‡æ”¾Redoçš„å¼€å§‹ä½ç½®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºç”ŸæˆCheckpointæ—¶æ•°æ®åº“è¿˜åœ¨æ­£å¸¸æä¾›æœåŠ¡ï¼ˆFuzzy Checkpointï¼‰ï¼Œå…¶ä¸­è®°å½•çš„æ´»è·ƒäº‹åŠ¡åŠè„é¡µä¿¡æ¯å¹¶ä¸ä¸€å®šå‡†ç¡®ï¼Œå› æ­¤éœ€è¦Recoveryé˜¶æ®µé€šè¿‡Logå†…å®¹è¿›è¡Œä¿®æ­£ã€‚</p><p>Recoverè¿‡ç¨‹ï¼šæ•…éšœæ¢å¤åŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼šAnalysisï¼ŒRedoå’ŒUndoã€‚Analysisé˜¶æ®µçš„ä»»åŠ¡ä¸»è¦æ˜¯åˆ©ç”¨CheckpointåŠLogä¸­çš„ä¿¡æ¯ç¡®è®¤åç»­Redoå’ŒUndoé˜¶æ®µçš„æ“ä½œèŒƒå›´ï¼Œé€šè¿‡Logä¿®æ­£Checkpointä¸­è®°å½•çš„è„é¡µé›†åˆä¿¡æ¯ï¼Œå¹¶ç”¨å…¶ä¸­æ¶‰åŠæœ€å°çš„LSNä½ç½®ä½œä¸ºä¸‹ä¸€æ­¥Redoçš„å¼€å§‹ä½ç½®RedoLSNã€‚åŒæ—¶ä¿®æ­£Checkpointä¸­è®°å½•çš„æ´»è·ƒäº‹åŠ¡é›†åˆï¼ˆæœªæäº¤äº‹åŠ¡ï¼‰ï¼Œä½œä¸ºUndoè¿‡ç¨‹çš„å›æ»šå¯¹è±¡ï¼›Redoé˜¶æ®µä»Analysisè·å¾—çš„RedoLSNå‡ºå‘ï¼Œé‡æ”¾æ‰€æœ‰çš„Logä¸­çš„Redoå†…å®¹ï¼Œæ³¨æ„è¿™é‡Œä¹ŸåŒ…å«äº†æœªCommitäº‹åŠ¡ï¼›æœ€åUndoé˜¶æ®µå¯¹æ‰€æœ‰æœªæäº¤äº‹åŠ¡åˆ©ç”¨Undoä¿¡æ¯è¿›è¡Œå›æ»šï¼Œé€šè¿‡Logçš„PrevLSNå¯ä»¥é¡ºåºæ‰¾åˆ°äº‹åŠ¡æ‰€æœ‰éœ€è¦å›æ»šçš„ä¿®æ”¹ã€‚</p></blockquote><p>ä»¥ARIESè¿‡ç¨‹ä¸ºä¾‹ï¼ŒCrash Recoveryçš„è¿‡ç¨‹ä¸­ä¼šå…ˆé‡æ”¾æ‰€æœ‰çš„Redo Logï¼Œæ•´ä¸ªUndoçš„ç£ç›˜ç»„ç»‡ç»“æ„ï¼Œä¹Ÿä¼šä½œä¸ºä¸€ç§æ•°æ®ç±»å‹ä¹Ÿä¼šé€šè¿‡ä¸Šé¢è®²åˆ°çš„è¿™äº›Redoç±»å‹çš„é‡æ”¾æ¢å¤å‡ºæ¥ã€‚ä¹‹ååœ¨trx_sys_init_at_db_startæ“ä½œä¸­ä¼šæ‰«æUndoçš„ç£ç›˜ç»“æ„ï¼Œéå†æ‰€æœ‰çš„Rollback Segmentå’Œå…¶ä¸­æ‰€æœ‰çš„Undo Segmentï¼Œé€šè¿‡è¯»å–Undo Segment Headerä¸­çš„Stateï¼Œå¯ä»¥çŸ¥é“åœ¨Crashå‰ï¼Œæœ€åæŒæœ‰è¿™ä¸ªUndo Segmentçš„äº‹åŠ¡çŠ¶æ€ã€‚å¦‚æœæ˜¯<code>TRX_UNDO_ACTIVE</code>ï¼Œè¯´æ˜å½“æ—¶äº‹åŠ¡éœ€è¦å›æ»šï¼Œå¦åˆ™è¯´æ˜äº‹åŠ¡å·²ç»ç»“æŸï¼Œå¯ä»¥ç»§ç»­æ¸…ç†Undo Segmentçš„é€»è¾‘ã€‚ä¹‹åï¼Œå°±å¯ä»¥æ¢å¤å‡ºUndo Logçš„å†…å­˜ç»„ç»‡æ¨¡å¼ï¼ŒåŒ…æ‹¬æ´»è·ƒäº‹åŠ¡çš„å†…å­˜ç»“æ„trx_tï¼ŒRollback Segmentçš„å†…å­˜ç»“æ„trx_rseg_tï¼Œä»¥åŠå…¶ä¸­çš„trx_undo_tçš„å››ä¸ªé“¾è¡¨ã€‚</p><p>Crash Recoveryå®Œæˆä¹‹å‰ï¼Œä¼šå¯åŠ¨åœ¨srv_dict_recover_on_restartä¸­å¯åŠ¨å¼‚æ­¥å›æ»šçº¿ç¨‹trx_recovery_rollback_threadï¼Œå…¶ä¸­å¯¹Crashå‰è¿˜æ´»è·ƒçš„äº‹åŠ¡ï¼Œé€šè¿‡trx_rollback_activeè¿›è¡Œå›æ»šï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ä¸Šé¢æåˆ°çš„Undoå›æ»šæ˜¯ä¸€è‡´çš„ã€‚</p><h3 id="Undo-Logçš„æ¸…ç†"><a href="#Undo-Logçš„æ¸…ç†" class="headerlink" title="Undo Logçš„æ¸…ç†"></a>Undo Logçš„æ¸…ç†</h3><p>InnoDBåœ¨Undo Logä¸­ä¿å­˜äº†å¤šä»½å†å²ç‰ˆæœ¬æ¥å®ç°MVCCï¼Œå½“æŸä¸ªå†å²ç‰ˆæœ¬å·²ç»ç¡®è®¤ä¸ä¼šè¢«ä»»ä½•ç°æœ‰çš„å’Œæœªæ¥çš„äº‹åŠ¡çœ‹åˆ°çš„æ—¶å€™ï¼Œå°±åº”è¯¥è¢«æ¸…ç†æ‰ã€‚å› æ­¤å°±éœ€è¦æœ‰åŠæ³•åˆ¤æ–­å“ªäº›Undo Logä¸ä¼šå†è¢«çœ‹åˆ°ã€‚InnoDBä¸­æ¯ä¸ªå†™äº‹åŠ¡ç»“æŸæ—¶éƒ½ä¼šæ‹¿ä¸€ä¸ªé€’å¢çš„ç¼–å·trx_noä½œä¸ºäº‹åŠ¡çš„æäº¤åºå·ï¼Œè€Œæ¯ä¸ªè¯»äº‹åŠ¡ä¼šåœ¨è‡ªå·±çš„ReadViewä¸­è®°å½•è‡ªå·±å¼€å§‹çš„æ—¶å€™çœ‹åˆ°çš„æœ€å¤§çš„trx_noä¸ºm_low_limit_noã€‚é‚£ä¹ˆï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡çš„trx_noå°äºå½“å‰æ‰€æœ‰æ´»è·ƒçš„è¯»äº‹åŠ¡Readviewä¸­çš„è¿™ä¸ªm_low_limit_noï¼Œè¯´æ˜è¿™ä¸ªäº‹åŠ¡åœ¨æ‰€æœ‰çš„è¯»å¼€å§‹ä¹‹å‰å·²ç»æäº¤äº†ï¼Œå…¶ä¿®æ”¹çš„æ–°ç‰ˆæœ¬æ˜¯å¯è§çš„ï¼Œ å› æ­¤ä¸å†éœ€è¦é€šè¿‡undoæ„å»ºä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªäº‹åŠ¡çš„Undo Logä¹Ÿå°±å¯ä»¥è¢«æ¸…ç†äº†ã€‚</p><p>è¿™é‡Œä¸å¤šæ·±å…¥ï¼Œæš‚æ—¶ç”¨å¤„ä¸å¤§ï¼Œç›¸å…³å†…å®¹ï¼šUndo Purgeã€Undo Truncateã€Undo Tablespace Truncateã€‚</p><h2 id="MVCCå’Œé”-Isolation"><a href="#MVCCå’Œé”-Isolation" class="headerlink" title="MVCCå’Œé” (Isolation)"></a>MVCCå’Œé” (Isolation)</h2><p>å¤šç‰ˆæœ¬çš„ç›®çš„æ˜¯ä¸ºäº†é¿å…å†™äº‹åŠ¡å’Œè¯»äº‹åŠ¡çš„äº’ç›¸ç­‰å¾…ï¼Œé‚£ä¹ˆæ¯ä¸ªè¯»äº‹åŠ¡éƒ½éœ€è¦åœ¨ä¸å¯¹æ•°æ®åº“è®°å½•åŠ é”çš„æƒ…å†µä¸‹ï¼Œæ‰¾åˆ°å¯¹åº”çš„åº”è¯¥çœ‹åˆ°çš„å†å²ç‰ˆæœ¬ã€‚æ‰€è°“å†å²ç‰ˆæœ¬å°±æ˜¯å‡è®¾åœ¨è¯¥åªè¯»äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å¯¹æ•´ä¸ªDBæ‰“ä¸€ä¸ªå¿«ç…§ï¼Œä¹‹åè¯¥äº‹åŠ¡çš„æ‰€æœ‰è¯»è¯·æ±‚éƒ½ä»è¿™ä¸ªå¿«ç…§ä¸Šè·å–ã€‚å½“ç„¶å®ç°ä¸Šä¸èƒ½çœŸæ­£å»ä¸ºæ¯ä¸ªäº‹åŠ¡æ‰“ä¸€ä¸ªå¿«ç…§ï¼Œè¿™ä¸ªæ—¶é—´ç©ºé—´éƒ½å¤ªé«˜äº†ã€‚InnoDBçš„åšæ³•ï¼Œæ˜¯åœ¨è¯»äº‹åŠ¡ç¬¬ä¸€æ¬¡è¯»å–çš„æ—¶å€™è·å–ä¸€ä»½ReadViewï¼Œå¹¶ä¸€ç›´æŒæœ‰ï¼Œå…¶ä¸­è®°å½•æ‰€æœ‰å½“å‰æ´»è·ƒçš„å†™äº‹åŠ¡IDï¼Œç”±äºå†™äº‹åŠ¡çš„IDæ˜¯è‡ªå¢åˆ†é…çš„ï¼Œé€šè¿‡è¿™ä¸ªReadViewæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨è¿™ä¸€ç¬é—´ï¼Œå“ªäº›äº‹åŠ¡å·²ç»æäº¤å“ªäº›è¿˜åœ¨è¿è¡Œï¼Œæ ¹æ®Read Committedçš„è¦æ±‚ï¼Œæœªæäº¤çš„äº‹åŠ¡çš„ä¿®æ”¹å°±æ˜¯ä¸åº”è¯¥è¢«çœ‹è§çš„ï¼Œå¯¹åº”åœ°ï¼Œå·²ç»æäº¤çš„äº‹åŠ¡çš„ä¿®æ”¹åº”è¯¥è¢«çœ‹åˆ°ã€‚</p><p>ä½œä¸ºå­˜å‚¨å†å²ç‰ˆæœ¬çš„Undo Recordï¼Œå…¶ä¸­è®°å½•çš„trx_idå°±æ˜¯åšè¿™ä¸ªå¯è§æ€§åˆ¤æ–­çš„ï¼Œå¯¹åº”çš„æ•°æ®åº“ä¸»ç´¢å¼•çš„è®°å½•ä¸Šä¹Ÿæœ‰è¿™ä¸ªå€¼ã€‚å½“ä¸€ä¸ªè¯»äº‹åŠ¡æ‹¿ç€è‡ªå·±çš„ReadViewè®¿é—®æŸä¸ªè¡¨ç´¢å¼•ä¸Šçš„è®°å½•æ—¶ï¼Œä¼šé€šè¿‡æ¯”è¾ƒè®°å½•ä¸Šçš„trx_idç¡®å®šæ˜¯å¦æ˜¯å¯è§çš„ç‰ˆæœ¬ï¼Œå¦‚æœä¸å¯è§å°±æ²¿ç€Recordæˆ–Undo Recordä¸­è®°å½•çš„rollpträ¸€è·¯æ‰¾æ›´è€çš„å†å²ç‰ˆæœ¬ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œäº‹åŠ¡$R$å¼€å§‹éœ€è¦æŸ¥è¯¢è¡¨$t$ä¸Šçš„idä¸º1çš„è®°å½•ï¼Œ$R$å¼€å§‹æ—¶äº‹åŠ¡$I$å·²ç»æäº¤ï¼Œäº‹åŠ¡$J$è¿˜åœ¨è¿è¡Œï¼Œäº‹åŠ¡$K$è¿˜æ²¡å¼€å§‹ï¼Œè¿™äº›ä¿¡æ¯éƒ½è¢«è®°å½•åœ¨äº†äº‹åŠ¡$R$çš„ReadViewä¸­ã€‚äº‹åŠ¡$R$ä»ç´¢å¼•ä¸­æ‰¾åˆ°å¯¹åº”çš„è¿™æ¡$Record_{1,C}$ï¼Œå¯¹åº”çš„trx_idæ˜¯$K$ï¼Œä¸å¯è§ã€‚æ²¿ç€rollptræ‰¾åˆ°Undoä¸­çš„å‰ä¸€ç‰ˆæœ¬$Record_{1,B}$ï¼Œå¯¹åº”çš„trx_idæ˜¯$J$ï¼Œä¸å¯è§ã€‚ç»§ç»­æ²¿ç€rollptræ‰¾åˆ°$Record_{1,A}$ï¼Œtrx_idæ˜¯$I$å¯è§ï¼Œè¿”å›ç»“æœã€‚</p><p><img src="/assets/post_img/article123/undo_mvcc.png" alt=""></p><p>å‰é¢æåˆ°è¿‡ï¼Œä½œä¸ºé€»è¾‘æ—¥å¿—ï¼ŒUndoä¸­è®°å½•çš„å…¶å®æ˜¯å‰åä¸¤ä¸ªç‰ˆæœ¬çš„diffä¿¡æ¯ï¼Œè€Œè¯»æ“ä½œæœ€ç»ˆæ˜¯è¦è·å¾—å®Œæ•´çš„Recordå†…å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ²¿ç€rollptræŒ‡é’ˆä¸€è·¯æŸ¥æ‰¾çš„è¿‡ç¨‹ä¸­éœ€è¦ç”¨Undo Recordä¸­çš„diffå†…å®¹ä¾æ¬¡æ„é€ å‡ºå¯¹åº”çš„å†å²ç‰ˆæœ¬ï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨å‡½æ•°row_search_mvccä¸­ï¼Œå…¶ä¸­trx_undo_prev_version_buildä¼šæ ¹æ®å½“å‰çš„rollptræ‰¾åˆ°å¯¹åº”çš„Undo Recordä½ç½®ï¼Œè¿™é‡Œå¦‚æœæ˜¯rollptræŒ‡å‘çš„æ˜¯insertç±»å‹ï¼Œæˆ–è€…æ‰¾åˆ°äº†å·²ç»Purgeäº†çš„ä½ç½®ï¼Œè¯´æ˜åˆ°å¤´äº†ï¼Œä¼šç›´æ¥è¿”å›å¤±è´¥ã€‚å¦åˆ™ï¼Œå°±ä¼šè§£æå¯¹åº”çš„Undo Recordï¼Œæ¢å¤å‡ºtrx_idã€æŒ‡å‘ä¸‹ä¸€æ¡Undo Recordçš„rollptrã€ä¸»é”®ä¿¡æ¯å’Œdiffä¿¡æ¯update vectorç­‰ä¿¡æ¯ã€‚ä¹‹åé€šè¿‡row_upd_rec_in_placeï¼Œç”¨update vectorä¿®æ”¹å½“å‰æŒæœ‰çš„Recordæ‹·è´ä¸­çš„ä¿¡æ¯ï¼Œè·å¾—Recordçš„è¿™ä¸ªå†å²ç‰ˆæœ¬ã€‚ä¹‹åè°ƒç”¨è‡ªå·±ReadViewçš„changes_visibleåˆ¤æ–­å¯è§æ€§ï¼Œå¦‚æœå¯è§åˆ™è¿”å›ç”¨æˆ·ã€‚å®Œæˆè¿™ä¸ªå†å²ç‰ˆæœ¬çš„è¯»å–ã€‚</p><p>TODOï¼šè¡¥å……å…³äºé”çš„å†…å®¹å’ŒMVCCçš„ç›¸å…³å†…å®¹ï¼Œå¹¶å‘äº‹åŠ¡é—®é¢˜-&gt;äº‹åŠ¡éš”ç¦»çº§åˆ«-&gt;ï¼ˆéš”ç¦»çº§åˆ«è®¾ç½®ï¼‰-&gt;éš”ç¦»çº§åˆ«çš„å®ç°-&gt;é”ï¼ˆè¡¨ã€è¡Œã€é¡µï¼‰-&gt;MVCCï¼ˆéšè—å­—æ®µã€undoã€read viewï¼‰ã€‚[3]</p><h1 id="Springäº‹åŠ¡ä½¿ç”¨"><a href="#Springäº‹åŠ¡ä½¿ç”¨" class="headerlink" title="Springäº‹åŠ¡ä½¿ç”¨"></a>Springäº‹åŠ¡ä½¿ç”¨</h1><p>å…ˆä»‹ç»Springæ”¯æŒçš„ä¸¤ç§äº‹åŠ¡ç®¡ç†æ–¹å¼ï¼Œç„¶åä»‹ç»Springæä¾›çš„ä¸»è¦äº‹åŠ¡ç®¡ç†æ¥å£ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨<code>@Transactional</code>æ³¨è§£æ¥å¼€å¯äº‹åŠ¡ï¼Œäºæ˜¯æˆ‘ä»¬ä»‹ç»è¿™ä¸ªæ³¨è§£ä¸­åŒ…å«çš„äº‹åŠ¡å±æ€§å‚æ•°ï¼ˆåŒ…æ‹¬éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºç­‰ç­‰é‡è¦å†…å®¹ï¼‰ï¼Œå¹¶ä»‹ç»å¦‚ä½•ä½¿ç”¨è¯¥æ³¨è§£ã€‚</p><h2 id="ä¸¤ç§äº‹åŠ¡ç®¡ç†æ–¹å¼"><a href="#ä¸¤ç§äº‹åŠ¡ç®¡ç†æ–¹å¼" class="headerlink" title="ä¸¤ç§äº‹åŠ¡ç®¡ç†æ–¹å¼"></a>ä¸¤ç§äº‹åŠ¡ç®¡ç†æ–¹å¼</h2><h3 id="ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†"><a href="#ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†" class="headerlink" title="ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†"></a>ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†</h3><p>é€šè¿‡ <code>TransactionTemplate</code> æˆ–è€… <code>TransactionManager</code> æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡ï¼Œå®é™…åº”ç”¨ä¸­å¾ˆå°‘ä½¿ç”¨ã€‚ä½¿ç”¨ <code>TransactionTemplate</code> è¿›è¡Œç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TransactionTemplate transactionTemplate;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        transactionTemplate.execute(<span class="keyword">new</span> TransactionCallbackWithoutResult() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doInTransactionWithoutResult</span><span class="params">(TransactionStatus transactionStatus)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ....  ä¸šåŠ¡ä»£ç </span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    <span class="comment">//å›æ»š</span></span><br><span class="line">                    transactionStatus.setRollbackOnly();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>TransactionManager</code> è¿›è¡Œç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  TransactionStatus status = transactionManager.getTransaction(<span class="keyword">new</span> DefaultTransactionDefinition());</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">// ....  ä¸šåŠ¡ä»£ç </span></span><br><span class="line">              transactionManager.commit(status);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              transactionManager.rollback(status);</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼ˆå¸¸ç”¨ï¼‰"><a href="#å£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼ˆå¸¸ç”¨ï¼‰" class="headerlink" title="å£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼ˆå¸¸ç”¨ï¼‰"></a>å£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼ˆå¸¸ç”¨ï¼‰</h3><p>ä»£ç ä¾µå…¥æ€§æœ€å°ï¼Œå®é™…æ˜¯é€šè¿‡ AOP å®ç°ï¼ˆåŸºäº<code>@Transactional</code>çš„å…¨æ³¨è§£æ–¹å¼ä½¿ç”¨æœ€å¤šï¼‰ã€‚</p><p>ä½¿ç”¨<code>@Transactional</code>æ³¨è§£è¿›è¡Œäº‹åŠ¡ç®¡ç†çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> aMethod &#123;</span><br><span class="line">  <span class="comment">//do something</span></span><br><span class="line">  B b = <span class="keyword">new</span> B();</span><br><span class="line">  C c = <span class="keyword">new</span> C();</span><br><span class="line">  b.bMethod();</span><br><span class="line">  c.cMethod();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-äº‹åŠ¡ç®¡ç†æ¥å£"><a href="#Spring-äº‹åŠ¡ç®¡ç†æ¥å£" class="headerlink" title="Spring äº‹åŠ¡ç®¡ç†æ¥å£"></a>Spring äº‹åŠ¡ç®¡ç†æ¥å£</h2><p>Spring æ¡†æ¶ä¸­ï¼Œäº‹åŠ¡ç®¡ç†ç›¸å…³æœ€é‡è¦çš„ 3 ä¸ªæ¥å£å¦‚ä¸‹ï¼š<code>PlatformTransactionManager</code>ï¼Œï¼ˆå¹³å°ï¼‰äº‹åŠ¡ç®¡ç†å™¨ï¼ŒSpring äº‹åŠ¡ç­–ç•¥çš„æ ¸å¿ƒï¼›<code>TransactionDefinition</code>ï¼Œäº‹åŠ¡å®šä¹‰ä¿¡æ¯(äº‹åŠ¡éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºã€è¶…æ—¶ã€åªè¯»ã€å›æ»šè§„åˆ™)ï¼›<code>TransactionStatus</code>ï¼Œäº‹åŠ¡è¿è¡ŒçŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥æŠŠ <code>PlatformTransactionManager</code> æ¥å£å¯ä»¥è¢«çœ‹ä½œæ˜¯äº‹åŠ¡ä¸Šå±‚çš„ç®¡ç†è€…ï¼Œè€Œ <code>TransactionDefinition</code> å’Œ <code>TransactionStatus</code> è¿™ä¸¤ä¸ªæ¥å£å¯ä»¥çœ‹ä½œæ˜¯äº‹åŠ¡çš„æè¿°ã€‚<code>PlatformTransactionManager</code> ä¼šæ ¹æ® <code>TransactionDefinition</code> çš„å®šä¹‰æ¯”å¦‚äº‹åŠ¡è¶…æ—¶æ—¶é—´ã€éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºç­‰æ¥è¿›è¡Œäº‹åŠ¡ç®¡ç† ï¼Œè€Œ <code>TransactionStatus</code> æ¥å£åˆ™æä¾›äº†ä¸€äº›æ–¹æ³•æ¥è·å–äº‹åŠ¡ç›¸åº”çš„çŠ¶æ€æ¯”å¦‚æ˜¯å¦æ–°äº‹åŠ¡ã€æ˜¯å¦å¯ä»¥å›æ»šç­‰ç­‰ã€‚</p><h3 id="PlatformTransactionManager-äº‹åŠ¡ç®¡ç†å™¨æ¥å£"><a href="#PlatformTransactionManager-äº‹åŠ¡ç®¡ç†å™¨æ¥å£" class="headerlink" title="PlatformTransactionManager - äº‹åŠ¡ç®¡ç†å™¨æ¥å£"></a><code>PlatformTransactionManager</code> - äº‹åŠ¡ç®¡ç†å™¨æ¥å£</h3><p>Spring å¹¶ä¸ç›´æ¥ç®¡ç†äº‹åŠ¡ï¼Œè€Œæ˜¯æä¾›äº†å¤šç§äº‹åŠ¡ç®¡ç†å™¨ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼ŒSpring ä¸ºå„ä¸ªå¹³å°å¦‚ï¼šJDBC(<code>DataSourceTransactionManager</code>)ã€Hibernate(<code>HibernateTransactionManager</code>)ã€JPA(<code>JpaTransactionManager</code>)ç­‰éƒ½æä¾›äº†å¯¹åº”çš„äº‹åŠ¡ç®¡ç†å™¨ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°å°±æ˜¯å„ä¸ªå¹³å°è‡ªå·±çš„äº‹æƒ…äº†ã€‚å°†äº‹åŠ¡ç®¡ç†è¡Œä¸ºæŠ½è±¡å‡ºæ¥æ–¹ä¾¿ç¨‹åºæ‰©å±•ã€‚</p><p><code>PlatformTransactionManager</code>æ¥å£ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlatformTransactionManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å¾—äº‹åŠ¡</span></span><br><span class="line">    <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(<span class="meta">@Nullable</span> TransactionDefinition var1)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">    <span class="comment">//æäº¤äº‹åŠ¡</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus var1)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">    <span class="comment">//å›æ»šäº‹åŠ¡</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus var1)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TransactionDefinition-äº‹åŠ¡å±æ€§å®šä¹‰"><a href="#TransactionDefinition-äº‹åŠ¡å±æ€§å®šä¹‰" class="headerlink" title="TransactionDefinition - äº‹åŠ¡å±æ€§å®šä¹‰"></a><code>TransactionDefinition</code> - äº‹åŠ¡å±æ€§å®šä¹‰</h3><p>äº‹åŠ¡ç®¡ç†å™¨æ¥å£ <code>PlatformTransactionManager</code> é€šè¿‡ <code>getTransaction(TransactionDefinition definition)</code> æ–¹æ³•æ¥å¾—åˆ°ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢çš„å‚æ•°æ˜¯ `TransactionDefinition</p><p>äº‹åŠ¡å±æ€§å¯ä»¥ç†è§£æˆäº‹åŠ¡çš„ä¸€äº›åŸºæœ¬é…ç½®ï¼Œæè¿°äº†äº‹åŠ¡ç­–ç•¥å¦‚ä½•åº”ç”¨åˆ°æ–¹æ³•ä¸Šã€‚</p><p>äº‹åŠ¡å±æ€§åŒ…å«äº† 5 ä¸ªæ–¹é¢ï¼š</p><ul><li>éš”ç¦»çº§åˆ«</li><li>ä¼ æ’­è¡Œä¸º</li><li>å›æ»šè§„åˆ™</li><li>æ˜¯å¦åªè¯»</li><li>äº‹åŠ¡è¶…æ—¶</li></ul><p><code>TransactionDefinition</code> æ¥å£ä¸­å®šä¹‰äº† 5 ä¸ªæ–¹æ³•ä»¥åŠä¸€äº›è¡¨ç¤ºäº‹åŠ¡å±æ€§çš„å¸¸é‡æ¯”å¦‚éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºç­‰ç­‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDefinition</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_REQUIRED = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_SUPPORTS = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_MANDATORY = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_REQUIRES_NEW = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_NOT_SUPPORTED = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_NEVER = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_NESTED = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_DEFAULT = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_READ_UNCOMMITTED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_READ_COMMITTED = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_REPEATABLE_READ = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_SERIALIZABLE = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">int</span> TIMEOUT_DEFAULT = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// è¿”å›äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºï¼Œé»˜è®¤å€¼ä¸º REQUIREDã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPropagationBehavior</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//è¿”å›äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œé»˜è®¤å€¼æ˜¯ DEFAULT</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getIsolationLevel</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// è¿”å›äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º-1ã€‚å¦‚æœè¶…è¿‡è¯¥æ—¶é—´é™åˆ¶ä½†äº‹åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™è‡ªåŠ¨å›æ»šäº‹åŠ¡ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getTimeout</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// è¿”å›æ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡ï¼Œé»˜è®¤å€¼ä¸º false</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isReadOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TransactionStatus-äº‹åŠ¡çŠ¶æ€"><a href="#TransactionStatus-äº‹åŠ¡çŠ¶æ€" class="headerlink" title="TransactionStatus - äº‹åŠ¡çŠ¶æ€"></a><code>TransactionStatus</code> - äº‹åŠ¡çŠ¶æ€</h3><p><code>TransactionStatus</code>æ¥å£ç”¨æ¥è®°å½•äº‹åŠ¡çš„çŠ¶æ€ï¼Œè¯¥æ¥å£å®šä¹‰äº†ä¸€ç»„æ–¹æ³•ï¼Œç”¨æ¥è·å–æˆ–åˆ¤æ–­äº‹åŠ¡çš„ç›¸åº”çŠ¶æ€ä¿¡æ¯ã€‚<code>PlatformTransactionManager.getTransaction()</code>æ–¹æ³•è¿”å›ä¸€ä¸ª <code>TransactionStatus</code> å¯¹è±¡ã€‚<code>TransactionStatus</code> æ¥å£å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionStatus</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isNewTransaction</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦æ˜¯æ–°çš„äº‹åŠ¡</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasSavepoint</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦æœ‰æ¢å¤ç‚¹</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRollbackOnly</span><span class="params">()</span></span>;  <span class="comment">// è®¾ç½®ä¸ºåªå›æ»š</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isRollbackOnly</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦ä¸ºåªå›æ»š</span></span><br><span class="line">    <span class="keyword">boolean</span> isCompleted; <span class="comment">// æ˜¯å¦å·²å®Œæˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº‹åŠ¡å±æ€§è¯¦è§£"><a href="#äº‹åŠ¡å±æ€§è¯¦è§£" class="headerlink" title="äº‹åŠ¡å±æ€§è¯¦è§£"></a>äº‹åŠ¡å±æ€§è¯¦è§£</h2><p><code>@Transactional</code>ä¸­åŒ…å«çš„äº‹åŠ¡å±æ€§å‚æ•°ã€‚</p><h3 id="äº‹åŠ¡ä¼ æ’­è¡Œä¸º"><a href="#äº‹åŠ¡ä¼ æ’­è¡Œä¸º" class="headerlink" title="äº‹åŠ¡ä¼ æ’­è¡Œä¸º"></a>äº‹åŠ¡ä¼ æ’­è¡Œä¸º</h3><p><strong>äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ˜¯ä¸ºäº†è§£å†³ä¸šåŠ¡å±‚æ–¹æ³•ä¹‹é—´äº’ç›¸è°ƒç”¨çš„äº‹åŠ¡é—®é¢˜ã€‚</strong></p><p>å½“äº‹åŠ¡æ–¹æ³•è¢«å¦ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå¿…é¡»æŒ‡å®šäº‹åŠ¡åº”è¯¥å¦‚ä½•ä¼ æ’­ã€‚ä¾‹å¦‚ï¼šæ–¹æ³•å¯èƒ½ç»§ç»­åœ¨ç°æœ‰äº‹åŠ¡ä¸­è¿è¡Œï¼Œä¹Ÿå¯èƒ½å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œå¹¶åœ¨è‡ªå·±çš„äº‹åŠ¡ä¸­è¿è¡Œã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œåœ¨ A ç±»çš„<code>aMethod()</code>ä¸­è°ƒç”¨äº† B ç±»çš„<code>bMethod()</code>ã€‚è¿™ä¸ªæ—¶å€™å°±æ¶‰åŠåˆ°ä¸šåŠ¡å±‚æ–¹æ³•ä¹‹é—´äº’ç›¸è°ƒç”¨çš„äº‹åŠ¡é—®é¢˜ã€‚å¦‚æœ<code>bMethod()</code>å‘ç”Ÿå¼‚å¸¸éœ€è¦å›æ»šï¼Œå¦‚ä½•é…ç½®äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ‰èƒ½è®©<code>aMethod()</code>ä¹Ÿè·Ÿç€å›æ»šå‘¢ï¼Ÿä¸‹é¢æ¥çœ‹ä¸€ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line">Class A &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    B b;</span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.xxx)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> aMethod &#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">        b.bMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line">Class B &#123;</span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.xxx)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> bMethod &#123;</span><br><span class="line">       <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>TransactionDefinition</code>å®šä¹‰ä¸­åŒ…æ‹¬äº†å¦‚ä¸‹å‡ ä¸ªè¡¨ç¤ºä¼ æ’­è¡Œä¸ºçš„å¸¸é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDefinition</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_REQUIRED = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_SUPPORTS = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_MANDATORY = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_REQUIRES_NEW = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_NOT_SUPPORTED = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_NEVER = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_NESTED = <span class="number">6</span>;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼ŒSpring ç›¸åº”åœ°å®šä¹‰äº†ä¸€ä¸ªæšä¸¾ç±»ï¼š<code>Propagation</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.transaction.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Propagation</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚</span></span><br><span class="line">    REQUIRED(TransactionDefinition.PROPAGATION_REQUIRED),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚</span></span><br><span class="line">    SUPPORTS(TransactionDefinition.PROPAGATION_SUPPORTS),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    MANDATORY(TransactionDefinition.PROPAGATION_MANDATORY),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</span></span><br><span class="line">    REQUIRES_NEW(TransactionDefinition.PROPAGATION_REQUIRES_NEW),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</span></span><br><span class="line">    NOT_SUPPORTED(TransactionDefinition.PROPAGATION_NOT_SUPPORTED),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    NEVER(TransactionDefinition.PROPAGATION_NEVER),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œå°±åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚</span></span><br><span class="line">    NESTED(TransactionDefinition.PROPAGATION_NESTED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    Propagation(<span class="keyword">int</span> value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡ä¼ æ’­è¡Œä¸ºå¯èƒ½çš„å€¼å¦‚ä¸‹ï¼š</p><p>1.<code>TransactionDefinition.PROPAGATION_REQUIRED</code></p><p><code>@Transactional</code>æ³¨è§£é»˜è®¤ä½¿ç”¨çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºã€‚å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š</p><ul><li>å¦‚æœå¤–éƒ¨æ–¹æ³•æ²¡æœ‰å¼€å¯äº‹åŠ¡çš„è¯ï¼Œ<code>Propagation.REQUIRED</code>ä¿®é¥°çš„å†…éƒ¨æ–¹æ³•ä¼šæ–°å¼€å¯è‡ªå·±çš„äº‹åŠ¡ï¼Œä¸”å¼€å¯çš„äº‹åŠ¡ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ã€‚</li><li>å¦‚æœå¤–éƒ¨æ–¹æ³•å¼€å¯äº‹åŠ¡å¹¶ä¸”è¢«<code>Propagation.REQUIRED</code>çš„è¯ï¼Œæ‰€æœ‰<code>Propagation.REQUIRED</code>ä¿®é¥°çš„å†…éƒ¨æ–¹æ³•å’Œå¤–éƒ¨æ–¹æ³•å‡å±äºåŒä¸€äº‹åŠ¡ï¼Œåªè¦ä¸€ä¸ªæ–¹æ³•å›æ»šï¼Œæ•´ä¸ªäº‹åŠ¡å‡å›æ»šã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line">Class A &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    B b;</span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRED)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> aMethod &#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">        b.bMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line">Class B &#123;</span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRED)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> bMethod &#123;</span><br><span class="line">       <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸Šé¢çš„<code>aMethod()</code>å’Œ<code>bMethod()</code>ä½¿ç”¨çš„éƒ½æ˜¯<code>PROPAGATION_REQUIRED</code>ä¼ æ’­è¡Œä¸ºçš„è¯ï¼Œä¸¤è€…ä½¿ç”¨çš„å°±æ˜¯åŒä¸€ä¸ªäº‹åŠ¡ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªæ–¹æ³•å›æ»šï¼Œæ•´ä¸ªäº‹åŠ¡å‡å›æ»šã€‚</p><p>2.<code>TransactionDefinition.PROPAGATION_REQUIRES_NEW</code></p><p>åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸ç®¡å¤–éƒ¨æ–¹æ³•æ˜¯å¦å¼€å¯äº‹åŠ¡ï¼Œ<code>Propagation.REQUIRES_NEW</code>ä¿®é¥°çš„å†…éƒ¨æ–¹æ³•ä¼šæ–°å¼€å¯è‡ªå·±çš„äº‹åŠ¡ï¼Œä¸”å¼€å¯çš„äº‹åŠ¡ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line">Class A &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    B b;</span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRED)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> aMethod &#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">        b.bMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line">Class B &#123;</span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> bMethod &#123;</span><br><span class="line">       <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸Šé¢çš„<code>bMethod()</code>ä½¿ç”¨<code>PROPAGATION_REQUIRES_NEW</code>äº‹åŠ¡ä¼ æ’­è¡Œä¸ºä¿®é¥°ï¼Œ<code>aMethod()</code>è¿˜æ˜¯ç”¨<code>PROPAGATION_REQUIRED</code>ä¿®é¥°çš„è¯ã€‚å¦‚æœ<code>aMethod()</code>å‘ç”Ÿå¼‚å¸¸å›æ»šï¼Œ<code>bMethod()</code>ä¸ä¼šè·Ÿç€å›æ»šï¼Œå› ä¸º<code>bMethod()</code>å¼€å¯äº†ç‹¬ç«‹çš„äº‹åŠ¡ã€‚ä½†æ˜¯ï¼Œå¦‚æœ<code>bMethod()</code>æŠ›å‡ºäº†æœªè¢«æ•è·çš„å¼‚å¸¸å¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ»¡è¶³äº‹åŠ¡å›æ»šè§„åˆ™çš„è¯ï¼Œ<code>aMethod()</code>åŒæ ·ä¹Ÿä¼šå›æ»šï¼Œå› ä¸ºè¿™ä¸ªå¼‚å¸¸è¢«<code>aMethod()</code>çš„äº‹åŠ¡ç®¡ç†æœºåˆ¶æ£€æµ‹åˆ°äº†ã€‚</p><p>3.<code>TransactionDefinition.PROPAGATION_NESTED</code></p><p>å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œå°±åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±æ‰§è¡Œä¸<code>TransactionDefinition.PROPAGATION_REQUIRED</code>ç±»ä¼¼çš„æ“ä½œã€‚åµŒå¥—äº‹åŠ¡å›æ»šä¸å½±å“å¤–éƒ¨äº‹åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š</p><ul><li>åœ¨å¤–éƒ¨æ–¹æ³•å¼€å¯äº‹åŠ¡çš„æƒ…å†µä¸‹ï¼Œåœ¨å†…éƒ¨å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œä½œä¸ºåµŒå¥—äº‹åŠ¡å­˜åœ¨ã€‚</li><li>å¦‚æœå¤–éƒ¨æ–¹æ³•æ— äº‹åŠ¡ï¼Œåˆ™å•ç‹¬å¼€å¯ä¸€ä¸ªäº‹åŠ¡ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line">Class A &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    B b;</span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRED)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> aMethod &#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">        b.bMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line">Class B &#123;</span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.NESTED)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> bMethod &#123;</span><br><span class="line">       <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœ <code>bMethod()</code> å›æ»šçš„è¯ï¼Œ<code>aMethod()</code>ä¸ä¼šå›æ»šã€‚å¦‚æœ<code>aMethod()</code>å›æ»šçš„è¯ï¼Œ<code>bMethod()</code>ä¼šå›æ»šã€‚</p><p>4.<code>TransactionDefinition.PROPAGATION_MANDATORY</code><br>å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚è¿™ç§æ–¹å¼è¿˜æ˜¯èƒ½ä¿è¯å…¨éƒ¨å›æ»šçš„ï¼Œä¸‹é¢çš„ä¸‰ç§åˆ™ä¸ä¸€å®šäº†ï¼Œéœ€è¦çœ‹æƒ…å†µä½¿ç”¨ã€‚</p><p>5.<code>TransactionDefinition.PROPAGATION_SUPPORTS</code><br>å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚</p><p>6.<code>TransactionDefinition.PROPAGATION_NOT_SUPPORTED</code><br>ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</p><p>7.<code>TransactionDefinition.PROPAGATION_NEVER</code><br>ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p><h3 id="äº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«</h3><p><code>TransactionDefinition</code> æ¥å£ä¸­å®šä¹‰äº†äº”ä¸ªè¡¨ç¤ºéš”ç¦»çº§åˆ«çš„å¸¸é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">int</span> ISOLATION_DEFAULT = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_READ_UNCOMMITTED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_READ_COMMITTED = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_REPEATABLE_READ = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_SERIALIZABLE = <span class="number">8</span>;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œäº‹åŠ¡ä¼ æ’­è¡Œä¸ºä¸€æ ·ï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼ŒSpring ä¹Ÿç›¸åº”åœ°å®šä¹‰äº†ä¸€ä¸ªæšä¸¾ç±»ï¼š<code>Isolation</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Isolation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  DEFAULT(TransactionDefinition.ISOLATION_DEFAULT),</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è¯»æœªæäº¤</span></span><br><span class="line">  READ_UNCOMMITTED(TransactionDefinition.ISOLATION_READ_UNCOMMITTED),</span><br><span class="line">  <span class="comment">// è¯»å·²æäº¤</span></span><br><span class="line">  READ_COMMITTED(TransactionDefinition.ISOLATION_READ_COMMITTED),</span><br><span class="line">  <span class="comment">// å¯é‡å¤è¯»</span></span><br><span class="line">  REPEATABLE_READ(TransactionDefinition.ISOLATION_REPEATABLE_READ),</span><br><span class="line">  <span class="comment">// å¯ä¸²è¡Œ</span></span><br><span class="line">  SERIALIZABLE(TransactionDefinition.ISOLATION_SERIALIZABLE);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">  Isolation(<span class="keyword">int</span> value) &#123;</span><br><span class="line">    <span class="keyword">this</span>.value = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾æ¬¡å¯¹æ¯ä¸€ç§äº‹åŠ¡éš”ç¦»çº§åˆ«è¿›è¡Œä»‹ç»ï¼š</p><ul><li><code>TransactionDefinition.ISOLATION_DEFAULT</code>ï¼šä½¿ç”¨åç«¯æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼ŒMySQL é»˜è®¤é‡‡ç”¨çš„ <code>REPEATABLE_READ</code> éš”ç¦»çº§åˆ«ï¼ŒOracle é»˜è®¤é‡‡ç”¨çš„ <code>READ_COMMITTED</code> éš”ç¦»çº§åˆ«ã€‚</li><li><code>TransactionDefinition.ISOLATION_READ_UNCOMMITTED</code>ï¼šæœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œä½¿ç”¨è¿™ä¸ªéš”ç¦»çº§åˆ«å¾ˆå°‘ï¼Œå› ä¸ºå®ƒå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ã€‚</li><li><code>TransactionDefinition.ISOLATION_READ_COMMITTED</code>ï¼šå…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚</li><li><code>TransactionDefinition.ISOLATION_REPEATABLE_READ</code>ï¼šå¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚</li><li><code>TransactionDefinition.ISOLATION_SERIALIZABLE</code>ï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä» ACID çš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚ä½†æ˜¯è¿™å°†ä¸¥é‡å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ä¹Ÿä¸ä¼šç”¨åˆ°è¯¥çº§åˆ«ã€‚</li></ul><h3 id="äº‹åŠ¡è¶…æ—¶å±æ€§"><a href="#äº‹åŠ¡è¶…æ—¶å±æ€§" class="headerlink" title="äº‹åŠ¡è¶…æ—¶å±æ€§"></a>äº‹åŠ¡è¶…æ—¶å±æ€§</h3><p>æ‰€è°“äº‹åŠ¡è¶…æ—¶ï¼Œå°±æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡æ‰€å…è®¸æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¯¥æ—¶é—´é™åˆ¶ä½†äº‹åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™è‡ªåŠ¨å›æ»šäº‹åŠ¡ã€‚åœ¨ <code>TransactionDefinition</code> ä¸­ä»¥æ•´å‹çš„å€¼æ¥è¡¨ç¤ºè¶…æ—¶æ—¶é—´ï¼Œå…¶å•ä½æ˜¯ç§’ï¼Œé»˜è®¤å€¼ä¸º<code>-1</code>ï¼Œè¿™è¡¨ç¤ºäº‹åŠ¡çš„è¶…æ—¶æ—¶é—´å–å†³äºåº•å±‚äº‹åŠ¡ç³»ç»Ÿæˆ–è€…æ²¡æœ‰è¶…æ—¶æ—¶é—´ã€‚</p><h3 id="äº‹åŠ¡åªè¯»å±æ€§"><a href="#äº‹åŠ¡åªè¯»å±æ€§" class="headerlink" title="äº‹åŠ¡åªè¯»å±æ€§"></a>äº‹åŠ¡åªè¯»å±æ€§</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDefinition</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="comment">// è¿”å›æ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡ï¼Œé»˜è®¤å€¼ä¸º false</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isReadOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºåªæœ‰è¯»å–æ•°æ®æŸ¥è¯¢çš„äº‹åŠ¡ï¼Œå¯ä»¥æŒ‡å®šäº‹åŠ¡ç±»å‹ä¸º <code>readonly</code>ï¼Œå³åªè¯»äº‹åŠ¡ã€‚åªè¯»äº‹åŠ¡ä¸æ¶‰åŠæ•°æ®çš„ä¿®æ”¹ï¼Œæ•°æ®åº“ä¼šæä¾›ä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼Œé€‚åˆç”¨åœ¨æœ‰å¤šæ¡æ•°æ®åº“æŸ¥è¯¢æ“ä½œçš„æ–¹æ³•ä¸­ã€‚</p><p>ä¸ºä»€ä¹ˆæ•°æ®æŸ¥è¯¢æ“ä½œè¿˜è¦å¯ç”¨äº‹åŠ¡æ”¯æŒå‘¢ï¼Ÿæ‹¿Innodbä¸¾ä¾‹å­ï¼Œæ ¹æ®<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-autocommit-commit-rollback.html">å®˜ç½‘</a>æè¿°ï¼š</p><blockquote><p>MySQL é»˜è®¤å¯¹æ¯ä¸€ä¸ªæ–°å»ºç«‹çš„è¿æ¥éƒ½å¯ç”¨äº†<code>autocommit</code>æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œæ¯ä¸€ä¸ªå‘é€åˆ° MySQL æœåŠ¡å™¨çš„sqlè¯­å¥éƒ½ä¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„äº‹åŠ¡ä¸­è¿›è¡Œå¤„ç†ï¼Œæ‰§è¡Œç»“æŸåä¼šè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼Œå¹¶å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚</p></blockquote><p>ä½†æ˜¯ï¼Œå¦‚æœä½ ç»™æ–¹æ³•åŠ ä¸Šäº†<code>@Transactional</code>æ³¨è§£çš„è¯ï¼Œè¿™ä¸ªæ–¹æ³•æ‰§è¡Œçš„æ‰€æœ‰sqlä¼šè¢«æ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚å¦‚æœå£°æ˜äº†åªè¯»äº‹åŠ¡çš„è¯ï¼Œæ•°æ®åº“å°±ä¼šå»ä¼˜åŒ–å®ƒçš„æ‰§è¡Œï¼Œå¹¶ä¸ä¼šå¸¦æ¥å…¶ä»–çš„ä»€ä¹ˆæ”¶ç›Šã€‚</p><p>å¦‚æœä¸åŠ <code>@Transactional</code>ï¼Œæ¯æ¡sqlä¼šå¼€å¯ä¸€ä¸ªå•ç‹¬çš„äº‹åŠ¡ï¼Œä¸­é—´è¢«å…¶å®ƒäº‹åŠ¡æ”¹äº†æ•°æ®ï¼Œéƒ½ä¼šå®æ—¶è¯»å–åˆ°æœ€æ–°å€¼ã€‚</p><p>åˆ†äº«ä¸€ä¸‹å…³äºäº‹åŠ¡åªè¯»å±æ€§ï¼Œå…¶ä»–äººçš„è§£ç­”ï¼š</p><ul><li>å¦‚æœä½ ä¸€æ¬¡æ‰§è¡Œå•æ¡æŸ¥è¯¢è¯­å¥ï¼Œåˆ™æ²¡æœ‰å¿…è¦å¯ç”¨äº‹åŠ¡æ”¯æŒï¼Œæ•°æ®åº“é»˜è®¤æ”¯æŒ SQL æ‰§è¡ŒæœŸé—´çš„è¯»ä¸€è‡´æ€§ï¼›</li><li>å¦‚æœä½ ä¸€æ¬¡æ‰§è¡Œå¤šæ¡æŸ¥è¯¢è¯­å¥ï¼Œä¾‹å¦‚ç»Ÿè®¡æŸ¥è¯¢ï¼ŒæŠ¥è¡¨æŸ¥è¯¢ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¤šæ¡æŸ¥è¯¢ SQL å¿…é¡»ä¿è¯æ•´ä½“çš„è¯»ä¸€è‡´æ€§ï¼Œå¦åˆ™ï¼Œåœ¨å‰æ¡ SQL æŸ¥è¯¢ä¹‹åï¼Œåæ¡ SQL æŸ¥è¯¢ä¹‹å‰ï¼Œæ•°æ®è¢«å…¶ä»–ç”¨æˆ·æ”¹å˜ï¼Œåˆ™è¯¥æ¬¡æ•´ä½“çš„ç»Ÿè®¡æŸ¥è¯¢å°†ä¼šå‡ºç°è¯»æ•°æ®ä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œæ­¤æ—¶ï¼Œåº”è¯¥å¯ç”¨äº‹åŠ¡æ”¯æŒã€‚</li></ul><h3 id="äº‹åŠ¡å›æ»šè§„åˆ™"><a href="#äº‹åŠ¡å›æ»šè§„åˆ™" class="headerlink" title="äº‹åŠ¡å›æ»šè§„åˆ™"></a>äº‹åŠ¡å›æ»šè§„åˆ™</h3><p>è¿™äº›è§„åˆ™å®šä¹‰äº†å“ªäº›å¼‚å¸¸ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šè€Œå“ªäº›ä¸ä¼šã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œäº‹åŠ¡åªæœ‰é‡åˆ°è¿è¡ŒæœŸå¼‚å¸¸ï¼ˆ<code>RuntimeException</code> çš„å­ç±»ï¼‰æ—¶æ‰ä¼šå›æ»šï¼Œ<code>Error</code>ä¹Ÿä¼šå¯¼è‡´äº‹åŠ¡å›æ»šï¼Œä½†æ˜¯ï¼Œåœ¨é‡åˆ°æ£€æŸ¥å‹ï¼ˆCheckedï¼‰å¼‚å¸¸æ—¶ä¸ä¼šå›æ»šã€‚</p><p>å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å›æ»šç‰¹å®šçš„å¼‚å¸¸ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor= MyException.class)</span></span><br></pre></td></tr></table></figure><h2 id="Transactional-æ³¨è§£ä½¿ç”¨è¯¦è§£"><a href="#Transactional-æ³¨è§£ä½¿ç”¨è¯¦è§£" class="headerlink" title="@Transactional æ³¨è§£ä½¿ç”¨è¯¦è§£"></a><code>@Transactional</code> æ³¨è§£ä½¿ç”¨è¯¦è§£</h2><h3 id="Transactional-çš„ä½œç”¨èŒƒå›´"><a href="#Transactional-çš„ä½œç”¨èŒƒå›´" class="headerlink" title="@Transactional çš„ä½œç”¨èŒƒå›´"></a><code>@Transactional</code> çš„ä½œç”¨èŒƒå›´</h3><ol><li>æ–¹æ³•ï¼šæ¨èå°†æ³¨è§£ä½¿ç”¨äºæ–¹æ³•ä¸Šï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥æ³¨è§£åªèƒ½åº”ç”¨åˆ° <code>public</code> æ–¹æ³•ä¸Šï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚</li><li>ç±»ï¼šå¦‚æœè¿™ä¸ªæ³¨è§£ä½¿ç”¨åœ¨ç±»ä¸Šçš„è¯ï¼Œè¡¨æ˜è¯¥æ³¨è§£å¯¹è¯¥ç±»ä¸­æ‰€æœ‰çš„ <code>public</code> æ–¹æ³•éƒ½ç”Ÿæ•ˆã€‚</li><li>æ¥å£ï¼šä¸æ¨èåœ¨æ¥å£ä¸Šä½¿ç”¨ã€‚</li></ol><h3 id="Transactional-çš„å¸¸ç”¨é…ç½®å‚æ•°"><a href="#Transactional-çš„å¸¸ç”¨é…ç½®å‚æ•°" class="headerlink" title="@Transactional çš„å¸¸ç”¨é…ç½®å‚æ•°"></a><code>@Transactional</code> çš„å¸¸ç”¨é…ç½®å‚æ•°</h3><p><code>@Transactional</code>æ³¨è§£æºç å¦‚ä¸‹ï¼Œé‡Œé¢åŒ…å«äº†åŸºæœ¬äº‹åŠ¡å±æ€§çš„é…ç½®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Transactional &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AliasFor(&quot;transactionManager&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Propagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Isolation <span class="title">isolation</span><span class="params">()</span> <span class="keyword">default</span> Isolation.DEFAULT</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">timeout</span><span class="params">()</span> <span class="keyword">default</span> TransactionDefinition.TIMEOUT_DEFAULT</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">readOnly</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">Class&lt;? extends Throwable&gt;[] rollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">String[] rollbackForClassName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">Class&lt;? extends Throwable&gt;[] noRollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">String[] noRollbackForClassName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨é…ç½®å‚æ•°å³ï¼špropagationã€isolationã€timeoutã€readOnlyã€rollbackForï¼Œå…·ä½“å†…å®¹ä¸ŠèŠ‚å·²åˆ—å‡ºã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://javaguide.cn/system-design/framework/spring/spring-transaction.html">https://javaguide.cn/system-design/framework/spring/spring-transaction.html</a><br>[2] <a href="https://blog.csdn.net/ITcreater000/article/details/115338657">https://blog.csdn.net/ITcreater000/article/details/115338657</a><br>[3] <a href="https://www.cnblogs.com/rickiyang/p/13652664.html">https://www.cnblogs.com/rickiyang/p/13652664.html</a><br>[4] <a href="https://dl.acm.org/doi/10.1145/289.291">https://dl.acm.org/doi/10.1145/289.291</a><br>[5] <a href="https://juejin.cn/post/6860252224930070536">https://juejin.cn/post/6860252224930070536</a><br>[6] <a href="https://spongecaptain.cool/post/database/logicalandphicallog/">https://spongecaptain.cool/post/database/logicalandphicallog/</a><br>[7] <a href="https://www.jianshu.com/p/646961b93c7e">https://www.jianshu.com/p/646961b93c7e</a><br>[8] <a href="https://zhuanlan.zhihu.com/p/394388285">https://zhuanlan.zhihu.com/p/394388285</a><br>[9] <a href="https://blog.csdn.net/qq_24854607/article/details/114639318">https://blog.csdn.net/qq_24854607/article/details/114639318</a><br>[10] <a href="https://blog.csdn.net/m0_71777195/article/details/130842268">https://blog.csdn.net/m0_71777195/article/details/130842268</a><br>[11] <a href="https://www.cnblogs.com/f66666/articles/10993873.html">https://www.cnblogs.com/f66666/articles/10993873.html</a><br>[12] <a href="http://catkang.github.io/2021/10/30/mysql-undo.html">http://catkang.github.io/2021/10/30/mysql-undo.html</a><br>[13] <a href="http://catkang.github.io/2020/02/27/mysql-redo.html">http://catkang.github.io/2020/02/27/mysql-redo.html</a><br>[14] <a href="http://catkang.github.io/2018/09/19/concurrency-control.html">http://catkang.github.io/2018/09/19/concurrency-control.html</a><br>[15] <a href="https://catkang.github.io/2023/08/08/mysql-buffer-pool.html">https://catkang.github.io/2023/08/08/mysql-buffer-pool.html</a><br>[16] <a href="https://mariadb.com/kb/en/innodb-undo-log">https://mariadb.com/kb/en/innodb-undo-log</a><br>[17] <a href="https://javaguide.cn/system-design/framework/spring/spring-transaction.html">https://javaguide.cn/system-design/framework/spring/spring-transaction.html</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;è°ˆè®ºä¸€åˆ‡ä¹‹å‰ï¼Œä½¿ç”¨çš„æ•°æ®åº“ä¸€å®šè¦æ”¯æŒäº‹åŠ¡ï¼Œæœ¬æ–‡ä»¥MySQL InnoDBå­˜å‚¨å¼•æ“ä¸ºä¾‹ï¼Œä»æ•°æ®åº“äº‹åŠ¡åŸºæœ¬åŸç†å‡ºå‘ï¼Œç®€è¦è¯´æ˜äº‹åŠ¡ç›¸å…³çš„ä¸»è¦çŸ¥è¯†ï¼Œä»¥åŠå¦‚ä½•åœ¨Springé¡¹ç›®ä¸­ä½¿ç”¨ï¼Œå¯¹äºç»†èŠ‚çš„æè¿°å°‘ä¸”æ¨¡ç³Šï¼Œéœ€è¦ä¸æ–­å®Œå–„ã€‚&lt;/p&gt;
&lt;p&gt;ç›¸å…³å†…å®¹ï¼šInnoDBäº‹åŠ¡å®ç°ã€Springäº‹åŠ¡ä¼ æ’­æœºåˆ¶ç­‰ã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="Spring" scheme="http://silencezheng.top/tags/Spring/"/>
    
    <category term="MySQL" scheme="http://silencezheng.top/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Optionalä½¿ç”¨å…¥é—¨</title>
    <link href="http://silencezheng.top/2023/09/14/article122/"/>
    <id>http://silencezheng.top/2023/09/14/article122/</id>
    <published>2023-09-14T15:08:57.000Z</published>
    <updated>2023-09-14T15:11:44.556Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Optional æ˜¯ Java 8 å¼•è¿›çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼Œå¯ä»¥åŒ…å«æˆ–ä¸åŒ…å«éç©ºå€¼ã€‚</p><span id="more"></span><h2 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional</h2><p>Optionalçš„æœºåˆ¶ç±»ä¼¼äºå—æ£€å¼‚å¸¸ï¼Œå¼ºè¿«APIè°ƒç”¨è€…é¢å¯¹æ²¡æœ‰è¿”å›å€¼çš„ç°å®ï¼Œå› ä¸ºç¨‹åºç›´æ¥è¿”å› null å¾ˆå¯èƒ½å¯¼è‡´è°ƒç”¨ç«¯äº§ç”Ÿé”™è¯¯ï¼ˆç©ºæŒ‡é’ˆå¼‚å¸¸ï¼ï¼‰ã€‚</p><p>Optional æ˜¯ç”¨æ¥ä½œä¸ºæ–¹æ³•è¿”å›å€¼çš„ï¼Œç›®çš„æ˜¯æ¸…æ™°åœ°è¡¨è¾¾è¿”å›å€¼ä¸­æ²¡æœ‰ç»“æœçš„å¯èƒ½æ€§ã€‚</p><h2 id="å¸¸ç”¨æ–¹æ³•åŠè°ƒç”¨æ–¹å¼"><a href="#å¸¸ç”¨æ–¹æ³•åŠè°ƒç”¨æ–¹å¼" class="headerlink" title="å¸¸ç”¨æ–¹æ³•åŠè°ƒç”¨æ–¹å¼"></a>å¸¸ç”¨æ–¹æ³•åŠè°ƒç”¨æ–¹å¼</h2><ul><li><p><code>of(value)</code>ï¼šåˆ›å»ºä¸€ä¸ªåŒ…å«æŒ‡å®šéç©ºå€¼çš„ <code>Optional</code> å¯¹è±¡ã€‚</p></li><li><p><code>ofNullable(value)</code>ï¼šåˆ›å»ºä¸€ä¸ªå¯èƒ½ä¸ºç©ºçš„ <code>Optional</code> å¯¹è±¡ã€‚å¦‚æœä¼ å…¥çš„å€¼ä¸º <code>null</code>ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºçš„ <code>Optional</code>ã€‚</p></li><li><p><code>empty()</code>ï¼šåˆ›å»ºä¸€ä¸ªç©ºçš„ <code>Optional</code> å¯¹è±¡ã€‚</p></li><li><p><code>isPresent()</code>ï¼šæ£€æŸ¥ <code>Optional</code> å¯¹è±¡æ˜¯å¦åŒ…å«å€¼ã€‚</p></li><li><p><code>get()</code>ï¼šè·å– <code>Optional</code> å¯¹è±¡ä¸­çš„å€¼ã€‚åœ¨è°ƒç”¨ä¹‹å‰åº”å…ˆä½¿ç”¨ <code>isPresent()</code> è¿›è¡Œåˆ¤æ–­ã€‚</p></li></ul><p><code>Optional</code> æ”¯æŒæ–¹æ³•é“¾å¼è°ƒç”¨ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ç³»åˆ—æ“ä½œä¸­è¿›è¡Œç©ºå€¼æ£€æŸ¥å’Œè½¬æ¢ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;String&gt; optionalValue = Optional.of(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (optionalValue.isPresent()) &#123;</span><br><span class="line">    String value = optionalValue.get();</span><br><span class="line">    System.out.println(value); <span class="comment">// è¾“å‡ºï¼šHello</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Optional&lt;String&gt; nullableValue = Optional.ofNullable(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">String result = nullableValue.orElse(<span class="string">&quot;Default Value&quot;</span>);</span><br><span class="line">System.out.println(result); <span class="comment">// è¾“å‡ºï¼šDefault Value</span></span><br></pre></td></tr></table></figure><p>é™¤äº†å¸¸ç”¨æ–¹æ³•ï¼Œè¿˜æœ‰ä¸€äº›æ–¹æ³•å¯ä»¥å¯¹<code>Optional</code>å¯¹è±¡è¿›è¡Œå¿«æ·æ“ä½œï¼Œå¦‚ä¸Šé¢å‡ºç°çš„<code>orElse</code>ï¼Œä¸‹é¢ä»‹ç»å…¶ä¸­ä¸€äº›ã€‚</p><ul><li><p><code>orElse(T other)</code>ï¼šå¦‚æœåŒ…å«çš„å€¼å­˜åœ¨ï¼Œåˆ™è¿”å›è¯¥å€¼ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å›é»˜è®¤å€¼ <code>other</code>ã€‚æ— è®ºå€¼æ˜¯å¦å­˜åœ¨ï¼Œéƒ½ä¼šè¿›è¡Œè®¡ç®—ï¼Œå¹¶è¿”å›ç»“æœã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;String&gt; optionalValue = Optional.of(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">String value = optionalValue.orElse(<span class="string">&quot;Default Value&quot;</span>);</span><br><span class="line">System.out.println(value); <span class="comment">// è¾“å‡ºï¼šHello</span></span><br><span class="line"></span><br><span class="line">Optional&lt;String&gt; emptyOptional = Optional.empty();</span><br><span class="line">String defaultValue = emptyOptional.orElse(<span class="string">&quot;Default Value&quot;</span>);</span><br><span class="line">System.out.println(defaultValue); <span class="comment">// è¾“å‡ºï¼šDefault Value</span></span><br></pre></td></tr></table></figure></li><li><p><code>orElseGet(Supplier&lt;? extends T&gt; other)</code>ï¼šå¦‚æœåŒ…å«çš„å€¼å­˜åœ¨ï¼Œåˆ™è¿”å›è¯¥å€¼ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨æä¾›çš„ <code>Supplier</code> å‡½æ•°æ¥è®¡ç®—å¹¶è¿”å›å€¼ã€‚ä¸ <code>orElse()</code> ç±»ä¼¼ï¼Œä½†åœ¨å€¼ä¸å­˜åœ¨æ—¶ï¼Œ<code>Supplier</code> å‡½æ•°æ‰ä¼šè¢«è°ƒç”¨ã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;String&gt; optionalValue = Optional.of(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">String value = optionalValue.orElseGet(() -&gt; expensiveOperation());</span><br><span class="line">System.out.println(value); <span class="comment">// è¾“å‡ºï¼šHello</span></span><br><span class="line"></span><br><span class="line">Optional&lt;String&gt; emptyOptional = Optional.empty();</span><br><span class="line">String computedValue = emptyOptional.orElseGet(() -&gt; expensiveOperation());</span><br><span class="line">System.out.println(computedValue); <span class="comment">// è°ƒç”¨ expensiveOperation() æ–¹æ³•ï¼Œå¹¶è¾“å‡ºå…¶è¿”å›å€¼</span></span><br></pre></td></tr></table></figure></li><li><p><code>orElseThrow(Supplier&lt;? extends X&gt; exceptionSupplier)</code>ï¼šå¦‚æœåŒ…å«çš„å€¼å­˜åœ¨ï¼Œåˆ™è¿”å›è¯¥å€¼ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºæŒ‡å®šçš„å¼‚å¸¸ã€‚é€šè¿‡æä¾›ä¸€ä¸ªexceptionSupplieræ¥ç”Ÿæˆå¼‚å¸¸å¯¹è±¡ã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;String&gt; optionalValue = Optional.of(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">String value = optionalValue.orElseThrow(() -&gt; <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Value not found&quot;</span>));</span><br><span class="line">System.out.println(value); <span class="comment">// è¾“å‡ºï¼šHello</span></span><br><span class="line"></span><br><span class="line">Optional&lt;String&gt; emptyOptional = Optional.empty();</span><br><span class="line">String computedValue = emptyOptional.orElseThrow(() -&gt; <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Value not found&quot;</span>)); <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br></pre></td></tr></table></figure></li><li><p><code>ifPresent(Consumer&lt;? super T&gt; consumer)</code>ï¼šæ¥å—ä¸€ä¸ª Consumer å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶åœ¨åŒ…å«çš„å€¼å­˜åœ¨æ—¶æ‰§è¡Œè¯¥å‡½æ•°ã€‚è¯¥æ–¹æ³•æ— è¿”å›å€¼ã€‚</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;String&gt; optionalValue = Optional.of(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">optionalValue.ifPresent(value -&gt; System.out.println(<span class="string">&quot;Value is present: &quot;</span> + value)); <span class="comment">// è¾“å‡ºï¼šValue is present: Hello</span></span><br><span class="line"></span><br><span class="line">Optional&lt;String&gt; emptyOptional = Optional.empty();</span><br><span class="line">emptyOptional.ifPresent(value -&gt; System.out.println(<span class="string">&quot;Value is present: &quot;</span> + value)); <span class="comment">// ç”±äºå€¼ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä¸æ‰§è¡Œä»»ä½•æ“ä½œ</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><p>1ã€ä¸è¦ä½¿ç”¨<code>Optional</code>ä½œä¸ºJava Beanå®ä¾‹åŸŸçš„ç±»å‹<br>å³é¿å…ä»¥ä¸‹è¿™ç§ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AVOID</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    [access_modifier] [<span class="keyword">static</span>] [<span class="keyword">final</span>] Optional&lt;String&gt; zip;</span><br><span class="line">    [access_modifier] [<span class="keyword">static</span>] [<span class="keyword">final</span>] Optional&lt;String&gt; telephone = Optional.empty();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>å› ä¸º <code>Optional</code> æ²¡æœ‰å®ç°Serializableæ¥å£ï¼ˆä¸å¯åºåˆ—åŒ–ï¼‰</p><p>2ã€ä¸è¦æŠŠå®¹å™¨ç±»å‹åŒ…è£…åœ¨<code>Optional</code>ä¸­<br>å³é¿å…ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AVOID</span></span><br><span class="line"><span class="keyword">public</span> Optional&lt;List&lt;String&gt;&gt; fetchCartItems(<span class="keyword">long</span> id) &#123;</span><br><span class="line">    Cart cart = ... ;    </span><br><span class="line">    List&lt;String&gt; items = cart.getItems(); <span class="comment">// this may return null</span></span><br><span class="line">    <span class="keyword">return</span> Optional.ofNullable(items);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>å› ä¸ºå®¹å™¨ç±»éƒ½æœ‰è‡ªå·±ç©ºå€¼è®¾è®¡ï¼Œå¦‚ <code>Collections.emptyList() Collections.emptySet() Collections.emptyMap() Stream.empty()</code> ç­‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PREFER</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">fetchCartItems</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">    Cart cart = ... ;    </span><br><span class="line">    List&lt;String&gt; items = cart.getItems(); <span class="comment">// this may return null</span></span><br><span class="line">    <span class="keyword">return</span> items == <span class="keyword">null</span> ? Collections.emptyList() : items;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3ã€ä¸è¦ç»™<code>Optional</code>å¯¹è±¡èµ‹å€¼ null<br>é¿å…ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AVOID</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Optional&lt;Cart&gt; <span class="title">fetchCart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Optional&lt;Cart&gt; emptyCart = <span class="keyword">null</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>è€Œåº”è¯¥ç”¨ <code>Optional.empty()</code> è¡¨è¾¾ç©ºå€¼ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PREFER</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Optional&lt;Cart&gt; <span class="title">fetchCart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Optional&lt;Cart&gt; emptyCart = Optional.empty();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>4ã€å°½é‡ä½¿ç”¨<code>Optional</code>æä¾›çš„å¿«æ·APIé¿å…æ‰‹å†™æ¡ä»¶è¯­å¥<br>ä»£ç æ›´ç®€æ´ã€‚</p><p>5ã€ä½¿ç”¨ <code>equals</code> è€Œä¸æ˜¯ <code>==</code> æ¥æ¯”è¾ƒ <code>Optional</code> çš„å€¼<br><code>Optional</code> çš„ <code>equals</code> æ–¹æ³•å·²ç»å®ç°äº†å†…éƒ¨å€¼æ¯”è¾ƒã€‚</p><p>6ã€å¯¹äºå¯èƒ½æ˜¯ç©ºå€¼çš„å‡½æ•°è¿”å›ä½¿ç”¨<code>Optional</code><br>å¯¹äºè¯»å–å€¼ç±»å‹çš„å‡½æ•°ä½¿ç”¨æ˜¯å¾ˆå¥½çš„å®è·µã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html">https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html</a><br>[2] <a href="https://zhuanlan.zhihu.com/p/128481434">https://zhuanlan.zhihu.com/p/128481434</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;Optional æ˜¯ Java 8 å¼•è¿›çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼Œå¯ä»¥åŒ…å«æˆ–ä¸åŒ…å«éç©ºå€¼ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="Java" scheme="http://silencezheng.top/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>LombokåŸç†ç®€æ</title>
    <link href="http://silencezheng.top/2023/09/11/article121/"/>
    <id>http://silencezheng.top/2023/09/11/article121/</id>
    <published>2023-09-11T13:32:25.000Z</published>
    <updated>2023-09-11T13:36:03.780Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Lombokå®ç°åŸç†ç®€æã€‚<br><span id="more"></span></p><h2 id="JCPä¸JSR"><a href="#JCPä¸JSR" class="headerlink" title="JCPä¸JSR"></a>JCPä¸JSR</h2><p>JCPï¼ˆJava Community Processï¼‰æ˜¯ç®¡ç† Java ç”Ÿæ€ï¼ˆåŒ…æ‹¬ J2SEã€J2EE ç­‰ç­‰ï¼‰å‘å±•åŠæŒ‡å¯¼å’Œæ¨åŠ¨Javaå¹³å°å‘å±•çš„åˆä½œç»„ç»‡ï¼Œè€ŒJSRï¼ˆJava Specification Requestï¼‰åˆ™æ˜¯ç”±JCPæå‡ºçš„ä¸€ç§è§„èŒƒè¯·æ±‚ã€‚</p><blockquote><p>JCPæ˜¯ç”±Sun Microsystemsï¼ˆç°åœ¨æ˜¯Oracle Corporationï¼‰åˆ›å»ºçš„ä¸€ä¸ªç»„ç»‡ï¼Œè´Ÿè´£åˆ¶å®šå’Œç®¡ç†JavaæŠ€æœ¯çš„å‘å±•ã€‚å®ƒåŒ…æ‹¬äº†ä¸€ç³»åˆ—ä¸“å®¶ç»„å’Œå·¥ä½œç»„ï¼Œè¿™äº›ç»„ç»‡å’Œä¸ªäººå…±åŒåˆä½œåˆ¶å®šå’Œæ›´æ–°Javaè§„èŒƒã€‚</p><p>JSR æ˜¯ Java è§„èŒƒè¯·æ±‚ã€‚è¿™æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜æäº¤ç»™ PMO çš„æ–‡ä»¶ï¼Œä»¥æè®®å¼€å‘æ–°è§„èŒƒæˆ–å¯¹ç°æœ‰è§„èŒƒè¿›è¡Œé‡å¤§ä¿®è®¢ã€‚ JCP è®¡åˆ’ç›®å‰æ­£åœ¨å¼€å‘è®¸å¤š Java æŠ€æœ¯è§„èŒƒï¼ŒåŒ…æ‹¬ Javaâ„¢ Micro Edition (Java MEâ„¢)ã€Javaâ„¢ Platform Enterprise Edition (Java EEâ„¢) å’Œ Javaâ„¢ Standard Edition (Java SEâ„¢) çš„ä¸‹ä¸€ç‰ˆæœ¬ã€‚ JSR è¿˜æŒ‡ç”±è¿™äº›ææ¡ˆäº§ç”Ÿçš„è§„èŒƒå¼€å‘å·¥ä½œã€‚</p><p>JSRç»å†å¤šä¸ªé˜¶æ®µï¼ŒåŒ…æ‹¬è‰æ¡ˆã€ææ¡ˆã€å…¬å¼€è¯„è®ºã€ç»´æŠ¤å’Œæœ€ç»ˆå‘å¸ƒç­‰ã€‚</p><p>PMO å³ Program Management Officeï¼Œé¡¹ç›®ç®¡ç†åŠå…¬å®¤æ˜¯ Oracle å†…éƒ¨è´Ÿè´£ç›‘ç£ Java ç¤¾åŒºæµç¨‹å¹¶ç®¡ç†é¡¹ç›®æ—¥å¸¸è¿è¡Œçš„å°ç»„ã€‚è¯¥è§„èŒƒçš„å®é™…å¼€å‘æ˜¯åœ¨ä¸“å®¶ç»„å†…è¿›è¡Œçš„ã€‚</p></blockquote><p>JCPï¼š<a href="https://jcp.org/en/home/index">https://jcp.org/en/home/index</a></p><h2 id="JSR-000269"><a href="#JSR-000269" class="headerlink" title="JSR-000269"></a>JSR-000269</h2><p>JSR-000269ï¼ˆJSR-269ï¼‰çš„ç›®æ ‡æ˜¯å®šä¹‰å¹¶å®ç°Javaç¼–è¯‘æ—¶æ³¨è§£å¤„ç†å™¨çš„æ ‡å‡†APIï¼Œæˆ–ç§°ä¸ºå¯æ’æ‹”æ³¨è§£å¤„ç†ï¼ˆPluggable Annotation Processingï¼‰ï¼Œè¯¥JSRæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿåœ¨Javaæºä»£ç ç¼–è¯‘è¿‡ç¨‹ä¸­è®¿é—®å’Œå¤„ç†æ³¨è§£ï¼Œä»è€Œå®ç°æ›´é«˜çº§çš„è¯­ä¹‰æ•ˆæœå’Œè‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚</p><p>è¦å®Œå…¨çš„äº†è§£JSR-269çš„å‰å› åæœåŠæŠ€æœ¯ç»†èŠ‚ï¼Œä¸åº”è¯¥åœ¨æœ¬æ–‡ä¸­å¯»æ‰¾ç­”æ¡ˆï¼Œæœ¬æ–‡ä»…é“ºå«ä¸€äº›å½¢è±¡åŒ–æè¿°Lombokå®ç°åŸç†æ‰€å¿…éœ€çš„å‰ç½®çŸ¥è¯†ã€‚æ€»ä¹‹ï¼Œé€šè¿‡JSR-269çš„å®ç°ï¼Œå¼€å‘äººå‘˜å¯ä»¥åˆ©ç”¨ç¼–è¯‘æ—¶æ³¨è§£å¤„ç†å™¨çš„èƒ½åŠ›ï¼Œä»¥ä¸€ç§æ ‡å‡†åŒ–å’Œå¯æ‰©å±•çš„æ–¹å¼å¯¹æºä»£ç è¿›è¡Œè‡ªåŠ¨åŒ–å¤„ç†ã€‚è¿™ç§å¤„ç†åŒ…æ‹¬ç”Ÿæˆé¢å¤–çš„ä»£ç ã€è¿›è¡Œé™æ€åˆ†æã€éªŒè¯çº¦æŸæ¡ä»¶ç­‰ã€‚</p><p>JSR-000269çš„åŸå§‹æå‡ºç¬¬ä¸€èŠ‚å¦‚ä¸‹ï¼š</p><blockquote><p>J2SE 1.5å¼•å…¥äº†ä¸€ç§æ–°çš„Javaè¯­è¨€æœºåˆ¶â€œæ³¨è§£â€ï¼Œå…è®¸ä½¿ç”¨æ³¨è§£ç±»å‹å¯¹ç±»ã€å­—æ®µå’Œæ–¹æ³•è¿›è¡Œæ³¨è§£ã€‚è¿™äº›æ³¨è§£é€šå¸¸ç”±ç¼–è¯‘æ—¶å·¥å…·æˆ–è¿è¡Œæ—¶åº“æ¥å¤„ç†ï¼Œä»¥å®ç°æ–°çš„è¯­ä¹‰æ•ˆæœã€‚ä¸ºäº†æ”¯æŒç¼–è¯‘æ—¶çš„æ³¨è§£å¤„ç†ï¼Œè¿™ä¸ªJSRå°†å®šä¹‰APIï¼Œå…è®¸ä½¿ç”¨æ ‡å‡†å¯æ’æ‹”çš„APIåˆ›å»ºæ³¨è§£å¤„ç†å™¨ã€‚è¿™å°†ç®€åŒ–åˆ›å»ºæ³¨è§£å¤„ç†å™¨çš„ä»»åŠ¡ï¼Œå¹¶ä¸”è¿˜å¯ä»¥è‡ªåŠ¨å‘ç°é€‚ç”¨äºç»™å®šæºæ–‡ä»¶çš„åˆé€‚çš„æ³¨è§£å¤„ç†å™¨ã€‚</p><p>è¯¥è§„èŒƒå°†åŒ…æ‹¬è‡³å°‘ä¸¤ä¸ªéƒ¨åˆ†ï¼šä¸€ä¸ªéƒ¨åˆ†æ˜¯å¯¹Javaç¼–ç¨‹è¯­è¨€è¿›è¡Œå»ºæ¨¡çš„APIéƒ¨åˆ†ï¼Œå¦ä¸€ä¸ªéƒ¨åˆ†ç”¨äºå£°æ˜æ³¨è§£å¤„ç†å™¨å¹¶æ§åˆ¶å®ƒä»¬çš„è¿è¡Œæ–¹å¼ã€‚ç”±äºæ³¨è§£æ˜¯æ”¾ç½®åœ¨ç¨‹åºå…ƒç´ ä¸Šçš„ï¼Œæ³¨è§£å¤„ç†æ¡†æ¶éœ€è¦åæ˜ ç¨‹åºç»“æ„ã€‚æ³¨è§£å¤„ç†å™¨å°†èƒ½å¤ŸæŒ‡å®šå®ƒä»¬å¤„ç†çš„æ³¨è§£ï¼Œå¹¶ä¸”å¤šä¸ªå¤„ç†å™¨å°†èƒ½å¤Ÿåˆä½œè¿è¡Œã€‚</p><p>å¤„ç†å™¨å’Œç¨‹åºç»“æ„APIå¯ä»¥åœ¨ç¼–è¯‘æ—¶è®¿é—®ï¼›å³æ­¤åŠŸèƒ½è¡¥å……äº†æ ¸å¿ƒåå°„æ”¯æŒè¯»å–æ³¨è§£çš„èƒ½åŠ›ã€‚</p></blockquote><h2 id="Lombokä»£ç æ³¨å…¥åŸç†"><a href="#Lombokä»£ç æ³¨å…¥åŸç†" class="headerlink" title="Lombokä»£ç æ³¨å…¥åŸç†"></a>Lombokä»£ç æ³¨å…¥åŸç†</h2><p>Lombokä½¿ç”¨äº†JSR-269çš„APIï¼Œå³<code>javax.annotation.processing</code>ä¸‹çš„ä¸€ç»„æ¥å£ï¼Œåœ¨ç¼–è¯‘æœŸæ—¶æŠŠ Lombok çš„æ³¨è§£ä»£ç ï¼Œè½¬æ¢ä¸ºå¸¸è§„çš„ Java â½…æ³•â½½å®ç°æ³¨â¼Šã€‚</p><p>ä½¿ç”¨ <code>javac</code> è¿›è¡Œç¼–è¯‘æ—¶ï¼ŒLombokç”Ÿæˆç›®æ ‡æ–¹æ³•çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é¦–å…ˆ <code>javac</code> å¯¹æºä»£ç è¿›è¡Œåˆ†æç”Ÿæˆä¸€æ£µæŠ½è±¡è¯­æ³•æ ‘(AST)</li><li>æ¥ç€åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨å®ç°äº† JSR-269 API çš„ lombok ç¨‹åº</li><li>æ¥ç€ç¼–è¯‘å™¨ä¼šè°ƒç”¨ lombok ç¨‹åºå¯¹ä¸Šé¢å¾—åˆ°çš„æŠ½è±¡è¯­æ³•æ ‘ AST è¿›è¡Œå¤„ç†ï¼Œæ‰¾åˆ°å…¶æ³¨è§£æ‰€åœ¨ç±»å¯¹åº”çš„è¯­æ³•æ ‘(AST)ï¼Œç„¶åä¿®æ”¹è¯¥è¯­æ³•æ ‘ï¼Œå¢åŠ æ³¨è§£å¯¹åº”çš„æ–¹æ³•æˆ–ä»£ç ç‰‡æ®µåˆ°å®šä¹‰çš„ç›¸åº”æ ‘èŠ‚ç‚¹</li><li><code>javac</code> ä½¿ç”¨ä¿®æ”¹åçš„æŠ½è±¡è¯­æ³•æ ‘ç”Ÿæˆæœ€ç»ˆçš„ class æ–‡ä»¶</li></ol><h2 id="åˆ©ç”¨269APIå®ç°Setteræ³¨è§£"><a href="#åˆ©ç”¨269APIå®ç°Setteræ³¨è§£" class="headerlink" title="åˆ©ç”¨269APIå®ç°Setteræ³¨è§£"></a>åˆ©ç”¨269APIå®ç°Setteræ³¨è§£</h2><p>1ã€â¾ƒå®šä¹‰æ³¨è§£<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lombok.setter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.SOURCE)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MySetter &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2ã€è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨<br>æ³¨è§£å¤„ç†å™¨æ˜¯ä»£ç ç”Ÿæˆçš„æ ¸å¿ƒï¼Œå¯¹è¯­æ³•æ ‘çš„æ“ä½œéœ€è¦ä½¿ç”¨è‡ªå·±JDKçš„<code>tools.jar</code>ï¼Œæ¶‰åŠåˆ°çš„æ ¸å¿ƒåº“ä¸»è¦ä¸º<code>com.sun.tools.javac</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="keyword">package</span> lombok.setter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.source.tree.Tree.Kind;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.api.JavacTrees;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.code.Flags;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.code.Type;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.processing.JavacProcessingEnvironment;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.tree.JCTree;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.tree.TreeMaker;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.tree.TreeTranslator;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.util.Context;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.util.ListBuffer;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.util.Name;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.util.Names;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.*;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.Element;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SupportedAnnotationTypes(&quot;lombok.setter.MySetter&quot;)</span></span><br><span class="line"><span class="meta">@SupportedSourceVersion(SourceVersion.RELEASE_8)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySetterProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> JavacTrees javacTrees; <span class="comment">// æä¾›äº†å¾…å¤„ç†çš„æŠ½è±¡è¯­æ³•æ ‘</span></span><br><span class="line">    <span class="keyword">private</span> TreeMaker treeMaker; <span class="comment">// å°è£…äº†åˆ›å»ºASTèŠ‚ç‚¹çš„ä¸€äº›æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> Names names; <span class="comment">// æä¾›äº†åˆ›å»ºæ ‡è¯†ç¬¦çš„æ–¹æ³•</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.init(processingEnv);</span><br><span class="line">        <span class="comment">// è·å–èµ„æº</span></span><br><span class="line">        <span class="keyword">this</span>.javacTrees = JavacTrees.instance(processingEnv);</span><br><span class="line">        Context context = ((JavacProcessingEnvironment) processingEnv).getContext();</span><br><span class="line">        <span class="keyword">this</span>.treeMaker = TreeMaker.instance(context);</span><br><span class="line">        <span class="keyword">this</span>.names = Names.instance(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–MySetteræ³¨è§£çš„å…ƒç´ </span></span><br><span class="line">        Set&lt;? extends Element&gt; elementsAnnotatedWith = roundEnv.getElementsAnnotatedWith(MySetter.class);</span><br><span class="line">        elementsAnnotatedWith.forEach(element -&gt; &#123;</span><br><span class="line">            JCTree tree = javacTrees.getTree(element);</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ TreeTranslator éå†æŠ½è±¡è¯­æ³•æ ‘</span></span><br><span class="line">            tree.accept(<span class="keyword">new</span> TreeTranslator() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitClassDef</span><span class="params">(JCTree.JCClassDecl jcClassDecl)</span> </span>&#123;</span><br><span class="line">                    List&lt;JCTree.JCVariableDecl&gt; jcVariableDeclList = List.nil();</span><br><span class="line">                    <span class="comment">// åœ¨æŠ½è±¡æ ‘ä¸­æ‰¾å‡ºæ‰€æœ‰å˜é‡</span></span><br><span class="line">                    <span class="keyword">for</span>(JCTree jcTree:jcClassDecl.defs) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(jcTree.getKind().equals(Kind.VARIABLE)) &#123;</span><br><span class="line">                            JCTree.JCVariableDecl jcVariableDecl = (JCTree.JCVariableDecl) jcTree;</span><br><span class="line">                            jcVariableDeclList = jcVariableDeclList.append(jcVariableDecl);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¯¹å˜é‡ç”Ÿæˆæ–¹æ³•</span></span><br><span class="line">                    jcVariableDeclList.forEach(jcVariableDecl -&gt; &#123;</span><br><span class="line">                        jcClassDecl.defs = jcClassDecl.defs.prepend(makeGetterMethodDecl(jcVariableDecl));</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="keyword">super</span>.visitClassDef(jcClassDecl);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JCTree.<span class="function">JCMethodDecl <span class="title">makeGetterMethodDecl</span><span class="params">(JCTree.JCVariableDecl jcVariableDecl)</span> </span>&#123;</span><br><span class="line">        ListBuffer&lt;JCTree.JCStatement&gt; statements = <span class="keyword">new</span> ListBuffer&lt;&gt;();</span><br><span class="line">        <span class="comment">// ç”Ÿæˆè¡¨è¾¾å¼ï¼Œä¾‹å¦‚ this.a = a;</span></span><br><span class="line">        JCTree.JCExpressionStatement aThis = makeAssignment(</span><br><span class="line">            treeMaker.Select(treeMaker.Ident(names.fromString(<span class="string">&quot;this&quot;</span>)), jcVariableDecl.getName()),</span><br><span class="line">            treeMaker.Ident(jcVariableDecl.getName())</span><br><span class="line">        );</span><br><span class="line">        statements.append(aThis);</span><br><span class="line">        JCTree.JCBlock block = treeMaker.Block(<span class="number">0</span>, statements.toList()); <span class="comment">// åˆ›å»ºä»£ç å—æŠ½è±¡è¯­æ³•æ ‘èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆå…¥å‚</span></span><br><span class="line">        JCTree.JCVariableDecl param = treeMaker.VarDef( <span class="comment">// åˆ›å»ºä¸€ä¸ªå˜é‡å®šä¹‰èŠ‚ç‚¹</span></span><br><span class="line">            treeMaker.Modifiers(Flags.PARAMETER), <span class="comment">// æŒ‡å®šä¿®é¥°ç¬¦ä¸ºå…¥å‚</span></span><br><span class="line">            jcVariableDecl.getName(), <span class="comment">// ä½¿ç”¨åŸå§‹å˜é‡å®šä¹‰èŠ‚ç‚¹çš„åç§°ä½œä¸ºå…¥å‚çš„åç§°</span></span><br><span class="line">            jcVariableDecl.vartype, <span class="comment">// ä½¿ç”¨åŸå§‹å˜é‡å®šä¹‰èŠ‚ç‚¹çš„å˜é‡ç±»å‹ä½œä¸ºå…¥å‚çš„ç±»å‹</span></span><br><span class="line">            <span class="keyword">null</span> <span class="comment">// è¡¨ç¤ºå…¥å‚æ²¡æœ‰åˆå§‹å€¼</span></span><br><span class="line">        );</span><br><span class="line">        List&lt;JCTree.JCVariableDecl&gt; parameters = List.of(param);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆè¿”å›å¯¹è±¡</span></span><br><span class="line">        JCTree.JCExpression methodType = treeMaker.Type(</span><br><span class="line">            <span class="keyword">new</span> Type.JCVoidType()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»“åˆå†…å®¹ç”Ÿæˆæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> treeMaker.MethodDef(</span><br><span class="line">            treeMaker.Modifiers(Flags.PUBLIC),</span><br><span class="line">            getNewMethodName(jcVariableDecl.getName()),</span><br><span class="line">            methodType, List.nil(), parameters, List.nil(), block, <span class="keyword">null</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Name <span class="title">getNewMethodName</span><span class="params">(Name name)</span> </span>&#123;</span><br><span class="line">        String s = name.toString();</span><br><span class="line">        <span class="comment">// é©¼å³°å‘½åæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> names.fromString(</span><br><span class="line">            <span class="string">&quot;set&quot;</span> + s.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + s.substring(<span class="number">1</span>, name.length())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JCTree.<span class="function">JCExpressionStatement <span class="title">makeAssignment</span><span class="params">(JCTree.JCExpression lhs, JCTree.JCExpression rhs)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç”Ÿæˆèµ‹å€¼è¯­å¥çš„æŠ½è±¡è¯­æ³•æ ‘èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">return</span> treeMaker.Exec(</span><br><span class="line">            treeMaker.Assign(</span><br><span class="line">                lhs, <span class="comment">// left-hand side</span></span><br><span class="line">                rhs  <span class="comment">// right-hand side</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3ã€ç¼–è¯‘æ³¨è§£å¤„ç†å™¨<br>ä¹‹åæ‰€æœ‰æ“ä½œéƒ½åœ¨MySetterçš„ç›®å½•ä¸‹è¿›è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -cp /path/to/tools.jar MySetter* -d .</span><br></pre></td></tr></table></figure><p>4ã€ç¼–å†™å’Œç¼–è¯‘ç›®æ ‡ç±»<br>ç›®æ ‡ç±»ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MySetter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMySetter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Integer intt;</span><br><span class="line">    <span class="keyword">public</span> String strr;</span><br><span class="line">    <span class="keyword">public</span> Byte bytee;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç”¨è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨ç¼–è¯‘ç›®æ ‡ç±»ï¼š<code>javac -processor  lombok.setter.MySetterProcessor TestMySetter.java</code></p><p>ç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMySetter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Integer intt;</span><br><span class="line">    <span class="keyword">public</span> String strr;</span><br><span class="line">    <span class="keyword">public</span> Byte bytee;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBytee</span><span class="params">(Byte var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bytee = var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStrr</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.strr = var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntt</span><span class="params">(Integer var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.intt = var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestMySetter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Lombokæ’ä»¶"><a href="#Lombokæ’ä»¶" class="headerlink" title="Lombokæ’ä»¶"></a>Lombokæ’ä»¶</h2><p>å‰é¢å½¢è±¡åŒ–çš„è®²è¿°äº†Lombokçš„ä»£ç ç”ŸæˆåŸç†ï¼Œä½†è¿™äº›éƒ½å‘ç”Ÿåœ¨ç¼–è¯‘æœŸï¼Œä»£ç ç¼–è¾‘å™¨å¦‚ä½•è·å–åˆ°è¿™äº›ä¿¡æ¯å¹¶æå‰åº”ç”¨åˆ°ä»£ç æç¤ºä¸Šå‘¢ï¼ŸLombokç»™ä¸»æµé›†æˆå¼€å‘ç¯å¢ƒç¼–å†™äº†Lombokæ’ä»¶ï¼Œåœ¨ä½¿ç”¨Lombokçš„è¿‡ç¨‹ä¸­ä¸éœ€è¦ç¼–è¯‘å³å¯å®ç°ä»£ç æç¤ºå’Œä»£ç è¡¥å…¨ï¼Œç›¸å…³æºç éƒ½å…¬å¼€åœ¨GitHubä¸Šï¼ˆè§[9]ï¼‰ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ç ”ç©¶ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://developer.aliyun.com/article/1081626">https://developer.aliyun.com/article/1081626</a><br>[2] <a href="https://blog.csdn.net/shouchenchuan5253/article/details/111658356">https://blog.csdn.net/shouchenchuan5253/article/details/111658356</a><br>[3] <a href="https://blog.csdn.net/weixin_43983762/article/details/105867398">https://blog.csdn.net/weixin_43983762/article/details/105867398</a><br>[4] <a href="https://juejin.cn/post/7103011031672176677">https://juejin.cn/post/7103011031672176677</a><br>[5] <a href="https://jcp.org/en/jsr/detail?id=269">https://jcp.org/en/jsr/detail?id=269</a><br>[6] <a href="https://jcp.org/aboutJava/communityprocess/mrel/jsr269/index6.html">https://jcp.org/aboutJava/communityprocess/mrel/jsr269/index6.html</a><br>[7] <a href="https://projectlombok.org/">https://projectlombok.org/</a><br>[8] <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/apt/GettingStarted.html">https://docs.oracle.com/javase/7/docs/technotes/guides/apt/GettingStarted.html</a><br>[9] <a href="https://github.com/projectlombok/lombok">https://github.com/projectlombok/lombok</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;Lombokå®ç°åŸç†ç®€æã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="Java" scheme="http://silencezheng.top/tags/Java/"/>
    
    <category term="Lombok" scheme="http://silencezheng.top/tags/Lombok/"/>
    
  </entry>
  
  <entry>
    <title>Lombokä¹‹@Builderç¢ç¢å¿µ</title>
    <link href="http://silencezheng.top/2023/09/10/article120/"/>
    <id>http://silencezheng.top/2023/09/10/article120/</id>
    <published>2023-09-10T12:23:30.000Z</published>
    <updated>2023-09-10T12:24:14.625Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Lombok@Builderå®ç°é“¾å¼æ„å»ºçš„å¼Šç—…åŠæ›¿ä»£æ–¹æ¡ˆã€‚<br><span id="more"></span></p><h2 id="Builderçš„å¼Šç—…"><a href="#Builderçš„å¼Šç—…" class="headerlink" title="@Builderçš„å¼Šç—…"></a>@Builderçš„å¼Šç—…</h2><h3 id="å­˜åœ¨ç»§æ‰¿å…³ç³»æ—¶ååˆ†å¤æ‚"><a href="#å­˜åœ¨ç»§æ‰¿å…³ç³»æ—¶ååˆ†å¤æ‚" class="headerlink" title="å­˜åœ¨ç»§æ‰¿å…³ç³»æ—¶ååˆ†å¤æ‚"></a>å­˜åœ¨ç»§æ‰¿å…³ç³»æ—¶ååˆ†å¤æ‚</h3><p>é”™è¯¯ç”¨æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String parentName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> parentAge;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String childName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> childAge;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ¥é”™ï¼šImplicit super constructor Parent() is undefined. Must explicitly invoke another constructor</span></span><br></pre></td></tr></table></figure></p><p>æ­£ç¡®ç”¨æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String parentName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> parentAge;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String childName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> childAge;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Child</span><span class="params">(String parentName, <span class="keyword">int</span> parentAge, String childName, <span class="keyword">int</span> childAge)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parentName, parentAge);</span><br><span class="line">        <span class="keyword">this</span>.childName = childName;</span><br><span class="line">        <span class="keyword">this</span>.childAge = childAge;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">Child child = Child.builder()</span><br><span class="line">  .parentName(<span class="string">&quot;Andrea&quot;</span>)</span><br><span class="line">  .parentAge(<span class="number">38</span>)</span><br><span class="line">  .childName(<span class="string">&quot;Emma&quot;</span>)</span><br><span class="line">  .childAge(<span class="number">6</span>)</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure></p><p>ä½†å¦‚æœçˆ¶ç±»ä½¿ç”¨äº†@Builderæ³¨è§£å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String parentName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> parentAge;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ç”¨åŸå­ç±»ä¼šæŠ¥é”™ï¼š<code>Childä¸­çš„builder()æ— æ³•è¦†ç›–Parentä¸­çš„builder()</code>ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹å­ç±»ä¸ºå¦‚ä¸‹å½¢å¼è§£å†³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String childName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> childAge;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Builder(builderMethodName = &quot;childBuilder&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Child</span><span class="params">(String parentName, <span class="keyword">int</span> parentAge, String childName, <span class="keyword">int</span> childAge)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parentName, parentAge);</span><br><span class="line">        <span class="keyword">this</span>.childName = childName;</span><br><span class="line">        <span class="keyword">this</span>.childAge = childAge;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†åœ¨é“¾å¼æ„å»ºå­ç±»å¯¹è±¡æ—¶ï¼Œå°±éœ€è¦è°ƒç”¨<code>Child.childBuilder()</code>äº†ã€‚å³ä¾¿å¦‚æ­¤ï¼Œåœ¨ç»§æ‰¿å±‚çº§å¤šæ—¶ä¹Ÿååˆ†ç¹çã€‚</p><p>åœ¨Lombok1.18ä¸­ï¼Œæä¾›äº†@SuperBuilderæ³¨è§£ï¼Œå¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String parentName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> parentAge;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String childName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> childAge;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="ä¸å¯ä¸-DataåŒæ—¶ä½¿ç”¨"><a href="#ä¸å¯ä¸-DataåŒæ—¶ä½¿ç”¨" class="headerlink" title="ä¸å¯ä¸@DataåŒæ—¶ä½¿ç”¨"></a>ä¸å¯ä¸@DataåŒæ—¶ä½¿ç”¨</h3><p>å¾ˆå¤šæ¡†æ¶ä¼šä½¿ç”¨ç±»çš„æ— å‚æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡ï¼Œä½†æ˜¯å¦‚æœåŒæ—¶ä½¿â½¤@Dataå’Œ@Builderçš„è¯ï¼Œä¼šå¯¼è‡´ç±»çš„æ— å‚æ„é€ å‡½æ•°ç¼ºå¤±ã€‚</p><p>å¹¶ä¸”ï¼Œè¿™ç§æƒ…å†µå¹¶ä¸èƒ½é€šè¿‡æ‰‹åŠ¨æ·»åŠ æ— å‚æ„é€ å‡½æ•°æˆ–æ·»åŠ @NoArgsConstructorè§£å†³ã€‚</p><p>è¯¥é—®é¢˜åªèƒ½é€šè¿‡å¼•â¼Šæ³¨è§£@Tolerateæ¥è§£å†³ã€‚</p><p>LombokåŒæ—¶ä½¿â½¤@Dataå’Œ@Builderçš„æ—¶å€™ï¼Œå¦‚æœè¦â½£æˆâ½†å‚æ„é€ ï¼Œéœ€è¦åœ¨ä»£ç â¾¥â¾¯â¼¿åŠ¨å¼•â¼Šæ³¨è§£@Tolerateï¼Œè®©Lombokåœ¨â½£æˆç±»çš„æ—¶å€™ï¼Œå¯¹æŒ‡å®šçš„æ„é€ å‡½æ•°ä¸æ„ŸçŸ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer int1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Tolerate</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç”¨-Accessorsæ›¿ä»£-Builder"><a href="#ç”¨-Accessorsæ›¿ä»£-Builder" class="headerlink" title="ç”¨@Accessorsæ›¿ä»£@Builder"></a>ç”¨@Accessorsæ›¿ä»£@Builder</h2><p>åœ¨ä¸ºäº†é“¾å¼ç¼–ç¨‹è€Œä½¿ç”¨@Builderæ—¶ï¼Œå®ƒå¹¶éæœ€ä½³å®è·µã€‚@Builderä¼šé¢å¤–åˆ›å»ºå†…éƒ¨ç±»ï¼Œæ— æ³•ä¸@Dataå…¼å®¹ï¼Œä¸”å¤„ç†ç»§æ‰¿å…³ç³»ååˆ†å¤æ‚ã€‚</p><p>ä½¿ç”¨@Accessors(chain = true)å®ç°é“¾å¼ç¼–ç¨‹æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">APIResponse</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T payload;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Status status;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰ä»·ä»£ç </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">APIResponse</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T payload;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Status status;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getPayload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> APIResponse&lt;T&gt; <span class="title">setPayload</span><span class="params">(T payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.payload = payload;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Status <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> APIResponse&lt;T&gt; <span class="title">setStatus</span><span class="params">(Status status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="comment">// å‡è®¾Statusä¹Ÿä½¿ç”¨äº†@Accessors(chain = true)</span></span><br><span class="line">Status status = <span class="keyword">new</span> Status().setResponseCode(<span class="string">&quot;RESPONSE_CODE_IDENTIFIER&quot;</span>).setDescription(<span class="string">&quot;Bla Bla Bla&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> APIResponse().setStatus(status);</span><br></pre></td></tr></table></figure></p><p>å®é™…è¿ç”¨æ—¶ï¼Œå¦‚æœå±æ€§è¾ƒå¤šï¼Œä¸”åˆ†ä¸ºå¿…ä¼ å±æ€§å’Œé€‰å¡«å±æ€§æ—¶ï¼Œå¯ä»¥å°†å¿…ä¼ å‚æ•°å®šä¹‰åœ¨æ„é€ æ–¹æ³•ä¸­ï¼ŒåŠ ä¸Š @Accessors æ³¨è§£ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°å¿…ä¼ å‚æ•°çš„ä¼ å…¥ï¼Œåˆå¯ä»¥å®ç°é€‰å¡«å‚æ•°çš„é“¾å¼è°ƒç”¨ã€‚</p><p>å‡è®¾ Student ç±»ï¼Œå®ƒçš„ å­¦ç”ŸIDå’Œå¹´çº§å’Œç­çº§æ˜¯å¿…å¡«çš„ï¼Œå§“åã€æ€§åˆ«ã€ä½å€æ˜¯é€‰å¡«çš„ï¼Œé‚£ä¹ˆç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰å¿…ä¼ å±æ€§ï¼Œä½¿ç”¨ final ä¿®é¥°ï¼Œä¸æä¾› setter æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> studentId; <span class="comment">// å­¦ç”ŸID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> grade; <span class="comment">// å¹´çº§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> classNum; <span class="comment">// ç­çº§</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰é€‰å¡«å±æ€§ï¼Œæä¾› setter æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> String name; <span class="comment">// å§“å</span></span><br><span class="line">    <span class="keyword">private</span> String gender; <span class="comment">// æ€§åˆ«</span></span><br><span class="line">    <span class="keyword">private</span> String address; <span class="comment">// ä½å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰æ„é€ æ–¹æ³•ï¼Œæ¥æ”¶å¿…ä¼ å‚æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(<span class="keyword">int</span> studentId, <span class="keyword">int</span> grade, <span class="keyword">int</span> classNum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.studentId = studentId;</span><br><span class="line">        <span class="keyword">this</span>.grade = grade;</span><br><span class="line">        <span class="keyword">this</span>.classNum = classNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœç•¥ getter å’Œ setter æ–¹æ³•</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">Student student = <span class="keyword">new</span> Student(<span class="number">1001</span>, <span class="number">3</span>, <span class="number">8</span>) <span class="comment">// åˆ›å»ºä¸€ä¸ªå­¦ç”Ÿå¯¹è±¡ï¼Œä¼ å…¥å¿…ä¼ å‚æ•°</span></span><br><span class="line">        .setName(<span class="string">&quot;å¼ ä¸‰&quot;</span>) <span class="comment">// è®¾ç½®å§“å</span></span><br><span class="line">        .setGender(<span class="string">&quot;ç”·&quot;</span>) <span class="comment">// è®¾ç½®æ€§åˆ«</span></span><br><span class="line">        .setAddress(<span class="string">&quot;åŒ—äº¬å¸‚æœé˜³åŒº&quot;</span>); <span class="comment">// è®¾ç½®ä½å€</span></span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://www.baeldung.com/lombok-builder-inheritance">https://www.baeldung.com/lombok-builder-inheritance</a><br>[2] <a href="https://mp.weixin.qq.com/s?__biz=MzIzOTU0NTQ0MA%3D%3D&amp;mid=2247534735&amp;idx=1&amp;sn=c6363bff49edbe8b03b5789d2f5b18b9&amp;chksm=e92a7580de5dfc967aaaa7d696a95a7361c4188fe8a626037f51cb70c53466f9ee78efef369d&amp;scene=262&amp;from=industrynews">https://mp.weixin.qq.com/s?__biz=MzIzOTU0NTQ0MA%3D%3D&amp;mid=2247534735&amp;idx=1&amp;sn=c6363bff49edbe8b03b5789d2f5b18b9&amp;chksm=e92a7580de5dfc967aaaa7d696a95a7361c4188fe8a626037f51cb70c53466f9ee78efef369d&amp;scene=262&amp;from=industrynews</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;Lombok@Builderå®ç°é“¾å¼æ„å»ºçš„å¼Šç—…åŠæ›¿ä»£æ–¹æ¡ˆã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="Java" scheme="http://silencezheng.top/tags/Java/"/>
    
    <category term="Lombok" scheme="http://silencezheng.top/tags/Lombok/"/>
    
  </entry>
  
  <entry>
    <title>åŒ¿åå†…éƒ¨ç±»</title>
    <link href="http://silencezheng.top/2023/09/02/article119/"/>
    <id>http://silencezheng.top/2023/09/02/article119/</id>
    <published>2023-09-02T10:10:40.000Z</published>
    <updated>2023-09-02T10:11:20.145Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Javaä¸­çš„åŒ¿åç±»ï¼ŒJava8åŠä»¥åã€‚</p><p>æ¶‰åŠæ¦‚å¿µåŒ…æ‹¬ï¼š<strong>ç­‰æ•ˆ<code>final</code></strong>ï¼Œæˆå‘˜ï¼Œå˜é‡ï¼Œä½œç”¨åŸŸã€‚<br><span id="more"></span></p><h2 id="åŒ¿åå†…éƒ¨ç±»-Anonymous-Classes"><a href="#åŒ¿åå†…éƒ¨ç±»-Anonymous-Classes" class="headerlink" title="åŒ¿åå†…éƒ¨ç±»(Anonymous Classes)"></a>åŒ¿åå†…éƒ¨ç±»(Anonymous Classes)</h2><p>åŒ¿åå†…éƒ¨ç±»ï¼ˆåŒ¿åç±»ï¼‰æ˜¯ä¸€ç§åœ¨Javaä¸­ç”¨äºåˆ›å»ºä¸´æ—¶æ€§ã€ä¸€æ¬¡æ€§ä½¿ç”¨çš„ç±»çš„ç‰¹æ®Šè¯­æ³•ç»“æ„ã€‚å®ƒå¯ä»¥ç”¨æ¥å®ç°æ¥å£ã€ç»§æ‰¿ç±»æˆ–åˆ›å»ºä¸´æ—¶å¯¹è±¡ç­‰æ“ä½œï¼Œé€šå¸¸åœ¨éœ€è¦ä¸€ä¸ªç±»çš„å®ä¾‹ï¼Œä½†åˆä¸å¸Œæœ›å•ç‹¬ä¸ºä¹‹åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ç±»æ–‡ä»¶æ—¶ä½¿ç”¨ã€‚</p><p>åŒ¿åç±»å¯ä»¥ä½¿ä½ çš„ä»£ç æ›´åŠ ç®€æ´ï¼Œä½ å¯ä»¥åœ¨å®šä¹‰ä¸€ä¸ªç±»çš„åŒæ—¶å¯¹å…¶è¿›è¡Œå®ä¾‹åŒ–ã€‚å®ƒä¸å±€éƒ¨ç±»å¾ˆç›¸ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒæ²¡æœ‰ç±»åï¼Œå¦‚æœæŸä¸ªå±€éƒ¨ç±»ä½ åªéœ€è¦ç”¨ä¸€æ¬¡ï¼Œå°±å¯ä»¥ä½¿ç”¨åŒ¿åç±»æ¥è¡¨è¾¾ã€‚</p><p>åŒ¿åç±»é€šå¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š</p><ol><li><p><strong>å®ç°æ¥å£ï¼š</strong> é€šè¿‡åŒ¿åç±»å®ç°ä¸€ä¸ªæ¥å£ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªæ¥å£çš„å®ä¾‹ã€‚</p></li><li><p><strong>ç»§æ‰¿ç±»ï¼š</strong> é€šè¿‡åŒ¿åç±»ç»§æ‰¿ä¸€ä¸ªç±»ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªå­ç±»çš„å®ä¾‹ã€‚</p></li><li><p><strong>åˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼š</strong> åœ¨ä¸€äº›ä¸´æ—¶éœ€è¦çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨åŒ¿åç±»æ¥åˆ›å»ºå¯¹è±¡ã€‚</p></li></ol><h2 id="åŒ¿åç±»ä¸å±€éƒ¨ç±»å¯¹æ¯”"><a href="#åŒ¿åç±»ä¸å±€éƒ¨ç±»å¯¹æ¯”" class="headerlink" title="åŒ¿åç±»ä¸å±€éƒ¨ç±»å¯¹æ¯”"></a>åŒ¿åç±»ä¸å±€éƒ¨ç±»å¯¹æ¯”</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldAnonymousClasses</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒ…å«ä¸¤ä¸ªæ–¹æ³•çš„HelloWorldæ¥å£</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">greet</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">greetSomeone</span><span class="params">(String someone)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1ã€å±€éƒ¨ç±»EnglishGreetingå®ç°äº†HelloWorldæ¥å£</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">EnglishGreeting</span> <span class="keyword">implements</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">            String name = <span class="string">&quot;world&quot;</span>;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">greet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                greetSomeone(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">greetSomeone</span><span class="params">(String someone)</span> </span>&#123;</span><br><span class="line">                name = someone;</span><br><span class="line">                System.out.println(<span class="string">&quot;Hello &quot;</span> + name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HelloWorld englishGreeting = <span class="keyword">new</span> EnglishGreeting();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2ã€åŒ¿åç±»å®ç°HelloWorldæ¥å£</span></span><br><span class="line">        HelloWorld frenchGreeting = <span class="keyword">new</span> HelloWorld() &#123;</span><br><span class="line">            String name = <span class="string">&quot;tout le monde&quot;</span>;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">greet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                greetSomeone(<span class="string">&quot;tout le monde&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">greetSomeone</span><span class="params">(String someone)</span> </span>&#123;</span><br><span class="line">                name = someone;</span><br><span class="line">                System.out.println(<span class="string">&quot;Salut &quot;</span> + name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3ã€åŒ¿åç±»å®ç°HelloWorldæ¥å£</span></span><br><span class="line">        HelloWorld spanishGreeting = <span class="keyword">new</span> HelloWorld() &#123;</span><br><span class="line">            String name = <span class="string">&quot;mundo&quot;</span>;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">greet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                greetSomeone(<span class="string">&quot;mundo&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">greetSomeone</span><span class="params">(String someone)</span> </span>&#123;</span><br><span class="line">                name = someone;</span><br><span class="line">                System.out.println(<span class="string">&quot;Hola, &quot;</span> + name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        englishGreeting.greet();</span><br><span class="line">        frenchGreeting.greetSomeone(<span class="string">&quot;Fred&quot;</span>);</span><br><span class="line">        spanishGreeting.greet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        HelloWorldAnonymousClasses myApp = <span class="keyword">new</span> HelloWorldAnonymousClasses();</span><br><span class="line">        myApp.sayHello();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¾“å‡ºï¼š</span></span><br><span class="line">        <span class="comment">// Hello world</span></span><br><span class="line">        <span class="comment">// Salut Fred</span></span><br><span class="line">        <span class="comment">// Hola, mundo</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ä¾‹ä¸­ç”¨å±€éƒ¨ç±»æ¥åˆå§‹åŒ–å˜é‡<code>englishGreeting</code>ï¼Œç”¨åŒ¿ç±»æ¥åˆå§‹åŒ–å˜é‡<code>frenchGreeting</code>å’Œ<code>spanishGreeting</code>ï¼Œä¸¤ç§å®ç°ä¹‹é—´æœ‰æ˜æ˜¾çš„åŒºåˆ«ï¼š</p><p>1ï¼‰å±€éƒ¨ç±»<code>EnglishGreeting</code>ç»§æ‰¿<code>HelloWorld</code>æ¥å£ï¼Œæœ‰è‡ªå·±çš„ç±»åï¼Œå®šä¹‰å®Œæˆä¹‹åéœ€è¦å†ç”¨newå…³é”®å­—å®ä¾‹åŒ–æ‰å¯ä»¥ä½¿ç”¨ï¼›</p><p>2ï¼‰<code>frenchGreetingã€spanishGreeting</code>åœ¨å®šä¹‰çš„æ—¶å€™å°±å®ä¾‹åŒ–äº†ï¼Œå®šä¹‰å®Œäº†å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼›</p><p>3ï¼‰<strong>åŒ¿åç±»æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼</strong>ï¼Œå› æ­¤åœ¨å®šä¹‰çš„æœ€åç”¨åˆ†å·â€;â€ç»“æŸã€‚</p><h2 id="åŒ¿åç±»çš„è¯­æ³•"><a href="#åŒ¿åç±»çš„è¯­æ³•" class="headerlink" title="åŒ¿åç±»çš„è¯­æ³•"></a>åŒ¿åç±»çš„è¯­æ³•</h2><p>åŒ¿åç±»è¡¨è¾¾å¼çš„é€šç”¨è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºåŒ¿åç±»å®ä¾‹</span></span><br><span class="line">SuperClassOrInterface obj = <span class="keyword">new</span> SuperClassOrInterface() &#123;</span><br><span class="line">    <span class="comment">// æˆå‘˜å˜é‡ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å—ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ–¹æ³•é‡å†™</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">returnType <span class="title">methodName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ–¹æ³•å®ç°</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„å…³é”®ç‚¹åŒ…æ‹¬ï¼š</p><ul><li><p><code>SuperClassOrInterface</code>ï¼šåŒ¿åç±»å¯ä»¥ç»§æ‰¿ä¸€ä¸ªç±»æˆ–å®ç°ä¸€ä¸ªæ¥å£ï¼Œè¿™ä¸ªéƒ¨åˆ†å°±æ˜¯ä½ è¦ç»§æ‰¿æˆ–å®ç°çš„ç±»æˆ–æ¥å£çš„ç±»å‹ã€‚</p></li><li><p>æˆå‘˜å˜é‡ï¼šå¦‚æœéœ€è¦ï¼Œåœ¨åŒ¿åç±»å†…éƒ¨å¯ä»¥å®šä¹‰æˆå‘˜å˜é‡ï¼Œå¯ä»¥åœ¨æ„é€ å™¨ã€åˆå§‹åŒ–å—ä»¥åŠæ–¹æ³•ä¸­ä½¿ç”¨ã€‚</p></li><li><p>åˆå§‹åŒ–å—ï¼šå¦‚æœéœ€è¦ï¼Œåœ¨åŒ¿åç±»å†…éƒ¨å¯ä»¥å®šä¹‰åˆå§‹åŒ–å—ï¼Œç”¨æ¥åˆå§‹åŒ–æˆå‘˜å˜é‡ã€‚</p></li><li><p>æ–¹æ³•é‡å†™ï¼šåŒ¿åç±»å¯ä»¥é‡å†™çˆ¶ç±»æˆ–æ¥å£ä¸­çš„æ–¹æ³•ã€‚</p></li><li><p><code>returnType</code>ï¼šé‡å†™æ–¹æ³•çš„è¿”å›ç±»å‹ã€‚</p></li><li><p><code>methodName()</code>ï¼šè¦é‡å†™çš„æ–¹æ³•åã€‚</p></li></ul><h2 id="åŒ¿åç±»å¯¹å±€éƒ¨å˜é‡çš„è®¿é—®è§„åˆ™ï¼ŒåŠå¯¹æˆå‘˜çš„å£°æ˜åŠè®¿é—®è§„åˆ™"><a href="#åŒ¿åç±»å¯¹å±€éƒ¨å˜é‡çš„è®¿é—®è§„åˆ™ï¼ŒåŠå¯¹æˆå‘˜çš„å£°æ˜åŠè®¿é—®è§„åˆ™" class="headerlink" title="åŒ¿åç±»å¯¹å±€éƒ¨å˜é‡çš„è®¿é—®è§„åˆ™ï¼ŒåŠå¯¹æˆå‘˜çš„å£°æ˜åŠè®¿é—®è§„åˆ™"></a>åŒ¿åç±»å¯¹å±€éƒ¨å˜é‡çš„è®¿é—®è§„åˆ™ï¼ŒåŠå¯¹æˆå‘˜çš„å£°æ˜åŠè®¿é—®è§„åˆ™</h2><p>ä¸å±€éƒ¨ç±»ä¸€æ ·ï¼ŒåŒ¿åç±»å¯ä»¥æ•è·å˜é‡ï¼Œå®ƒä»¬å¯¹å¤–éƒ¨åŸŸçš„å±€éƒ¨å˜é‡å…·æœ‰ç›¸åŒçš„è®¿é—®æƒé™ï¼š</p><ol><li>åŒ¿åç±»å¯ä»¥è®¿é—®å…¶å¤–éƒ¨ç±»çš„æˆå‘˜ã€‚</li><li>åŒ¿åç±»æ— æ³•è®¿é—®å…¶å¤–éƒ¨åŸŸå†…æœªå£°æ˜ä¸º<code>final</code>æˆ–å®é™…ä¸Šæœªå£°æ˜ä¸º<code>final</code>çš„<strong>å±€éƒ¨å˜é‡</strong>ã€‚</li><li>ä¸åµŒå¥—ç±»ä¸€æ ·ï¼ŒåŒ¿åç±»ä¸­çš„ç±»å‹ï¼ˆä¾‹å¦‚å˜é‡ï¼‰å£°æ˜ä¼šéšè—ï¼ˆ<strong>shadow</strong>ï¼‰å¤–éƒ¨åŸŸä¸­å…·æœ‰ç›¸åŒåç§°çš„ä»»ä½•å…¶ä»–å£°æ˜ã€‚</li></ol><p>åŒ¿åç±»å¯¹äºå…¶æˆå‘˜ä¹Ÿæœ‰ä¸å±€éƒ¨ç±»ç›¸åŒçš„é™åˆ¶ï¼š</p><ol><li>ä¸èƒ½åœ¨åŒ¿åç±»ä¸­å£°æ˜<strong>é™æ€åˆå§‹åŒ–å—</strong>æˆ–<strong>æˆå‘˜æ¥å£</strong>ã€‚</li><li>åŒ¿åç±»å¯ä»¥å…·æœ‰é™æ€æˆå‘˜ï¼Œå‰ææ˜¯å®ƒä»¬æ˜¯<strong>å¸¸é‡å˜é‡</strong>ã€‚</li></ol><p>åŒ¿åç±»ä¸­å¯ä»¥å£°æ˜ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>å­—æ®µ</li><li>é¢å¤–çš„æ–¹æ³•ï¼ˆå³ä½¿å®ƒä»¬ä¸å®ç°çˆ¶ç±»çš„ä»»ä½•æ–¹æ³•ï¼‰</li><li>å®ä¾‹åˆå§‹åŒ–å—ï¼ˆInstance initializersï¼‰</li><li>å±€éƒ¨ç±»ï¼ˆLocal classesï¼‰</li></ul><p>ä½†æ˜¯ï¼Œ<strong>åœ¨åŒ¿åç±»ä¸­ä¸èƒ½å£°æ˜æ„é€ å‡½æ•°</strong>ï¼ˆconstructorsï¼‰ã€‚</p><h2 id="åŒ¿åç±»è®¿é—®å¤–éƒ¨ç±»æˆå‘˜"><a href="#åŒ¿åç±»è®¿é—®å¤–éƒ¨ç±»æˆå‘˜" class="headerlink" title="åŒ¿åç±»è®¿é—®å¤–éƒ¨ç±»æˆå‘˜"></a>åŒ¿åç±»è®¿é—®å¤–éƒ¨ç±»æˆå‘˜</h2><p>ä¸€ä¸ªæœ‰ç»§æ‰¿çˆ¶ç±»çš„åŒ¿åç±»ç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnimalTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–éƒ¨ç±»æˆå‘˜å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> String ANIMAL = <span class="string">&quot;åŠ¨ç‰©&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤–éƒ¨ç±»æˆå‘˜æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accessTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åŒ¿åç±»è®¿é—®å…¶å¤–éƒ¨ç±»æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Animal</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printAnimalName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(bird.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é¸Ÿç±»ï¼ŒåŒ¿åå­ç±»ï¼Œç»§æ‰¿è‡ªAnimalç±»ï¼Œå¯ä»¥è¦†å†™çˆ¶ç±»æ–¹æ³•</span></span><br><span class="line">    Animal bird = <span class="keyword">new</span> Animal(<span class="string">&quot;å¸ƒè°·é¸Ÿ&quot;</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printAnimalName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            accessTest();   <span class="comment">// è®¿é—®å¤–éƒ¨ç±»æˆå‘˜æ–¹æ³•</span></span><br><span class="line">            System.out.println(ANIMAL);  <span class="comment">// è®¿é—®å¤–éƒ¨ç±»æˆå‘˜å˜é‡</span></span><br><span class="line">            <span class="keyword">super</span>.printAnimalName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bird.printAnimalName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        AnimalTest animalTest = <span class="keyword">new</span> AnimalTest();</span><br><span class="line">        animalTest.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¾“å‡ºï¼š</span></span><br><span class="line">        <span class="comment">// åŒ¿åç±»è®¿é—®å…¶å¤–éƒ¨ç±»æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// åŠ¨ç‰©</span></span><br><span class="line">        <span class="comment">// å¸ƒè°·é¸Ÿ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŒ¿åç±»å¯ä»¥è®¿é—®å¤–éƒ¨ç±»çš„æ‰€æœ‰æˆå‘˜ã€‚äº‹å®ä¸Šï¼Œä»–ä»¬ç”šè‡³å¯ä»¥ä¿®æ”¹è¿™äº›æˆå‘˜ã€‚</p><h2 id="åŒ¿åç±»è®¿é—®å±€éƒ¨å˜é‡"><a href="#åŒ¿åç±»è®¿é—®å±€éƒ¨å˜é‡" class="headerlink" title="åŒ¿åç±»è®¿é—®å±€éƒ¨å˜é‡"></a>åŒ¿åç±»è®¿é—®å±€éƒ¨å˜é‡</h2><p>åŒ¿åç±»ä¸å±€éƒ¨ç±»å¯¹å¤–éƒ¨åŸŸ<strong>å±€éƒ¨å˜é‡</strong>çš„è®¿é—®æƒé™æ˜¯ç›¸åŒçš„ï¼Œå…ˆçœ‹ä¸‹é¢å±€éƒ¨ç±»çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OuterClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> outerValue = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// å°è¯•ä¿®æ”¹å±€éƒ¨å˜é‡ localValueï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outerMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> localValue = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">LocalInner</span> </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">innerMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// è¾“å‡ºValue</span></span><br><span class="line">                System.out.println(<span class="string">&quot;å†…éƒ¨æ–¹æ³•å†…éƒ¨ç±»è®¿é—®å¤–éƒ¨å˜é‡Int: &quot;</span> + outerValue);</span><br><span class="line">                System.out.println(<span class="string">&quot;å†…éƒ¨æ–¹æ³•å†…éƒ¨ç±»è®¿é—®å±€éƒ¨å˜é‡Int: &quot;</span> + localValue);</span><br><span class="line">                outerValue = <span class="number">20</span>;</span><br><span class="line">                System.out.println(<span class="string">&quot;å†…éƒ¨æ–¹æ³•å†…éƒ¨ç±»ä¿®æ”¹å¤–éƒ¨å˜é‡Int: &quot;</span> + outerValue);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å°è¯•ä¿®æ”¹å±€éƒ¨å˜é‡ localValueï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LocalInner localInner = <span class="keyword">new</span> LocalInner();</span><br><span class="line">        localInner.innerMethod();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        OuterClass outer = <span class="keyword">new</span> OuterClass();</span><br><span class="line">        outer.outerMethod();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¾“å‡ºï¼š</span></span><br><span class="line">        <span class="comment">// å†…éƒ¨ç±»æ–¹æ³•è®¿é—®å¤–éƒ¨ç±»æˆå‘˜å˜é‡Int: 10</span></span><br><span class="line">        <span class="comment">// å†…éƒ¨ç±»æ–¹æ³•è®¿é—®å±€éƒ¨å˜é‡Int: 20</span></span><br><span class="line">        <span class="comment">// å†…éƒ¨ç±»æ–¹æ³•ä¿®æ”¹å¤–éƒ¨ç±»æˆå‘˜å˜é‡Int: 20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºè¯´æ˜å±€éƒ¨ç±»å¯ä»¥è®¿é—®å¤–éƒ¨ç±»æˆå‘˜ï¼Œä¹Ÿå¯ä»¥è®¿é—®å±€éƒ¨å˜é‡ã€‚ä½†ä¿®æ”¹å±€éƒ¨å˜é‡ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæˆ‘ä»¬æ·»åŠ <code>localValue = 10;</code>åœ¨å¯¹åº”æ³¨é‡Šä¸‹å¹¶æ‰§è¡Œï¼Œä¼šæŠ¥é”™ï¼š<code>java: ä»å†…éƒ¨ç±»å¼•ç”¨çš„æœ¬åœ°å˜é‡å¿…é¡»æ˜¯æœ€ç»ˆå˜é‡æˆ–å®é™…ä¸Šçš„æœ€ç»ˆå˜é‡</code>ã€‚</p><p>è¿™æ˜¯å› ä¸ºå±€éƒ¨ç±»è®¿é—®å±€éƒ¨å˜é‡çš„å…ˆå†³æ¡ä»¶æ˜¯å±€éƒ¨å˜é‡æ»¡è¶³<code>final</code>æˆ–<strong>ç­‰æ•ˆ<code>final</code></strong>ã€‚ç®€å•æ¥è¯´ï¼Œè¯¥å±€éƒ¨å˜é‡å¿…é¡»åœ¨åˆå§‹åŒ–åä¸è¢«ä¿®æ”¹ï¼Œæ— è®ºæ˜¯å¦å£°æ˜ä¸º<code>final</code>ã€‚</p><p>åŒ¿åç±»å¯¹äºå±€éƒ¨å˜é‡çš„è®¿é—®è§„åˆ™ä¸å±€éƒ¨ç±»ç›¸åŒï¼Œå¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// author: SilenceZheng66</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EffectivelyFinalExample</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">10</span>; <span class="comment">// Effectively Finalï¼Œè™½ç„¶æ²¡æœ‰å£°æ˜ä¸ºfinalï¼Œä½†ä¸ä¼šå†æ¬¡ä¿®æ”¹</span></span><br><span class="line">        <span class="comment">// x = 20; // å¦‚æœå°è¯•ä¿®æ”¹xçš„å€¼ï¼Œç¼–è¯‘å™¨å°†äº§ç”Ÿé”™è¯¯</span></span><br><span class="line"></span><br><span class="line">        Runnable r = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Value of x: &quot;</span> + x); <span class="comment">// åœ¨åŒ¿åå†…éƒ¨ç±»ä¸­è®¿é—®Effectively Finalå˜é‡</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(r);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŒ¿åç±»éšè—å¤–éƒ¨åŸŸå£°æ˜"><a href="#åŒ¿åç±»éšè—å¤–éƒ¨åŸŸå£°æ˜" class="headerlink" title="åŒ¿åç±»éšè—å¤–éƒ¨åŸŸå£°æ˜"></a>åŒ¿åç±»éšè—å¤–éƒ¨åŸŸå£°æ˜</h2><p>å½“åœ¨åŒ¿åç±»ä¸­å£°æ˜å…·æœ‰ä¸å¤–éƒ¨ç±»ç›¸åŒåç§°çš„ç±»å‹ï¼ˆä¾‹å¦‚å˜é‡ï¼‰æ—¶ï¼Œä¼šå‘ç”Ÿéšè—ï¼ˆshadowingï¼‰ç°è±¡ã€‚è¿™æ„å‘³ç€åŒ¿åç±»ä¸­çš„ç±»å‹å£°æ˜ä¼šè¦†ç›–å¤–éƒ¨ç±»ä¸­å…·æœ‰ç›¸åŒåç§°çš„ä»»ä½•å…¶ä»–å£°æ˜ï¼Œä»è€Œéšè—å¤–éƒ¨ç±»ä¸­çš„ç›¸åº”å†…å®¹ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œç”¨äºè¯´æ˜è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShadowingExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value = <span class="number">10</span>; <span class="comment">// å¤–éƒ¨ç±»ä¸­çš„æˆå‘˜å˜é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> value = <span class="number">20</span>; <span class="comment">// å¤–éƒ¨ç±»ä¸­çš„å±€éƒ¨å˜é‡</span></span><br><span class="line"></span><br><span class="line">        Runnable r = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> value = <span class="number">30</span>; <span class="comment">// åŒ¿åç±»ä¸­çš„å±€éƒ¨å˜é‡ï¼Œä¼šéšè—å¤–éƒ¨ç±»çš„å±€éƒ¨å˜é‡</span></span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;Value in anonymous class: &quot;</span> + value); <span class="comment">// è®¿é—®åŒ¿åç±»ä¸­çš„å±€éƒ¨å˜é‡</span></span><br><span class="line">                System.out.println(<span class="string">&quot;Value in outer class method: &quot;</span> + ShadowingExample.<span class="keyword">this</span>.value); <span class="comment">// è®¿é—®å¤–éƒ¨ç±»æˆå‘˜å˜é‡</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        r.run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ShadowingExample example = <span class="keyword">new</span> ShadowingExample();</span><br><span class="line">        example.performAction();</span><br><span class="line">        <span class="comment">// è¾“å‡ºï¼š</span></span><br><span class="line">        <span class="comment">// Value in anonymous class: 30</span></span><br><span class="line">        <span class="comment">// Value in outer class method: 10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åŒ¿åç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>ShadowingExample.this.value</code> è®¿é—®å¤–éƒ¨ç±»çš„æˆå‘˜å˜é‡ï¼Œå› ä¸ºåŒ¿åç±»ä¸­çš„å±€éƒ¨å˜é‡ <code>value</code> éšè—äº†å¤–éƒ¨ç±»çš„å±€éƒ¨å˜é‡ <code>value</code>ï¼Œä½†æ²¡æœ‰éšè—å¤–éƒ¨ç±»çš„æˆå‘˜å˜é‡ <code>value</code>ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://docs.oracle.com/javase/tutorial/java/javaOO/anonymousclasses.html">https://docs.oracle.com/javase/tutorial/java/javaOO/anonymousclasses.html</a><br>[2] <a href="https://www.cnblogs.com/wuhenzhidu/p/anonymous.html">https://www.cnblogs.com/wuhenzhidu/p/anonymous.html</a><br>[3] <a href="https://docs.oracle.com/javase/tutorial/java/javaOO/nested.html#shadowing">https://docs.oracle.com/javase/tutorial/java/javaOO/nested.html#shadowing</a><br>[4] <a href="https://docs.oracle.com/javase/tutorial/java/javaOO/localclasses.html">https://docs.oracle.com/javase/tutorial/java/javaOO/localclasses.html</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;Javaä¸­çš„åŒ¿åç±»ï¼ŒJava8åŠä»¥åã€‚&lt;/p&gt;
&lt;p&gt;æ¶‰åŠæ¦‚å¿µåŒ…æ‹¬ï¼š&lt;strong&gt;ç­‰æ•ˆ&lt;code&gt;final&lt;/code&gt;&lt;/strong&gt;ï¼Œæˆå‘˜ï¼Œå˜é‡ï¼Œä½œç”¨åŸŸã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="Java" scheme="http://silencezheng.top/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>MyBatis-Plusä¹‹é…ç½®è‡ªåŠ¨å¡«å……</title>
    <link href="http://silencezheng.top/2023/08/26/article118/"/>
    <id>http://silencezheng.top/2023/08/26/article118/</id>
    <published>2023-08-26T05:12:19.000Z</published>
    <updated>2023-08-26T05:13:41.546Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é€šè¿‡<code>MetaObjectHandler</code>æ¥å£ï¼Œé…ç½®MyBatis-Plusçš„è‡ªåŠ¨å¡«å……ã€‚</p><p>MyBatis-Plusç‰ˆæœ¬ï¼š<code>3.4.3.4</code><br><span id="more"></span></p><h2 id="ä»€ä¹ˆæ˜¯è‡ªåŠ¨å¡«å……"><a href="#ä»€ä¹ˆæ˜¯è‡ªåŠ¨å¡«å……" class="headerlink" title="ä»€ä¹ˆæ˜¯è‡ªåŠ¨å¡«å……"></a>ä»€ä¹ˆæ˜¯è‡ªåŠ¨å¡«å……</h2><p>é€šå¸¸åœ¨å»ºè¡¨æ—¶ï¼Œä¼šè®¾ç½®ä¸€äº›å…¬å…±å­—æ®µï¼Œä¾‹å¦‚åˆ›å»ºäººï¼ˆcreatorï¼‰ã€æ›´æ–°äººï¼ˆuptaterï¼‰ã€åˆ›å»ºæ—¶é—´ï¼ˆcreate_timeï¼‰ã€æ›´æ–°æ—¶é—´ï¼ˆupdate_timeï¼‰ç­‰ç­‰ã€‚</p><p>æ¯æ¬¡å°†å®ä½“å¯¹è±¡æ–°å¢å…¥åº“æ—¶ï¼Œéƒ½è¦è®¾ç½®åˆ›å»ºäººå’Œåˆ›å»ºæ—¶é—´ï¼›æ¯æ¬¡æ›´æ–°å®ä½“å¯¹è±¡æ—¶ï¼Œéƒ½è¦è®¾ç½®æ›´æ–°äººå’Œæ›´æ–°æ—¶é—´ï¼›å¦‚æœè¿™äº›éƒ½æ”¾åœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œå¾ˆæ˜¯ç¹çï¼Œäºæ˜¯å°±éœ€è¦é…ç½®è‡ªåŠ¨å¡«å……æ¥ç®€åŒ–å·¥ä½œã€‚</p><h2 id="MetaObjectHandler"><a href="#MetaObjectHandler" class="headerlink" title="MetaObjectHandler"></a>MetaObjectHandler</h2><p><code>MetaObjectHandler</code> æ˜¯ MyBatis-Plus æä¾›çš„ä¸€ä¸ªæ¥å£ç±»ï¼Œé€šè¿‡å®ç°è¯¥æ¥å£å¹¶é‡å†™å…¶ä¸­çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼ˆæ’å…¥å’Œæ›´æ–°ï¼‰æ—¶è‡ªåŠ¨å¡«å……æŸäº›å­—æ®µçš„å€¼ã€‚</p><p><code>MetaObjectHandler</code> ä¸­æœ‰è‹¥å¹²é»˜è®¤æ–¹æ³•ï¼ˆå·²å®ç°ï¼‰å’Œä¸¤ä¸ªæ¥å£æ–¹æ³•ï¼ˆéœ€å®ç°ï¼‰ï¼Œæ¥å£æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MetaObject æ˜¯ MyBatis çš„ä¸€ä¸ªåå°„å·¥å…·ç±»ï¼Œç”¨äºæ“ä½œ Java å¯¹è±¡çš„å±æ€§ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥è·å–ã€è®¾ç½®ã€åˆ¤æ–­å’Œæ“ä½œ Java å¯¹è±¡çš„å±æ€§ï¼Œä½¿å¾—åœ¨ä¸ç›´æ¥è°ƒç”¨ JavaBean çš„ getter å’Œ setter æ–¹æ³•çš„æƒ…å†µä¸‹è¿›è¡Œå±æ€§æ“ä½œå˜å¾—æ›´åŠ æ–¹ä¾¿å’Œçµæ´»ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertFill</span><span class="params">(MetaObject metaObject)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateFill</span><span class="params">(MetaObject metaObject)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºç¡€çš„è‡ªåŠ¨å¡«å……é…ç½®ç¤ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title">MetaObjectHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ–°å¢æ—¶å¡«å……</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.strictInsertFill(metaObject, <span class="string">&quot;createTime&quot;</span>, LocalDateTime.class, LocalDateTime.now()); <span class="comment">// èµ·å§‹ç‰ˆæœ¬ 3.3.0(æ¨èä½¿ç”¨)</span></span><br><span class="line">            <span class="comment">// æˆ–è€…</span></span><br><span class="line">            <span class="keyword">this</span>.strictInsertFill(metaObject, <span class="string">&quot;createTime&quot;</span>, () -&gt; LocalDateTime.now(), LocalDateTime.class); <span class="comment">// èµ·å§‹ç‰ˆæœ¬ 3.3.3(æ¨è)</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¿®æ”¹æ—¶å¡«å……</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.strictUpdateFill(metaObject, <span class="string">&quot;updateTime&quot;</span>, LocalDateTime.class, LocalDateTime.now()); <span class="comment">// èµ·å§‹ç‰ˆæœ¬ 3.3.0(æ¨è)</span></span><br><span class="line">            <span class="comment">// æˆ–è€…</span></span><br><span class="line">            <span class="keyword">this</span>.strictUpdateFill(metaObject, <span class="string">&quot;updateTime&quot;</span>, () -&gt; LocalDateTime.now(), LocalDateTime.class); <span class="comment">// èµ·å§‹ç‰ˆæœ¬ 3.3.3(æ¨è)</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦æƒ³ä½¿ç”¨ <code>MetaObjectHandler</code>ï¼Œéœ€è¦åœ¨å…¶å®ç°ç±»ä¸Šæ·»åŠ  <code>@Component</code> æ³¨è§£ï¼Œç„¶åå°†å…¶æ³¨å†Œä¸º Spring çš„ä¸€ä¸ª Beanï¼Œè¿™æ · MyBatis Plus å°±ä¼šè‡ªåŠ¨è°ƒç”¨å…¶ä¸­å®šä¹‰çš„æ–¹æ³•æ¥è¿›è¡Œå­—æ®µå€¼çš„å¡«å……ã€‚</p><p>ç„¶åï¼Œåœ¨å®ä½“ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼Œå‘ŠçŸ¥Mybatis-Pluséœ€è¦é¢„ç•™æ³¨å…¥SQLå­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableField(value = &quot;create_time&quot;,fill = FieldFill.INSERT)</span></span><br><span class="line"><span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line"><span class="keyword">private</span> LocalDateTime createTime;</span><br></pre></td></tr></table></figure><p>å¡«å……ç­–ç•¥åŒ…æ‹¬ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">FieldFill</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é»˜è®¤ä¸å¤„ç†</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DEFAULT,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ’å…¥å¡«å……å­—æ®µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    INSERT,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ›´æ–°å¡«å……å­—æ®µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UPDATE,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ’å…¥å’Œæ›´æ–°å¡«å……å­—æ®µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    INSERT_UPDATE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h2><p>1ã€å¦‚æœå±æ€§æœ‰å€¼åˆ™ä¸è¦†ç›–ï¼Œå¦‚æœsqlä¸­èµ‹å€¼äº†ï¼Œè‡ªåŠ¨å¡«å……åˆè®¾ç½®ä¸ºå…¶ä»–å€¼ï¼Œåˆ™ä»¥sqlä¸­çš„å€¼ä¸ºå‡†ã€‚</p><p>2ã€å¦‚æœå¡«å……å€¼ä¸ºnullåˆ™ä¸å¡«å……ï¼Œæ¯”å¦‚<code>this.setFieldValByName(â€œupdate_timeâ€, null, metaObject);</code>å®é™…æ˜¯ä¸ä¼šæ›´æ–°ä¸ºnullçš„ã€‚</p><p>3ã€å¡«å……å¤„ç†å™¨ï¼ˆå¦‚<code>MyMetaObjectHandler</code>ï¼‰åœ¨ Spring Boot ä¸­éœ€è¦å£°æ˜<code>@Component</code>æˆ–<code>@Bean</code>æ³¨å…¥</p><p>4ã€æœ€å¥½ä¸è¦åœ¨è‡ªå®šä¹‰mapperæ–¹æ³•ä¸­ä½¿ç”¨å¡«å……ï¼Œéè¦ä½¿ç”¨çš„è¯éœ€è¦ä½¿ç”¨ç‰¹å®šå‚æ•°æ³¨è§£ï¼Œå¦‚<code>@Param(&quot;et&quot;)</code>ç­‰ã€‚</p><p>5ã€<code>update(T t,Wrapper updateWrapper)</code>æ—¶<code>t</code>ä¸èƒ½ä¸ºç©º,å¦åˆ™è‡ªåŠ¨å¡«å……å¤±æ•ˆï¼Œå¦‚<code>this.update(new User(), new UpdateWrapper&lt;User&gt;().set(&quot;name&quot;, &quot;å¼ ä¸‰&quot;)));</code>ä¸èƒ½çœç•¥<code>new User()</code>ã€‚</p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;é€šè¿‡&lt;code&gt;MetaObjectHandler&lt;/code&gt;æ¥å£ï¼Œé…ç½®MyBatis-Plusçš„è‡ªåŠ¨å¡«å……ã€‚&lt;/p&gt;
&lt;p&gt;MyBatis-Plusç‰ˆæœ¬ï¼š&lt;code&gt;3.4.3.4&lt;/code&gt;&lt;br&gt;</summary>
    
    
    
    
    <category term="Java" scheme="http://silencezheng.top/tags/Java/"/>
    
    <category term="MyBatis" scheme="http://silencezheng.top/tags/MyBatis/"/>
    
  </entry>
  
  <entry>
    <title>å›¾å·ç§¯(GCN)å­¦ä¹ </title>
    <link href="http://silencezheng.top/2023/08/15/article117/"/>
    <id>http://silencezheng.top/2023/08/15/article117/</id>
    <published>2023-08-15T15:11:28.000Z</published>
    <updated>2023-08-15T15:16:44.254Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å›¾å·ç§¯å­¦ä¹ è®°å½•ï¼ŒåŒæ—¶ä¹Ÿæ¶‰åŠç¦»æ•£æ‹‰æ™®æ‹‰æ–¯ç®—å­å†…å®¹ï¼Œå¯èƒ½å¯¹è§†è§‰æ–¹å‘æœ‰å¸®åŠ©ã€‚</p><p>ç›¸å…³å†…å®¹ï¼šå·ç§¯ã€å‚…ç«‹å¶å˜æ¢ã€æ‹‰æ™®æ‹‰æ–¯ç®—å­ã€ç‹„åˆ©å…‹é›·èƒ½é‡ã€å›¾å·ç§¯<br><span id="more"></span></p><h2 id="ä¼ ç»Ÿå·ç§¯"><a href="#ä¼ ç»Ÿå·ç§¯" class="headerlink" title="ä¼ ç»Ÿå·ç§¯"></a>ä¼ ç»Ÿå·ç§¯</h2><p>ä¼ ç»Ÿçš„å·ç§¯ä¸»è¦åº”ç”¨äºEuclidean Structureçš„æ•°æ®ä¸Šï¼ˆæ’åˆ—å¾ˆæ•´é½ã€Gridå½¢å¼çš„ï¼‰ï¼Œå¦‚å›¾åƒã€è¯­å¥ç­‰ï¼Œä¸»è¦æ˜¯å› ä¸ºæ¬§å¼ç»“æ„æ•°æ®èƒ½å¤Ÿä¿è¯å·ç§¯çš„æ€§è´¨ï¼Œå³å¹³ç§»ä¸å˜æ€§ï¼Œè€ŒNon-Euclideanæ— æ³•ä¿è¯å¹³ç§»ä¸å˜æ€§ï¼Œé€šä¿—ç†è§£å°±æ˜¯åœ¨æ‹“æ‰‘å›¾ä¸­æ¯ä¸ªé¡¶ç‚¹çš„ç›¸é‚»é¡¶ç‚¹æ•°ç›®éƒ½å¯èƒ½ä¸åŒï¼Œé‚£ä¹ˆå½“ç„¶æ— æ³•ç”¨ä¸€ä¸ªåŒæ ·å°ºå¯¸çš„å·ç§¯æ ¸æ¥è¿›è¡Œå·ç§¯è¿ç®—ã€‚</p><h2 id="æ¨å¹¿å·ç§¯åˆ°å›¾"><a href="#æ¨å¹¿å·ç§¯åˆ°å›¾" class="headerlink" title="æ¨å¹¿å·ç§¯åˆ°å›¾"></a>æ¨å¹¿å·ç§¯åˆ°å›¾</h2><p>å·ç§¯å®šç†æŒ‡å‡ºï¼Œ<strong>å‡½æ•°å·ç§¯çš„å‚…é‡Œå¶å˜æ¢æ˜¯å‡½æ•°å‚…é‡Œå¶å˜æ¢çš„ä¹˜ç§¯</strong>ã€‚å³ä¸€ä¸ªåŸŸä¸­çš„å·ç§¯å¯¹åº”äºå¦ä¸€ä¸ªåŸŸä¸­çš„ä¹˜ç§¯, ä¾‹å¦‚æ—¶åŸŸä¸­çš„å·ç§¯å¯¹åº”äºé¢‘åŸŸä¸­çš„ä¹˜ç§¯ã€‚</p><script type="math/tex; mode=display">\mathcal{F}\{f * g\}=\mathcal{F}\{f\} \cdot \mathcal{F}\{g\}</script><p>å…¶ä¸­ $\mathcal{F}(f)$ è¡¨ç¤º $f$ çš„å‚…é‡Œå¶å˜æ¢ã€‚ä¸‹é¢è¿™ç§å½¢å¼ä¹Ÿæˆç«‹ï¼š</p><script type="math/tex; mode=display">\mathcal{F}\{f \cdot g\}=\mathcal{F}\{f\} * \mathcal{F}\{g\}</script><p>å€Ÿç”±å‚…é‡Œå¶é€†å˜æ¢ $\mathcal{F}^{-1}$, ä¹Ÿå¯ä»¥å†™æˆï¼š</p><script type="math/tex; mode=display">f * g=\mathcal{F}^{-1}\{\mathcal{F}\{f\} \cdot \mathcal{F}\{g\}\}</script><p>æ³¨æ„ä»¥ä¸Šçš„å†™æ³•åªå¯¹ç‰¹å®šå½¢å¼å®šä¹‰çš„å˜æ¢æ­£ç¡®ï¼Œå˜æ¢å¯èƒ½ç”±å…¶å®ƒæ–¹å¼æ­£è§„åŒ–ï¼Œä½¿å¾—ä¸Šé¢çš„å…³ç³»å¼ä¸­å‡ºç°å…¶å®ƒçš„å¸¸æ•°å› å­ã€‚</p><p>è¿™ä¸€å®šç†å¯¹æ‹‰æ™®æ‹‰æ–¯å˜æ¢ã€åŒè¾¹æ‹‰æ™®æ‹‰æ–¯å˜æ¢ã€Zå˜æ¢ã€æ¢…æ—å˜æ¢å’ŒHartleyå˜æ¢ç­‰å„ç§å‚…é‡Œå¶å˜æ¢çš„å˜ä½“åŒæ ·æˆç«‹ã€‚</p><p>åˆ©ç”¨å·ç§¯å®šç†å¯ä»¥ç®€åŒ–å·ç§¯çš„è¿ç®—é‡ã€‚å¯¹äºé•¿åº¦ä¸º $n$ çš„åºåˆ—ï¼ŒæŒ‰ç…§å·ç§¯çš„å®šä¹‰è¿›è¡Œè®¡ç®—ï¼Œéœ€è¦åš $2 n-1$ ç»„å¯¹ä½ä¹˜æ³•ï¼Œå…¶è®¡ç®—å¤æ‚åº¦ä¸º $\mathcal{O}\left(n^2\right)$ï¼›è€Œåˆ©ç”¨å‚…é‡Œå¶å˜æ¢å°†åºåˆ—å˜æ¢åˆ°é¢‘åŸŸä¸Šåï¼Œåªéœ€è¦ä¸€ç»„å¯¹ä½ä¹˜æ³•ï¼Œåˆ©ç”¨å‚…é‡Œå¶å˜æ¢çš„å¿«é€Ÿç®—æ³•ä¹‹åï¼Œæ€»çš„è®¡ç®—å¤æ‚åº¦ä¸º $\mathcal{O}(n \log n)$ ã€‚è¿™ä¸€ç»“æœå¯ä»¥åœ¨å¿«é€Ÿä¹˜æ³•è®¡ç®—ä¸­å¾—åˆ°åº”ç”¨ã€‚</p><p>å‚…é‡Œå¶å˜æ¢åˆå¯ä»¥é€šè¿‡<strong>è°±å›¾ç†è®º</strong>æ¨å¹¿åˆ°å›¾ä¸Šè¿›è¡Œå˜æ¢ã€‚</p><blockquote><p>è°±å›¾ç†è®ºæ˜¯å›¾è®ºä¸çº¿æ€§ä»£æ•°ç›¸ç»“åˆçš„äº§ç‰©ï¼Œå®ƒé€šè¿‡åˆ†æå›¾çš„æŸäº›çŸ©é˜µçš„ç‰¹å¾å€¼ä¸ç‰¹å¾å‘é‡è€Œç ”ç©¶å›¾çš„æ€§è´¨ã€‚æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µæ˜¯è°±å›¾ç†è®ºä¸­çš„æ ¸å¿ƒä¸åŸºæœ¬æ¦‚å¿µï¼Œåœ¨æœºå™¨å­¦ä¹ ä¸æ·±åº¦å­¦ä¹ ä¸­æœ‰é‡è¦çš„åº”ç”¨ã€‚åŒ…æ‹¬ä½†ä¸ä»…é™äºï¼šæµå½¢å­¦ä¹ æ•°æ®é™ç»´ç®—æ³•ä¸­çš„æ‹‰æ™®æ‹‰æ–¯ç‰¹å¾æ˜ å°„ã€å±€éƒ¨ä¿æŒæŠ•å½±ï¼Œæ— ç›‘ç£å­¦ä¹ ä¸­çš„è°±èšç±»ç®—æ³•ï¼ŒåŠç›‘ç£å­¦ä¹ ä¸­åŸºäºå›¾çš„ç®—æ³•ï¼Œä»¥åŠç›®å‰ç‚™æ‰‹å¯çƒ­çš„å›¾ç¥ç»ç½‘ç»œç­‰ã€‚è¿˜æœ‰åœ¨å›¾åƒå¤„ç†ã€è®¡ç®—æœºå›¾å½¢å­¦ä»¥åŠå…¶ä»–å·¥ç¨‹é¢†åŸŸåº”ç”¨å¹¿æ³›çš„å›¾åˆ‡å‰²é—®é¢˜ã€‚ç†è§£æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„å®šä¹‰ä¸æ€§è´¨æ˜¯æŒæ¡è¿™äº›ç®—æ³•çš„åŸºç¡€ã€‚</p></blockquote><p>æ‰€ä»¥ï¼ŒConvolution â€”â€” Fourier â€”â€” Spectral Graphï¼Œå·ç§¯é€šè¿‡å‚…é‡Œå¶å˜æ¢å’Œå›¾ï¼ˆé¢‘è°±åŸŸï¼‰å‘ç”Ÿäº†è”ç³»ã€‚</p><p>ä»æ•´ä¸ªçš„ç ”ç©¶è¿›ç¨‹æ¥çœ‹ï¼Œé¦–å…ˆæ˜¯ç ”ç©¶GSPï¼ˆGraph Signal Processingï¼‰çš„å­¦è€…æå‡ºäº†Graphä¸Šçš„Fourier Transformationï¼Œè¿›è€Œå®šä¹‰äº†Graphçš„Convolutionï¼Œæœ€åä¸æ·±åº¦å­¦ä¹ ç»“åˆèµ·æ¥ï¼Œå‘å±•å‡ºæ¥GCNã€‚</p><h2 id="å›¾å‚…ç«‹å¶å˜æ¢çš„å®æ–½"><a href="#å›¾å‚…ç«‹å¶å˜æ¢çš„å®æ–½" class="headerlink" title="å›¾å‚…ç«‹å¶å˜æ¢çš„å®æ–½"></a>å›¾å‚…ç«‹å¶å˜æ¢çš„å®æ–½</h2><p>å…³äºæ—¶åŸŸå’Œé¢‘åŸŸï¼Œæˆ‘åœ¨<a href="https://silencezheng.top/2022/10/05/article67/">é«˜æ–¯æ»¤æ³¢å’ŒåŒè¾¹æ»¤æ³¢</a>ä¸€æ–‡ä¸­å·²æœ‰ä¸€äº›ä»‹ç»ã€‚</p><p>æ­¤å¤„éœ€è¦å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯<strong>å‚…é‡Œå¶çº§æ•°æ˜¯å‘é‡</strong>ï¼Œä¸€èˆ¬æè¿°å‘é‡çš„æ—¶å€™ï¼Œéƒ½æœ‰å¯¹åº”çš„åŸºï¼Œå³åœ¨æŸç»„åŸºä¸‹çš„åæ ‡è¡¨ç¤ºæ„æˆäº†å‘é‡ã€‚é»˜è®¤æ˜¯å•ä½åŸºæ—¶ï¼Œåˆ™ä¸æ˜¾å¼æåˆ°ã€‚é¢‘åŸŸä¸‹ï¼ŒæŸä¸ªæ›²çº¿æ˜¯è¡¨ç¤ºæˆäº†å…³äºæ­£å¼¦å‡½æ•°æ­£äº¤åŸºä¸‹çš„å‚…é‡Œå¶çº§æ•°å‘é‡ã€‚è€Œåœ¨æ—¶åŸŸä¸‹ï¼ŒæŸä¸ªæ›²çº¿æ˜¯è¡¨ç¤ºæˆäº†å…³äºæ—¶é—´çš„å‘¨æœŸå‡½æ•°ã€‚ä¸ç®¡æ—¶åŸŸè¿˜æ˜¯é¢‘åŸŸï¼Œå…¶å®åæ˜ çš„éƒ½æ˜¯åŒä¸€ä¸ªæ›²çº¿ï¼Œåªæ˜¯ä¸€ä¸ªæ˜¯ç”¨å‡½æ•°çš„è§‚ç‚¹ï¼Œä¸€ä¸ªæ˜¯ç”¨å‘é‡çš„è§‚ç‚¹ã€‚</p><p>å›¾ä¸Šçš„å‚…é‡Œå¶å˜æ¢æ˜¯é€šè¿‡ä¸‹è¿°è”ç³»å®æ–½çš„ï¼š</p><ol><li>å›¾æ‹‰æ™®æ‹‰æ–¯ç®—å­ï¼Œ Laplacian Operator â€”- Graph Laplacian Matrixã€‚</li><li>å›¾æ‹‰æ™®æ‹‰æ–¯çš„è°±åˆ†è§£ï¼ŒGraph Laplacian Matrix â€”- Spectral Decompositionã€‚</li><li>å›¾ä¸Šç‹„åˆ©å…‹é›·èƒ½é‡æœ€å°çš„åŸºï¼Œ Dirichlet Energy â€”- Orthonormal Basis â€”- Spectral Decomposition â€”- Eigenvectors</li><li>å‚…é‡Œå¶å˜æ¢ï¼ŒFourier â€”- Fourier Basis â€”- Laplacian eigenfunctions</li></ol><p>æ ¹æ®4ï¼Œå¯ä»¥è¯æ˜ï¼ŒFourier basis = Laplacian eigenfunctionsï¼Œå³å‚…ç«‹å¶çº§æ•°çš„åŸº(å’Œé¢‘ç‡ä¸€ä¸€å¯¹åº”)æ˜¯æ‹‰æ™®æ‹‰æ–¯ç®—å­çš„ç‰¹å¾å‡½æ•° (æ»¡è¶³ç‰¹å¾æ–¹ç¨‹)ã€‚æ ¹æ®1ï¼Œåœ¨å›¾ä¸Šï¼Œæ‹‰æ™®æ‹‰æ–¯ç®—å­ä¸ºæ‹‰æ™®æ‹‰æ–¯çŸ©é˜µã€‚æ ¹æ®2ï¼Œæ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„è°±åˆ†è§£å¾—åˆ°çš„ç‰¹å¾å‘é‡(å’Œç‰¹å¾å€¼ä¸€ä¸€å¯¹åº”)ç±»æ¯”ç‰¹å¾å‡½æ•°ã€‚å› æ­¤ï¼Œ<strong>ä¼ ç»Ÿå‚…é‡Œå¶å˜æ¢åœ¨å›¾çš„æ‹“å±•å°±æ˜¯å°†æ­£å¼¦å‡½æ•°åŸºæ›¿æ¢æ¢æˆå›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„ç‰¹å¾å‘é‡</strong>ï¼Œæ­£å¼¦å‡½æ•°ä¸é¢‘ç‡ä¸€ä¸€å¯¹åº”ï¼Œç‰¹å¾å‘é‡ä¸ç‰¹å¾å€¼ä¸€ä¸€å¯¹åº”ã€‚è€Œæ ¹æ®3ï¼Œè¿™ä¸€æ›¿æ¢çš„æ ¹æºæ„ä¹‰åœ¨äºï¼Œå›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„ç‰¹å¾å‘é‡ä½œä¸ºä¸€ç»„åŸºçš„è¯ï¼Œè¿™ç»„åŸºæ˜¯å›¾ä¸Šç‹„åˆ©å…‹é›·èƒ½é‡æœ€å°çš„åŸºã€‚</p><blockquote><p>Laplacian Operatorï¼ˆæ‹‰æ™®æ‹‰æ–¯ç®—å­ï¼‰å’ŒLaplacian eigenfunctionsï¼ˆæ‹‰æ™®æ‹‰æ–¯ç‰¹å¾å‡½æ•°ï¼‰æ˜¯åœ¨å›¾è®ºå’Œå›¾ä¿¡å·å¤„ç†ä¸­å¯†åˆ‡ç›¸å…³çš„æ¦‚å¿µã€‚</p><ol><li><p>Laplacian Operator:<br>åœ¨å›¾è®ºä¸­ï¼ŒLaplacian Operatoræ˜¯ç”¨æ¥æè¿°å›¾çš„æ‹“æ‰‘ç»“æ„å’ŒèŠ‚ç‚¹ä¹‹é—´è¿æ¥å…³ç³»çš„ç®—å­ã€‚å¯¹äºä¸€ä¸ªæ— å‘å›¾Gï¼ŒLaplacian Operatoré€šå¸¸å®šä¹‰ä¸ºåº¦çŸ©é˜µï¼ˆDegree Matrixï¼‰Då’Œé‚»æ¥çŸ©é˜µï¼ˆAdjacency Matrixï¼‰Aä¹‹é—´çš„å·®ï¼Œå³L = D - Aã€‚å…¶ä¸­ï¼Œåº¦çŸ©é˜µDæ˜¯ä¸€ä¸ªå¯¹è§’çŸ©é˜µï¼Œå…¶å¯¹è§’çº¿å…ƒç´ æ˜¯æ¯ä¸ªèŠ‚ç‚¹çš„åº¦æ•°ï¼ˆä¸è¯¥èŠ‚ç‚¹ç›¸è¿æ¥çš„è¾¹çš„æ•°é‡ï¼‰ï¼Œé‚»æ¥çŸ©é˜µAæè¿°äº†èŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥å…³ç³»ã€‚<br>Laplacian Operatoræœ‰å¤šç§å½¢å¼ï¼Œå¸¸è§çš„æœ‰åº¦æ ‡å‡†åŒ–Laplacianã€éšæœºæ¸¸èµ°æ ‡å‡†åŒ–Laplacianç­‰ï¼Œä¸åŒçš„å½¢å¼åœ¨ä¸åŒçš„å›¾ä¿¡å·å¤„ç†ä»»åŠ¡ä¸­æœ‰ä¸åŒçš„åº”ç”¨ã€‚</p></li><li><p>Laplacian eigenfunctions:<br>Laplacian eigenfunctionsæ˜¯æŒ‡Laplacian Operatorå¯¹åº”çš„ç‰¹å¾å‡½æ•°ï¼Œä¹Ÿç§°ä¸ºæ‹‰æ™®æ‹‰æ–¯ç‰¹å¾å‘é‡ã€‚Laplacian Operatorçš„ç‰¹å¾å‡½æ•°æ˜¯åœ¨å›¾ä¸Šå®šä¹‰çš„ä¸€ç»„æ­£äº¤å‡½æ•°ï¼Œå®ƒä»¬æè¿°äº†å›¾çš„æŒ¯åŠ¨æ¨¡å¼å’Œé¢‘ç‡ã€‚</p></li></ol><p>å¯¹äºå›¾çš„Laplacian Operator Lï¼Œå®ƒå¯ä»¥è¿›è¡Œè°±åˆ†è§£ï¼Œå¾—åˆ°ä¸€ç»„ç‰¹å¾å‘é‡ï¼ˆLaplacian eigenfunctionsï¼‰å’Œå¯¹åº”çš„ç‰¹å¾å€¼ï¼ˆLaplacian eigenvaluesï¼‰ã€‚è¿™äº›ç‰¹å¾å‘é‡åœ¨å›¾ä¿¡å·å¤„ç†ä¸­å…·æœ‰é‡è¦çš„æ„ä¹‰ï¼Œå®ƒä»¬æ„æˆäº†ä¸€ä¸ªåŸºï¼Œå¯ä»¥ç”¨äºå°†å›¾ä¿¡å·ä»åŸå§‹çš„èŠ‚ç‚¹ç©ºé—´è½¬æ¢åˆ°é¢‘åŸŸç©ºé—´ï¼Œç±»ä¼¼äºå‚…é‡Œå¶å˜æ¢ä¸­çš„åŸºå‡½æ•°ã€‚</p><p>Laplacian eigenfunctionså¯¹åº”çš„ç‰¹å¾å€¼å¯ä»¥ç”¨æ¥è¡¨ç¤ºå›¾çš„ç»“æ„å’ŒèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥å…³ç³»ï¼Œä¸åŒçš„ç‰¹å¾å€¼å¯¹åº”ä¸åŒçš„é¢‘ç‡ï¼Œåæ˜ äº†å›¾çš„æŒ¯åŠ¨ç‰¹æ€§ã€‚åœ¨å›¾ä¿¡å·å¤„ç†ä»»åŠ¡ä¸­ï¼ŒLaplacian eigenfunctionså¸¸å¸¸è¢«ç”¨ä½œå›¾åµŒå…¥ã€å›¾å·ç§¯ç¥ç»ç½‘ç»œï¼ˆGCNï¼‰ç­‰æ–¹æ³•çš„åŸºç¡€ï¼Œä»¥ä¾¿æœ‰æ•ˆåœ°å­¦ä¹ å›¾çš„ç‰¹å¾å’Œç»“æ„ã€‚</p></blockquote><h2 id="å›¾æ‹‰æ™®æ‹‰æ–¯ç®—å­"><a href="#å›¾æ‹‰æ™®æ‹‰æ–¯ç®—å­" class="headerlink" title="å›¾æ‹‰æ™®æ‹‰æ–¯ç®—å­"></a>å›¾æ‹‰æ™®æ‹‰æ–¯ç®—å­</h2><p>å…ˆè®¨è®ºå¸¸è§„è¿ç»­æ‹‰æ™®æ‹‰æ–¯ç®—å­ï¼Œç„¶åé€šè¿‡<strong>æœ‰é™å·®åˆ†æ³•</strong>åœ¨ç¦»æ•£ç½‘æ ¼ä¸Šè¿‘ä¼¼è®¡ç®—æ‹‰æ™®æ‹‰æ–¯ç®—å­ï¼Œå¯¹å…¶è¿›è¡Œç¦»æ•£åŒ–ã€‚</p><blockquote><p>æœ‰é™å·®åˆ†æ³•æ˜¯å°†å¯¼æ•°æˆ–å¾®åˆ†ç®—å­æ›¿æ¢ä¸ºå·®åˆ†çš„å½¢å¼ï¼Œä»è€Œå°†å¾®åˆ†æ–¹ç¨‹è½¬åŒ–ä¸ºå·®åˆ†æ–¹ç¨‹ã€‚</p><p>å·®åˆ†æ–¹ç¨‹æ˜¯ä¸€ç§æ•°å­¦æ–¹ç¨‹ï¼Œç”¨äºæè¿°ç¦»æ•£ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œé€šå¸¸åœ¨æ•°å€¼è®¡ç®—å’Œç¦»æ•£æ¨¡å‹ä¸­ä½¿ç”¨ã€‚ä¸å¾®åˆ†æ–¹ç¨‹ç±»ä¼¼ï¼Œå·®åˆ†æ–¹ç¨‹æ˜¯åœ¨ç¦»æ•£æ—¶é—´æˆ–ç©ºé—´ä¸Šå»ºç«‹å‡½æ•°ä¹‹é—´çš„å…³ç³»ï¼Œè€Œä¸æ˜¯è¿ç»­å˜é‡çš„å…³ç³»ã€‚</p></blockquote><p>æœ€åï¼Œæˆ‘ä»¬æ¨å¹¿åˆ°å›¾ç»“æ„ä¸Šã€‚</p><h3 id="æ‹‰æ™®æ‹‰æ–¯ç®—å­ï¼ˆLaplacian-Operatorï¼‰"><a href="#æ‹‰æ™®æ‹‰æ–¯ç®—å­ï¼ˆLaplacian-Operatorï¼‰" class="headerlink" title="æ‹‰æ™®æ‹‰æ–¯ç®—å­ï¼ˆLaplacian Operatorï¼‰"></a>æ‹‰æ™®æ‹‰æ–¯ç®—å­ï¼ˆLaplacian Operatorï¼‰</h3><p>æ‹‰æ™®æ‹‰æ–¯ç®—å­çš„ä¸¥æ ¼æ•°å­¦å®šä¹‰ï¼šå¤šå…ƒå‡½æ•°$f(x_1,â€¦,x_n)$çš„æ‹‰æ™®æ‹‰æ–¯ç®—å­æ˜¯<strong>æ‰€æœ‰è‡ªå˜é‡çš„éæ··åˆäºŒé˜¶åå¯¼æ•°ä¹‹å’Œ</strong>ã€‚</p><script type="math/tex; mode=display">\Delta f=\sum_{i=1}^n \frac{\partial^2 f}{\partial x_i^2}</script><p>åŸºäºå®šä¹‰ï¼Œæ‰€æœ‰çš„__æ‹‰æ™®æ‹‰æ–¯ç®—å­éƒ½æ˜¯å…¶ä¸€ä¸ªç‰¹ä¾‹ï¼Œæˆ–æ˜¯æŸç§æƒ…å†µä¸‹(æ¯”å¦‚ç¦»æ•£æƒ…å†µä¸‹)çš„ä¸€ç§è¿‘ä¼¼ã€‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¹‹åªèƒ½è¿‘ä¼¼è®¡ç®—å¯¼æ•°å€¼ï¼Œç§°ä¸º<strong>æ•°å€¼å¾®åˆ†</strong>ã€‚</p><blockquote><p>æ•°å€¼å¾®åˆ†æ˜¯ä¸€ç§é€šè¿‡æ•°å€¼è®¡ç®—æ¥è¿‘ä¼¼è®¡ç®—å‡½æ•°çš„å¯¼æ•°çš„æ–¹æ³•ã€‚å®ƒåœ¨æ•°å€¼åˆ†æå’Œç§‘å­¦è®¡ç®—ä¸­ç»å¸¸ç”¨äºè§£å†³æ— æ³•é€šè¿‡è§£ææ–¹æ³•æ±‚å¾—å¯¼æ•°çš„é—®é¢˜ï¼Œæˆ–è€…ç”¨äºéªŒè¯è§£æå¯¼æ•°çš„ç»“æœã€‚</p><p>æ•°å€¼å¾®åˆ†çš„åŸºæœ¬æ€æƒ³æ˜¯åˆ©ç”¨å‡½æ•°åœ¨æŸä¸€ç‚¹é™„è¿‘çš„å‡½æ•°å€¼æ¥è¿‘ä¼¼è®¡ç®—è¯¥ç‚¹çš„å¯¼æ•°ã€‚å¸¸è§çš„æ•°å€¼å¾®åˆ†æ–¹æ³•åŒ…æ‹¬ï¼š</p><ol><li><p><strong>ä¸­å¿ƒå·®åˆ†æ³•ï¼š</strong> ä¸­å¿ƒå·®åˆ†æ³•ä½¿ç”¨å‡½æ•°åœ¨å½“å‰ç‚¹çš„å‰åä¸¤ä¸ªé‚»è¿‘ç‚¹çš„å‡½æ•°å€¼æ¥è¿‘ä¼¼è®¡ç®—å¯¼æ•°ã€‚å®ƒçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">f'(x) \approx \frac{f(x+h) - f(x-h)}{2h}</script><p>è¿™é‡Œï¼Œ$h$ æ˜¯ä¸€ä¸ªå°çš„æ­£æ•°ï¼Œä»£è¡¨ç‚¹çš„é—´éš”ã€‚</p></li><li><p><strong>å‰å‘å·®åˆ†æ³•ï¼š</strong> å‰å‘å·®åˆ†æ³•ä½¿ç”¨å‡½æ•°åœ¨å½“å‰ç‚¹å’Œè¯¥ç‚¹ä¹‹åçš„ä¸€ä¸ªé‚»è¿‘ç‚¹çš„å‡½æ•°å€¼æ¥è¿‘ä¼¼è®¡ç®—å¯¼æ•°ã€‚å®ƒçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">f'(x) \approx \frac{f(x+h) - f(x)}{h}</script></li><li><p><strong>åå‘å·®åˆ†æ³•ï¼š</strong> åå‘å·®åˆ†æ³•ä½¿ç”¨å‡½æ•°åœ¨å½“å‰ç‚¹å’Œè¯¥ç‚¹ä¹‹å‰çš„ä¸€ä¸ªé‚»è¿‘ç‚¹çš„å‡½æ•°å€¼æ¥è¿‘ä¼¼è®¡ç®—å¯¼æ•°ã€‚å®ƒçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">f'(x) \approx \frac{f(x) - f(x-h)}{h}</script></li></ol><p>æ•°å€¼å¾®åˆ†æ–¹æ³•çš„ç²¾åº¦å–å†³äºé—´éš”$h$çš„å¤§å°ï¼Œè¿‡å¤§çš„$h$å¯èƒ½å¼•å…¥è¾ƒå¤§çš„è¿‘ä¼¼è¯¯å·®ï¼Œè€Œè¿‡å°çš„$h$å¯èƒ½å¼•å…¥èˆå…¥è¯¯å·®ã€‚é€‰æ‹©åˆé€‚çš„$h$å€¼æ˜¯ç¡®ä¿æ•°å€¼å¾®åˆ†ç»“æœç²¾åº¦çš„å…³é”®ã€‚</p></blockquote><p>å¯¹äºäºŒé˜¶å¯¼æ•°ï¼Œåˆ™æœ‰ï¼š</p><script type="math/tex; mode=display">\begin{aligned}f^{\prime \prime}(x) & \approx \frac{f^{\prime}(x)-f^{\prime}(x-\Delta x)}{\Delta x} \approx \frac{\frac{f(x+\Delta x)-f(x)}{\Delta x}-\frac{f(x)-f(x-\Delta x)}{\Delta x}}{\Delta x} \\& =\frac{f(x+\Delta x)+f(x-\Delta x)-2 f(x)}{(\Delta x)^2}\end{aligned}</script><p>ä¸‹é¢è€ƒè™‘å¤šå…ƒå‡½æ•°çš„åå¯¼æ•°ã€‚å¯¹äºäºŒå…ƒå‡½æ•°$f(x,y)$ï¼Œå…¶æ‹‰æ™®æ‹‰æ–¯ç®—å­å¯ä»¥ç”¨ä¸‹é¢çš„å…¬å¼è¿‘ä¼¼è®¡ç®—ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\Delta f & =\frac{\partial^2 f}{\partial x^2}+\frac{\partial^2 f}{\partial y^2} \\& \approx \frac{f(x+\Delta x, y)+f(x-\Delta x, y)-2 f(x, y)}{(\Delta x)^2}+\frac{f(x, y+\Delta y)+f(x, y-\Delta y)-2 f(x, y)}{(\Delta y)^2}\end{aligned}</script><h3 id="ç¦»æ•£æ‹‰æ™®æ‹‰æ–¯ç®—å­"><a href="#ç¦»æ•£æ‹‰æ™®æ‹‰æ–¯ç®—å­" class="headerlink" title="ç¦»æ•£æ‹‰æ™®æ‹‰æ–¯ç®—å­"></a>ç¦»æ•£æ‹‰æ™®æ‹‰æ–¯ç®—å­</h3><p>å›¾åƒå’Œå›¾ç»“æ„éƒ½æ˜¯ç¦»æ•£æ•°æ®ï¼Œå…¶æ‹‰æ™®æ‹‰æ–¯ç®—å­å¿…ç„¶è¦è¿›è¡Œç¦»æ•£åŒ–ã€‚å¦‚æœä¸Šé¢çš„äºŒå…ƒå‡½æ•°è¿›è¡Œç¦»æ•£åŒ–ï¼Œå¯¹è‡ªå˜é‡çš„ä¸€ç³»åˆ—ç‚¹å¤„çš„å‡½æ•°å€¼è¿›è¡Œé‡‡æ ·ï¼Œå¾—åˆ°ä¸‹é¢ä¸€ç³»åˆ—ç‚¹å¤„çš„å‡½æ•°å€¼ï¼Œæ„æˆä¸€ä¸ªçŸ©é˜µã€‚</p><script type="math/tex; mode=display">\left[\begin{array}{cccc}f\left(x_1, y_1\right) & f\left(x_2, y_1\right) & \ldots & f\left(x_n, y_1\right) \\f\left(x_1, y_2\right) & f\left(x_2, y_2\right) & \ldots & f\left(x_n, y_2\right) \\\ldots & \ldots & \ldots & \ldots \\f\left(x_1, y_n\right) & f\left(x_2, y_n\right) & \ldots & f\left(x_n, y_n\right)\end{array}\right]</script><p>åœ¨è¿™é‡Œ $x$ ä¸ºæ°´å¹³æ–¹å‘ï¼Œ $y$ ä¸ºå‚ç›´æ–¹å‘ã€‚ä¸ºäº†ç®€åŒ–ï¼Œ å‡è®¾ $x$ å’Œ $y$ çš„å¢é‡ï¼ˆæ­¥é•¿ï¼‰å…¨ä¸º $1$ ï¼Œ å³ï¼š</p><script type="math/tex; mode=display">\Delta x=x_{i+1}-x_i=1, \Delta y=y_{i+1}-y_i=1</script><p>åˆ™ç‚¹ $\left(x_i, y_j\right)$ å¤„çš„æ‹‰æ™®æ‹‰æ–¯ç®—å­å¯ä»¥ç”¨ä¸‹é¢çš„å…¬å¼è¿‘ä¼¼è®¡ç®—ï¼š</p><script type="math/tex; mode=display">\begin{aligned}& \frac{f\left(x_i+\Delta x, y_j\right)+f\left(x_i-\Delta x, y_j\right)-2 f\left(x_i, y_j\right)}{(\Delta x)^2}+\frac{f\left(x_i, y_j+\Delta y\right)+f\left(x_i, y_j-\Delta y\right)-2 f\left(x_i, y_j\right)}{(\Delta y)^2} \\& \quad=\frac{f\left(x_{i+1}, y_j\right)+f\left(x_{i-1}, y_j\right)-2 f\left(x_i, y_j\right)}{1^2}+\frac{f\left(x_i, y_{j+1}\right)+f\left(x_i, y_{j-1}\right)-2 f\left(x_i, y_j\right)}{1^2} \\& \quad=f\left(x_{i+1}, y_j\right)+f\left(x_{i-1}, y_j\right)+f\left(x_i, y_{j+1}\right)+f\left(x_i, y_{j-1}\right)-4 f\left(x_i, y_j\right)\end{aligned}</script><p>è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç¾çš„ç»“æœï¼Œ å®ƒå°±æ˜¯ $\left(x_i, y_j\right)$ çš„ 4 ä¸ªç›¸é‚»ç‚¹å¤„çš„å‡½æ•°å€¼ä¹‹å’Œä¸ $\left(x_i, y_j\right)$ ç‚¹å¤„çš„å‡½æ•°å€¼ä¹˜ä»¥ 4 åçš„å·®å€¼ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/assets/post_img/article117/lisan-lapo.png" alt="lisan"></p><p>åŸºäºè¿™ç§ç¦»æ•£è¡¨ç¤ºï¼Œæ‹‰æ™®æ‹‰æ–¯ç®—å­çš„è®¡ç®—å…¬å¼å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\Delta f & =f\left(x_{i+1}, y_j\right)+f\left(x_{i-1}, y_j\right)+f\left(x_i, y_{j+1}\right)+f\left(x_i, y_{j-1}\right)-4 f\left(x_i, y_j\right) \\& =f\left(x_{i+1}, y_j\right)-f\left(x_i, y_j\right)+f\left(x_{i-1}, y_j\right)-f\left(x_i, y_j\right) \\& +f\left(x_i, y_{j+1}\right)-f\left(x_i, y_j\right)+f\left(x_i, y_{j-1}\right)-f\left(x_i, y_j\right) \\& =\sum_{(k, l) \in N(i, j)}\left(f\left(x_k, y_l\right)-f\left(x_i, y_j\right)\right)\end{aligned}</script><p>å…¶ä¸­ $N(i, j)$ æ˜¯ $\left(x_i, y_j\right)$ é‚»å±…èŠ‚ç‚¹çš„é›†åˆã€‚</p><p>è¿™ä¹Ÿç»™æˆ‘ä»¬ä¸€ç§å½¢è±¡çš„ç»“è®ºï¼šäºŒç»´ç½‘æ ¼ï¼ˆç¦»æ•£äºŒå…ƒå‡½æ•°ï¼‰ä¸Šè®¡ç®—æŸç‚¹çš„æ‹‰æ™®æ‹‰æ–¯ç®—å­å°±æ˜¯è®¡ç®—ä¸Šä¸‹å·¦å³å››ä¸ªè‡ªç”±åº¦ä¸Šçš„â€œå˜åŒ–å’Œâ€ã€‚</p><p>PSï¼šå˜åŒ–å’Œæ˜¯ç¬”è€…çš„ä¸ªäººç†è§£ï¼Œä¹Ÿæœ‰äººè¯´æ˜¯â€œå¾®å°å˜åŒ–åè·å¾—çš„å¢ç›Šâ€ã€‚å¦å¤–ï¼Œå¯¹äºäºŒç»´ç½‘æ ¼ï¼Œä¹Ÿå¯ä»¥æ‹“å±•å‡ºå…«ä¸ªè‡ªç”±åº¦çš„æ‹‰æ™®æ‹‰æ–¯ç®—å­ã€‚</p><h3 id="å›¾ä¸Šçš„æ‹‰æ™®æ‹‰æ–¯ç®—å­"><a href="#å›¾ä¸Šçš„æ‹‰æ™®æ‹‰æ–¯ç®—å­" class="headerlink" title="å›¾ä¸Šçš„æ‹‰æ™®æ‹‰æ–¯ç®—å­"></a>å›¾ä¸Šçš„æ‹‰æ™®æ‹‰æ–¯ç®—å­</h3><p>åœ¨å›¾ä¸­ï¼Œé¡¶ç‚¹çš„è¿æ¥å…³ç³»æ˜¯ä»»æ„çš„ï¼Œè¿™æ„å‘³ç€é¡¶ç‚¹çš„é‚»å±…èŠ‚ç‚¹æ•°é‡ä¸å›ºå®šã€‚å°†æ‹‰æ™®æ‹‰æ–¯ç®—å­æ¨å¹¿åˆ°å›¾ä¸Šï¼Œå¦‚æœå°†å›¾çš„é¡¶ç‚¹å¤„çš„å€¼çœ‹ä½œæ˜¯å‡½æ•°å€¼ï¼Œåˆ™åœ¨é¡¶ç‚¹$i$å¤„çš„æ‹‰æ™®æ‹‰æ–¯ç®—å­ä¸ºï¼š</p><script type="math/tex; mode=display">\Delta f_i=\sum_{j \in N_i}\left(f_i-f_j\right)</script><p>å…¶ä¸­ $N_i$ æ˜¯é¡¶ç‚¹ $i$ çš„æ‰€æœ‰é‚»å±…é¡¶ç‚¹çš„é›†åˆã€‚è¿™é‡Œæˆ‘ä»¬è°ƒæ¢äº† $f_i$ å’Œ $f_j$ çš„ä½ç½®ï¼Œ å’Œä¹‹å‰çš„æ‹‰æ™®æ‹‰æ–¯ç®—å­ç›¸æ¯”ï¼Œ ç›¸å½“äºå¤šäº†ä¸€ä¸ªè´Ÿå·ã€‚ç”±äºå›¾çš„è¾¹å¯ä»¥å¸¦æœ‰æƒé‡ï¼Œ æˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢çš„è®¡ç®—å…¬å¼ä¸­åŠ ä¸Šæƒé‡ï¼š</p><script type="math/tex; mode=display">\Delta f_i=\sum_{j \in N_i} w_{i j}\left(f_i-f_j\right)</script><p>å¦‚æœ $j$ ä¸æ˜¯ $i$ çš„é‚»å±…, åˆ™ $w_{i j}=0$ ã€‚å› æ­¤ä¸Šé¢çš„å¼å­ä¹Ÿå¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p><script type="math/tex; mode=display">\Delta f_i=\sum_{j \in V} w_{i j}\left(f_i-f_j\right)=\sum_{j \in V} w_{i j} f_i-\sum_{j \in V} w_{i j} f_j=d_i f_i-\mathbf{w}_i \mathbf{f}</script><p>è¿™é‡Œçš„ $d_i$ æ˜¯é¡¶ç‚¹ $i$ çš„åŠ æƒåº¦ï¼Œ$w_i$ æ˜¯é‚»æ¥çŸ©é˜µçš„ç¬¬ $i$ è¡Œ, $f$ æ˜¯æ‰€æœ‰é¡¶ç‚¹çš„å€¼æ„æˆçš„åˆ—å‘é‡, $w_i f$ æ˜¯äºŒè€…çš„å†…ç§¯ã€‚å¯¹äºå›¾çš„æ‰€æœ‰é¡¶ç‚¹, æœ‰</p><script type="math/tex; mode=display">\begin{aligned}\Delta f & =\left[\begin{array}{c}\Delta f_1 \\\ldots \\\Delta f_n\end{array}\right]=\left[\begin{array}{c}d_1 f_1-\mathbf{w}_1 \mathbf{f} \\\ldots \\d_n f_n-\mathbf{w}_n \mathbf{f}\end{array}\right]=\left[\begin{array}{ccc}d_1 & \ldots & \ldots \\\ldots & \ldots & \ldots \\\ldots & \ldots & d_n\end{array}\right]\left[\begin{array}{c}f_1 \\\ldots \\f_n\end{array}\right]-\left[\begin{array}{c}\mathbf{w}_1 \\\ldots \\\mathbf{w}_n\end{array}\right]\left[\begin{array}{c}f_1 \\\ldots \\f_n\end{array}\right] \\& =(\mathbf{D}-\mathbf{A}) \mathbf{f}\end{aligned}</script><p>ä¸Šå¼çš„å…¨ç§°æ˜¯ï¼šå›¾æ‹‰æ™®æ‹‰æ–¯ç®—å­ä½œç”¨åœ¨ç”±å›¾èŠ‚ç‚¹ä¿¡æ¯æ„æˆçš„å‘é‡$f$ä¸Šå¾—åˆ°çš„ç»“æœç­‰äº<strong>å›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µ</strong>å’Œå‘é‡$f$çš„ç‚¹ç§¯ã€‚</p><p>è¿™ä¹Ÿè¯´æ˜ï¼Œ<strong>åœ¨å›¾ä¸Šï¼Œæ‹‰æ™®æ‹‰æ–¯ç®—å­ç­‰äºæ‹‰æ™®æ‹‰æ–¯çŸ©é˜µ</strong>ã€‚</p><h3 id="å›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼ˆLaplacian-Matrixï¼‰"><a href="#å›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼ˆLaplacian-Matrixï¼‰" class="headerlink" title="å›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼ˆLaplacian Matrixï¼‰"></a>å›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼ˆLaplacian Matrixï¼‰</h3><p>ç”±æ­¤ï¼Œæˆ‘ä»¬æ¨å‡ºäº†æ— å‘å›¾ä¸Šå®šä¹‰æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„ä¸€ç§æ–¹å¼ï¼š</p><script type="math/tex; mode=display">L = D - A</script><p>å…¶ä¸­ï¼Œ$L$æ˜¯å›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼Œ$D$æ˜¯åŠ æƒåº¦çŸ©é˜µï¼ˆWeighted Degree Matrixï¼‰ï¼Œ$A$æ˜¯é‚»æ¥çŸ©é˜µï¼ˆAdjacency Matrixï¼‰ã€‚</p><p>ç”±äº$D$ å’Œ $A$éƒ½æ˜¯å¯¹ç§°çŸ©é˜µï¼Œåˆ™æ— å‘å›¾çš„æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µä¹Ÿæ˜¯å¯¹ç§°çŸ©é˜µï¼Œå®ƒå®é™…ä¸Šä»£è¡¨äº†å›¾çš„äºŒé˜¶å¯¼æ•°ã€‚</p><p>æ˜¾ç„¶æ— å‘å›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µæ¯ä¸€è¡Œå…ƒç´ ä¹‹å’Œéƒ½ä¸º 0 ã€‚ä¸‹é¢ä»‹ç»æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„è‹¥å¹²é‡è¦æ€§è´¨ï¼ˆçœç•¥è¯æ˜ï¼‰ï¼š</p><p>1ã€å¯¹ä»»æ„å‘é‡ $\mathbf{f} \in \mathbb{R}^n$ æœ‰ï¼š</p><script type="math/tex; mode=display">\mathbf{f}^{\mathrm{T}} \mathbf{L} \mathbf{f}=\frac{1}{2} \sum_{i=1}^n \sum_{j=1}^n w_{i j}\left(f_i-f_j\right)^2</script><p>2ã€æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µæ˜¯å¯¹ç§°åŠæ­£å®šçŸ©é˜µ;</p><p>3ã€æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„æœ€å°ç‰¹å¾å€¼ä¸º 0 ï¼Œå…¶å¯¹åº”çš„ç‰¹å¾å‘é‡ä¸ºå¸¸å‘é‡ 1 ï¼Œå³æ‰€æœ‰åˆ†é‡ä¸º 1 ;</p><p>4ã€æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µæœ‰ $n$ ä¸ªéè´Ÿå®æ•°ç‰¹å¾å€¼ï¼Œå¹¶ä¸”æ»¡è¶³ï¼š</p><script type="math/tex; mode=display">0=\lambda_1 \leq \lambda_2 \leq \ldots \leq \lambda_n</script><p>5ï¼ˆç»“è®ºï¼‰ã€å‡è®¾ $G$ æ˜¯ä¸€ä¸ªæœ‰éè´Ÿæƒé‡çš„æ— å‘å›¾ï¼Œå…¶æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µ $L$ çš„ç‰¹å¾å€¼0çš„é‡æ•° $k$ ç­‰äºå›¾çš„è”é€šåˆ†é‡çš„ä¸ªæ•°$A_1ï¼Œ \ldots, A_k$ã€‚ç‰¹å¾å€¼0çš„ç‰¹å¾ç©ºé—´ç”±è¿™äº›è”é€šåˆ†é‡æ‰€å¯¹åº”çš„ç‰¹å¾å‘é‡$\mathbf{1}_{A_1}ï¼Œ \ldots, \mathbf{1}_{A_k}$æ‰€å¼ æˆã€‚</p><p>å¯¹äºç»“è®º5ï¼Œä¸¾ä¸€ä¸ªä¾‹å­è¿›è¡Œè¯´æ˜ï¼š</p><p><img src="/assets/post_img/article117/jl5.png" alt="jl5"></p><p>ä¸Šå›¾æœ‰ä¸¤ä¸ªè”é€šå­å›¾ï¼Œå…¶é‚»æ¥çŸ©é˜µä¸ºï¼š</p><script type="math/tex; mode=display">\mathbf{A}=\left[\begin{array}{ccccc}0 & 0.37 & 0.37 & 0 & 0 \\0.37 & 0 & 0.14 & 0 & 0 \\0.37 & 0.14 & 0 & 0 & 0 \\0 & 0 & 0 & 0 & 0.37 \\0 & 0 & 0 & 0.37 & 0\end{array}\right]</script><p>å…¶åŠ æƒåº¦çŸ©é˜µä¸ºï¼š</p><script type="math/tex; mode=display">\mathbf{D}=\left[\begin{array}{ccccc}0.74 & 0 & 0 & 0 & 0 \\0 & 0.51 & 0 & 0 & 0 \\0 & 0 & 0.51 & 0 & 0 \\0 & 0 & 0 & 0.37 & 0 \\0 & 0 & 0 & 0 & 0.37\end{array}\right]</script><p>æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µä¸ºï¼š</p><script type="math/tex; mode=display">\mathbf{L}=\mathbf{D}-\mathbf{A}=\left[\begin{array}{ccccc}0.74 & -0.37 & -0.37 & 0 & 0 \\-0.37 & 0.51 & -0.14 & 0 & 0 \\-0.37 & -0.14 & 0.51 & 0 & 0 \\0 & 0 & 0 & 0.37 & -0.37 \\0 & 0 & 0 & -0.37 & 0.37\end{array}\right]</script><p>å®ƒç”±å¦‚ä¸‹ä¸¤ä¸ªå­çŸ©é˜µæ„æˆï¼š</p><script type="math/tex; mode=display">\begin{aligned}& \mathbf{L}_1=\left[\begin{array}{ccc}0.74 & -0.37 & -0.37 \\-0.37 & 0.51 & -0.14 \\-0.37 & -0.14 & 0.51\end{array}\right] \\& \mathbf{L}_2=\left[\begin{array}{cc}0.37 & -0.37 \\-0.37 & 0.37\end{array}\right]\end{aligned}</script><p>æ¯ä¸ªå­çŸ©é˜µå¯¹åº”äºå›¾çš„ä¸€ä¸ªè”é€šåˆ†é‡ã€‚0 æ˜¯æ¯ä¸ªå­çŸ©é˜µçš„ 1 é‡ç‰¹å¾å€¼ï¼Œç”±äºæœ‰ä¸¤ä¸ªè”é€šåˆ†é‡ï¼Œå› æ­¤ 0 æ˜¯æ•´ä¸ªå›¾çš„æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„ 2 é‡ç‰¹å¾å€¼ã€‚ä¸¤ä¸ªçº¿æ€§æ— å…³çš„ç‰¹å¾å‘é‡ä¸ºï¼š</p><script type="math/tex; mode=display">\begin{aligned}& \mathbf{1}_{A_1}=\left[\begin{array}{lllll}1 & 1 & 1 & 0 & 0\end{array}\right]^{\mathrm{T}} \\& \mathbf{1}_{A_2}=\left[\begin{array}{lllll}0 & 0 & 0 & 1 & 1\end{array}\right]^{\mathrm{T}}\end{aligned}</script><h3 id="å½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼ˆNormalized-Laplacian-Matrixï¼‰"><a href="#å½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼ˆNormalized-Laplacian-Matrixï¼‰" class="headerlink" title="å½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼ˆNormalized Laplacian Matrixï¼‰"></a>å½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼ˆNormalized Laplacian Matrixï¼‰</h3><p>å›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µæœ‰ä¸¤ç§å½¢å¼çš„å½’ä¸€åŒ–ã€‚</p><p>ç¬¬ä¸€ç§ç§°ä¸º<strong>å¯¹ç§°å½’ä¸€åŒ–</strong>ï¼Œå®šä¹‰ä¸ºï¼š</p><script type="math/tex; mode=display">\mathbf{L}_{\text {sym }}=\mathbf{D}^{-1 / 2} \mathbf{L D}^{-1 / 2}=\mathbf{I}-\mathbf{D}^{-1 / 2} \mathbf{A} \mathbf{D}^{-1 / 2}</script><p>è¿™é‡Œ $D^{1 / 2}$ æ˜¯ $D$ çš„æ‰€æœ‰å…ƒç´ è®¡ç®—æ­£å¹³æ–¹æ ¹å¾—åˆ°çš„çŸ©é˜µã€‚ä½ç½®ä¸º $(i . j), i \neq j$ çš„å…ƒç´ ä¸ºå°†æœªå½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µå¯¹åº”ä½ç½®å¤„çš„å…ƒç´  $l_{i j}$ é™¤ä»¥ $\sqrt{d_{i i} d_{j j}}$ åå½¢æˆçš„ï¼Œä¸»å¯¹è§’çº¿ä¸Šçš„å…ƒç´ ä¸º 1 ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\mathbf{L}_{\mathrm{sym}} & =\left[\begin{array}{cccc}1 / \sqrt{d_{11}} & 0 & \ldots & 0 \\0 & 1 / \sqrt{d_{22}} & \ldots & 0 \\\ldots & \ldots & \ldots & \ldots \\0 & 0 & \ldots & 1 / \sqrt{d_{n n}}\end{array}\right]\left[\begin{array}{cccc}l_{11} & l_{12} & \ldots & l_{1 n} \\l_{21} & l_{22} & \ldots & l_{2 n} \\\ldots & \ldots & \ldots & \ldots \\l_{n 1} & l_{n 2} & \ldots & l_{n n}\end{array}\right]\left[\begin{array}{cccc}1 / \sqrt{d_{11}} & 0 & \ldots & 0 \\0 & 1 / \sqrt{d_{22}} & \ldots & 0 \\\ldots & \ldots & \ldots & \ldots \\0 & 0 & \ldots & 1 / \sqrt{d_{n n}}\end{array}\right] \\& =\left[\begin{array}{cccc}1 & l_{12} / \sqrt{d_{11} d_{22}} & \ldots & l_{1 n} / \sqrt{d_{11} d_{n n}} \\l_{21} / \sqrt{d_{22} d_{11}} & 1 & \ldots & l_{2 n} / \sqrt{d_{22} d_{n n}} \\\ldots & \ldots & \ldots & \ldots \\l_{n 1} / \sqrt{d_{n n} d_{11}} & l_{n 2} / \sqrt{d_{n n} d_{22}} & \ldots & 1\end{array}\right]\end{aligned}</script><p>ç”±äº $D^{1 / 2}$ å’Œ $L$ éƒ½æ˜¯å¯¹ç§°çŸ©é˜µ, å› æ­¤ $L_{sym}$ ä¹Ÿæ˜¯å¯¹ç§°çŸ©é˜µã€‚å¦‚æœå›¾æ˜¯è”é€šçš„ï¼Œåˆ™ $D$ å’Œ $D^{1 / 2}$ éƒ½æ˜¯å¯é€†çš„å¯¹è§’çŸ©é˜µï¼Œå…¶é€†çŸ©é˜µåˆ†åˆ«ä¸ºå…¶ä¸»å¯¹è§’çº¿å…ƒç´ çš„é€†ã€‚</p><p>ç¬¬äºŒç§ç§°ä¸º<strong>éšæœºæ¼«æ­¥å½’ä¸€åŒ–</strong>ï¼Œå®šä¹‰ä¸ºï¼š</p><script type="math/tex; mode=display">\mathbf{L}_{\mathrm{rw}}=\mathbf{D}^{-1} \mathbf{L}=\mathbf{I}-\mathbf{D}^{-1} \mathbf{A}</script><p>å…¶ä½ç½®ä¸º $(i, j), i \neq j$ çš„å…ƒç´ ä¸ºå°†æœªå½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µå¯¹åº”ä½ç½®å¤„çš„å…ƒç´  $l_{i j}$ é™¤ä»¥ $d_{i i}$ åå½¢æˆçš„ï¼Œä¸»å¯¹è§’çº¿å…ƒç´ ä¹Ÿä¸º 1ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\mathbf{L}_{\mathrm{rw}} & =\left[\begin{array}{cccc}1 / d_{11} & 0 & \ldots & 0 \\0 & 1 / d_{22} & \ldots & 0 \\\ldots & \ldots & \ldots & \ldots \\0 & 0 & \ldots & 1 / d_{n n}\end{array}\right]\left[\begin{array}{cccc}l_{11} & l_{12} & \ldots & l_{1 n} \\l_{21} & l_{22} & \ldots & l_{2 n} \\\ldots & \ldots & \ldots & \ldots \\l_{n 1} & l_{n 2} & \ldots & l_{n n}\end{array}\right] \\& =\left[\begin{array}{cccc}1 & l_{12} / d_{11} & \ldots & l_{1 n} / d_{11} \\l_{21} / d_{22} & 1 & \ldots & l_{2 n} / d_{22} \\\ldots & \ldots & \ldots & \ldots \\l_{n 1} / d_{n n} & l_{n 2} / d_{n n} & \ldots & 1\end{array}\right]\end{aligned}</script><p>ä¸‹é¢ä»‹ç»è¿™ä¸¤ç§å½’ä¸€åŒ–çŸ©é˜µçš„è‹¥å¹²é‡è¦æ€§è´¨ï¼š</p><p>1ã€å¯¹ä»»æ„å‘é‡ $\mathbf{f} \in \mathbb{R}^n$ æœ‰ï¼š</p><script type="math/tex; mode=display">\mathbf{f}^{\mathrm{T}} \mathbf{L}_{\mathrm{sym}} \mathbf{f}=\frac{1}{2} \sum_{i=1}^n \sum_{j=1}^n w_{i j}\left(\frac{f_i}{\sqrt{d_i}}-\frac{f_j}{\sqrt{d_j}}\right)^2</script><p>2ã€$\lambda$ æ˜¯çŸ©é˜µ $L_{rw}$ çš„ç‰¹å¾å€¼ï¼Œ$\mu$ æ˜¯ç‰¹å¾å‘é‡, å½“ä¸”ä»…å½“ $\lambda$ æ˜¯ $L_{sym}$ çš„ç‰¹å¾å€¼ä¸”å…¶ç‰¹å¾å‘é‡ä¸º $w=D^{1 / 2} \mu$ã€‚</p><p>3ã€$\mu$ æ˜¯çŸ©é˜µ $L_{rw}$ çš„ç‰¹å¾å€¼ï¼Œ$\mu$ æ˜¯å¯¹åº”çš„ç‰¹å¾å‘é‡ï¼Œå½“ä¸”ä»…å½“ $\lambda$ å’Œ $\mu$ æ˜¯å¹¿ä¹‰ç‰¹å¾å€¼é—®é¢˜ $L u=\lambda D u$ çš„è§£ã€‚</p><p>4ã€0 æ˜¯çŸ©é˜µ $L_{rw}$ çš„ç‰¹å¾å€¼ï¼Œå…¶å¯¹åº”çš„ç‰¹å¾å‘é‡ä¸ºå¸¸å‘é‡ 1 ï¼Œå³æ‰€æœ‰åˆ†é‡ä¸º 1ã€‚ 0 æ˜¯çŸ©é˜µ $L_{sym}$ çš„ç‰¹å¾å€¼ï¼Œå…¶å¯¹åº”çš„ç‰¹å¾å‘é‡ä¸º $D^{1 / 2} 1$ ã€‚</p><p>5ã€çŸ©é˜µ $L_{sym}$ å’Œ $L_{rw}$ æ˜¯åŠæ­£å®šçŸ©é˜µï¼Œæœ‰ $n$ ä¸ªéè´Ÿå®æ•°ç‰¹å¾å€¼, å¹¶ä¸”æ»¡è¶³ï¼š</p><script type="math/tex; mode=display">0=\lambda_1 \leq \lambda_2 \leq \ldots \leq \lambda_n</script><p>6ï¼ˆç»“è®ºï¼‰ã€å’Œæœªå½’ä¸€åŒ–çš„æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µç±»ä¼¼ï¼Œå‡è®¾ $G$ æ˜¯ä¸€ä¸ªæœ‰éè´Ÿæƒé‡çš„æ— å‘å›¾ï¼Œå…¶å½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µ $L_{rw}$ å’Œ $L_{sym}$ çš„ç‰¹å¾å€¼0çš„é‡æ•° $k$ ç­‰äºå›¾çš„è”é€šåˆ†é‡çš„ä¸ªæ•° $A_1, \ldots, A_k$ ã€‚</p><p>å¯¹äºçŸ©é˜µ $L_{rw}$ï¼Œç‰¹å¾å€¼0çš„ç‰¹å¾ç©ºé—´ç”±è¿™äº›è”é€šåˆ†é‡æ‰€å¯¹åº”çš„å‘é‡ $1_{A_1}, \ldots, 1_{A_k}$ æ‰€å¼ æˆã€‚ $1_{A_i}$ çš„å®šä¹‰ä¸æœªå½’ä¸€åŒ–æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µ0ç‰¹å¾å€¼çš„ç‰¹å¾å‘é‡ç›¸åŒã€‚</p><p>å¯¹äºçŸ©é˜µ $L_{sym}$, ç‰¹å¾å€¼Oçš„ç‰¹å¾ç©ºé—´ç”±è¿™äº›è”é€šåˆ†é‡æ‰€å¯¹åº”çš„å‘é‡ $\mathbf{D}^{1 / 2} \mathbf{1}_{A_1}, \ldots, \mathbf{D}^{1 / 2} \mathbf{1}_{A_k}$ æ‰€å¼ æˆã€‚</p><h2 id="æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„è°±åˆ†è§£ï¼ˆSpectral-Decompositionï¼‰"><a href="#æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„è°±åˆ†è§£ï¼ˆSpectral-Decompositionï¼‰" class="headerlink" title="æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„è°±åˆ†è§£ï¼ˆSpectral Decompositionï¼‰"></a>æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„è°±åˆ†è§£ï¼ˆSpectral Decompositionï¼‰</h2><p>åœ¨çŸ©é˜µèŒƒå›´å†…ï¼Œä¸è€ƒè™‘è¿‡äºå¤æ‚çš„æ•°å­¦æ¦‚å¿µï¼Œè°±åˆ†è§£åˆç§°ä¸ºç‰¹å¾å€¼åˆ†è§£ï¼Œåªæœ‰æ–¹é˜µæ‰èƒ½è¿›è¡Œè°±åˆ†è§£ã€‚</p><blockquote><p><strong>ç‰¹å¾å‘é‡ï¼ˆEigenvectorsï¼‰</strong>ï¼šä¸€ä¸ªçŸ©é˜µçš„ç‰¹å¾å‘é‡æ˜¯æŒ‡ä¸€ä¸ªéé›¶å‘é‡ï¼Œå…¶åœ¨ç»è¿‡çŸ©é˜µå˜æ¢ååªå‘ç”Ÿäº†ä¼¸ç¼©è€Œæ²¡æœ‰æ”¹å˜æ–¹å‘ï¼Œåªç›¸å·®äº†ä¸€ä¸ªå¸¸æ•°å€æ•°ã€‚æ¢å¥è¯è¯´ï¼ŒçŸ©é˜µä¹˜ä»¥ç‰¹å¾å‘é‡åï¼Œç›¸å½“äºå¯¹è¯¥å‘é‡è¿›è¡Œäº†ä¸€ä¸ªæ¯”ä¾‹çš„æ‹‰ä¼¸ã€‚</p><p><strong>ç‰¹å¾å€¼ï¼ˆEigenvaluesï¼‰</strong>ï¼šç‰¹å¾å€¼æ˜¯å¯¹åº”äºç‰¹å¾å‘é‡çš„æ ‡é‡ï¼Œå®ƒè¡¨ç¤ºäº†åœ¨ç‰¹å¾å‘é‡è¿›è¡ŒçŸ©é˜µå˜æ¢åçš„ä¼¸ç¼©å€æ•°ã€‚ä¸€ä¸ªçŸ©é˜µå¯ä»¥æœ‰å¤šä¸ªç‰¹å¾å‘é‡å’Œå¯¹åº”çš„ç‰¹å¾å€¼ã€‚</p></blockquote><p>å¯¹äºä¸€ä¸ªæ–¹é˜µ $A$ï¼Œè°±åˆ†è§£çš„åŸºæœ¬æ€æƒ³æ˜¯å°†å®ƒè¡¨ç¤ºä¸ºç‰¹å¾å‘é‡çŸ©é˜µ $P$ ä¸å¯¹è§’ç‰¹å¾å€¼çŸ©é˜µ $Î›$ ç›¸ä¹˜çš„å½¢å¼ï¼Œå³ $A = P <em> Î› </em> P^{-1} $ã€‚å¦‚æœ $A$ æ˜¯å¯¹ç§°çŸ©é˜µï¼Œåˆ™ $P$ æ˜¯æ­£äº¤çŸ©é˜µï¼Œåˆ™åŸå¼ä¹Ÿå¯å†™ä½œ $A = P <em> Î› </em> P^T$ã€‚</p><p>ç”±äºæ‹‰æ™®æ‹‰æ–¯çŸ©é˜µæ˜¯<strong>å¯¹ç§°åŠæ­£å®š</strong>çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹æ€§è´¨ï¼š<br>1ã€ä¸€å®šæœ‰$n$ä¸ªçº¿æ€§æ— å…³çš„ç‰¹å¾å‘é‡ï¼ˆå¯¹ç§°ï¼‰ã€‚<br>2ã€çŸ©é˜µçš„ç‰¹å¾å€¼ä¸€å®šéè´Ÿï¼ˆåŠæ­£å®šï¼‰ã€‚<br>3ã€çŸ©é˜µçš„ç‰¹å¾å‘é‡ç›¸äº’æ­£äº¤ï¼Œå³æ‰€æœ‰ç‰¹å¾å‘é‡æ„æˆçš„çŸ©é˜µä¸ºæ­£äº¤çŸ©é˜µï¼ˆå¯¹ç§°ï¼‰ã€‚</p><p>æ‰€ä»¥ï¼Œæ‹‰æ™®æ‹‰æ–¯çŸ©é˜µ $L$ çš„è°±åˆ†è§£ä¹Ÿå¯ä»¥å†™æˆ $P <em> Î› </em> P^T$ çš„å½¢å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><script type="math/tex; mode=display">\boldsymbol{L}=\boldsymbol{\Phi} \boldsymbol{\Lambda} \boldsymbol{\Phi}^{\top}</script><p>$\Phi=\left(\phi_1, \phi_2, \ldots, \phi_n\right) \in \mathbb{R}^{\mathrm{n} \times n}$ æ˜¯æ­£äº¤çŸ©é˜µï¼Œå…¶åˆ—å‘é‡ä¸ºå•ä½ç‰¹å¾å‘é‡ã€‚<br>$\Lambda=\operatorname{diag}\left(\lambda_1, \ldots, \lambda_n\right)$ æ˜¯ç”±å¯¹åº”ç‰¹å¾å€¼æ„æˆçš„å¯¹è§’çŸ©é˜µã€‚</p><h2 id="ç‹„åˆ©å…‹é›·èƒ½é‡ï¼ˆDirichlet-Energyï¼‰"><a href="#ç‹„åˆ©å…‹é›·èƒ½é‡ï¼ˆDirichlet-Energyï¼‰" class="headerlink" title="ç‹„åˆ©å…‹é›·èƒ½é‡ï¼ˆDirichlet Energyï¼‰"></a>ç‹„åˆ©å…‹é›·èƒ½é‡ï¼ˆDirichlet Energyï¼‰</h2><p>ç‹„åˆ©å…‹é›·èƒ½é‡è¡¡é‡äº†å‡½æ•°çš„å¹³æ»‘æ€§ï¼ˆSmoothnessï¼‰ï¼Œè¶Šå°è¯´æ˜å‡½æ•°è¶Šå¹³æ»‘ã€‚ç‹„åˆ©å…‹é›·èƒ½é‡å®šä¹‰ä¸º:</p><script type="math/tex; mode=display">\mathrm{E}_{\mathrm{Dir}}(\boldsymbol{f})=\boldsymbol{f}^{\top} \boldsymbol{\Delta} \boldsymbol{f}</script><p>å…¶ä¸­$f$ æ˜¯å‡½æ•°ï¼Œ$\Delta$ æ˜¯æ‹‰æ™®æ‹‰æ–¯ç®—å­ã€‚æ•´ä¸ªå…¬å¼åœ¨å›¾ç»“æ„ä¸Šçš„å«ä¹‰æ˜¯ï¼Œè®¡ç®—å‡½æ•°$\boldsymbol{f}$åœ¨å›¾çš„èŠ‚ç‚¹ä¸Šçš„å˜åŒ–ç¨‹åº¦ï¼Œå…¶ä¸­å˜åŒ–ç¨‹åº¦é€šè¿‡å°†å‡½æ•°$\boldsymbol{f}$æ˜ å°„åˆ°æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µçš„ç©ºé—´ï¼ˆ$\boldsymbol{\Delta} \boldsymbol{f}$ï¼‰ï¼Œå¹¶è®¡ç®—æ˜ å°„åçš„å‘é‡ä¸åŸå‘é‡çš„å†…ç§¯æ¥è¡¡é‡ã€‚</p><p>åœ¨å›¾è®ºä¸­ï¼Œç‹„åˆ©å…‹é›·èƒ½é‡è¶Šå°è¡¨ç¤ºå›¾ä¸­èŠ‚ç‚¹çš„å‡½æ•°åœ¨ç©ºé—´ä¸­å˜åŒ–è¶Šå¹³æ»‘ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥æˆ–å…³ç³»è¶Šç´§å¯†ã€‚è¿™å¯ä»¥ç”¨äºé‡åŒ–å›¾ä¸­çš„å¹³æ»‘æ€§å’Œè¿é€šæ€§ã€‚</p><p>é‚£ä¹ˆï¼Œ<strong>ç‹„åˆ©å…‹é›·èƒ½é‡æœ€å°åŒ–é—®é¢˜å¯¹æ¨å¹¿å›¾å‚…ç«‹å¶å˜æ¢æœ‰ä»€ä¹ˆå¸®åŠ©å‘¢</strong>ï¼Ÿ</p><p>å›¾å‚…ç«‹å¶å˜æ¢æ˜¯å°†ä¸€ä¸ªå®šä¹‰åœ¨å›¾çš„èŠ‚ç‚¹ä¸Šçš„å‡½æ•°æ˜ å°„åˆ°é¢‘è°±åŸŸï¼Œç±»ä¼¼äºä¿¡å·å¤„ç†ä¸­çš„å‚…ç«‹å¶å˜æ¢ã€‚åœ¨è¿ç»­ä¿¡å·çš„æƒ…å†µä¸‹ï¼Œå‚…ç«‹å¶å˜æ¢å°†ä¿¡å·åˆ†è§£ä¸ºä¸åŒé¢‘ç‡çš„æ­£å¼¦å’Œä½™å¼¦å‡½æ•°ã€‚ç±»ä¼¼åœ°ï¼Œåœ¨å›¾ä¸Šï¼Œå›¾å‚…ç«‹å¶å˜æ¢å°†ä¸€ä¸ªå‡½æ•°åˆ†è§£ä¸ºå›¾ä¸­çš„åŸºå‡½æ•°ï¼Œ<strong>è¿™äº›åŸºå‡½æ•°ç”±ç‹„åˆ©å…‹é›·èƒ½é‡æœ€å°åŒ–é—®é¢˜å¾—åˆ°</strong>ã€‚</p><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¯»æ‰¾å›¾ä¸Šç‹„åˆ©å…‹é›·èƒ½é‡æœ€å°çš„ä¸€ç»„å•ä½æ­£äº¤åŸºï¼ˆæ¯ä¸ªåŸºéƒ½å¯ä»¥çœ‹æˆå‡½æ•°ï¼‰ã€‚ å·§åˆçš„æ˜¯ï¼Œè¿™æ ·çš„æ­£äº¤åŸºæ­£å¥½å°±æ˜¯å¯¹æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µ $L$ è¿›è¡Œè°±åˆ†è§£å¾—åˆ°çš„å•ä½ç‰¹å¾å‘é‡ $\phi_1, \ldots, \phi_n$ ã€‚ è¿™å¯¹æˆ‘ä»¬ä»ä¼ ç»Ÿå‚…é‡Œå¶å˜æ¢æ¨å¹¿åˆ°å›¾ä¸Šå‚…é‡Œå¶å˜æ¢æ—¶è¿›è¡Œçš„ç±»æ¯”å’Œæ›¿æ¢æä¾›äº†ç†è®ºè§£é‡Šã€‚</p><h2 id="å›¾å‚…ç«‹å¶å˜æ¢ï¼ˆGraph-Fourier-Transformationï¼‰"><a href="#å›¾å‚…ç«‹å¶å˜æ¢ï¼ˆGraph-Fourier-Transformationï¼‰" class="headerlink" title="å›¾å‚…ç«‹å¶å˜æ¢ï¼ˆGraph Fourier Transformationï¼‰"></a>å›¾å‚…ç«‹å¶å˜æ¢ï¼ˆGraph Fourier Transformationï¼‰</h2><p>ç®€å•å›é¡¾å‚…ç«‹å¶å˜æ¢ï¼Œç„¶åæ¨å¹¿åˆ°å›¾ã€‚</p><h3 id="å‚…ç«‹å¶å˜æ¢ï¼ˆFourier-Transformationï¼‰"><a href="#å‚…ç«‹å¶å˜æ¢ï¼ˆFourier-Transformationï¼‰" class="headerlink" title="å‚…ç«‹å¶å˜æ¢ï¼ˆFourier Transformationï¼‰"></a>å‚…ç«‹å¶å˜æ¢ï¼ˆFourier Transformationï¼‰</h3><p>å‚…é‡Œå¶å˜æ¢äºå°†ä¸€ä¸ªå‡½æ•°ä»æ—¶é—´ï¼ˆæˆ–ç©ºé—´ï¼‰åŸŸè½¬æ¢åˆ°é¢‘ç‡åŸŸï¼Œä»¥ä¾¿åˆ†æå…¶é¢‘ç‡ç‰¹æ€§ã€‚å‚…é‡Œå¶å˜æ¢å¯ä»¥å°†ä¸€ä¸ªä¿¡å·åˆ†è§£æˆä¸åŒé¢‘ç‡çš„æˆåˆ†ï¼Œä»è€Œæ­ç¤ºå‡ºä¿¡å·çš„é¢‘è°±ä¿¡æ¯ã€‚</p><p>å‚…é‡Œå¶å˜æ¢çš„å…¬å¼å¦‚ä¸‹ï¼š</p><p>å¯¹äºè¿ç»­ä¿¡å·ï¼š</p><script type="math/tex; mode=display">F(\omega) = \int_{-\infty}^{\infty} f(t) e^{-j\omega t} dt</script><p>å¯¹äºç¦»æ•£ä¿¡å·ï¼š</p><script type="math/tex; mode=display">F(k) = \sum_{n=0}^{N-1} f(n) e^{-j\frac{2\pi}{N}kn}</script><p>å…¶ä¸­ï¼Œ$ F(\omega) $ æˆ– $ F(k)$ æ˜¯ä¿¡å·åœ¨é¢‘ç‡åŸŸçš„è¡¨ç¤ºï¼Œ$ f(t) $ æˆ– $ f(n) $ æ˜¯ä¿¡å·åœ¨æ—¶é—´ï¼ˆæˆ–ç©ºé—´ï¼‰åŸŸçš„è¡¨ç¤ºï¼Œ$ \omega $ æ˜¯è§’é¢‘ç‡ï¼Œ$ j $ æ˜¯è™šæ•°å•ä½ï¼Œ $ t $ æˆ– $ n $ æ˜¯æ—¶é—´ï¼ˆæˆ–ç©ºé—´ï¼‰çš„å˜é‡ã€‚</p><p>$F(\omega)$ å°±æ˜¯å‚…é‡Œå¶å˜æ¢ï¼Œå¾—åˆ°çš„å°±æ˜¯é¢‘åŸŸå›¾ï¼Œå®ƒåœ¨ $\omega_0$ çš„å€¼ $F(\omega_0)$ è¡¨ç¤º $f(x)$ åœ¨ $\omega_0$ é¢‘ç‡å¯¹åº”çš„æ­£äº¤åŸºä¸Šçš„ç³»æ•°ã€‚</p><p>ä¸‹é¢ä¸¤è€…ç§°ä¸ºå‚…é‡Œå¶å˜æ¢å¯¹, å¯ä»¥ç›¸äº’è½¬æ¢:</p><script type="math/tex; mode=display">f(x) \Leftrightarrow F(\omega)</script><p>å¦å¤–ï¼Œ$e^{-j\omega t}$ æ˜¯å‚…ç«‹å¶åŸºå‡½æ•°ä¹‹ä¸€ï¼Œä¹Ÿè¢«ç§°ä¸º<strong>å¤æŒ‡æ•°å‡½æ•°</strong>ã€‚å‚…ç«‹å¶å˜æ¢å¯ä»¥å°†ä¸€ä¸ªå‡½æ•°ä»æ—¶åŸŸè½¬æ¢åˆ°é¢‘åŸŸï¼Œå®ƒå°†ä¸€ä¸ªå‡½æ•°è¡¨ç¤ºä¸ºä¸åŒé¢‘ç‡çš„æ­£å¼¦å’Œä½™å¼¦å‡½æ•°çš„å åŠ ã€‚$e^{-j\omega t}$ å°±æ˜¯è¿™äº›æ­£å¼¦å’Œä½™å¼¦å‡½æ•°çš„å¤æ•°å½¢å¼ï¼Œå‚ç…§$e^{jx} = \cos(x) + j \sin(x)$ã€‚</p><h3 id="å‚…ç«‹å¶åŸºå‡½æ•°ï¼ˆFourier-Basis-Functionsï¼‰"><a href="#å‚…ç«‹å¶åŸºå‡½æ•°ï¼ˆFourier-Basis-Functionsï¼‰" class="headerlink" title="å‚…ç«‹å¶åŸºå‡½æ•°ï¼ˆFourier Basis Functionsï¼‰"></a>å‚…ç«‹å¶åŸºå‡½æ•°ï¼ˆFourier Basis Functionsï¼‰</h3><p>å‚…ç«‹å¶åŸºå‡½æ•°ï¼ˆFourier Basis Functionsï¼‰æ˜¯ä¸€ç»„æ­£äº¤å‡½æ•°ï¼Œç”¨äºå±•å¼€å’Œè¡¨ç¤ºä¿¡å·åœ¨é¢‘ç‡åŸŸçš„æˆåˆ†ã€‚åœ¨å‚…ç«‹å¶å˜æ¢ä¸­ï¼ŒåŸå§‹ä¿¡å·å¯ä»¥è¢«åˆ†è§£ä¸ºå„ç§é¢‘ç‡çš„æ­£å¼¦å’Œä½™å¼¦å‡½æ•°çš„çº¿æ€§ç»„åˆï¼Œè€Œè¿™äº›æ­£å¼¦å’Œä½™å¼¦å‡½æ•°å°±æ„æˆäº†å‚…ç«‹å¶åŸºå‡½æ•°ã€‚</p><p>å‚…ç«‹å¶åŸºå‡½æ•°çš„å…·ä½“å½¢å¼å–å†³äºæ˜¯è¿ç»­ä¿¡å·è¿˜æ˜¯ç¦»æ•£ä¿¡å·ã€‚å¯¹äºè¿ç»­ä¿¡å·ï¼Œå‚…ç«‹å¶åŸºå‡½æ•°æ˜¯æ­£å¼¦å’Œä½™å¼¦å‡½æ•°ï¼Œè¡¨è¾¾å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\phi_k(t) = \frac{1}{\sqrt{T}} \cdot \begin{cases} \cos(2\pi kft), & \text{for even}\ k \\ \sin(2\pi kft), & \text{for odd}\ k \end{cases}</script><p>å…¶ä¸­ï¼Œ$k$ ä¸ºé¢‘ç‡ç´¢å¼•ï¼Œ$f$ ä¸ºä¿¡å·çš„åŸºæœ¬é¢‘ç‡ï¼Œ$T$ ä¸ºä¿¡å·çš„å‘¨æœŸã€‚</p><p>å¯¹äºç¦»æ•£ä¿¡å·ï¼Œå‚…ç«‹å¶åŸºå‡½æ•°æ˜¯å¤æŒ‡æ•°å‡½æ•°ï¼Œè¡¨è¾¾å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\phi_k[n] = \frac{1}{\sqrt{N}} \cdot e^{j2\pi kn/N}</script><p>å…¶ä¸­ï¼Œ$k$ ä¸ºé¢‘ç‡ç´¢å¼•ï¼Œ$N$ ä¸ºä¿¡å·çš„æ ·æœ¬ç‚¹æ•°ã€‚</p><p>å‚…ç«‹å¶åŸºå‡½æ•°æ„æˆäº†é¢‘ç‡åŸŸçš„æ­£äº¤åŸºï¼Œæ„å‘³ç€ä¸åŒé¢‘ç‡çš„åŸºå‡½æ•°ä¹‹é—´å½¼æ­¤æ­£äº¤ã€‚é€šè¿‡å°†ä¿¡å·åœ¨å‚…ç«‹å¶åŸºå‡½æ•°ä¸Šçš„æŠ•å½±ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¿¡å·åœ¨ä¸åŒé¢‘ç‡ä¸Šçš„åˆ†é‡ï¼Œä»è€Œå®ç°é¢‘åŸŸåˆ†æã€‚</p><p>å‚…ç«‹å¶åŸºå‡½æ•°æ˜¯å‚…ç«‹å¶å˜æ¢çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒä»¬çš„çº¿æ€§ç»„åˆå¯ä»¥ç”¨æ¥è¡¨ç¤ºä»»ä½•ä¿¡å·ã€‚</p><h3 id="å›¾å‚…ç«‹å¶å˜æ¢"><a href="#å›¾å‚…ç«‹å¶å˜æ¢" class="headerlink" title="å›¾å‚…ç«‹å¶å˜æ¢"></a>å›¾å‚…ç«‹å¶å˜æ¢</h3><p>é¦–å…ˆï¼Œåœ¨å›¾ä¸Šï¼Œæ‹‰æ™®æ‹‰æ–¯ç®—å­ç­‰äºæ‹‰æ™®æ‹‰æ–¯çŸ©é˜µã€‚å¤æŒ‡æ•°å‡½æ•°$e^{-j\omega t}$ï¼Œå³å‚…ç«‹å¶å˜æ¢çš„åŸºå‡½æ•°ï¼Œå¯ä»¥è¢«è¯æ˜æ˜¯å›¾ä¸Šæ‹‰æ™®æ‹‰æ–¯ç®—å­çš„ä¸€ä¸ªç‰¹å¾å‡½æ•°ã€‚</p><script type="math/tex; mode=display">\Delta e^{-j\omega t}=\frac{\partial^2 e^{-j\omega t}}{\partial t^2}=-\omega^2 e^{-j\omega t}</script><p>åœ¨å›¾ä¸Šä½œç±»æ¯”ï¼Œä»¤å˜é‡ä¸º $x$ï¼Œä»¤é¢‘ç‡ä¸º $\mathrm{k}$ ï¼ˆæ³¨æ„ä¸è§’é¢‘ç‡çš„åŒºåˆ«ï¼‰ï¼Œ $\phi_{\mathrm{k}}$ ä¸ºå›¾æ‹‰æ™®æ‹‰æ–¯ç®—å­ $L$ çš„ç‰¹å¾å‘é‡ï¼ˆæ»¡è¶³ $L \phi_k=\lambda_k \phi_k$ ï¼‰ã€‚å³åœ¨å›¾ä¸­ $\Delta=\boldsymbol{L}, \mathrm{e}^{-\mathrm{jkx}}=\phi_k$ ï¼Œè€Œ $\mathrm{k}$ å’Œç‰¹å¾å€¼ $\lambda_{\mathrm{k}}$ æœ‰å…³ã€‚</p><p>å› æ­¤ï¼Œä¸ºäº†åœ¨å›¾ä¸Šè¿›è¡Œå‚…é‡Œå¶å˜æ¢ï¼Œå¯ä»¥æŠŠä¼ ç»Ÿå‚…é‡Œå¶å˜æ¢ä¸­çš„ $\mathrm{e}^{-\mathrm{jk} x}$ æ¢æˆ $\phi_k$ ï¼ŒæŠŠé¢‘ç‡ $\mathrm{k}$ æ¢ä¸º ç‰¹å¾å€¼ $\lambda_{\mathrm{k}}$ã€‚</p><p>åˆ™å›¾å‚…é‡Œå¶å˜æ¢å†™ä½œ:</p><script type="math/tex; mode=display">F\left(\lambda_k\right)=\hat{f_k}=\left\langle f, \phi_k\right\rangle</script><p>$f=\left(f_1, \ldots, f_n\right)$ æ˜¯ç”±èŠ‚ç‚¹ä¿¡æ¯æ„æˆçš„nç»´å‘é‡ã€‚åšä¸ªç±»ä¼¼çš„è§£é‡Šï¼Œå³ç‰¹å¾å€¼ $\lambda_k$ ä¸‹ï¼Œ$f$ çš„ å›¾å‚…é‡Œå¶å˜æ¢ï¼ˆæŒ¯å¹…ï¼‰ç­‰äº $f$ ä¸ $\lambda_k$ å¯¹åº”çš„ç‰¹å¾å‘é‡ $\phi_k$ çš„å†…ç§¯ã€‚</p><p>æ¨å¹¿åˆ°çŸ©é˜µå½¢å¼ï¼Œå›¾å‚…é‡Œå¶å˜æ¢:</p><script type="math/tex; mode=display">\hat{f} = \boldsymbol{\Phi}^{\top} f</script><p>å…¶ä¸­, $\hat{f}=\left(\hat{f_1} , \hat{f_2}, \ldots, \hat{f_n}\right)$ï¼Œå³å›¾å‚…é‡Œå¶å˜æ¢ï¼Œå³ä¸åŒç‰¹å¾å€¼(é¢‘ç‡)ä¸‹å¯¹åº”çš„æŒ¯å¹…æ„æˆçš„å‘é‡ã€‚ $f=\left(f_1, \ldots, f_n\right)$ æ˜¯ç”±èŠ‚ç‚¹ä¿¡æ¯æ„æˆçš„nç»´å‘é‡ã€‚</p><p>ç±»ä¼¼çš„ï¼Œä¼ ç»Ÿé€†å‚…é‡Œå¶å˜æ¢ï¼ˆnä¸ªæ­£å¼¦æ³¢çš„å åŠ ï¼‰ï¼š</p><script type="math/tex; mode=display">{ }^{-1}[F(k)]=f(x)=\sum_k F(k) e^{i k x}=\sum_k \frac{1}{2 \pi} \int_{-\infty}^{\infty} f\left(x^{\prime}\right) e^{-i k x^{\prime}} d x^{\prime} e^{i k x}</script><p>è¿ç§»åˆ°å›¾ä¸Šï¼Œ$\mathrm{e}^{ikx} \mathrm{e}^{-ikx}=1$ï¼Œä¸¤ä¸ªåŸºæ­£äº¤ï¼Œç±»æ¯”äº $\left(\phi_{\mathrm{k}}^{\top} \phi_{\mathrm{k}}\right)_{\mathrm{i}}=1$ï¼Œåˆ™å›¾é€†å‚…é‡Œå¶å˜æ¢ï¼š</p><script type="math/tex; mode=display">\mathrm{f}_{\mathrm{i}}=\sum_{\mathrm{k}=1}^{\mathrm{n}} \hat{\mathrm{f}_{\mathrm{k}}}\left(\boldsymbol{\phi}_k^{\top}\right)_{\mathrm{i}}</script><p>æ¨å¹¿åˆ°çŸ©é˜µå½¢å¼ï¼Œå›¾é€†å‚…ç«‹å¶å˜æ¢ï¼š</p><script type="math/tex; mode=display">f = \boldsymbol{\Phi} \hat{f}</script><h2 id="å›¾å·ç§¯ï¼ˆGraph-Convolutionï¼‰"><a href="#å›¾å·ç§¯ï¼ˆGraph-Convolutionï¼‰" class="headerlink" title="å›¾å·ç§¯ï¼ˆGraph Convolutionï¼‰"></a>å›¾å·ç§¯ï¼ˆGraph Convolutionï¼‰</h2><p>ç»“åˆå›¾å‚…ç«‹å¶å˜æ¢å’Œå·ç§¯å®šç†çš„ç»“è®ºï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºå›¾å·ç§¯ï¼Œé¦–å…ˆæœ‰ï¼š</p><script type="math/tex; mode=display">\begin{align}    f * g=\mathcal{F}^{-1}\{\mathcal{F}\{f\} \cdot \mathcal{F}\{g\}\} \\    \\    \hat{f} = \boldsymbol{\Phi}^{\top} f \\    \\    f = \boldsymbol{\Phi} \hat{f}\end{align}</script><p>ä¸‹é¢ä»¤å›¾ä¸º $f$ï¼Œå·ç§¯æ ¸ä¸º $h$ï¼Œåˆ™å›¾å·ç§¯ä¸º $f * h$ï¼Œæœ‰ï¼š</p><script type="math/tex; mode=display">\begin{align}f * h = \mathcal{F}^{-1}\{\mathcal{F}\{f\} \cdot \mathcal{F}\{h\}\} \\= \mathcal{F}^{-1}\{\boldsymbol{\Phi}^{\top} f \odot \boldsymbol{\Phi}^{\top} h\} \\ = \boldsymbol{\Phi}\boldsymbol{\Phi}^{\top} f \odot \boldsymbol{\Phi}^{\top} h \\= \boldsymbol{\Phi}\boldsymbol{\Phi}^{\top} h \odot \boldsymbol{\Phi}^{\top} f \\= \boldsymbol{\Phi}\hat{h} \odot \boldsymbol{\Phi}^{\top} f \\= \boldsymbol{\Phi} \operatorname{diag}\left[\hat{h}\left(\lambda_1\right), \ldots, \hat{h}\left(\lambda_n\right)\right] \boldsymbol{\Phi}^T \boldsymbol{f}\end{align}</script><p>ä¸Šå¼æ˜¯æˆ‘æŒ‰è‡ªå·±çš„ç†è§£æ¨å¯¼å¾—æ¥ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œè¯·è”ç³»æˆ‘çš„é‚®ç®±èµæ•™ğŸ™ï¼Œæ„Ÿè°¢ã€‚</p><p>å¯¹äºå·ç§¯æ ¸çš„å›¾å‚…é‡Œå¶å˜æ¢: $\hat{h}=\left(\hat{h}_1, \ldots, \hat{h}_n\right)$, å…¶ä¸­ $\hat{h}_k=\left\langle h, \phi_k\right\rangle, k=1,2 \ldots, n$ã€‚</p><p>å¯¹äºæŠŠ $\hat{h}$ ç»„ç»‡æˆå¯¹è§’çŸ©é˜µ $\operatorname{diag}\left[\hat{h}\left(\lambda_k\right)\right] \in \mathbb{R}^{N \times N}$ï¼Œä¸ªäººç†è§£ï¼Œå¹¶ä¸æ˜¯åœ¨æ”¹å˜å‘é‡çš„å½¢çŠ¶ï¼Œè€Œæ˜¯åœ¨æ”¹å˜æ“ä½œæ–¹å¼ï¼ˆè½¬å˜æˆçŸ©é˜µä¹˜æ³•ï¼‰ï¼Œä»¥æ›´å¥½åœ°è¡¨è¾¾å›¾å·ç§¯çš„è¿ç®—ã€‚</p><p>æ·±åº¦å­¦ä¹ ä¸­çš„å·ç§¯å°±æ˜¯è¦è®¾è®¡å¯å­¦ä¹ çš„å·ç§¯æ ¸ï¼Œä»å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œå°±æ˜¯è¦è®¾è®¡ $\operatorname{diag}\left[\hat{h}\left(\lambda_1\right), \ldots, \hat{h}\left(\lambda_n\right)\right]$, ç”±æ­¤, å¯ä»¥ç›´æ¥å°†å…¶å˜ä¸ºå·ç§¯æ ¸ $\operatorname{diag}\left[\theta_1, \ldots, \theta_n\right]$ï¼Œè€Œä¸éœ€è¦å†å°†å·ç§¯æ ¸è¿›è¡Œå‚…é‡Œå¶å˜æ¢ï¼Œç›¸å½“äºç›´æ¥å¯¹å˜æ¢åçš„å‚é‡è¿›è¡Œå­¦ä¹ ï¼Œå¯ä»¥æŠŠå®ƒç†è§£æˆå¯è®­ç»ƒæƒé‡å‘é‡ã€‚</p><p>PSï¼šæœ¬äººè¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ²¡ææ‡‚ï¼Œæ˜¯å¦å›¾å’Œå·ç§¯æ ¸è¦åˆ†åˆ«è®¡ç®— $\boldsymbol{\Phi}$ ï¼Ÿ</p><h3 id="ä¸€ä»£GCN"><a href="#ä¸€ä»£GCN" class="headerlink" title="ä¸€ä»£GCN"></a>ä¸€ä»£GCN</h3><p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/1312.6203">Spectral Networks and Locally Connected Networks on Graphs</a></p><p>ç”±ä¸Šè¿°å›¾å·ç§¯å¯ä»¥å¾—åˆ°ç¬¬ä¸€ä»£GCNï¼š</p><script type="math/tex; mode=display">\boldsymbol{y}_{\text {output }}=\sigma\left(\boldsymbol{\Phi} \boldsymbol{g}_\theta \boldsymbol{\Phi}^T \boldsymbol{x}\right)=\sigma\left(\boldsymbol{\Phi} \operatorname{diag}\left[\theta_1, \ldots, \theta_n\right] \boldsymbol{\Phi}^T \boldsymbol{x}\right)</script><p>å…¶ä¸­ï¼Œ$\boldsymbol{g}_{\boldsymbol{\theta}}=\text{diag}[\theta_1,â€¦,\theta_n]$ ä¸ºå·ç§¯æ ¸ï¼Œ$\sigma$ æ˜¯æ¿€æ´»å‡½æ•°ï¼Œ$\boldsymbol{x}$ å°±æ˜¯å›¾ä¸Šå¯¹åº”æ¯ä¸ªèŠ‚ç‚¹çš„ç‰¹å¾æ„æˆçš„å‘é‡ï¼Œ$x=\left(x_1, x_2, \ldots, x_n\right)$ï¼Œè¿™é‡Œæš‚æ—¶å¯¹æ¯ä¸ªèŠ‚ç‚¹éƒ½ä½¿ç”¨æ ‡é‡ï¼Œç›¸å½“äºé€šé“æ•°ä¸º 1 ï¼Œç„¶åç»è¿‡æ¿€æ´»ä¹‹åï¼Œå¾—åˆ°è¾“å‡º $\boldsymbol{y}_{\text {output, }}$ ä¹‹åä¼ å…¥ä¸‹ä¸€å±‚ã€‚</p><p>ç¼ºç‚¹ï¼š</p><ul><li>éœ€è¦å¯¹æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µè¿›è¡Œè°±åˆ†è§£æ¥æ±‚ $\boldsymbol{\Phi}$ï¼Œåœ¨å›¾å¾ˆå¤§çš„æ—¶å€™å¤æ‚åº¦å¾ˆé«˜ã€‚ å¦å¤–ï¼Œè¿˜éœ€è¦è®¡ç®—çŸ©é˜µä¹˜ç§¯ï¼Œå¤æ‚åº¦ä¸º $O\left(n^2\right)$ ã€‚</li><li>å·ç§¯æ ¸å‚æ•°ä¸º $n$ï¼Œå½“å›¾å¾ˆå¤§çš„æ—¶å€™ï¼Œ$n$ ä¼šå¾ˆå¤§ã€‚</li><li>å·ç§¯æ ¸çš„spatial localizationä¸å¥½ã€‚</li></ul><blockquote><p>å·ç§¯æ ¸çš„ç©ºé—´å®šä½ï¼ˆspatial localizationï¼‰æ˜¯æŒ‡å·ç§¯æ ¸åœ¨è¾“å…¥æ•°æ®çš„ç©ºé—´ç»´åº¦ä¸Šçš„æ“ä½œèŒƒå›´å’Œå½±å“èŒƒå›´ã€‚åœ¨å·ç§¯æ“ä½œä¸­ï¼Œå·ç§¯æ ¸ä¼šåœ¨è¾“å…¥æ•°æ®çš„ä¸åŒä½ç½®ä¸Šæ»‘åŠ¨ï¼Œé€šè¿‡ä¸è¾“å…¥æ•°æ®çš„å±€éƒ¨åŒºåŸŸè¿›è¡Œé€å…ƒç´ ç›¸ä¹˜å¹¶æ±‚å’Œæ¥ç”Ÿæˆè¾“å‡ºã€‚</p><p>åœ¨å›¾åƒå¤„ç†é¢†åŸŸï¼Œå·ç§¯æ ¸çš„ç©ºé—´å®šä½å†³å®šäº†å·ç§¯æ“ä½œåœ¨å›¾åƒä¸­æå–ç‰¹å¾çš„æ–¹å¼ã€‚ä¸åŒå¤§å°çš„å·ç§¯æ ¸å’Œä¸åŒçš„å·ç§¯æ“ä½œæ–¹å¼å¯ä»¥æ•æ‰åˆ°å›¾åƒä¸­ä¸åŒå°ºåº¦å’Œç»“æ„çš„ç‰¹å¾ã€‚ä¾‹å¦‚ï¼Œå°å°ºå¯¸çš„å·ç§¯æ ¸å¯ä»¥æ•æ‰åˆ°å›¾åƒä¸­çš„ç»†èŠ‚ç‰¹å¾ï¼Œè€Œè¾ƒå¤§å°ºå¯¸çš„å·ç§¯æ ¸åˆ™å¯ä»¥æ•æ‰åˆ°å›¾åƒä¸­çš„æ•´ä½“ç»“æ„ç‰¹å¾ã€‚</p><p>åœ¨å›¾å·ç§¯ç½‘ç»œä¸­ï¼Œå·ç§¯æ ¸çš„ç©ºé—´å®šä½ä¹Ÿå¾ˆé‡è¦ã€‚ç”±äºå›¾æ•°æ®ä¸åƒå›¾åƒä¸€æ ·å…·æœ‰è§„åˆ™çš„ç½‘æ ¼ç»“æ„ï¼Œå·ç§¯æ ¸çš„è®¾è®¡éœ€è¦è€ƒè™‘å›¾çš„æ‹“æ‰‘ç»“æ„ã€‚å·ç§¯æ ¸åœ¨å›¾ä¸Šçš„ç©ºé—´å®šä½å¯ä»¥ç”¨æ¥æ§åˆ¶å·ç§¯æ“ä½œåœ¨å›¾èŠ‚ç‚¹ä¹‹é—´ä¼ æ’­ä¿¡æ¯çš„æ–¹å¼ï¼Œä»è€Œæ•æ‰åˆ°å›¾çš„å±€éƒ¨å’Œå…¨å±€ç‰¹å¾ã€‚</p><p>å› æ­¤ï¼Œå·ç§¯æ ¸çš„ç©ºé—´å®šä½åœ¨å·ç§¯æ“ä½œä¸­èµ·åˆ°äº†è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œå®ƒå†³å®šäº†å·ç§¯æ“ä½œå¦‚ä½•åœ¨è¾“å…¥æ•°æ®çš„ä¸åŒä½ç½®ä¸Šè¿›è¡Œç‰¹å¾æå–ã€‚</p></blockquote><h3 id="äºŒä»£GCN"><a href="#äºŒä»£GCN" class="headerlink" title="äºŒä»£GCN"></a>äºŒä»£GCN</h3><p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/1606.09375">Convolutional Neural Networks on Graphs with Fast Localized Spectral Filtering</a></p><p>å›¾å‚…é‡Œå¶å˜æ¢æ˜¯å…³äºç‰¹å¾å€¼(ç›¸å½“äºæ™®é€šå‚…é‡Œå¶å˜æ¢çš„é¢‘ç‡)çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ $F\left(\lambda_1\right), \ldots, F\left(\lambda_n\right)$ï¼Œå³ $F(\boldsymbol{\Lambda})$, å› æ­¤ï¼Œå°†å·ç§¯æ ¸ $\boldsymbol{g}_\theta$ å†™æˆ $\boldsymbol{g}_\theta(\Lambda)$ï¼Œç„¶åå°† $\boldsymbol{g}_\theta(\Lambda)$ å®šä¹‰ä¸ºå¦‚ä¸‹ké˜¶å¤šé¡¹å¼</p><script type="math/tex; mode=display">g_{\theta^{\prime}}(\mathbf{\Lambda}) \approx \sum_{k=0}^K \theta_k^{\prime} \mathbf{\Lambda}^k</script><p>è¿™é‡Œçš„ $\Lambda$ ä¸ºä»¥ç‰¹å¾å€¼ä¸ºå¯¹è§’å…ƒç´ çš„å¯¹è§’çŸ©é˜µï¼Œæ‰€ä»¥ $\Lambda^k$ ä¹Ÿæ˜¯å¯¹è§’çŸ©é˜µï¼Œé€šè¿‡æ±‚å’Œä¹‹åï¼Œè¿˜æ˜¯å¯¹è§’çŸ©é˜µï¼Œå°±è¿™ä¸€ç‚¹æ¥è¯´ï¼Œå’Œ $g_\theta$ æœ¬èº«æ˜¯å¯¹è§’çŸ©é˜µæ˜¯éå¸¸å»åˆçš„ã€‚</p><p>å°†å·ç§¯å…¬å¼å¸¦å…¥ï¼Œå¯ä»¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\begin{aligned}g_{\theta^{\prime}} * x & \approx \Phi \sum_{k=0}^K \theta_k^{\prime} \boldsymbol{\Lambda}^k \boldsymbol{\Phi}^T \boldsymbol{x} \\& =\sum_{k=0}^K \theta_k^{\prime}\left(\boldsymbol{\Phi} \boldsymbol{\Lambda}^k \boldsymbol{\Phi}^T\right) x \\& =\sum_{k=0}^K \theta_k^{\prime}\left(\mathbf{\Phi} \boldsymbol{\Lambda} \boldsymbol{\Phi}^T\right)^k x \\& =\sum_{k=0}^K \theta_k^{\prime} \boldsymbol{L}^k x\end{aligned}</script><p>å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸€ä»£çš„GCNä¸éœ€è¦åšç‰¹å¾åˆ†è§£äº†ï¼Œå¯ä»¥ç›´æ¥å¯¹LaplaciançŸ©é˜µåšå˜æ¢ï¼Œé€šè¿‡äº‹å…ˆå°†LaplaciançŸ©é˜µæ±‚å‡ºæ¥ï¼Œä»¥åŠ $\boldsymbol{L}^k$ æ±‚å‡ºæ¥ï¼Œå‰å‘ä¼ æ’­çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå¤æ‚åº¦ä¸º $O\left(K n^2\right)$ ã€‚</p><p>é‚£ä¹ˆä¸Šå¼æ˜¯å¦‚ä½•ä½“ç°localizationå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼ŒçŸ©é˜µçš„$k$æ¬¡æ–¹å¯ä»¥ç”¨äºæ±‚è¿é€šæ€§ï¼Œå³1ä¸ªèŠ‚ç‚¹ç»è¿‡$k$æ­¥èƒ½å¦åˆ°è¾¾å¦ä¸€ä¸ªé¡¶ç‚¹ï¼ŒçŸ©é˜µ$k$æ¬¡æ–¹ç»“æœä¸­å¯¹åº”å…ƒç´ é0çš„è¯å¯è¾¾ï¼Œä¸º0ä¸å¯è¾¾ã€‚é‚£ä¹ˆ $\boldsymbol{L}^k$ æ‰€è¡¨è¾¾çš„å°±æ˜¯ k-hop å†…çš„èŠ‚ç‚¹ã€‚åˆå¯ä»¥é€šè¿‡æ‹‰æ™®æ‹‰æ–¯ç®—å­çš„æ€§è´¨è¯æ˜ï¼Œå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹çš„æœ€çŸ­è·¯å¾„å¤§äº $k$ çš„è¯ï¼Œ$\boldsymbol{L}^k$ åœ¨ç›¸åº”ä½ç½®çš„å…ƒç´ å€¼ä¸º0ã€‚</p><p>ç»¼ä¸Šï¼Œç›¸å½“äºåªæœ‰nèŠ‚ç‚¹çš„k-hopä¹‹å†…çš„é‚»å±…èŠ‚ç‚¹èƒ½å¤Ÿä¼ é€’ä¿¡æ¯ï¼Œå®é™…ä¸Šåªåˆ©ç”¨äº†èŠ‚ç‚¹çš„K-Localizedä¿¡æ¯ã€‚</p><p>å¦å¤–ï¼Œä½œè€…æå‡ºå¯ä»¥ä½¿ç”¨åˆ‡æ¯”é›ªå¤«å±•å¼€å¼æ¥è¿‘ä¼¼ $\boldsymbol{L}^k$ï¼Œå› ä¸ºä»»ä½• $\mathbf{k}$ æ¬¡å¤šé¡¹å¼éƒ½å¯ä»¥ä½¿ç”¨åˆ‡æ¯”é›ªå¤«å±•å¼€å¼æ¥è¿‘ä¼¼ï¼Œç”±æ­¤ï¼Œå¼•å…¥åˆ‡æ¯”é›ªå¤«å¤šé¡¹å¼çš„ $K$ é˜¶æˆªæ–­è·å¾— $\boldsymbol{L}^k$ è¿‘ä¼¼ï¼Œä»è€Œè·å¾—å¯¹ $g_\theta(\boldsymbol{\Lambda})$ çš„è¿‘ä¼¼</p><script type="math/tex; mode=display">g_{\theta^{\prime}}(\mathbf{\Lambda}) \approx \sum_{k=0}^K \theta_k^{\prime} T_k(\tilde{\mathbf{\Lambda}})</script><p>å…¶ä¸­ï¼Œ$\tilde{\boldsymbol{\Lambda}}=\frac{2}{\lambda_{\max }} \boldsymbol{\Lambda}-\boldsymbol{I}_n $ ä¸ºç»å›¾æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µ $L$ çš„æœ€å¤§ç‰¹å¾å€¼ï¼ˆå³è°±åŠå¾„ï¼‰ç¼©æ”¾åçš„ç‰¹å¾å‘é‡çŸ©é˜µï¼ˆé˜²æ­¢è¿ä¹˜çˆ†ç‚¸ï¼‰ï¼Œ$ \boldsymbol{\theta}^{\prime} \in \mathbb{R}^K$ ä¸ºä¸€ä¸ªåˆ‡æ¯”é›ªå¤«å‘é‡ï¼Œ$\theta_k^{\prime}$ ä¸ºç¬¬ $k$ ç»´åˆ†é‡ï¼Œåˆ‡æ¯”é›ªå¤«å¤šé¡¹å¼ $T_k(x)$ ä½¿ç”¨é€’å½’çš„æ–¹å¼è¿›è¡Œå®šä¹‰ï¼š</p><script type="math/tex; mode=display">T_k(x)=2 x T_{k-1}(x)-T_{k-2}(x)</script><p>å…¶ä¸­, $T_0(x)=1, T_1(x)=x$ ã€‚</p><p>æ­¤æ—¶ï¼Œç”¨è¿‘ä¼¼çš„å·ç§¯æ ¸å¸¦å…¥åˆ°åŸå…¬å¼ï¼Œå¯å¾—ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\boldsymbol{g}_{\boldsymbol{\theta}^{\prime}} * \boldsymbol{x} & \approx \boldsymbol{\Phi} \sum_{k=0}^K \theta_k^{\prime} T_k(\tilde{\boldsymbol{\Lambda}}) \boldsymbol{\Phi}^T \boldsymbol{x} \\& \approx \sum_{k=0}^K \theta_k^{\prime}\left(\boldsymbol{\Phi} T_k(\tilde{\boldsymbol{\Lambda}}) \boldsymbol{\Phi}^T\right) x \\& =\sum_{k=0}^K \theta_k^{\prime} T_k(\tilde{\boldsymbol{L}}) \boldsymbol{x}\end{aligned}</script><p>å…¶ä¸­ï¼Œ$\tilde{\boldsymbol{L}}=\frac{2}{\lambda_{\max }} \boldsymbol{L}-\boldsymbol{I}_n$ ã€‚</p><p>å› æ­¤ï¼Œå¯ä»¥å¾—åˆ°è¾“å‡ºä¸ºï¼š</p><script type="math/tex; mode=display">\boldsymbol{y}_{\text {output }}=\sigma\left(\sum_{k=0}^K \theta_k^{\prime} T_k(\tilde{\boldsymbol{L}}) \boldsymbol{x}\right)</script><p>å…¶ä¸­å‚æ•°å‘é‡ $\boldsymbol{\theta}^{\prime} \in \mathbb{R}^{k}$ éœ€è¦å­¦ä¹ ã€‚</p><h3 id="ä¸‰ä»£GCN"><a href="#ä¸‰ä»£GCN" class="headerlink" title="ä¸‰ä»£GCN"></a>ä¸‰ä»£GCN</h3><p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/1609.02907">Semi-supervised Classification with Graph Convolutional Networks</a></p><p>è¿™ä¸€ä»£GCNç›´æ¥å–åˆ‡æ¯”é›ªå¤«å¤šé¡¹å¼ä¸­ $K=1$ï¼Œæ­¤æ—¶æ¨¡å‹æ˜¯ 1 é˜¶è¿‘ä¼¼ï¼Œå³æ¯å±‚å·ç§¯å±‚åªè€ƒè™‘äº†ç›´æ¥é‚»åŸŸï¼Œç±»ä¼¼CNNä¸­ $3 \times 3$ çš„å·ç§¯æ ¸ã€‚å¹¶ä¸”ï¼Œè¿™ä¸€ä»£GCNåŠ æ·±äº†æ·±åº¦è€Œå‡å°äº†å®½åº¦ï¼Œè‹¥è¦å»ºç«‹å¤šé˜¶ proximityï¼Œåªéœ€è¦ä½¿ç”¨å¤šä¸ªå·ç§¯å±‚ã€‚åŒæ—¶ï¼ŒåŠ å…¥äº†ä¸€äº›å‚æ•°çº¦æŸï¼Œå¦‚ $\lambda_{\max }=2$ å’Œå¼•å…¥renormalization trickï¼Œå¤§å¤§ç®€åŒ–äº†æ¨¡å‹ã€‚</p><p>ä¸‹é¢å¼€å§‹æ¨å¯¼ï¼Œå°† $K=1, \quad \lambda_{\max }=2$ å¸¦å…¥å¯ä»¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\boldsymbol{g}_{\theta^{\prime}} * \boldsymbol{x} & \approx \boldsymbol{\theta}_0^{\prime} \boldsymbol{x}+\theta_1^{\prime}\left(\boldsymbol{L}-\boldsymbol{I}_n\right) \boldsymbol{x} \\& =\boldsymbol{\theta}_0^{\prime} \boldsymbol{x}+\theta_1^{\prime}\left(\boldsymbol{L}-\boldsymbol{I}_n\right) \boldsymbol{x} \\& =\theta_0^{\prime} \boldsymbol{x}-\theta_1^{\prime}\left(\boldsymbol{D}^{-1 / 2} \boldsymbol{W} \boldsymbol{D}^{-1 / 2}\right) \boldsymbol{x}\end{aligned}</script><p>æœ€ç»ˆè½¬æ¢æ­¥éª¤çš„è§£é‡Šå¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\boldsymbol{L}=\boldsymbol{D}^{-1 / 2}(\boldsymbol{D}-\boldsymbol{W}) \boldsymbol{D}^{-1 / 2}=\boldsymbol{I}_n-\boldsymbol{D}^{-1 / 2} \boldsymbol{W} \boldsymbol{D}^{-1 / 2}</script><p>ç°åœ¨æ¯ä¸ªå·ç§¯æ ¸åªæœ‰2ä¸ªå‚æ•°ï¼Œä¸ºäº†è¿›ä¸€æ­¥ç®€åŒ–ï¼Œä»¤ $\theta_0^{\prime}=-\theta_1^{\prime}$ï¼Œæ­¤æ—¶åªå«æœ‰ä¸€ä¸ªå‚æ•° $\theta$ï¼š</p><script type="math/tex; mode=display">g_{\theta^{\prime}} * x=\theta\left(I_n+D^{-1 / 2} W D^{-1 / 2}\right) x</script><p>ç”±äº $\boldsymbol{I}_n+\boldsymbol{D}^{-1 / 2} \boldsymbol{W} \boldsymbol{D}^{-1 / 2}$ çš„è°±åŠå¾„ $[0,2]$ å¤ªå¤§ï¼Œä½¿ç”¨renormalization trickï¼š</p><script type="math/tex; mode=display">\boldsymbol{I}_n+\boldsymbol{D}^{-1 / 2} \boldsymbol{W} \boldsymbol{D}^{-1 / 2} \rightarrow \tilde{\boldsymbol{D}}^{-1 / 2} \tilde{\boldsymbol{W}} \tilde{\boldsymbol{D}}^{-1 / 2}</script><p>å…¶ä¸­ï¼Œ$\tilde{\boldsymbol{W}}=\boldsymbol{W}+\boldsymbol{I}_n$ (ç›¸å½“äºåŠ äº†self-connectionï¼Œæœ¬æ¥$\boldsymbol{W}$å¯¹è§’å…ƒç´ ä¸º0)ï¼Œ$\tilde{D}_{i j}=\Sigma_j \tilde{W}_{i j}$ ã€‚</p><p>å¸¦å…¥å·ç§¯å…¬å¼ï¼š</p><script type="math/tex; mode=display">\underbrace{g_{\theta^{\prime}} * x}_{\mathbb{R}^{n \times 1}}=\theta(\underbrace{\tilde{D}^{-1 / 2} \tilde{W} \tilde{D}^{-1 / 2}}_{\mathbb{R}^{n \times n}}) \underbrace{x}_{\mathbb{R}^{n \times 1}}</script><p>å¦‚æœæ¨å¹¿åˆ°å¤šé€šé“ï¼Œç›¸å½“äºæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯æ˜¯å‘é‡ï¼Œä¸”æœ‰å¤šå·ç§¯æ ¸ï¼š</p><script type="math/tex; mode=display">x \in \mathbb{R}^{N \times 1} \rightarrow X \in \mathbb{R}^{N \times C}</script><p>å…¶ä¸­ï¼Œ$N$ æ˜¯èŠ‚ç‚¹æ•°é‡ï¼Œ$C$ æ˜¯é€šé“æ•°ï¼Œæˆ–è€…ç§°ä½œè¡¨ç¤ºèŠ‚ç‚¹çš„ä¿¡æ¯ç»´åº¦æ•°ã€‚ $\mathrm{X}$ æ˜¯ èŠ‚ç‚¹çš„ç‰¹å¾çŸ©é˜µã€‚</p><p>ç›¸åº”çš„å·ç§¯æ ¸å‚æ•°å˜åŒ–ï¼š</p><script type="math/tex; mode=display">\theta \in \mathbb{R} \rightarrow \Theta \in \mathbb{R}^{C \times F}</script><p>å…¶ä¸­ï¼Œ$F$ ä¸ºå·ç§¯æ ¸æ•°é‡ã€‚</p><p>é‚£ä¹ˆå·ç§¯ç»“æœå†™æˆçŸ©é˜µå½¢å¼ä¸ºï¼š</p><script type="math/tex; mode=display">\underbrace{Z}_{\mathbb{R}^{N \times F}}=\underbrace{\tilde{D}^{-1 / 2} \tilde{W} \tilde{D}^{-1 / 2}}_{\mathbb{R}^{N \times N}} \underbrace{X}_{\mathbb{R}^{N \times C}}  \underbrace{\Theta}_{\mathbb{R}^{C \times F}}</script><p>ä¸Šè¿°æ“ä½œå¯ä»¥å åŠ å¤šå±‚ï¼Œå¯¹è¾“å‡º$Z$æ¿€æ´»ä¸€ä¸‹ï¼Œå°±å¯ä»¥ä½œä¸ºä¸‹ä¸€å±‚èŠ‚ç‚¹çš„ç‰¹å¾çŸ©é˜µã€‚</p><p>è¿™ä¸€ä»£GCNç‰¹ç‚¹ï¼š</p><ul><li>å– $K=1$ï¼Œç›¸å½“äºç›´æ¥å–é‚»åŸŸä¿¡æ¯ï¼Œç±»ä¼¼äº $3 \times 3$ çš„å·ç§¯æ ¸ã€‚</li><li>ç”±äºå·ç§¯æ ¸å®½åº¦å‡å°ï¼Œå¯ä»¥é€šè¿‡å¢åŠ å·ç§¯å±‚æ•°æ¥æ‰©å¤§æ„Ÿå—åŸŸï¼Œä»è€Œå¢å¼ºç½‘ç»œçš„è¡¨è¾¾èƒ½åŠ›ã€‚</li><li>å¢åŠ äº†å‚æ•°çº¦æŸï¼Œæ¯”å¦‚ $\lambda_{\max } \approx 2$ï¼Œå¼•å…¥é‡å½’ä¸€åŒ–trickã€‚</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://zhuanlan.zhihu.com/p/76296353">https://zhuanlan.zhihu.com/p/76296353</a><br>[2] <a href="https://zhuanlan.zhihu.com/p/54505069">https://zhuanlan.zhihu.com/p/54505069</a><br>[3] <a href="http://xtf615.com/2019/02/24/gcn/">http://xtf615.com/2019/02/24/gcn/</a><br>[4] <a href="https://zhuanlan.zhihu.com/p/362416124">https://zhuanlan.zhihu.com/p/362416124</a><br>[5] <a href="https://qddmj.cn/gcn-laplacian.htm">https://qddmj.cn/gcn-laplacian.htm</a><br>[6] <a href="https://zhuanlan.zhihu.com/p/170091053">https://zhuanlan.zhihu.com/p/170091053</a><br>[7] <a href="https://qddmj.cn/gcn-laplacian2.htm">https://qddmj.cn/gcn-laplacian2.htm</a><br>[8] <a href="https://zhuanlan.zhihu.com/p/41609577">https://zhuanlan.zhihu.com/p/41609577</a><br>[9] <a href="https://zhuanlan.zhihu.com/p/464121739">https://zhuanlan.zhihu.com/p/464121739</a><br>[10] <a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#convolutional-layers">https://pytorch-geometric.readthedocs.io/en/latest/modules/nn.html#convolutional-layers</a><br>[11] <a href="https://zhuanlan.zhihu.com/p/60014316">https://zhuanlan.zhihu.com/p/60014316</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å›¾å·ç§¯å­¦ä¹ è®°å½•ï¼ŒåŒæ—¶ä¹Ÿæ¶‰åŠç¦»æ•£æ‹‰æ™®æ‹‰æ–¯ç®—å­å†…å®¹ï¼Œå¯èƒ½å¯¹è§†è§‰æ–¹å‘æœ‰å¸®åŠ©ã€‚&lt;/p&gt;
&lt;p&gt;ç›¸å…³å†…å®¹ï¼šå·ç§¯ã€å‚…ç«‹å¶å˜æ¢ã€æ‹‰æ™®æ‹‰æ–¯ç®—å­ã€ç‹„åˆ©å…‹é›·èƒ½é‡ã€å›¾å·ç§¯&lt;br&gt;</summary>
    
    
    
    
    <category term="æ·±åº¦å­¦ä¹ " scheme="http://silencezheng.top/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="å›¾è®º" scheme="http://silencezheng.top/tags/%E5%9B%BE%E8%AE%BA/"/>
    
  </entry>
  
  <entry>
    <title>Yiliaå›¾ç‰‡å±…ä¸­</title>
    <link href="http://silencezheng.top/2023/08/13/article116/"/>
    <id>http://silencezheng.top/2023/08/13/article116/</id>
    <published>2023-08-13T07:48:59.000Z</published>
    <updated>2023-08-13T07:50:37.206Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Hexoåšå®¢ï¼ŒYiliaä¸»é¢˜è®¾ç½®å›¾ç‰‡å±…ä¸­ã€‚</p><span id="more"></span><p>Yiliaç”¨äº†å¾ˆä¹…äº†ï¼Œç»ˆäºæƒ³èµ·æ¥åŠ¨ä¸€ä¸‹å›¾ç‰‡å±…ä¸­çš„æ¯›ç—…ï¼ŒåŸç‰ˆæ˜¯æ— æ³•å®ç°å›¾ç‰‡å±…ä¸­çš„ï¼Œåœ¨<code>article-main.scss</code>ä¸­åŠ ä¸ªæ ·å¼å¯ä»¥è§£å†³ã€‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">img</span>&#123;</span><br><span class="line">  <span class="attribute">max-width</span>: <span class="number">100%</span>;</span><br><span class="line">  // è¦æ·»åŠ çš„</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ·»åŠ å®Œéœ€è¦é‡æ–°ç¼–è¯‘ä¸»é¢˜é¡¹ç›®ï¼Œè¿›å…¥é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">npm install</span><br><span class="line"><span class="comment"># ç¼–è¯‘ã€å‹ç¼©ã€‚</span></span><br><span class="line">npm run dist</span><br></pre></td></tr></table></figure></p><p>Yiliaè¿™ä¸ªé¡¹ç›®2017å¹´åå°±æ²¡æœ‰ç»´æŠ¤äº†ï¼Œæ³¨æ„åœ¨å®‰è£…ä¾èµ–æ—¶ç”¨Python2ç¯å¢ƒã€‚</p><p>å‚è€ƒ<a href="https://github.com/litten/hexo-theme-yilia/wiki/Yiliaæºç ç›®å½•ç»“æ„åŠæ„å»ºé¡»çŸ¥">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><p>åœ¨å¤–éƒ¨ç¼–è¯‘å‹ç¼©å®Œï¼Œæ›¿æ¢sourceç›®å½•ä¸‹çš„<code>main.XXX.css</code>æ–‡ä»¶å°±è¡Œäº†ã€‚</p><p>ä½†å¦‚æœé¡¹ç›®ç¼–è¯‘ç¯å¢ƒæœ‰é—®é¢˜çš„è¯ï¼Œè¿™æ ·æ›¿æ¢è¿˜æ˜¯å®¹æ˜“é€ æˆå…¶ä»–bugï¼Œæœ€ç¨³å¦¥çš„æ–¹å¼è¿˜æ˜¯ç›´æ¥åœ¨å·²å‘å¸ƒçš„<code>main.XXX.css</code>ä¸­æœç´¢<code>.article img</code>ç„¶åè¿›è¡Œä¿®æ”¹ã€‚</p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é¦–å‘äº <a href="https://silencezheng.top">silencezheng.top</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;Hexoåšå®¢ï¼ŒYiliaä¸»é¢˜è®¾ç½®å›¾ç‰‡å±…ä¸­ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="Yilia" scheme="http://silencezheng.top/tags/Yilia/"/>
    
  </entry>
  
</feed>
